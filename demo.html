<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFCKING – Kontaktløse visittkort | Demo & forhåndsvisning</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    :root{--brand:#3fffd2;--ink:#0b0b10;--card:#12121a;--muted:#8ea0b4}
    body{background:var(--ink);color:#eaf2ff}
    .hero{display:grid;gap:18px;align-items:center;grid-template-columns:1.2fr 1fr;margin-top:10px}
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
    .tag{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#17333a;color:#9ef7ea;font-weight:700}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;border:1px solid #344458}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px}
    .col-2{grid-template-columns:1fr 1fr}
    .card{background:var(--card);border-radius:14px;padding:16px}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .logo-prev{height:42px;max-width:240px;object-fit:contain;background:#fff;border-radius:8px;padding:6px}
    .preview-wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:1100px){.preview-wrap{grid-template-columns:1fr}}
    .phone{background:#0f1216;border:1px solid #1d2430;border-radius:28px;padding:18px}
    .phone iframe{width:100%;height:520px;border:0;border-radius:10px;background:#0b0b10}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a;border:0;cursor:pointer}
    .help{font-size:.9rem;color:#9fb0c6}
    .brandmark{filter:drop-shadow(0 0 6px var(--brand))}
    canvas.card-canvas{width:100%;height:auto;max-width:100%;border-radius:14px;display:block;background:#111}
    table th,table td{padding:6px 8px;border-bottom:1px solid #233046}
    .two-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.two-cards{grid-template-columns:1fr}}
    /* Retningsindikatorer for slidere */
    .axis{display:grid;gap:6px;min-width:260px}
    .axis h4{margin:4px 0}
    .axis-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center}
    .axis-cap{font:700 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#cfe3ff;background:#223141;border:1px solid #33465e;padding:4px 6px;border-radius:6px;white-space:nowrap}
    .val{font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#9fb0c6}
    .val code{color:#cfe3ff}
    .mock-card{background:#0f1216;border:1px solid #1d2430;border-radius:14px;padding:16px}
  </style>
</head>
<body>
    <nav class="navbar">
    <a href="/index.html">Adminpanel</a>
    <a href="/bestill-kort.html">Bestill kort</a>
  </nav>

<header class="card" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
  <div class="inline">
    <img src="/assets/NFCKING_dark.png" alt="NFCKING" class="brandmark" style="height:40px">
    <span class="tag">Kontaktløse visittkort</span>
  </div>
  <div class="inline">
    <a href="#demo" class="btn">Prøv demo</a>
    <a href="#hvordan" class="pill">Hvordan funker det?</a>
  </div>
</header>

<section class="hero">
  <div>
    <h1>NFCKING – én lenke, ett kort, uendelig fleksibelt.</h1>
    <p class="muted">Forhåndsvis digitalt kort og tosidig kort med lasergravert logo og tekst. Slidere har tydelige retninger: ↑ OPP / ↓ NED / ← VENSTRE / → HØYRE.</p>
    <ul>
      <li>✅ Felles renderer for <b>red/light/dark</b></li>
      <li>✅ <b>Lasergravert</b> logo + tekst</li>
      <li>✅ <b>Tosidig mockup</b> – forside/bakside</li>
      <li>✅ Manuell <b>størrelse</b> og <b>posisjon</b></li>
    </ul>
    <div class="inline" style="margin-top:8px">
      <label>Stil:
        <select id="cardStyleTop">
          <option value="dark" selected>Dark</option>
          <option value="light">Light</option>
          <option value="red">Red</option>
        </select>
      </label>
      <button type="button" id="downloadFrontTop" class="pill">Last ned forside</button>
      <button type="button" id="downloadBackTop" class="pill">Last ned bakside</button>
    </div>
  </div>

  <div class="card two-cards">
    <div>
      <h3 style="margin:0 0 8px 0">Forside</h3>
      <canvas id="frontTop" class="card-canvas" width="1000" height="630"></canvas>
    </div>
    <div>
      <h3 style="margin:0 0 8px 0">Bakside</h3>
      <canvas id="backTop" class="card-canvas" width="1000" height="630"></canvas>
    </div>
  </div>
</section>

<section id="hvordan" class="card">
  <h2>Hvordan funker det?</h2>
  <div class="grid col-2">
    <div><h3>1) Fyll inn</h3><p class="muted">Navn, tittel, kontaktfelt, lenker og logo (URL eller opplasting).</p></div>
    <div><h3>2) Velg kortoppsett</h3><p class="muted">Logo på begge sider, kun logo, eller logo + tekst på baksiden.</p></div>
    <div><h3>3) Plasser elementer</h3><p class="muted">Juster størrelse og posisjon. Retning står ved sliderne.</p></div>
    <div><h3>4) Last ned</h3><p class="muted">Eksporter PNG for for- og bakside.</p></div>
  </div>
</section>

<section id="demo" class="card">
  <h2>Prøv demoen – fyll ut og se live</h2>

  <div class="row">
    <label>Organisasjon <input id="orgName" placeholder="Wayback Trondheim"></label>
    <label>Org key <input id="orgKey" placeholder="Wayback" value="Wayback"></label>
    <label>Accent-farge <input id="accent" placeholder="#8fd3ff" value="#8fd3ff"></label>

    <label>Logo-URL <input id="logoUrl" placeholder="https://…/logo.png"></label>
    <label>eller last opp logo <input id="logoFile" type="file" accept="image/*"><small id="logoFileNote" class="help"></small></label>

    <label>Logo-bakgrunn <input id="logoBg" placeholder="#ffffff (tom = auto)"></label>
  </div>

  <div class="inline">
    <img id="logoPreview" class="logo-prev" alt="logo" style="display:none">
    <span class="help">Tips: Mørk logo → sett hvit bakgrunn for digitalt kort. Lasergravering ignorerer bakgrunn.</span>
  </div>

  <div class="inline" style="gap:14px;margin:8px 0">
    <label class="pill"><input type="checkbox" id="engraveMode" checked> Lasergravér logo</label>
    <label>Fjern lys bakgrunn <input type="checkbox" id="autoRemoveBg" checked></label>
    <label>Dybde <input type="range" id="engraveDepth" min="0.25" max="1" step="0.05" value="0.75"></label>
    <label>Terskel <input type="range" id="bgThreshold" min="8" max="80" step="1" value="28"> <code id="bgThresholdVal">28</code></label>
  </div>

  <div class="row">
    <label>Navn <input id="name" placeholder="Trygve Eiulf Waagen"></label>
    <label>Tittel <input id="title" placeholder="Avdelingsleder"></label>
    <label>Telefon <input id="phone" placeholder="+47 47731087"></label>
    <label>E-post <input id="email" placeholder="trygve@wayback.no"></label>
    <label>Nettside <input id="site" placeholder="https://wayback.no"></label>
    <label>Adresse <input id="address" placeholder="Kongens gate 46, 7012 Trondheim"></label>
    <label>Slug <input id="slug" placeholder="Trygve"></label>
    <label>VCF-filnavn <input id="vcfFilename" placeholder="trygve_wayback.vcf"></label>
  </div>

  <h3>Tosidig kort – oppsett</h3>
  <div class="inline" style="gap:18px;flex-wrap:wrap">
    <label>Modus:
      <select id="twoSideMode">
        <option value="logo-both" selected>1) Logo på begge sider</option>
        <option value="logo-front-only">2) Kun logo forside, bakside blank</option>
        <option value="logo-front-text-back">3) Logo forside + tekst bakside</option>
        <option value="logo-front-text+smalllogo-back">4) Logo forside + tekst + liten logo bakside</option>
      </select>
    </label>
    <label>Stil (demo):
      <select id="cardStyleDemo">
        <option value="dark" selected>Dark</option>
        <option value="light">Light</option>
        <option value="red">Red</option>
      </select>
    </label>

    <!-- Nedlasting for denne mocken -->
    <button class="pill" id="downloadFront">Last ned forside</button>
    <button class="pill" id="downloadBack">Last ned bakside</button>
  </div>

  <!-- FLYTTET: Første forhåndsvisning rett under modusvalget -->
  <div class="mock-card" style="margin-top:8px">
    <div class="two-cards">
      <canvas id="frontDemo" class="card-canvas" width="860" height="540"></canvas>
      <canvas id="backDemo"  class="card-canvas" width="860" height="540"></canvas>
    </div>
    <p class="help" style="margin:8px 0 0">Denne forhåndsvisningen oppdateres av sliderne under.</p>
  </div>

  <!-- SLIDERE -->
  <div class="grid" style="margin-top:12px">
    <!-- LOGO FORSIDE -->
    <div class="axis">
      <h4>Forside-logo</h4>
      <div><span class="val">Størrelse: </span><code id="frontLogoSizeVal">64%</code></div>
      <input type="range" id="frontLogoSize" min="20" max="100" step="1" value="64">
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="frontLogoX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="frontLogoXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="frontLogoY" min="0" max="100" step="1" value="50">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="frontLogoYVal">50%</code></span>
      </div>
    </div>

    <!-- LOGO BAKSIDE (liten) -->
    <div class="axis">
      <h4>Liten logo – bakside</h4>
      <div><span class="val">Størrelse: </span><code id="backSmallLogoSizeVal">24%</code></div>
      <input type="range" id="backSmallLogoSize" min="10" max="60" step="1" value="24">
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="backLogoX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="backLogoXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="backLogoY" min="0" max="100" step="1" value="18">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="backLogoYVal">18%</code></span>
      </div>
    </div>

    <!-- TEKST BAKSIDE -->
    <div class="axis">
      <h4>Tekst – bakside</h4>
      <div class="inline" style="gap:12px;margin:4px 0">
        <label>Justering
          <select id="textAlign">
            <option value="center" selected>Midtstilt</option>
            <option value="left">Venstrejustert</option>
          </select>
        </label>
        <label>Størrelse (base)
          <input type="range" id="textBaseSize" min="18" max="72" step="1" value="40">
          <code id="textBaseSizeVal">40 px</code>
        </label>
      </div>
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="textAnchorX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="textAnchorXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="textStartY" min="10" max="90" step="1" value="38">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="textStartYVal">38%</code></span>
      </div>
      <p class="help" style="margin:4px 0 0">Tips: Ved “Logo forside + liten logo bak” vil tekst starte under den lille logoen automatisk.</p>
    </div>
  </div>

  <hr>
  <div class="phone">
    <h3>Digitalt kort</h3>
    <iframe id="liveFrame"></iframe>
  </div>

  <div class="inline" style="margin-top:12px">
    <button class="btn" id="updatePreview">Oppdater forhåndsvisning</button>
  </div>
</section>

<footer class="card" style="margin-top:18px">
  <small class="muted">© NFCKING. Tosidig kortmockup med lasergravert logo og tekst – manuell størrelse og posisjon med tydelige retninger.</small>
</footer>

<script>
/* === BASIS === */
const BASES = { dark:'/assets/dark.png', light:'/assets/light.png', red:'/assets/red.png' };
window._uploadedLogoDataUrl = '';

function loadImg(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>res(i);i.onerror=rej;i.src=url;});}
function toCanvasFromImage(i){const c=document.createElement('canvas');c.width=i.width;c.height=i.height;c.getContext('2d',{willReadFrequently:true}).drawImage(i,0,0);return c;}
function roundRect(c,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);c.beginPath();c.moveTo(x+rr,y);c.lineTo(x+w-rr,y);c.quadraticCurveTo(x+w,y,x+w,y+rr);c.lineTo(x+w,y+h-rr);c.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);c.lineTo(x+rr,y+h);c.quadraticCurveTo(x,y+h,x,y+h-rr);c.lineTo(x,y+rr);c.quadraticCurveTo(x,y,x+rr,y);c.closePath();}

/* === LASER – LOGO (bildebehandling) === */
function removeBgByThreshold(c,t=28){
  const x=c.getContext('2d',{willReadFrequently:true});
  const id=x.getImageData(0,0,c.width,c.height);const d=id.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];
    if(a<20){ d[i+3]=0; continue; }
    const dist=Math.sqrt((255-r)**2+(255-g)**2+(255-b)**2);
    if(dist<t) d[i+3]=0;
  }
  x.putImageData(id,0,0); return c;
}
function toGrayBoost(c){
  const x=c.getContext('2d',{willReadFrequently:true});const id=x.getImageData(0,0,c.width,c.height);const d=id.data;
  for(let i=0;i<d.length;i+=4){
    let y=.2126*d[i]+.7152*d[i+1]+.0722*d[i+2];
    y=(y/255-.5)*1.2+.5; y=Math.max(0,Math.min(1,y));
    const v=Math.round(y*255); d[i]=d[i+1]=d[i+2]=v;
  }
  x.putImageData(id,0,0); return c;
}
async function prepareEngraveCanvas(src){
  if(!src) return null;
  let c=toCanvasFromImage(await loadImg(src));
  if(document.getElementById('autoRemoveBg')?.checked){
    const thr=parseInt(document.getElementById('bgThreshold')?.value||'28',10);
    c=removeBgByThreshold(c,thr);
  }
  return toGrayBoost(c);
}
function drawEngraved(ctx,img,x,y,w,h,d=0.75){
  ctx.save();
  ctx.globalCompositeOperation='multiply';
  ctx.filter='brightness(0.18) contrast(1.25)';
  ctx.globalAlpha=d; ctx.drawImage(img,x,y,w,h);
  ctx.restore();
  ctx.save();
  ctx.globalCompositeOperation='multiply';
  ctx.filter='blur(1.2px)';
  ctx.globalAlpha=Math.min(0.35,d*0.5);
  ctx.drawImage(img,x+1,y+1,w,h);
  ctx.restore();
}

/* === UI-HJELPERE === */
const esc = s => (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
function previewLogo(){
  const img=document.getElementById('logoPreview');
  const bg=(document.getElementById('logoBg')?.value||'').trim();
  const src=window._uploadedLogoDataUrl || (document.getElementById('logoUrl')?.value||'').trim();
  if(!img) return;
  img.style.display = src ? 'block' : 'none';
  if(!src) return;
  img.src=src; img.style.background=bg||'#ffffff'; img.style.borderRadius='8px'; img.style.padding='6px';
}
function handleLogoFileInput(file){
  if(!file) return;
  const note=document.getElementById('logoFileNote');
  const r=new FileReader();
  r.onload=()=>{ window._uploadedLogoDataUrl=String(r.result||''); const u=document.getElementById('logoUrl'); if(u) u.value=''; if(note) note.textContent='Bruker opplastet logo: '+file.name; previewLogo(); updatePreview(); };
  r.readAsDataURL(file);
}
document.getElementById('logoFile')?.addEventListener('change', e=>{
  const f=e.target.files && e.target.files[0]; handleLogoFileInput(f);
});

/* === DIGITALT KORT (IFRAME) === */
function makeLinksHTML(links){
  if(!links.length) return '';
  return links.map(l=>{
    const pre  = l.pre  ? '<div class="pre" style="margin:8px 0 4px;color:#bfc8d6">'+esc(l.pre)+'</div>' : '';
    const post = l.post ? '<div class="post" style="margin:4px 0 10px;color:#97a3b6;font-size:.95rem">'+esc(l.post)+'</div>' : '';
    return '<div class="link-block" style="margin-top:10px">'+pre+'<a class="btn" href="'+esc(l.url)+'" target="_blank" rel="noopener">'+esc(l.label)+'</a>'+post+'</div>';
  }).join('');
}
function makeHTML(d, links){
  const acc=d.accent||'#8fd3ff';
  const logoTag = d.logoUrl
    ? '<img class="brand-logo" src="'+d.logoUrl+'" style="max-height:56px;max-width:280px;object-fit:contain;'+(d.logoBg?('background:'+d.logoBg+';border-radius:8px;padding:6px;'):'')+'" alt="'+esc(d.orgName)+' logo">'
    : '';
  const phoneBtn=d.phone?'<a class="btn" href="tel:'+esc(d.phone)+'">Ring</a>':'';
  const emailBtn=d.email?'<a class="btn" href="mailto:'+esc(d.email)+'">E-post</a>':'';
  const siteBtn =d.site ?'<a class="btn" href="'+esc(d.site)+'" target="_blank" rel="noopener">Besøk nettside</a>':'';
  const extras=makeLinksHTML(links);

  return '<!doctype html><html lang="no"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'
  +'<title>Kontaktkort – '+esc(d.name||'')+'</title>'
  +'<style>:root{--accent:'+acc+';}body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}.card p{color:#bfc8d6}.brand-logo{display:block;margin:0 0 12px 0}</style>'
  +'</head><body><main class="container card">'
  +logoTag
  +'<h1>Kontaktkort – '+esc(d.name||'')+'</h1>'
  +'<p class="muted">'+esc(d.title||'')+' · '+esc(d.orgName||'')+'</p>'
  +'<div class="links">'+phoneBtn+emailBtn+siteBtn+'</div>'
  +extras
  +(d.address?'<p style="margin-top:14px">Adresse: '+esc(d.address)+'</p>':'')
  +'</main></body></html>';
}

/* === LOGOBLOKK === */
async function drawLogoBlock(ctx, d, box){
  const engraveOn=!!document.getElementById('engraveMode')?.checked;
  const depth=parseFloat(document.getElementById('engraveDepth')?.value||'0.75');
  if(!d.logoUrl) return;

  if(engraveOn){
    const engrC=await prepareEngraveCanvas(d.logoUrl);
    if(!engrC) return;
    const sc=Math.min(box.w/engrC.width, box.h/engrC.height);
    const lw=engrC.width*sc, lh=engrC.height*sc;
    const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
    drawEngraved(ctx, engrC, lx, ly, lw, lh, depth);
  } else {
    if((d.logoBg||'').trim()){ ctx.fillStyle=d.logoBg.trim(); roundRect(ctx, box.x, box.y, box.w, box.h, 12); ctx.fill(); }
    const logo=await loadImg(d.logoUrl);
    const sc=Math.min(box.w/logo.width, box.h/logo.height);
    const lw=logo.width*sc, lh=logo.height*sc;
    const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
    ctx.drawImage(logo, lx, ly, lw, lh);
  }
}

/* === LASERGRAVERT TEKST (midt/venstre, uten ghost ved midt) === */
function drawEngravedText(ctx, lines, startY, spacing=30, depth=0.85, align='center', xAnchor=null){
  const isCenter = (align==='center');
  const x = xAnchor != null ? xAnchor : (isCenter ? Math.round(ctx.canvas.width/2) : Math.round(ctx.canvas.width*0.10));

  // hoved-innbrenning
  ctx.save();
  ctx.globalCompositeOperation='multiply';
  ctx.filter='brightness(0.25) contrast(1.25)';
  ctx.globalAlpha=depth;
  ctx.textAlign = isCenter ? 'center' : 'left';
  let y = startY;
  lines.forEach(([txt, size, weight])=>{
    ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillStyle = '#ffffff';
    ctx.fillText(txt, x, y);
    y += spacing;
  });
  ctx.restore();

  // dybdeskygge – kun for venstrejustert
  if(!isCenter){
    ctx.save();
    ctx.globalCompositeOperation='multiply';
    ctx.filter='blur(1.2px)';
    ctx.globalAlpha=Math.min(0.4, depth*0.5);
    y = startY;
    lines.forEach(([txt, size, weight])=>{
      ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.fillText(txt, x + 1, y + 1);
      y += spacing;
    });
    ctx.restore();
  }
}

/* === RENDER PER SIDE === */
async function renderPhysical(canvas, d, style, side, mode){
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // base
  const base=await loadImg(BASES[style]||BASES.dark);
  const s=Math.max(canvas.width/base.width,canvas.height/base.height);
  const w=base.width*s, h=base.height*s;
  const ox=(canvas.width-w)/2, oy=(canvas.height-h)/2;
  ctx.drawImage(base,ox,oy,w,h);

  // Slidere (størrelse/posisjon)
  const frontPct  = parseFloat(document.getElementById('frontLogoSize')?.value||'64')/100;
  const backPct   = parseFloat(document.getElementById('backSmallLogoSize')?.value||'24')/100;
  const frontXpc  = parseFloat(document.getElementById('frontLogoX')?.value||'50')/100;
  const frontYpc  = parseFloat(document.getElementById('frontLogoY')?.value||'50')/100;
  const backXpc   = parseFloat(document.getElementById('backLogoX')?.value||'50')/100;
  const backYpc   = parseFloat(document.getElementById('backLogoY')?.value||'18')/100;

  const baseSize  = parseFloat(document.getElementById('textBaseSize')?.value||'40');
  const alignSel  = (document.getElementById('textAlign')?.value||'center');
  const textXpc   = parseFloat(document.getElementById('textAnchorX')?.value|| (alignSel==='center'?'50':'10'))/100;
  const textYpc   = parseFloat(document.getElementById('textStartY')?.value||'38')/100;

  // Bokser (logo)
  const frontSize = canvas.height * frontPct;
  const fullLogoBox = {
    x: canvas.width*frontXpc - frontSize/2,
    y: canvas.height*frontYpc - frontSize/2,
    w: frontSize, h: frontSize
  };

  const smallSize = canvas.height * backPct;
  const smallLogoBox = {
    x: canvas.width*backXpc - smallSize/2,
    y: canvas.height*backYpc - smallSize/2,
    w: smallSize, h: smallSize
  };

  // Tekst-område (startY påvirkes av liten logo-variant)
  const textTop = (mode === 'logo-front-text+smalllogo-back')
    ? (smallLogoBox.y + smallLogoBox.h + canvas.height*0.05)
    : canvas.height*textYpc;

  // FRONT
  if(side==='front'){
    await drawLogoBlock(ctx, d, fullLogoBox);
    return;
  }

  // BACK
  if(mode==='logo-both'){
    await drawLogoBlock(ctx, d, fullLogoBox);
    return;
  }
  if(mode==='logo-front-only'){
    return; // blank bakside
  }
  if(mode==='logo-front-text+smalllogo-back' && d.logoUrl){
    await drawLogoBlock(ctx, d, smallLogoBox);
  }

  // Tekststørrelser (relativt til base)
  const nameSize  = Math.round(baseSize * 1.3);
  const titleSize = Math.round(baseSize * 1.0);
  const infoSize  = Math.round(baseSize * 0.85);
  const hintSize  = Math.round(baseSize * 0.65);
  const spacing   = Math.round(baseSize * 0.95);

  // Linjer
  const lines=[];
  if(d.name)  lines.push([d.name, nameSize, '800']);
  if(d.title || d.orgName){
    const t = d.title ? d.title + (d.orgName ? ' · '+d.orgName : '') : d.orgName;
    lines.push([t, titleSize, '700']);
  }
  if(d.phone) lines.push(['Tel: '+d.phone,  infoSize, '600']);
  if(d.email) lines.push(['E-post: '+d.email,infoSize, '600']);
  if(d.site)  lines.push(['Nettside: '+d.site,infoSize, '600']);
  lines.push(['Scan NFC / QR for digitalt kort', hintSize, '600']);

  // Anker X (slider gjelder begge moduser)
  const anchorX = canvas.width*textXpc;
  drawEngravedText(ctx, lines, textTop, spacing, 0.88, alignSel, anchorX);
}

/* === SYNC & RENDER === */
async function updatePreview(){
  const d={
    orgName:(document.getElementById('orgName')?.value||'').trim() || (document.getElementById('orgKey')?.value||'').trim(),
    orgKey:(document.getElementById('orgKey')?.value||'').trim(),
    accent:(document.getElementById('accent')?.value||'').trim() || '#8fd3ff',
    logoUrl:window._uploadedLogoDataUrl || (document.getElementById('logoUrl')?.value||'').trim(),
    logoBg:(document.getElementById('logoBg')?.value||'').trim(),
    name:(document.getElementById('name')?.value||'').trim(),
    title:(document.getElementById('title')?.value||'').trim(),
    phone:(document.getElementById('phone')?.value||'').trim(),
    email:(document.getElementById('email')?.value||'').trim(),
    site:(document.getElementById('site')?.value||'').trim(),
    address:(document.getElementById('address')?.value||'').trim(),
    slug:(document.getElementById('slug')?.value||'').trim(),
    vcfFilename:(document.getElementById('vcfFilename')?.value||'').trim()
  };

  const links=Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr=>({
    label: tr.querySelector('.lbl')?.value.trim()||'',
    url:   tr.querySelector('.lnk')?.value.trim()||'',
    pre:   tr.querySelector('.pre')?.value.trim()||'',
    post:  tr.querySelector('.post')?.value.trim()||''
  })).filter(x=>x.label&&x.url);

  // Digitalt kort
  const frame=document.getElementById('liveFrame');
  if(frame){ const doc=frame.contentDocument||frame.contentWindow.document; doc.open(); doc.write(makeHTML(d,links)); doc.close(); }

  const styleTop =(document.getElementById('cardStyleTop') ?.value||'dark');
  const styleDemo=(document.getElementById('cardStyleDemo')?.value||'dark');
  const mode=(document.getElementById('twoSideMode')?.value||'logo-both');

  // Hero
  await renderPhysical(document.getElementById('frontTop'), d, styleTop, 'front', mode);
  await renderPhysical(document.getElementById('backTop'),  d, styleTop, 'back',  mode);

  // Demo (flyttet opp)
  await renderPhysical(document.getElementById('frontDemo'), d, styleDemo, 'front', mode);
  await renderPhysical(document.getElementById('backDemo'),  d, styleDemo, 'back',  mode);
}

/* === LENKER-TABELL === */
const tbody=document.querySelector('#linksTable tbody');
function addRow(label,url,pre='',post=''){
  const tr=document.createElement('tr');
  tr.innerHTML='<td><input value="'+(label||'')+'" class="lbl" /></td>'
    +'<td><input value="'+(url||'')+'" class="lnk" style="width:100%"/></td>'
    +'<td><textarea class="pre" rows="2" placeholder="Tekst over">'+(pre||'')+'</textarea></td>'
    +'<td><textarea class="post" rows="2" placeholder="Tekst under">'+(post||'')+'</textarea></td>'
    +'<td><button type="button" class="pill remove">Fjern</button></td>';
  tr.querySelector('.remove').addEventListener('click',()=>tr.remove());
  tbody.appendChild(tr);
}
document.getElementById('addLink')?.addEventListener('click', ()=>{
  addRow(
    (document.getElementById('newLabel')?.value||''),
    (document.getElementById('newUrl')  ?.value||''),
    (document.getElementById('newPre')  ?.value||''),
    (document.getElementById('newPost') ?.value||'')
  );
  ['newLabel','newUrl','newPre','newPost'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
});
document.querySelectorAll('.pill[data-label]')?.forEach(btn=>{
  btn.addEventListener('click',()=> addRow(btn.dataset.label, btn.dataset.url));
});

/* === SYNC: stil-velgere === */
function syncStyleSelects(changedId, otherId){
  const changed = document.getElementById(changedId);
  const other   = document.getElementById(otherId);
  if(!changed || !other) return;
  if(other.value !== changed.value){
    other.value = changed.value;
  }
  updatePreview();
}
document.getElementById('cardStyleTop') ?.addEventListener('change', ()=> syncStyleSelects('cardStyleTop','cardStyleDemo'));
document.getElementById('cardStyleDemo')?.addEventListener('change', ()=> syncStyleSelects('cardStyleDemo','cardStyleTop'));

/* === EVENTS === */
document.getElementById('updatePreview')?.addEventListener('click', updatePreview);
['orgName','orgKey','accent','logoUrl','logoBg','name','title','phone','email','site','address','slug','vcfFilename']
  .forEach(id=>document.getElementById(id)?.addEventListener('input',()=>{ if(id==='logoUrl'||id==='logoBg') previewLogo(); updatePreview(); }));

[
 'engraveMode','engraveDepth','autoRemoveBg','bgThreshold',
 'twoSideMode',
 'frontLogoSize','frontLogoX','frontLogoY',
 'backSmallLogoSize','backLogoX','backLogoY',
 'textAlign','textBaseSize','textAnchorX','textStartY'
].forEach(id=>document.getElementById(id)?.addEventListener('input',()=>{
  const get = id=>document.getElementById(id);
  const set=(id,suf)=>{const el=get(id); const out=document.getElementById(id+'Val'); if(out && el){ out.textContent = el.value + (suf||''); }};
  set('bgThreshold','');
  set('frontLogoSize','%'); set('backSmallLogoSize','%'); set('textBaseSize',' px');
  set('frontLogoX','%'); set('frontLogoY','%');
  set('backLogoX','%');  set('backLogoY','%');
  set('textAnchorX','%'); set('textStartY','%');
  updatePreview();
}));

// Nedlasting
function dlCanvasAsPNG(cnv, name){ const a=document.createElement('a'); a.href=cnv.toDataURL('image/png'); a.download=name; a.click(); }
document.getElementById('downloadFront')?.addEventListener('click', ()=> dlCanvasAsPNG(document.getElementById('frontDemo'), 'kort-forside.png'));
document.getElementById('downloadBack') ?.addEventListener('click', ()=> dlCanvasAsPNG(document.getElementById('backDemo'),  'kort-bakside.png'));
document.getElementById('downloadFrontTop')?.addEventListener('click', ()=> dlCanvasAsPNG(document.getElementById('frontTop'), 'kort-forside.png'));
document.getElementById('downloadBackTop') ?.addEventListener('click', ()=> dlCanvasAsPNG(document.getElementById('backTop'),  'kort-bakside.png'));

/* === INIT === */
addRow('LinkedIn','https://www.linkedin.com/in/','Følg meg','Oppdateres jevnlig');
previewLogo();
// initial sync av stil-velgere:
syncStyleSelects('cardStyleTop','cardStyleDemo');
</script>

</body>
</html>
