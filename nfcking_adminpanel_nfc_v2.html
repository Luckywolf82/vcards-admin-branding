<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFCKING – Adminpanel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    body{background:#0b0b10;color:#e9eef5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#21c36a;font-weight:700}
    .err{color:#ff6b6b;font-weight:700}
    .note{font-size:.95rem;color:#8ea0b4}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:1px solid #344458}
    .links-table{width:100%;border-collapse:collapse}
    .links-table th,.links-table td{border-bottom:1px solid #2a3442;padding:.3rem;vertical-align:top}
    .muted{color:#8ea0b4}
    code{background:#0d1117;color:#d1e7ff;padding:.2em .4em;border-radius:6px}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .logo-prev{height:36px;max-width:220px;object-fit:contain;margin-left:8px;background:#fff;border-radius:6px;padding:4px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a}
    .url-actions{margin-left:6px}
    .brand{text-align:center;margin:0 0 18px}
    .brand img{max-width:240px;height:auto;filter:drop-shadow(0 0 6px #3fffd2)}
    .brand-sub{margin:6px 0 0;color:#8ea0b4}
    .brand-rule{border:0;height:2px;background:linear-gradient(90deg,#8fd3ff,#52a3ff);opacity:.7;margin:10px 0 16px}
    #nfcLog{background:#0d1117;color:#cfe3ff;padding:10px;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto;margin-top:10px}
  </style>
</head>

<body>
<main>
  <!-- Topp-logo med robust fallback -->
  <div class="brand">
    <img
      src="/assets/NFCKING_dark.png?v=4"
      alt="NFCKING logo"
      onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
    <p class="brand-sub">Kongen av kontaktløs – bygg, merk og publiser NFC-kort</p>
  </div>
  <hr class="brand-rule">

  <!-- Organisasjonsprofiler + ansatte-lister -->
  <script>
  const ORG_PROFILES = {
    "Wayback": {
      name: "Wayback",
      accent: "#8fd3ff",
      logo: "https://www.wayback.no/wp-content/uploads/2017/12/logo.png",
      site: "https://wayback.no",
      logoBg: "#ffffff"
    },
    "MollerBil": {
      name: "Møller Bil",
      accent: "#002244",
      logo: "",
      site: "https://www.mollerbil.no"
    },
    "JarwsonsKjokken": {
      name: "Jarwsons kjøkken",
      accent: "#ee5500",
      logo: "",
      site: "https://jarwsons.no"
    }
  };

  // Eksempel-ansatte pr org – utvid fritt
  const EMPLOYEES = {
    "Wayback": [
      { slug:"Trygve", name:"Trygve Eiulf Waagen", title:"Avdelingsleder", phone:"+47 47731087", email:"trygve@wayback.no", site:"https://wayback.no", address:"Kongens gate 46, 7012 Trondheim, Norge", vcfFilename:"trygve_wayback.vcf" }
    ],
    "MollerBil": [],
    "JarwsonsKjokken": []
  };
  </script>

  <!-- Organisasjon -->
  <h2>Organisasjon</h2>
  <div class="row">
    <label>Velg organisasjon
      <select id="orgSelect"></select>
    </label>

    <div class="inline">
      <label style="flex:1">Org key (mappe – case sensitive)
        <input id="orgKey" placeholder="Wayback" required oninput="applyBranding('force'); syncOrgSelectFromKey(); loadEmployees();">
      </label>
      <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
        <img id="logoPreview" class="logo-prev" alt="logo">
      </div>
    </div>

    <label>Org navn (visning)
      <input id="orgName" placeholder="Wayback">
    </label>
    <label>Accent farge (hex)
      <input id="accent" placeholder="#8fd3ff">
    </label>
    <label>Org nettside
      <input id="orgSite" placeholder="https://wayback.no">
    </label>

    <label>Logo URL (eller last opp)
      <div style="display:flex;gap:6px;align-items:center">
        <input id="logoUrl" placeholder="https://.../logo.png" oninput="previewLogo()" style="flex:1">
        <input type="file" id="logoFile" accept="image/*" onchange="handleLogoUpload(event)">
      </div>
    </label>

    <label>Logo bakgrunn
      <input id="logoBg" placeholder="#ffffff (tom = auto)">
    </label>
  </div>

  <!-- Person -->
  <h2>Person</h2>
  <div class="row">
    <label>Velg ansatt
      <select id="employeeSelect"><option value="">(Velg ansatt…)</option></select>
    </label>
    <div></div>

    <label>Slug (mappe/URL uten æøå/mellomrom)
      <input id="slug" placeholder="Trygve" required>
    </label>
    <label>Navn
      <input id="name" placeholder="Trygve Eiulf Waagen" required>
    </label>
    <label>Tittel
      <input id="title" placeholder="Avdelingsleder">
    </label>
    <label>Telefon (E.164)
      <input id="phone" placeholder="+47 47731087">
    </label>
    <label>E-post
      <input id="email" placeholder="trygve@wayback.no">
    </label>
    <label>Nettside
      <input id="site" placeholder="https://wayback.no">
    </label>
    <label>Adresse
      <input id="address" placeholder="Kongens gate 46, 7012 Trondheim, Norge">
    </label>
    <label>VCF-filnavn
      <input id="vcfFilename" placeholder="trygve_wayback.vcf">
    </label>
  </div>

  <!-- Lenker -->
  <h2>Lenker og tekster</h2>
  <div class="row">
    <label>Forhåndsvalg (klikk for å legge til)</label>
    <div>
      <button type="button" class="pill" data-label="LinkedIn"  data-url="https://www.linkedin.com/in/">LinkedIn</button>
      <button type="button" class="pill" data-label="Instagram" data-url="https://instagram.com/">Instagram</button>
      <button type="button" class="pill" data-label="Facebook"  data-url="https://facebook.com/">Facebook</button>
      <button type="button" class="pill" data-label="YouTube"   data-url="https://youtube.com/@">YouTube</button>
      <button type="button" class="pill" data-label="TikTok"    data-url="https://www.tiktok.com/@">TikTok</button>
      <button type="button" class="pill" data-label="GitHub"    data-url="https://github.com/">GitHub</button>
      <button type="button" class="pill" data-label="Nettside"  data-url="https://">Nettside</button>
      <button type="button" class="pill" data-label="Kalender"  data-url="https://cal.com/">Kalender</button>
      <button type="button" class="pill" data-label="WhatsApp"  data-url="https://wa.me/">WhatsApp</button>
    </div>
  </div>

  <table class="links-table" id="linksTable">
    <thead>
      <tr>
        <th>Label</th>
        <th>URL</th>
        <th>Tekst over</th>
        <th>Tekst under</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="row">
    <label>Ny label
      <input id="newLabel" placeholder="LinkedIn">
    </label>
    <label>Ny URL
      <input id="newUrl" placeholder="https://linkedin.com/in/...">
    </label>
    <label>Tekst over
      <input id="newPre" placeholder="Følg meg på LinkedIn">
    </label>
    <label>Tekst under
      <input id="newPost" placeholder="@brukernavn (daglig oppdatert)">
    </label>
    <div><button type="button" id="addLink">Legg til</button></div>
  </div>

  <!-- Publisering -->
  <h2>Publisering</h2>
  <div class="row">
    <label>GitHub owner
      <input id="ghUser" placeholder="Luckywolf82">
    </label>
    <label>Repo-navn
      <input id="ghRepo" placeholder="Vcards">
    </label>
    <label>BASE_PATH
      <input id="basePath" placeholder="Vcards" value="Vcards">
    </label>
    <label>Commit-strategi
      <select id="strategy">
        <option value="pr">Branch + Pull Request</option>
        <option value="direct">Direkte til main</option>
      </select>
    </label>
  </div>

  <button id="generate">Generer & Publiser</button>
  <span id="status"></span>

  <!-- Resultat -->
  <h3>Resultat</h3>
  <p>NFC-URL: <input id="nfcUrl" style="width:100%" readonly></p>
  <p>HTML-URL: <input id="htmlUrl" style="width:100%" readonly></p>

  <!-- NFC-kontroller -->
  <h3>NFC</h3>
  <p class="note">
    Web NFC krever Android + Chrome/Edge og HTTPS. iOS støttes ikke i nettleser.
  </p>
  <div class="row">
    <div><button type="button" id="nfcRead" class="btn">Les fra NFC</button></div>
    <div><button type="button" id="nfcWriteUrl" class="btn">Skriv URL (fra feltet over)</button></div>
    <div><button type="button" id="nfcWriteVcf" class="btn">Skriv vCard (NDEF)</button></div>
    <div><button type="button" id="nfcWipe" class="btn">Overskriv med blank</button></div>
    <div><button type="button" id="nfcLock" class="btn">Gjør skrivebeskytta</button></div>
  </div>
  <pre id="nfcLog"></pre>
  <div style="margin-top:6px">
    <button type="button" id="nfcOpenLastUrl" class="btn">Åpne sist leste URL</button>
    <span id="nfcLastUrl" class="muted" style="margin-left:8px"></span>
  </div>

  <!-- vCard / HTML forhåndsvisning -->
  <h4>vCard</h4>
  <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

  <h4>index.html</h4>
  <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>

  <!-- Live forhåndsvisning -->
  <div id="livePreviewContainer" style="margin-top:10px;">
    <h4>Live forhåndsvisning</h4>
    <button id="openPreviewBtn" style="margin:6px 0;">Åpne forhåndsvisning i ny fane</button>
    <iframe id="livePreviewFrame" style="width:100%;height:480px;border:1px solid #333;border-radius:8px;background:#111;" title="Live Preview"></iframe>
  </div>

  <!-- Logo-opplasting til GitHub (Netlify function) -->
  <script>
  async function handleLogoUpload(evt){
    const file = evt.target.files?.[0];
    if(!file){ return; }

    const orgKey  = (document.getElementById('orgKey').value || '').trim() || 'Common';
    const ghUser  = (document.getElementById('ghUser').value || '').trim();
    const ghRepo  = (document.getElementById('ghRepo').value || '').trim();
    const basePath= (document.getElementById('basePath').value || 'Vcards').trim();

    const arrBuf  = await file.arrayBuffer();
    const base64  = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));

    const cleanOrg= orgKey.replace(/[^A-Za-z0-9_-]/g, '');
    const ts      = Date.now();
    const ext     = (file.name.split('.').pop() || 'png').toLowerCase().replace(/[^a-z0-9]/g,'') || 'png';
    const safeName= `${cleanOrg}_logo_${ts}.${ext}`;

    const res = await fetch('/api/uploadLogo', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body:JSON.stringify({
        repoOwner: ghUser || undefined,
        repoName:  ghRepo || undefined,
        basePath,
        orgKey:    cleanOrg,
        filename:  safeName,
        contentBase64: base64
      })
    });

    const out = await res.json().catch(()=> ({}));
    if(!res.ok || !out.url){
      console.error('Upload error:', out);
      alert('Kunne ikke laste opp logo. Sjekk Netlify-logs.');
      return;
    }

    // Bruk Pages-URL, fallback til RAW om nødvendig, og cache-bust
    let finalUrl = out.url;
    if (!finalUrl.includes('.github.io')) {
      finalUrl = `https://raw.githubusercontent.com/${ghUser}/${ghRepo}/main/${basePath}/assets/${cleanOrg}/${safeName}`;
    }

    const urlInput = document.getElementById('logoUrl');
    urlInput.value = finalUrl + '?v=' + Date.now();
    previewLogo();
  }
  </script>

  <script>
  // === Dropdowns: Organisasjon & Ansatt ===
  function populateOrgSelect(){
    const orgSelect = document.getElementById('orgSelect');
    if (!orgSelect) return;

    orgSelect.innerHTML = '';
    const keys = Object.keys(ORG_PROFILES || {});
    keys.forEach(key=>{
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = (ORG_PROFILES[key] && ORG_PROFILES[key].name) || key;
      orgSelect.appendChild(opt);
    });
  }

  function syncOrgKeyFromSelect(){
    const orgSelect = document.getElementById('orgSelect');
    if (!orgSelect) return;
    const key = orgSelect.value;
    document.getElementById('orgKey').value = key;
    applyBranding('force');
    loadEmployees();
  }

  function syncOrgSelectFromKey(){
    const key = document.getElementById('orgKey').value.trim();
    const orgSelect = document.getElementById('orgSelect');
    if (!orgSelect) return;
    const idx = Array.from(orgSelect.options).findIndex(o => o.value === key);
    if (idx >= 0) orgSelect.selectedIndex = idx;
  }

  function loadEmployees(){
    const key = document.getElementById('orgKey').value.trim();
    const list = (EMPLOYEES && EMPLOYEES[key]) || [];
    const sel = document.getElementById('employeeSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">(Velg ansatt…)</option>';
    list.forEach((emp, i)=>{
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = emp.name + (emp.title ? ' – ' + emp.title : '');
      sel.appendChild(opt);
    });
  }

  function fillEmployee(iStr){
    const key = document.getElementById('orgKey').value.trim();
    const list = (EMPLOYEES && EMPLOYEES[key]) || [];
    const i = parseInt(iStr, 10);
    const emp = list[i];
    if (!emp) return;

    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    set('slug', emp.slug);
    set('name', emp.name);
    set('title', emp.title);
    set('phone', emp.phone);
    set('email', emp.email);
    set('site', emp.site);
    set('address', emp.address);
    set('vcfFilename', emp.vcfFilename);
  }

  // Init dropdowns på load
  document.addEventListener('DOMContentLoaded', ()=>{
    try {
      populateOrgSelect();
      const orgSelect = document.getElementById('orgSelect');
      const orgKeyEl  = document.getElementById('orgKey');

      if (orgSelect && orgSelect.options.length > 0) {
        if (!orgKeyEl.value) {
          orgSelect.selectedIndex = 0;
          syncOrgKeyFromSelect();
        } else {
          syncOrgSelectFromKey();
          applyBranding('auto');
          loadEmployees();
        }
      }
      orgSelect?.addEventListener('change', syncOrgKeyFromSelect);
      document.getElementById('employeeSelect')?.addEventListener('change', (e)=> fillEmployee(e.target.value));
    } catch (e) {
      console.error('Init-feil for dropdowns:', e);
    }
  });

  // === Lenketabell ===
  const tbody = document.querySelector('#linksTable tbody');

  function addRow(label, url, pre = '', post = '') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${label || ''}" class="lbl" /></td>
      <td><input value="${url || ''}" class="lnk" style="width:100%"/></td>
      <td><textarea class="pre" rows="2" placeholder="Tekst over">${pre || ''}</textarea></td>
      <td><textarea class="post" rows="2" placeholder="Tekst under">${post || ''}</textarea></td>
      <td><button type="button" class="remove">Fjern</button></td>
    `;
    tr.querySelector('.remove').addEventListener('click', () => tr.remove());
    tbody.appendChild(tr);
  }

  document.getElementById('addLink').addEventListener('click', () => {
    addRow(
      document.getElementById('newLabel').value,
      document.getElementById('newUrl').value,
      document.getElementById('newPre').value,
      document.getElementById('newPost').value
    );
    ['newLabel','newUrl','newPre','newPost'].forEach(id => document.getElementById(id).value = '');
  });

  document.querySelectorAll('.pill').forEach(btn => {
    btn.addEventListener('click', () => addRow(btn.dataset.label, btn.dataset.url));
  });

  // === Branding & logo-preview ===
  function applyBranding(mode = 'auto'){
    const key  = document.getElementById('orgKey').value.trim();
    const prof = ORG_PROFILES[key];
    if (!prof) return;

    const set = (id, val) => {
      const el = document.getElementById(id);
      if (!el) return;
      if (mode === 'force' || !el.value) el.value = val || '';
    };

    set('orgName', prof.name || key);
    set('accent' , prof.accent || '#8fd3ff');
    set('orgSite', prof.site || '');
    set('logoUrl', prof.logo || '');
    set('logoBg' , prof.logoBg || '');

    previewLogo();
  }

  function previewLogo(){
    const url = document.getElementById('logoUrl').value.trim();
    const imgEl = document.getElementById('logoPreview');
    const bgInput = document.getElementById('logoBg');
    const manual = (bgInput?.value || '').trim();

    if(!url){
      imgEl.style.display='none';
      return;
    }

    imgEl.src = url;
    imgEl.style.display='block';
    imgEl.style.borderRadius = '8px';
    imgEl.style.padding = '6px';

    if (manual) {
      imgEl.style.background = manual;
      return;
    }

    let chosenBg = '#ffffff';
    imgEl.style.background = chosenBg;

    const tmp = new Image();
    tmp.crossOrigin = 'anonymous';
    tmp.src = url;

    const finish = (bg) => {
      chosenBg = bg || chosenBg;
      imgEl.style.background = chosenBg;
      if (bgInput && !bgInput.value) bgInput.value = chosenBg;
    };

    const analyze = () => {
      try {
        const c = document.createElement('canvas');
        const s = 24;
        c.width = s; c.height = s;
        const ctx = c.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(tmp, 0, 0, s, s);
        const data = ctx.getImageData(0,0,s,s).data;

        let r=0,g=0,b=0,n=0;
        for(let i=0;i<data.length;i+=4){
          const a = data[i+3];
          if (a < 16) continue;
          r += data[i]; g += data[i+1]; b += data[i+2]; n++;
        }
        if (n === 0) { finish('#ffffff'); return; }
        r = Math.round(r/n); g = Math.round(g/n); b = Math.round(b/n);
        const L = 0.2126*r + 0.7152*g + 0.0722*b;
        const autoBg = (L < 150) ? '#ffffff' : '#1e1f28';
        finish(autoBg);
      } catch (e) {
        finish('#ffffff');
      }
    };

    tmp.onload = analyze;
    tmp.onerror = () => finish('#ffffff');
    setTimeout(() => { if (!bgInput.value) finish('#ffffff'); }, 1500);
  }

  // === vCard + HTML generator ===
  function normalizePhone(p){
    p = (p||'').trim(); if(!p) return p;
    if(p.startsWith('0') && !p.startsWith('+')){
      if(p.length <= 8) return '+47' + p.replace(/^0+/, '');
    }
    return p;
  }

  function makeVcard(d){
    const parts = d.name.trim().split(' ');
    const first = parts[0] || '';
    const last  = parts.length>1 ? parts[parts.length-1] : '';
    const phone = normalizePhone(d.phone||'');

    return [
      'BEGIN:VCARD',
      'VERSION:3.0',
      `FN:${d.name}`,
      `N:${last};${first};;;`,
      `ORG:${d.orgName||d.orgKey}`,
      `TITLE:${d.title||''}`,
      `TEL;TYPE=CELL:${phone}`,
      `EMAIL;TYPE=INTERNET:${d.email||''}`,
      `URL:${d.site||''}`,
      `ADR;TYPE=WORK:;;${d.address||''}`,
      'END:VCARD'
    ].join('\n');
  }

  function esc(s){ return (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  function makeLinksHTML(links){
    if(!links.length) return '';
    return links.map(l => {
      const pre  = l.pre  ? `<div class="pre"  style="margin:8px 0 4px;color:#bfc8d6">${esc(l.pre)}</div>` : '';
      const post = l.post ? `<div class="post" style="margin:4px 0 10px;color:#97a3b6;font-size:.95rem">${esc(l.post)}</div>` : '';
      return `<div class="link-block" style="margin-top:10px">
        ${pre}
        <a class="btn" href="${esc(l.url)}" target="_blank" rel="noopener">${esc(l.label)}</a>
        ${post}
      </div>`;
    }).join('');
  }

  function makeHTML(d, vcfFile, links){
    const accent  = d.accent || '#8fd3ff';
    const bgStyle = `background:${d.logoBg || '#ffffff'};border-radius:8px;padding:6px;`;
    const logoTag = d.logoUrl ? `<img class="brand-logo" src="${d.logoUrl}" style="${bgStyle}" alt="${esc(d.orgName||d.orgKey)} logo">` : '';
    const extras  = makeLinksHTML(links);

    return `<!doctype html>
<html lang="no">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kontaktkort – ${esc(d.name)}</title>
<style>
:root{--accent:${accent};}
body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}
.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}
.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}
.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.card p{color:#bfc8d6}
code{background:#0d1117;padding:.2em .4em;border-radius:6px}
.brand-logo{max-height:56px;max-width:280px;object-fit:contain;margin:0 0 12px 0;display:block}
</style>
</head>
<body>
<main class="container card">
  ${logoTag}
  <h1>Kontaktkort – ${esc(d.name)}</h1>
  <p class="muted">${esc(d.title||'')} · ${esc(d.orgName||d.orgKey)}</p>
  <p><a class="btn" href="./${vcfFile}" download>Last ned vCard (.vcf)</a></p>
  <div class="links">
    <a href="tel:${esc(d.phone||'')}" class="btn">Ring</a>
    <a href="mailto:${esc(d.email||'')}" class="btn">E-post</a>
    <a href="${esc(d.site||'#')}" class="btn" target="_blank">Besøk nettside</a>
    <a href="../index.html" class="btn">← Tilbake</a>
  </div>
  ${extras}
  <p style="margin-top:14px">Adresse: ${esc(d.address||'')}</p>
  <p style="margin-top:8px;font-size:0.9rem;color:#9aa6b2">NFC-URL: <code id="nfcInline"></code></p>
</main>
</body>
</html>`;
  }

  // === Netlify helper ===
  async function postJSON(url, data){
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
    const t = await r.text();
    try { return { ok:r.ok, status:r.status, json:JSON.parse(t) }; }
    catch { return { ok:r.ok, status:r.status, text:t }; }
  }

  // Små UI-hjelpere: kopier/åpne-knapper ved URL-felt
  function ensureUrlControls(id, label) {
    const input = document.getElementById(id);
    if (!input) return;
    if (input.nextSibling?.classList?.contains('url-actions')) return;

    const wrap = document.createElement('span');
    wrap.className = 'url-actions';
    wrap.innerHTML = `
      <button type="button" class="pill" data-act="copy">Kopier ${label}</button>
      <button type="button" class="pill" data-act="open">Åpne</button>
    `;
    input.after(wrap);

    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const val = input.value.trim();
      if(!val) return;
      if(act === 'copy') navigator.clipboard.writeText(val);
      if(act === 'open') window.open(val, '_blank', 'noopener');
    });
  }

  // === Generer & Publiser ===
  document.getElementById('generate').addEventListener('click', async ()=>{
    const get = id => document.getElementById(id).value.trim();
    const d = {
      orgKey:get('orgKey'),
      orgName:get('orgName')||get('orgKey'),
      accent:get('accent')||'#8fd3ff',
      logoUrl:get('logoUrl'),
      logoBg:get('logoBg') || '',
      slug:get('slug'),
      name:get('name'),
      title:get('title'),
      phone:get('phone'),
      email:get('email'),
      site:get('site'),
      address:get('address'),
      vcfFilename:get('vcfFilename') || (get('slug') + '_' + get('orgKey') + '.vcf'),
      ghUser:get('ghUser'),
      ghRepo:get('ghRepo'),
      basePath:get('basePath')||'Vcards',
      strategy:document.getElementById('strategy').value
    };

    if(!d.orgKey || !d.slug || !d.name){
      alert('Mangler: orgKey, slug, name');
      return;
    }

    const links = Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr=>({
      label: tr.querySelector('.lbl').value.trim(),
      url:   tr.querySelector('.lnk').value.trim(),
      pre:   tr.querySelector('.pre').value.trim(),
      post:  tr.querySelector('.post').value.trim()
    })).filter(x=>x.label && x.url);

    const vcf  = makeVcard(d);
    const html = makeHTML(d, d.vcfFilename, links);
    document.getElementById('vcfPreview').value  = vcf;
    document.getElementById('htmlPreview').value = html;
    updateLivePreview(html);

    const ownerPart = d.ghUser || '<owner>';
    const repoPart  = d.ghRepo || '<repo>';
    const basePath  = (d.basePath || 'Vcards').replace(/^\/+|\/+$/g, '');
    const pathPart  = basePath ? `/${basePath}` : '';

    const baseUrl = `https://${ownerPart}.github.io/${repoPart}${pathPart}/${d.orgKey}/${d.slug}`;
    const htmlUrl = `${baseUrl}/index.html`;
    const vcfUrl  = `${baseUrl}/${d.vcfFilename}`;

    document.getElementById('nfcUrl').value  = vcfUrl;
    document.getElementById('htmlUrl').value = htmlUrl;
    ensureUrlControls('nfcUrl','NFC-URL');
    ensureUrlControls('htmlUrl','HTML-URL');

    const inline = document.getElementById('nfcInline');
    if (inline) inline.textContent = vcfUrl;

    document.getElementById('status').textContent = 'Publiserer…';

    const prefix = d.basePath ? (d.basePath.replace(/^\/+|\/+$/g,'') + '/') : '';
    const payload = {
      repoOwner: d.ghUser || undefined,
      repoName:  d.ghRepo || undefined,
      basePath:  d.basePath,
      orgKey:    d.orgKey,
      slug:      d.slug,
      files: [
        { path: `${prefix}${d.orgKey}/${d.slug}/${d.vcfFilename}`, content: vcf  },
        { path: `${prefix}${d.orgKey}/${d.slug}/index.html`,       content: html },
        { path: `${prefix}${d.orgKey}/${d.slug}/data.json`,        content: JSON.stringify({ ...d, links }, null, 2) },
        { path: `${prefix}.nojekyll`,                              content: ""   }
      ],
      strategy: d.strategy,
      commitMessage: `Add/Update card: ${d.orgKey}/${d.slug}`
    };

    try{
      const res = await postJSON('/api/createCard', payload);
      if(res.ok){
        document.getElementById('status').innerHTML =
          '<span class="ok">✅ Ferdig! Åpne HTML-URL-en i nettleser (gi Pages et lite minutt).</span>';
      } else {
        const msg = res.json && res.json.error ? res.json.error : (res.text || 'Ukjent feil');
        document.getElementById('status').innerHTML = '<span class="err">❌ Feil: '+msg+'</span>';
      }
    }catch(e){
      document.getElementById('status').innerHTML = '<span class="err">❌ Nettverksfeil: '+e.message+'</span>';
    }
  });

  // === Live preview helpers ===
  function updateLivePreview(html) {
    const frame = document.getElementById('livePreviewFrame');
    if (!frame) return;
    const doc = frame.contentDocument || frame.contentWindow.document;
    doc.open(); doc.write(html); doc.close();
  }
  function openPreviewInNewTab(html) {
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
    setTimeout(() => URL.revokeObjectURL(url), 60_000);
  }
  document.getElementById('openPreviewBtn')?.addEventListener('click', ()=>{
    const html = document.getElementById('htmlPreview').value;
    openPreviewInNewTab(html);
  });

  // === Auto-init ved lasting ===
  document.addEventListener('DOMContentLoaded', () => {
    try {
      populateOrgSelect();
      const orgSelect = document.getElementById('orgSelect');
      const orgKeyEl  = document.getElementById('orgKey');

      if (orgSelect && orgSelect.options.length > 0) {
        if (!orgKeyEl.value) {
          orgSelect.selectedIndex = 0;
          syncOrgKeyFromSelect();
        } else {
          syncOrgSelectFromKey();
          applyBranding('auto');
          loadEmployees();
        }
      }
    } catch (e) {
      console.error('Init-feil for dropdowns:', e);
    }

    const lu = document.getElementById('logoUrl')?.value.trim();
    if (lu) previewLogo();
  });
  </script>

  <!-- Web NFC – les/skriv/overskriv/lås (robust) -->
  <script>
  let __lastReadUrl = "";

  function nfcLog(msg){
    const el = document.getElementById('nfcLog');
    if(!el) return;
    const t = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    el.textContent = t + el.textContent;
  }

  function setLastUrl(u){
    __lastReadUrl = u || "";
    const lab = document.getElementById('nfcLastUrl');
    if (lab) lab.textContent = u ? `(${u})` : '';
  }

  function checkWebNfc(){
    if (!('NDEFReader' in window)) {
      nfcLog('🚫 Web NFC ikke støttet (krever Android + Chrome/Edge + HTTPS).');
      return false;
    }
    return true;
  }

  function dataToString(record){
    if (typeof record.data === 'string') return record.data;
    if (record.data && typeof record.data === 'object' && 'buffer' in record.data){
      try{
        const bytes = new Uint8Array(record.data.buffer);
        const enc = record.encoding || 'utf-8';
        return new TextDecoder(enc).decode(bytes);
      }catch(e){
        return '';
      }
    }
    return '';
  }

  async function nfcRead(){
    if(!checkWebNfc()) return;
    try{
      const reader = new NDEFReader();
      await reader.scan();
      nfcLog('📡 Hold tag inntil telefonen …');
      reader.onreadingerror = () => nfcLog('⚠️ Lese-feil. Prøv igjen og hold rolig mot antenne.');
      reader.onreading = (event) => {
        const { serialNumber, message } = event;
        nfcLog(`✅ Lest tag (serial: ${serialNumber || 'ukjent'})`);
        let foundUrl = "";
        for(const record of message.records){
          try{
            if(record.recordType === 'url'){
              const url = dataToString(record);
              nfcLog(`• URL: ${url}`);
              if (url) foundUrl = url;
            } else if(record.recordType === 'text'){
              const txt = dataToString(record);
              nfcLog(`• Tekst: ${txt}`);
            } else if(record.recordType === 'mime'){
              const mimeType = record.mediaType || 'ukjent';
              const bytes = record.data && record.data.buffer ? new Uint8Array(record.data.buffer) : null;
              nfcLog(`• MIME: ${mimeType} (${bytes ? bytes.byteLength : 0} bytes)`);
            } else {
              nfcLog(`• Record: ${record.recordType} (${record.mediaType||'n/a'})`);
            }
          }catch(e){
            nfcLog(`• (klarte ikke parse record: ${e.message})`);
          }
        }
        if (foundUrl){ setLastUrl(foundUrl); }
      };
    }catch(e){
      nfcLog(`❌ Kunne ikke starte lesing: ${e.message}`);
    }
  }

  async function nfcWriteUrl(){
    if(!checkWebNfc()) return;
    let url = (document.getElementById('htmlUrl')?.value || '').trim();
    if(!url){
      url = (document.getElementById('nfcUrl')?.value || '').trim();
      if(url) nfcLog('ℹ️ Fant ikke HTML-URL, skriver NFC-URL (VCF) i stedet.');
    }
    if(!url){ nfcLog('⚠️ Tom URL. Generer først.'); return; }
    try{
      const ndef = new NDEFReader();
      await ndef.write({ records: [{ recordType: 'url', data: url }] });
      nfcLog(`✅ Skrev URL til tag: ${url}`);
    }catch(e){
      nfcLog(`❌ Skrivefeil (URL): ${e.message}`);
    }
  }

  function buildVcardFromUI(){
    const get = id => (document.getElementById(id)?.value || '').trim();
    const parts = (get('name')||'').split(' ');
    const first = parts[0] || '';
    const last  = parts.length>1 ? parts[parts.length-1] : '';
    const phone = get('phone');
    return [
      'BEGIN:VCARD',
      'VERSION:3.0',
      `FN:${get('name')}`,
      `N:${last};${first};;;`,
      `ORG:${get('orgName')||get('orgKey')}`,
      `TITLE:${get('title')||''}`,
      `TEL;TYPE=CELL:${phone}`,
      `EMAIL;TYPE=INTERNET:${get('email')||''}`,
      `URL:${get('site')||''}`,
      `ADR;TYPE=WORK:;;${get('address')||''}`,
      'END:VCARD'
    ].join('\n');
  }

  async function nfcWriteVcf(){
    if(!checkWebNfc()) return;
    const vcf = buildVcardFromUI();
    if(!vcf){ nfcLog('⚠️ vCard tomt. Fyll ut feltene.'); return; }
    try{
      const bytes = new TextEncoder().encode(vcf);
      const ndef = new NDEFReader();
      await ndef.write({
        records: [{
          recordType: 'mime',
          mediaType: 'text/x-vcard',
          data: bytes
        }]
      });
      nfcLog('✅ Skrev vCard som MIME (text/x-vcard).');
    }catch(e){
      nfcLog(`❌ Skrivefeil (vCard): ${e.message}`);
    }
  }

  async function nfcWipe(){
    if(!checkWebNfc()) return;
    try{
      const ndef = new NDEFReader();
      await ndef.write({ records: [{ recordType:'text', data:'' }] });
      nfcLog('✅ Overskrev tag med tom tekst (praktisk sletting).');
    }catch(e){
      nfcLog(`❌ Feil ved overskriving: ${e.message}`);
    }
  }

  async function nfcLock(){
    if(!checkWebNfc()) return;
    if(!confirm('Dette kan være permanent. Er du sikker på at du vil skrivebeskytte taggen?')) return;
    try{
      const ndef = new NDEFReader();
      await ndef.makeReadOnly();
      nfcLog('🔒 Tag forsøkt gjort skrivebeskytta (avhenger av støtte).');
    }catch(e){
      nfcLog(`❌ Kunne ikke låse: ${e.message}`);
    }
  }

  document.getElementById('nfcRead')?.addEventListener('click', nfcRead);
  document.getElementById('nfcWriteUrl')?.addEventListener('click', nfcWriteUrl);
  document.getElementById('nfcWriteVcf')?.addEventListener('click', nfcWriteVcf);
  document.getElementById('nfcWipe')?.addEventListener('click', nfcWipe);
  document.getElementById('nfcLock')?.addEventListener('click', nfcLock);
  document.getElementById('nfcOpenLastUrl')?.addEventListener('click', ()=> {
    if (__lastReadUrl) window.open(__lastReadUrl, '_blank', 'noopener');
    else nfcLog('Ingen URL lest enda.');
  });
  </script>
</main>
</body>
</html>
