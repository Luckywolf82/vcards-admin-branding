<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFCKING ‚Äì Adminpanel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    body{background:#0b0b10;color:#e9eef5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#21c36a;font-weight:700}
    .err{color:#ff6b6b;font-weight:700}
    .note{font-size:.95rem;color:#8ea0b4}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:1px solid #344458}
    .links-table{width:100%;border-collapse:collapse}
    .links-table th,.links-table td{border-bottom:1px solid #2a3442;padding:.3rem;vertical-align:top}
    .muted{color:#8ea0b4}
    code{background:#0d1117;color:#d1e7ff;padding:.2em .4em;border-radius:6px}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .logo-prev{height:36px;max-width:220px;object-fit:contain;margin-left:8px;background:#fff;border-radius:6px;padding:4px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a}
    .url-actions{margin-left:6px}
    .brand{text-align:center;margin:0 0 18px}
    .brand img{max-width:240px;height:auto;filter:drop-shadow(0 0 6px #3fffd2)}
    .brand-sub{margin:6px 0 0;color:#8ea0b4}
    .brand-rule{border:0;height:2px;background:linear-gradient(90deg,#8fd3ff,#52a3ff);opacity:.7;margin:10px 0 16px}
    #nfcLog{background:#0d1117;color:#cfe3ff;padding:10px;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto;margin-top:10px}
    .hide{display:none}
    .card{max-width:1100px;margin:0 auto}
    .banner{background:#0f141a;border:1px solid #283246;padding:12px;border-radius:10px}
    .banner h3{margin:0 0 6px}
    .banner ul{margin:8px 0 0 18px}
    .banner .actions{display:flex;gap:8px;align-items:center}
    .file-list small{color:#8ea0b4}
    .kicker{font-size:.83rem;color:#9fb3c8;margin:0 0 8px}
    .mini{font-size:.85rem}
    .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    /* --- Kontrastfix p√• m√∏rk bakgrunn --- */
    input, select, textarea {
      background:#0f141a !important;
      color:#e9eef5 !important;
      border:1px solid #2a3442 !important;
    }
    input::placeholder, textarea::placeholder { color:#8ea0b4 !important; }

    /* Vedlegg-listen */
    #attachmentsList li { margin: 4px 0; }
    #attachmentsList a { text-decoration: none; }
  </style>
</head>

<body>
  <!-- AUTH: vises f√∏r innlogging -->
  <section id="auth" class="card">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Logg inn for √• bruke adminpanelet</p>
    </div>
    <hr class="brand-rule">
    <button id="btnGoogle" class="btn">Logg inn med Google</button>
    <p class="note" id="authStatusMessage" style="margin-top:8px">Krever at brukeren finnes i Firestore policy (kan √•pnes for alle ‚Äì n√• tillater vi alle innloggede).</p>
  </section>

  <!-- APP: skjules til bruker er innlogget -->
  <main id="app" class="hide card">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Kongen av kontaktl√∏s ‚Äì bygg, merk og publiser NFC-kort</p>
      <div style="margin-top:8px">
        <a href="./bestill-kort.html" class="btn">Bestill kort</a>
      </div>
    </div>
    <hr class="brand-rule">

    <script>
      // Fylles fra Firestore ved innlogging. Vi har ogs√• fallback.
      window.ORG_PROFILES = {};   // { key: {name, accent, logo, site, logoBg} }
      window.EMPLOYEES    = {};   // { key: [ {slug, name, ...} ] } ‚Äì valgfritt, tom som default
    </script>

    <!-- Banner: Siste opplastede filer -->
    <section class="banner" style="margin:0 0 16px">
      <div class="inline" style="justify-content:space-between;align-items:flex-end;gap:8px">
        <div>
          <h3 style="margin:0 0 6px">Siste opplastede filer</h3>
          <p class="note" id="recentFilesSub" style="margin:0">
            <span id="recentModeLabel">Viser kort</span>
            &nbsp;|&nbsp;
            <a href="#" id="switchToCards" style="color:#8fd3ff;text-decoration:none;">Vedlegg</a>
          </p>
        </div>
        <div class="actions">
          <button id="btnRecentRefresh" class="pill" type="button">Oppdater</button>
          <button id="btnRecentMore" class="pill" type="button" style="display:none">Se flere</button>
        </div>
      </div>
      <div id="recentFilesStatus" class="note" style="margin-top:6px"></div>
      <ul id="recentFilesList" class="file-list"></ul>
    </section>

    <h2>Organisasjon</h2>
    <div class="row">
      <label>Velg organisasjon
        <select id="orgSelect"></select>
      </label>
      <p class="note" id="orgAccessStatus" style="margin:6px 0 0"></p>
      <div class="inline" id="latestCardRow" style="gap:8px;margin-top:6px">
        <button type="button" class="pill" id="btnFetchLatestCard">Hent siste kort</button>
        <span class="note" id="latestCardStatus"></span>
      </div>

      <div class="inline">
        <label style="flex:1">Org key (mappe ‚Äì case sensitive)
          <input id="orgKey" placeholder="OrgKey" required oninput="applyBranding('force'); if (syncOrgSelectFromKey() !== false) loadEmployees();">
        </label>
        <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
          <img id="logoPreview" class="logo-prev" alt="logo" />
        </div>
      </div>

      <label>Org navn (visning)
        <input id="orgName" placeholder="Din organisasjon">
      </label>
      <label>Accent farge (hex)
        <input id="accent" placeholder="#3aa0ff">
      </label>
      <label>Org nettside
        <input id="orgSite" placeholder="https://domene.no">
      </label>

      <label>Logo URL (eller last opp)
        <div class="flex">
          <input id="logoUrl" placeholder="https://.../logo.png" oninput="previewLogo()" style="flex:1">
          <input type="file" id="logoFile" accept="image/*" onchange="handleLogoUpload(event)">
        </div>
        <small class="note">Lagrer til repo via <code>/api/uploadLogo</code>.</small>
      </label>

      <label>Logo bakgrunn
        <input id="logoBg" placeholder="#ffffff (tom = auto)">
      </label>
    </div>

    <h2>Person</h2>
    <div class="row">
      <label>Velg ansatt
        <select id="employeeSelect"><option value="">(Velg ansatt‚Ä¶)</option></select>
      </label>
      <div></div>

      <label>Slug (mappe/URL uten √¶√∏√•/mellomrom)
        <input id="slug" placeholder="ola-nordmann" required>
      </label>
      <label>Navn
        <input id="name" placeholder="Ola Nordmann" required>
      </label>
      <label>Tittel
        <input id="title" placeholder="Salgsleder">
      </label>
      <label>Telefon (E.164)
        <input id="phone" placeholder="+47 40000000">
      </label>
      <label>E-post
        <input id="email" placeholder="ola@firma.no">
      </label>
      <label>Nettside
        <input id="site" placeholder="https://firma.no">
      </label>
      <label>Adresse
        <input id="address" placeholder="Storgata 1, 0001 Oslo">
      </label>
      <label>VCF-filnavn
        <input id="vcfFilename" placeholder="ola_nordmann.vcf">
      </label>
    </div>

    <h2>Lenker og tekster</h2>
    <div class="row">
      <label>Forh√•ndsvalg (klikk for √• legge til)</label>
      <div>
        <button type="button" class="pill" data-label="LinkedIn"  data-url="https://www.linkedin.com/in/">LinkedIn</button>
        <button type="button" class="pill" data-label="Instagram" data-url="https://instagram.com/">Instagram</button>
        <button type="button" class="pill" data-label="Facebook"  data-url="https://facebook.com/">Facebook</button>
        <button type="button" class="pill" data-label="YouTube"   data-url="https://youtube.com/@">YouTube</button>
        <button type="button" class="pill" data-label="TikTok"    data-url="https://www.tiktok.com/@">TikTok</button>
        <button type="button" class="pill" data-label="GitHub"    data-url="https://github.com/">GitHub</button>
        <button type="button" class="pill" data-label="Nettside"  data-url="https://">Nettside</button>
        <button type="button" class="pill" data-label="Kalender"  data-url="https://cal.com/">Kalender</button>
        <button type="button" class="pill" data-label="WhatsApp"  data-url="https://wa.me/">WhatsApp</button>
      </div>
    </div>

    <table class="links-table" id="linksTable">
      <thead><tr><th>Label</th><th>URL</th><th>Tekst over</th><th>Tekst under</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row">
      <label>Ny label<input id="newLabel" placeholder="LinkedIn"></label>
      <label>Ny URL<input id="newUrl" placeholder="https://linkedin.com/in/..."></label>
      <label>Tekst over<input id="newPre" placeholder="F√∏lg meg p√• LinkedIn"></label>
      <label>Tekst under<input id="newPost" placeholder="@brukernavn (daglig oppdatert)"></label>
      <div><button type="button" id="addLink">Legg til</button></div>
    </div>

    <h2>Vedlegg (PDF, brosjyrer m.m.)</h2>
    <p class="kicker">Last opp til <code>/<span id="bpK"></span>/<span id="okK"></span>/<span id="slK"></span>/files/</code> i GitHub. Disse vises automatisk som ¬´Last ned¬ª-knapper p√• kontaktkortet.</p>
    <div class="row">
      <label>Velg filer (flere)
        <input type="file" id="attachmentsInput" multiple
          accept=".pdf,.png,.jpg,.jpeg,.webp,.doc,.docx,.xlsx,.ppt,.pptx,.ics,.txt,.md,.csv,.zip">
      </label>
      <div>
        <button type="button" id="uploadFilesBtn">Last opp valgte</button>
      </div>
      <label>Legg til ekstern URL (valgfritt)
        <div class="flex">
          <input id="extUrl" placeholder="https://‚Ä¶/fil.pdf" style="flex:1">
          <input id="extName" placeholder="Visningsnavn (valgfritt)" style="flex:1">
          <button type="button" id="addExtBtn" class="pill">Legg til URL</button>
        </div>
      </label>
      <div></div>
    </div>
    <ul id="attachmentsList" class="mini"></ul>

    <h2>Publisering</h2>
    <div class="row">
      <label>GitHub owner
        <input id="ghUser" placeholder="brukernavn" value="Luckywolf82">
      </label>
      <label>Repo-navn
        <input id="ghRepo" placeholder="Vcards" value="Vcards">
      </label>
      <label>BASE_PATH
        <input id="basePath" placeholder="Vcards" value="Vcards">
      </label>
      <label>Commit-strategi
        <select id="strategy">
          <option value="pr">Branch + Pull Request</option>
          <option value="direct">Direkte til main</option>
        </select>
      </label>
    </div>

    <div class="inline" style="gap:10px;align-items:center;margin:12px 0;flex-wrap:wrap">
      <button type="button" id="btnGenerate" class="pill">Generer</button>
      <button type="button" id="btnPublish" class="pill">Publiser</button>
      <span id="status" class="note"></span>
    </div>

    <h3>Resultat</h3>
    <p>NFC-URL: <input id="nfcUrl" style="width:100%" readonly></p>
    <p>HTML-URL: <input id="htmlUrl" style="width:100%" readonly></p>

    <h4>vCard</h4>
    <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

    <h4>index.html</h4>
    <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>

    <!-- Live forh√•ndsvisning -->
    <div id="livePreviewContainer" style="margin-top:10px;">
      <h4>Live forh√•ndsvisning</h4>
      <button id="openPreviewBtn" style="margin:6px 0;">√Öpne forh√•ndsvisning i ny fane</button>
      <iframe id="livePreviewFrame" style="width:100%;height:480px;border:1px solid #333;border-radius:8px;background:#111;" title="Live Preview"></iframe>
    </div>

    <h2>NFC (Web NFC ‚Äì Chrome/Android)</h2>
    <div class="row">
      <label>Velg skrive-type
        <select id="nfcWriteMode">
          <option value="url">URL (√•pnes i nettleser)</option>
          <option value="text">Tekst</option>
          <option value="vcard">vCard (.vcf fra forh√•ndsvisning)</option>
        </select>
      </label>
      <label>Payload (for URL/tekst)
        <input id="nfcPayload" placeholder="https://ditt-domene.no/sti">
      </label>
      <div>
        <button id="nfcRead" class="pill" type="button">Les NFC</button>
        <button id="nfcWrite" class="pill" type="button">Skriv NFC</button>
      </div>
    </div>
    <pre id="nfcLog"></pre>

    <!-- UI: ansatte/orga-synk -->
    <script>
      function populateOrgSelect(){
        const orgSelect = document.getElementById('orgSelect');
        if (!orgSelect) return;
        orgSelect.innerHTML = '';
        const orgs = window.ORG_PROFILES || {};
        Object.keys(orgs).forEach(key=>{
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = orgs[key].name || key;
          orgSelect.appendChild(opt);
        });
        enforceOrgSelection();
      }

      function syncOrgKeyFromSelect(){
        const select = document.getElementById('orgSelect');
        if (!select) return;
        const key = select.value;
        if (!hasOrgAccess(key)) {
          setOrgAccessMessage(`Ingen tilgang til ${key}.`);
          enforceOrgSelection();
          return false;
        }
        document.getElementById('orgKey').value = key;
        setOrgAccessMessage(describeAccess(window.ORG_PROFILES || {}));
        applyBranding('force');
        loadEmployees();
        return true;
      }

      function syncOrgSelectFromKey(){
        const key = document.getElementById('orgKey').value.trim();
        const orgSelect = document.getElementById('orgSelect');
        if (!orgSelect) return;
        if (!hasOrgAccess(key)) {
          if (key) setOrgAccessMessage(`Ingen tilgang til ${key}.`);
          enforceOrgSelection();
          return false;
        }
        const idx = Array.from(orgSelect.options).findIndex(o => o.value === key);
        if (idx >= 0) orgSelect.selectedIndex = idx;
        setOrgAccessMessage(describeAccess(window.ORG_PROFILES || {}));
        return true;
      }

      const EMPLOYEE_CACHE_TTL = 60 * 1000;
      const employeeFetches = {};
      const employeeCacheMeta = {};
      let employeeLoadTimer = null;
      let employeeRequestId = 0;

      const trimSlashes = (s) => (s || '').replace(/^\/+|\/+$/g, '');
      const pathToSegments = (s) => trimSlashes(s).split('/').filter(Boolean);

      function renderEmployeeOptions(sel, orgKey, preferredSlug){
        const store = window.EMPLOYEES || (window.EMPLOYEES = {});
        const list = Array.isArray(store[orgKey]) ? store[orgKey] : [];
        sel.innerHTML = '';
        const baseOpt = document.createElement('option');
        baseOpt.value = '';
        baseOpt.dataset.slug = '';
        baseOpt.textContent = list.length ? '(Velg ansatt‚Ä¶)' : '(Ingen ansatte funnet)';
        sel.appendChild(baseOpt);
        list.forEach((emp, i)=>{
          const slug = (emp && (emp.slug || emp._slug || '')) || '';
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.dataset.slug = slug;
          const name = emp?.name || slug || `Kort ${i + 1}`;
          opt.textContent = emp?.title ? `${name} ‚Äì ${emp.title}` : name;
          if (preferredSlug && slug && slug === preferredSlug) opt.selected = true;
          sel.appendChild(opt);
        });
        return list.length;
      }

      async function fetchEmployeesForOrg(orgKey, opts = {}){
        const key = (orgKey || '').trim();
        if (!key) return [];
        const now = Date.now();
        const cachedMeta = employeeCacheMeta[key];
        if (!opts.force && cachedMeta && (now - cachedMeta.loadedAt) < EMPLOYEE_CACHE_TTL) {
          const store = window.EMPLOYEES || {};
          return Array.isArray(store[key]) ? store[key] : [];
        }
        if (employeeFetches[key]) return employeeFetches[key];

        const owner = (document.getElementById('ghUser')?.value || 'Luckywolf82').trim();
        const repo  = (document.getElementById('ghRepo')?.value || 'Vcards').trim();
        const basePath = (document.getElementById('basePath')?.value || 'Vcards');
        const dirSegments = [...pathToSegments(basePath), key];
        if (!owner || !repo || dirSegments.length === 0) {
          const store = window.EMPLOYEES || {};
          return Array.isArray(store[key]) ? store[key] : [];
        }
        const encodedDir = dirSegments.map(seg => encodeURIComponent(seg)).join('/');
        const dirUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodedDir}?ref=HEAD`;

        const promise = (async ()=>{
          try {
            const dirResp = await fetch(dirUrl, { headers: { Accept: 'application/vnd.github+json' } });
            if (dirResp.status === 404) {
              (window.EMPLOYEES || (window.EMPLOYEES = {}))[key] = [];
              employeeCacheMeta[key] = { loadedAt: Date.now() };
              return [];
            }
            if (!dirResp.ok) throw new Error(`${dirResp.status} ${dirResp.statusText}`);
            let listing;
            try { listing = await dirResp.json(); }
            catch { listing = []; }
            const directories = Array.isArray(listing) ? listing.filter(entry => entry && entry.type === 'dir').slice(0, 40) : [];
            const employees = [];
            for (const entry of directories) {
              const slug = entry?.name || '';
              if (!slug) continue;
              const dataSegments = [...dirSegments, slug, 'data.json'];
              const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/HEAD/${dataSegments.map(seg => encodeURIComponent(seg)).join('/')}`;
              try {
                const resp = await fetch(rawUrl, { cache: 'no-store' });
                if (!resp.ok) continue;
                let data;
                try { data = await resp.json(); }
                catch { continue; }
                const normalized = Object.assign({}, data || {});
                normalized.slug = normalized.slug || slug;
                normalized.orgKey = normalized.orgKey || key;
                employees.push(normalized);
              } catch (err) {
                console.warn('Kunne ikke hente data for', `${key}/${slug}`, err);
              }
            }
            (window.EMPLOYEES || (window.EMPLOYEES = {}))[key] = employees;
            employeeCacheMeta[key] = { loadedAt: Date.now() };
            return employees;
          } catch (err) {
            console.warn('Kunne ikke hente ansatte for', key, err);
            const store = window.EMPLOYEES || {};
            return Array.isArray(store[key]) ? store[key] : [];
          } finally {
            delete employeeFetches[key];
          }
        })();

        employeeFetches[key] = promise;
        return promise;
      }

      function loadEmployees(){
        const sel = document.getElementById('employeeSelect');
        if (!sel) return;
        const key = document.getElementById('orgKey').value.trim();
        clearTimeout(employeeLoadTimer);

        if (!key) {
          sel.innerHTML = '<option value="">(Velg ansatt‚Ä¶)</option>';
          sel.disabled = true;
          return;
        }

        const prevSlug = sel.selectedOptions?.[0]?.dataset?.slug || '';
        const cached = Array.isArray((window.EMPLOYEES || {})[key]) ? window.EMPLOYEES[key] : null;

        if (cached && cached.length) {
          renderEmployeeOptions(sel, key, prevSlug);
          sel.disabled = false;
        } else {
          sel.innerHTML = '<option value="">Laster ansatte‚Ä¶</option>';
          sel.disabled = true;
        }

        const requestId = ++employeeRequestId;
        const targetKey = key;

        employeeLoadTimer = setTimeout(async ()=>{
          try {
            await fetchEmployeesForOrg(targetKey);
            if (requestId !== employeeRequestId) return;
            const count = renderEmployeeOptions(sel, targetKey, prevSlug);
            sel.disabled = count === 0;
          } catch (err) {
            if (requestId !== employeeRequestId) return;
            sel.innerHTML = '<option value="">Kunne ikke hente ansatte</option>';
            sel.disabled = true;
          }
        }, 200);
      }

      function fillEmployee(iStr){
        const key = document.getElementById('orgKey').value.trim();
        const list = (window.EMPLOYEES || {})[key] || [];
        const idx = parseInt(iStr, 10);
        if (Number.isNaN(idx)) return;
        const emp = list[idx];
        if (!emp || typeof emp !== 'object') return;

        const normalized = Object.assign({}, emp);
        normalized.slug = normalized.slug || normalized._slug || '';
        normalized.orgKey = normalized.orgKey || key;

        if (typeof window._fillFromCardData === 'function') {
          window._fillFromCardData(normalized);
          return;
        }

        const set = (id, val) => { const el=document.getElementById(id); if (el) el.value = val || ''; };
        set('slug', normalized.slug);
        set('name', normalized.name);
        set('title', normalized.title);
        set('phone', normalized.phone);
        set('email', normalized.email);
        set('site', normalized.site);
        set('address', normalized.address);
        set('vcfFilename', normalized.vcfFilename);

        const links = Array.isArray(normalized.links) ? normalized.links : [];
        if (typeof window._clearLinkRows === 'function') {
          window._clearLinkRows();
          if (typeof window._addLinkRow === 'function') {
            links.forEach(l => window._addLinkRow(l?.label || '', l?.url || '', l?.pre || '', l?.post || ''));
          }
        }

        const attachments = Array.isArray(normalized.attachments) ? normalized.attachments : [];
        window._latestAttachments = attachments;
        if (typeof window._setAttachmentsFromData === 'function') {
          window._setAttachmentsFromData(attachments);
        }
        if (typeof window.previewLogo === 'function') {
          window.previewLogo();
        }
      }

      window._refreshEmployeeSelect = function(orgKey, preferredSlug){
        const sel = document.getElementById('employeeSelect');
        if (!sel) return;
        const currentOrg = document.getElementById('orgKey').value.trim();
        if (orgKey && currentOrg && orgKey !== currentOrg) return;
        const slug = preferredSlug || sel.selectedOptions?.[0]?.dataset?.slug || '';
        const count = renderEmployeeOptions(sel, currentOrg || orgKey || '', slug);
        sel.disabled = count === 0;
      };

      window._markEmployeesLoaded = function(orgKey){
        if (!orgKey) return;
        employeeCacheMeta[orgKey] = { loadedAt: Date.now() };
      };

      document.getElementById('employeeSelect').addEventListener('change', (e)=> fillEmployee(e.target.value));
    </script>

    <!-- Lenketabell -->
    <script>
      const tbody = document.querySelector('#linksTable tbody');

      function addRow(label, url, pre = '', post = '') {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${label||''}" class="lbl" /></td>
          <td><input value="${url||''}" class="lnk" style="width:100%"/></td>
          <td><textarea class="pre" rows="2" placeholder="Tekst over">${pre||''}</textarea></td>
          <td><textarea class="post" rows="2" placeholder="Tekst under">${post||''}</textarea></td>
          <td><button type="button" class="remove">Fjern</button></td>`;
        tr.querySelector('.remove').addEventListener('click', () => tr.remove());
        tbody.appendChild(tr);
      }

      window._addLinkRow = addRow;
      window._clearLinkRows = () => { tbody.innerHTML = ''; };

      document.getElementById('addLink').addEventListener('click', () => {
        addRow(
          document.getElementById('newLabel').value,
          document.getElementById('newUrl').value,
          document.getElementById('newPre').value,
          document.getElementById('newPost').value
        );
        ['newLabel','newUrl','newPre','newPost'].forEach(id => document.getElementById(id).value = '');
      });

      document.querySelectorAll('button.pill[data-label]').forEach(btn => {
        btn.addEventListener('click', () => {
          addRow(btn.dataset.label || '', btn.dataset.url || '');
        });
      });
    </script>

    <!-- Branding & logo -->
    <script>
      function applyBranding(mode = 'auto'){
        const key  = document.getElementById('orgKey').value.trim();
        const prof = (window.ORG_PROFILES || {})[key];
        if (!prof) return;
        const set = (id, val) => { const el=document.getElementById(id); if (!el) return; if (mode==='force' || !el.value) el.value = val || ''; };
        set('orgName', prof.name || key);
        set('accent' , prof.accent || '#8fd3ff');
        set('orgSite', prof.site || '');
        set('logoUrl', prof.logo || '');
        set('logoBg' , prof.logoBg || '#ffffff');
        previewLogo();
      }
      window.applyBranding = applyBranding;

      function previewLogo(){
        const url = document.getElementById('logoUrl').value.trim();
        const img = document.getElementById('logoPreview');
        const bg  = document.getElementById('logoBg').value.trim();
        if(!url){ img.style.display='none'; return; }
        img.src = url; img.style.display='block'; img.style.borderRadius='8px'; img.style.padding='6px';
        img.style.background = bg || '#ffffff';
      }
      window.previewLogo = previewLogo;

      async function handleLogoUpload(evt){
        const file = evt.target.files?.[0];
        if(!file) return;
        const orgKey = (document.getElementById('orgKey').value || '').trim() || 'Common';
        const ghUser = (document.getElementById("ghUser")?.value || "Luckywolf82").trim();
        const ghRepo = (document.getElementById("ghRepo")?.value || "Vcards").trim();
        const basePath = (document.getElementById('basePath').value || 'Vcards').trim();
        const arrBuf = await file.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
        const cleanOrg = orgKey.replace(/[^A-Za-z0-9_-]/g, '');
        const ext = (file.name.split('.').pop() || 'png').toLowerCase().replace(/[^a-z0-9]/g,'') || 'png';
        const safeName = `${cleanOrg}_logo_${Date.now()}.${ext}`;
        const res = await fetch('/api/uploadLogo', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ repoOwner:ghUser||undefined, repoName:ghRepo||undefined, basePath, orgKey:cleanOrg, filename:safeName, contentBase64:base64 })
        });
        const out = await res.json().catch(()=> ({}));
        if(!res.ok || !out.url){ alert('Kunne ikke laste opp logo'); return; }
        document.getElementById('logoUrl').value = out.url; previewLogo();
      }
      window.handleLogoUpload = handleLogoUpload;
    </script>

    <!-- Vedlegg: opplasting og liste -->
    <script>
      const $bp = document.getElementById('bpK');
      const $ok = document.getElementById('okK');
      const $sl = document.getElementById('slK');
      const updatePathPreview = ()=>{
        $bp.textContent = (document.getElementById('basePath').value || 'Vcards').replace(/^\/+|\/+$/g,'');
        $ok.textContent = document.getElementById('orgKey').value || 'OrgKey';
        $sl.textContent = document.getElementById('slug').value || 'slug';
      };
      ['basePath','orgKey','slug'].forEach(id=>{
        document.getElementById(id)?.addEventListener('input', updatePathPreview);
      });
      updatePathPreview();

      const HTML_ESCAPE = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;",
      };
      const escapeHtml = (str='') => String(str).replace(/[&<>"']/g, c => HTML_ESCAPE[c] || c);
      const escapeAttr = (str='') => escapeHtml(str);

      function normalizeAttachment(entry){
        if (!entry) return null;
        if (typeof entry === 'string'){
          return { kind:'file', file: entry, label:'', sourceUrl:'' };
        }
        if (typeof entry === 'object'){
          if (entry.kind === 'file' || entry.type === 'file'){
            const file = entry.file || entry.url || entry.name || '';
            const label = entry.label || entry.name || '';
            return file ? { kind:'file', file, label, sourceUrl: entry.sourceUrl || entry.rawUrl || '' } : null;
          }
          if (entry.kind === 'url' || entry.type === 'url'){
            const url = entry.url || '';
            if (!url) return null;
            const label = entry.label || entry.name || '';
            return { kind:'url', url, label };
          }
          const url = entry.url || '';
          const label = entry.name || entry.label || '';
          if (url){
            if (/^https?:\/\//i.test(url)){
              return { kind:'url', url, label };
            }
            return { kind:'file', file: url, label, sourceUrl: entry.sourceUrl || '' };
          }
          if (entry.name){
            return { kind:'file', file: entry.name, label: entry.label || '' };
          }
        }
        return null;
      }

      function computeAttachmentDisplay(item){
        if (!item) return '';
        if (item.kind === 'file'){
          return (item.label && item.label.trim()) || item.file || '';
        }
        if (item.kind === 'url'){
          return (item.label && item.label.trim()) || item.url || '';
        }
        return '';
      }

      function setAttachmentsFromData(list){
        const normalized = (Array.isArray(list) ? list : []).map(normalizeAttachment).filter(Boolean);
        window._uploadedAttachments = normalized;
        renderAttachments();
      }

      window._uploadedAttachments = [];

      function renderAttachments(){
        const list = document.getElementById('attachmentsList');
        if (!list) return;
        const ghUser = document.getElementById('ghUser').value.trim();
        const ghRepo = document.getElementById('ghRepo').value.trim();
        const basePath = (document.getElementById('basePath').value || 'Vcards').replace(/^\/+|\/+$/g,'');
        const orgKey = document.getElementById('orgKey').value.trim();
        const slug   = document.getElementById('slug').value.trim();
        const pagesBase = ghUser && ghRepo ? `https://${ghUser}.github.io/${ghRepo}${basePath?`/${basePath}`:''}/${orgKey}/${slug}/files/` : '';
        const attachments = window._uploadedAttachments || [];
        if (!attachments.length){
          list.innerHTML = '<li class="note">Ingen vedlegg lagt til enda.</li>';
          return;
        }
        list.innerHTML = attachments.map((item, index)=>{
          const isFile = item.kind === 'file';
          const display = computeAttachmentDisplay(item) || '(uten navn)';
          const fileName = isFile ? (item.file || '') : '';
          const labelValue = item.label || '';
          const urlValue = isFile ? '' : (item.url || '');
          const openHref = isFile
            ? (fileName ? (pagesBase ? pagesBase + encodeURIComponent(fileName) : item.sourceUrl || '') : '')
            : (urlValue || '');
          const actions = [];
          if (openHref){
            actions.push(`<a class="pill" href="${escapeAttr(openHref)}" target="_blank" rel="noopener">√Öpne</a>`);
          }
          actions.push('<button type="button" class="pill" data-act="remove">Fjern</button>');
          const labelInput = `<label style="display:block;margin-top:6px">Visningsnavn<input data-field="label" value="${escapeAttr(labelValue)}" placeholder="${isFile?'Standard = filnavn':'F.eks. Produktark'}" style="width:100%"></label>`;
          const urlInput = isFile ? '' : `<label style="display:block;margin-top:6px">URL<input data-field="url" value="${escapeAttr(urlValue)}" placeholder="https://‚Ä¶" style="width:100%"></label>`;
          const note = isFile && fileName ? `<small class="note">Lagringsfil: ${escapeHtml(fileName)}</small>` : '';
          return `<li data-ix="${index}" class="attachment-item" style="margin:8px 0;padding:8px;border:1px solid #283246;border-radius:8px">`
            + `<div class="inline" style="gap:8px"><span>${isFile?'üìé':'üîó'}</span><strong data-role="display">${escapeHtml(display)}</strong></div>`
            + labelInput
            + urlInput
            + `<div class="inline" style="gap:6px;margin-top:8px">${actions.join(' ')}</div>`
            + (note ? `<div style="margin-top:4px">${note}</div>` : '')
            + `</li>`;
        }).join('');
      }

      function _collectAttachments(){
        const attachments = window._uploadedAttachments || [];
        return attachments.map(item=>{
          if (item.kind === 'file'){
            const file = (item.file || '').trim();
            if (!file) return null;
            const label = (item.label || '').trim();
            return label ? { name: label, url: file } : file;
          }
          if (item.kind === 'url'){
            const url = (item.url || '').trim();
            if (!url) return null;
            const label = (item.label || '').trim();
            return { name: label || url, url };
          }
          return null;
        }).filter(Boolean);
      }
      window._collectAttachments = _collectAttachments;
      window._setAttachmentsFromData = setAttachmentsFromData;

      const attachmentsListEl = document.getElementById('attachmentsList');
      attachmentsListEl?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-act="remove"]');
        if (!btn) return;
        e.preventDefault();
        const li = btn.closest('li[data-ix]');
        if (!li) return;
        const ix = Number(li.getAttribute('data-ix'));
        if (Number.isNaN(ix)) return;
        (window._uploadedAttachments || []).splice(ix, 1);
        renderAttachments();
      });

      attachmentsListEl?.addEventListener('input', (e)=>{
        const field = e.target?.dataset?.field;
        if (!field) return;
        const li = e.target.closest('li[data-ix]');
        if (!li) return;
        const ix = Number(li.getAttribute('data-ix'));
        if (Number.isNaN(ix)) return;
        const item = (window._uploadedAttachments || [])[ix];
        if (!item) return;
        item[field] = e.target.value;
        const displayEl = li.querySelector('[data-role="display"]');
        if (displayEl){
          displayEl.textContent = computeAttachmentDisplay(item) || '(uten navn)';
        }
      });

      document.getElementById('addExtBtn')?.addEventListener('click', ()=>{
        const url = document.getElementById('extUrl').value.trim();
        const name= document.getElementById('extName').value.trim();
        if (!url) return;
        const entry = normalizeAttachment({ kind:'url', url, label: name || '' });
        if (!entry) return;
        window._uploadedAttachments.push(entry);
        document.getElementById('extUrl').value = '';
        document.getElementById('extName').value = '';
        renderAttachments();
      });

      setAttachmentsFromData(window._latestAttachments || []);

      async function uploadOneFile(file, ctx){
        const arrBuf = await file.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
        const clean = (file.name||'file').replace(/[^\w.-]+/g,'_');
        const payload = {
          repoOwner: ctx.owner || undefined,
          repoName:  ctx.repo  || undefined,
          basePath:  ctx.basePath,
          orgKey:    ctx.orgKey,
          slug:      ctx.slug,
          filename:  clean,
          contentBase64: base64
        };
        const res = await fetch('/api/uploadFile', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const out = await res.json().catch(()=> ({}));
        if (!res.ok){ throw new Error((out && out.error) || `Upload feilet: ${res.status}`); }
        return { name: clean, url: out.url };
      }

      document.getElementById('uploadFilesBtn')?.addEventListener('click', async ()=>{
        const files = document.getElementById('attachmentsInput')?.files;
        if (!files || !files.length){ alert('Velg filer f√∏rst'); return; }
        const owner = document.getElementById('ghUser').value.trim();
        const repo  = document.getElementById('ghRepo').value.trim();
        const basePath = (document.getElementById('basePath').value || 'Vcards').replace(/^\/+|\/+$/g,'');
        const orgKey = document.getElementById('orgKey').value.trim();
        const slug   = document.getElementById('slug').value.trim();
        if (!owner || !repo || !basePath || !orgKey || !slug){
          alert('Fyll ut GitHub owner/repo, basePath, orgKey og slug f√∏r opplasting.');
          return;
        }
        const ctx = { owner, repo, basePath, orgKey, slug };
        const status = document.getElementById('status');
        status.textContent = 'Laster opp‚Ä¶';
        try{
          for (const f of files){
            const res = await uploadOneFile(f, ctx);
            const entry = normalizeAttachment({ kind:'file', file: res.name, label:'', sourceUrl: res.url });
            if (entry) window._uploadedAttachments.push(entry);
          }
          status.innerHTML = '<span class="ok">‚úÖ Opplasting ferdig</span>';
          document.getElementById('attachmentsInput').value = '';
          renderAttachments();
        }catch(e){
          status.innerHTML = '<span class="err">‚ùå '+(e.message||e)+'</span>';
        }
      });
    </script>

    <!-- Generer & Publiser + Live preview + NFC -->
    <script>
      (function(){
        const DEFAULT_OWNER = 'Luckywolf82';
        const DEFAULT_REPO = 'Vcards';
        const DEFAULT_BASE_PATH = 'Vcards';

        const state = {
          owner: DEFAULT_OWNER,
          repo: DEFAULT_REPO,
          basePath: DEFAULT_BASE_PATH,
          strategy: 'pr',
          data: null,
          html: '',
          vcf: '',
          htmlUrl: '',
          vcfUrl: ''
        };

        const $status = document.getElementById('status');
        const $htmlPreview = document.getElementById('htmlPreview');
        const $vcfPreview = document.getElementById('vcfPreview');
        const $generate = document.getElementById('btnGenerate');
        const $publish = document.getElementById('btnPublish');

        const HTML_ESCAPE = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        const escapeHtml = (str = '') => String(str).replace(/[&<>"']/g, c => HTML_ESCAPE[c] || c);

        const trimSlashes = (s = '') => s.replace(/^\/+|\/+$/g, '');
        const getVal = (id) => (document.getElementById(id)?.value || '').trim();
        const setVal = (id, value) => { const el = document.getElementById(id); if (el) el.value = value; };

        function ensureUrlControls(id, label){
          const input = document.getElementById(id);
          if (!input) return;
          if (input.nextSibling?.classList?.contains('url-actions')) return;
          const wrap = document.createElement('span');
          wrap.className = 'url-actions';
          wrap.innerHTML = `<button type="button" class="pill" data-act="copy">Kopier ${label}</button>`+
            `<button type="button" class="pill" data-act="open">√Öpne</button>`;
          input.after(wrap);
          wrap.addEventListener('click', (e)=>{
            const btn = e.target.closest('button[data-act]');
            if (!btn) return;
            const val = input.value.trim();
            if (!val) return;
            if (btn.dataset.act === 'copy') navigator.clipboard?.writeText(val);
            if (btn.dataset.act === 'open') window.open(val, '_blank', 'noopener');
          });
        }
        window.ensureUrlControls = window.ensureUrlControls || ensureUrlControls;

        function normalizePhone(p){
          p = (p || '').trim();
          if (!p) return p;
          if (p.startsWith('0') && !p.startsWith('+')){
            if (p.length <= 8) return '+47' + p.replace(/^0+/, '');
          }
          return p;
        }

        function makeVcard(d){
          const parts = (d.name || '').trim().split(' ');
          const first = parts[0] || '';
          const last = parts.length > 1 ? parts[parts.length - 1] : '';
          const phone = normalizePhone(d.phone || '');
          return [
            'BEGIN:VCARD',
            'VERSION:3.0',
            `FN:${d.name || ''}`,
            `N:${last};${first};;;`,
            `ORG:${d.orgName || d.orgKey || ''}`,
            `TITLE:${d.title || ''}`,
            `TEL;TYPE=CELL:${phone}`,
            `EMAIL;TYPE=INTERNET:${d.email || ''}`,
            `URL:${d.site || ''}`,
            `ADR;TYPE=WORK:;;${d.address || ''}`,
            'END:VCARD'
          ].join('\n');
        }

        function makeLinksHTML(links){
          if (!Array.isArray(links) || !links.length) return '';
          return links.map(l => {
            const pre  = l.pre  ? `<div class="pre" style="margin:8px 0 4px;color:#bfc8d6">${escapeHtml(l.pre)}</div>` : '';
            const post = l.post ? `<div class="post" style="margin:4px 0 10px;color:#97a3b6;font-size:.95rem">${escapeHtml(l.post)}</div>` : '';
            const label = escapeHtml(l.label || 'Lenke');
            const href = escapeHtml(l.url || '#');
            return `<div class="link-block" style="margin-top:10px">${pre}<a class="btn" href="${href}" target="_blank" rel="noopener">${label}</a>${post}</div>`;
          }).join('');
        }

        function describeAttachment(item){
          if (!item) return null;
          if (typeof item === 'string'){
            const name = item.split('/').pop();
            if (!name) return null;
            return { label: name, href: `./files/${encodeURIComponent(name)}` };
          }
          if (item.kind === 'file'){
            const file = item.file || item.url || '';
            if (!file) return null;
            const name = item.label || file.split('/').pop() || file;
            const local = file.split('/').pop() || file;
            return { label: name, href: `./files/${encodeURIComponent(local)}` };
          }
          if (item.kind === 'url'){
            const url = item.url || '';
            if (!url) return null;
            return { label: item.label || url, href: url };
          }
          const url = item.url || '';
          const name = item.name || item.label || '';
          if (url){
            const href = /^https?:\/\//i.test(url) ? url : `./files/${encodeURIComponent(url.split('/').pop() || url)}`;
            return { label: name || url, href };
          }
          if (name){
            return { label: name, href: `./files/${encodeURIComponent(name.split('/').pop() || name)}` };
          }
          return null;
        }

        function makeDownloadsHTML(attachments){
          const list = Array.isArray(attachments) ? attachments : [];
          if (!list.length) return '';
          const rows = list.map(describeAttachment).filter(Boolean).map(item =>
            `<li><a class="btn" href="${escapeHtml(item.href)}" download rel="noopener">${escapeHtml(item.label)}</a></li>`
          ).join('');
          if (!rows) return '';
          return `<section id="downloads" style="margin-top:16px">
          <h2 style="margin:0 0 8px">Last ned</h2>
          <ul style="margin:0;padding-left:18px">${rows}</ul>
        </section>`;
        }

        function makeHTML(d, vcfFile, links, attachments){
          const accent  = d.accent || '#8fd3ff';
          const bgStyle = `background:${d.logoBg || '#ffffff'};border-radius:8px;padding:6px;`;
          const safeLogoUrl = d.logoUrl ? escapeHtml(d.logoUrl) : '';
          const logoTag = safeLogoUrl ? `<img class="brand-logo" src="${safeLogoUrl}" style="${bgStyle}" alt="${escapeHtml(d.orgName || d.orgKey || '')} logo">` : '';
          const extras  = makeLinksHTML(links);
          const downloads = makeDownloadsHTML(attachments);
          return `<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kontaktkort ‚Äì ${escapeHtml(d.name || '')}</title>
  <style>
    :root{--accent:${accent};}
    body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px;margin:0}
    .container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.45)}
    .btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}
    .links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    p{color:#bfc8d6;margin:8px 0}
    h1{margin:0 0 6px;font-size:2rem}
    .brand-logo{max-height:56px;max-width:280px;object-fit:contain;margin:0 0 12px 0;display:block}
    .note{font-size:0.95rem;color:#9aa6b2}
    ul{list-style:disc;padding-left:20px;margin:10px 0 0}
    li{margin:4px 0}
  </style>
</head>
<body>
  <main class="container card">
    ${logoTag}
    <h1>Kontaktkort ‚Äì ${escapeHtml(d.name || '')}</h1>
    <p class="note">${escapeHtml(d.title || '')} ¬∑ ${escapeHtml(d.orgName || d.orgKey || '')}</p>
    <p><a class="btn" href="./${encodeURIComponent(vcfFile)}" download>Last ned vCard (.vcf)</a></p>
    <div class="links">
      <a href="tel:${escapeHtml(d.phone || '')}" class="btn">Ring</a>
      <a href="mailto:${escapeHtml(d.email || '')}" class="btn">E-post</a>
      <a href="${escapeHtml(d.site || '#')}" class="btn" target="_blank" rel="noopener">Bes√∏k nettside</a>
      <a href="../index.html" class="btn">‚Üê Tilbake</a>
    </div>
    ${extras}
    ${downloads}
    <p>Adresse: ${escapeHtml(d.address || '')}</p>
    <p class="note">NFC-URL: <code id="nfcInline"></code></p>
  </main>
  <script>
    (function(){
      const code = document.getElementById('nfcInline');
      if (!code) return;
      const file = ${JSON.stringify(vcfFile)};
      try {
        const href = window.location.href;
        const base = href.replace(/index\\.html?$/i, '');
        code.textContent = base + file;
      } catch {
        code.textContent = './' + file;
      }
    })();
  <\/script>
</body>
</html>`;
        }

        function showStatus(kind, html){
          if (!$status) return;
          $status.className = kind ? `note ${kind}` : 'note';
          $status.innerHTML = html || '';
        }

        function collectLinks(){
          return Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr => {
            const lbl = tr.querySelector('.lbl');
            const lnk = tr.querySelector('.lnk');
            const pre = tr.querySelector('.pre');
            const post = tr.querySelector('.post');
            return {
              label: lbl ? lbl.value.trim() : '',
              url: lnk ? lnk.value.trim() : '',
              pre: pre ? pre.value.trim() : '',
              post: post ? post.value.trim() : ''
            };
          }).filter(link => link.label && link.url);
        }

        function collectAttachments(){
          return window._collectAttachments ? window._collectAttachments() : [];
        }

        function resolveVcfFilename(raw, slug, orgKey){
          const clean = (raw || '').trim();
          if (clean) return clean.endsWith('.vcf') ? clean : `${clean}.vcf`;
          const base = slug || `${orgKey || 'kort'}`;
          return `${base.replace(/[^A-Za-z0-9_-]+/g,'-')}.vcf`;
        }

        function computePublicUrls(owner, repo, basePath, orgKey, slug, vcfFilename){
          const baseSegments = trimSlashes(basePath).split('/').filter(Boolean);
          const cardSegments = [...baseSegments];
          if (orgKey) cardSegments.push(orgKey);
          if (slug) cardSegments.push(slug);
          const encodedSegments = cardSegments.map(seg => encodeURIComponent(seg));
          const prefix = encodedSegments.length ? '/' + encodedSegments.join('/') : '';
          const baseUrl = `https://${owner}.github.io/${repo}${prefix}`;
          const htmlUrl = `${baseUrl}/index.html`;
          const vcfUrl = `${baseUrl}/${encodeURIComponent(vcfFilename)}`;
          return { baseUrl, htmlUrl, vcfUrl, encodedSegments };
        }

        function updatePreview(html){
          const frame = document.getElementById('livePreviewFrame');
          if (!frame) return;
          const doc = frame.contentDocument || frame.contentWindow?.document;
          if (!doc) return;
          doc.open();
          doc.write(html);
          doc.close();
        }

        function gatherCardInput(){
          const orgKey = getVal('orgKey');
          const slug = getVal('slug');
          const vcfFilename = resolveVcfFilename(getVal('vcfFilename'), slug, orgKey);
          return {
            orgKey,
            orgName: getVal('orgName') || orgKey,
            orgSite: getVal('orgSite'),
            accent: getVal('accent') || '#8fd3ff',
            logoUrl: getVal('logoUrl'),
            logoBg: getVal('logoBg'),
            slug,
            name: getVal('name'),
            title: getVal('title'),
            phone: getVal('phone'),
            email: getVal('email'),
            site: getVal('site'),
            address: getVal('address'),
            vcfFilename
          };
        }

        async function postJSON(url, data){
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const text = await res.text();
          try {
            return { ok: res.ok, status: res.status, json: text ? JSON.parse(text) : null };
          } catch {
            return { ok: res.ok, status: res.status, text };
          }
        }

        function generateAndPreview(options = {}){
          const { silent = false } = options;

          const owner = getVal('ghUser') || DEFAULT_OWNER;
          const repo = getVal('ghRepo') || DEFAULT_REPO;
          const basePathInput = getVal('basePath');
          const basePathNormalized = trimSlashes(basePathInput || DEFAULT_BASE_PATH);
          const basePath = basePathNormalized || DEFAULT_BASE_PATH;
          const strategy = document.getElementById('strategy')?.value || 'pr';

          const baseData = gatherCardInput();
          if (!baseData.orgKey || !baseData.slug){
            showStatus('err', '‚ùå Fyll ut b√•de Org key og Slug f√∏r generering.');
            return null;
          }

          const links = collectLinks();
          const attachments = collectAttachments();
          const cardData = { ...baseData, links, attachments };
          const vcf = makeVcard(cardData);
          const html = makeHTML(cardData, cardData.vcfFilename, links, attachments);

          const urls = computePublicUrls(owner, repo, basePath, cardData.orgKey, cardData.slug, cardData.vcfFilename);

          state.owner = owner;
          state.repo = repo;
          state.basePath = basePath;
          state.strategy = strategy;
          state.data = cardData;
          state.html = html;
          state.vcf = vcf;
          state.htmlUrl = urls.htmlUrl;
          state.vcfUrl = urls.vcfUrl;
          window._latestGenerated = { html, vcf, data: cardData };

          if ($vcfPreview) $vcfPreview.value = vcf;
          if ($htmlPreview) $htmlPreview.value = html;
          updatePreview(html);

          setVal('htmlUrl', urls.htmlUrl);
          setVal('nfcUrl', urls.vcfUrl);
          ensureUrlControls('htmlUrl', 'HTML-URL');
          ensureUrlControls('nfcUrl', 'NFC-URL');
          const inline = document.getElementById('nfcInline');
          if (inline) inline.textContent = urls.vcfUrl;

          if (!silent){
            showStatus('ok', '‚úÖ Generering fullf√∏rt. Publiser for √• sende til GitHub.');
          }

          return { owner, repo, basePath, strategy, cardData, html, vcf, urls };
        }

        async function publishCard(){
          const generated = generateAndPreview({ silent: true });
          if (!generated) return;

          const { owner, repo, basePath, strategy, cardData, html, vcf, urls } = generated;

          if (!html || !vcf || !cardData){
            showStatus('err', '‚ùå Kunne ikke finne generert innhold. Pr√∏v √• generere p√• nytt.');
            return;
          }

          const files = [
            { path: `${cardData.orgKey}/${cardData.slug}/${cardData.vcfFilename}`, content: vcf },
            { path: `${cardData.orgKey}/${cardData.slug}/index.html`, content: html },
            { path: `${cardData.orgKey}/${cardData.slug}/data.json`, content: JSON.stringify(cardData, null, 2) },
            { path: '.nojekyll', content: '' }
          ];

          const payload = {
            repoOwner: owner,
            repoName: repo,
            basePath,
            orgKey: cardData.orgKey,
            slug: cardData.slug,
            files,
            strategy,
            commitMessage: `Add/Update card: ${cardData.orgKey}/${cardData.slug}`
          };

          showStatus('info', '‚è≥ Publiserer‚Ä¶');

          try {
            const res = await postJSON('/api/createCard', payload);
            const errorText = !res.ok ? (res.json?.error || res.text || `Status ${res.status}`) : (!res.json?.ok && (res.json?.error || 'Ukjent feil'));
            if (errorText){
              let friendly = errorText;
              if (/401|403/.test(String(errorText))) {
                friendly = 'Mangler tilgang til GitHub-repoet. Sjekk token og rettigheter.';
              } else if (/404/.test(String(errorText))) {
                friendly = 'Fant ikke m√•lstien i repoet. Sjekk base path og org/slug.';
              } else if (/409/.test(String(errorText))) {
                friendly = 'Det finnes allerede et kort med samme slug. Endre slug eller slett eksisterende mappe.';
              }
              showStatus('err', `‚ùå Publisering feilet: ${escapeHtml(friendly)}`);
              return;
            }

            const ownerEnc = encodeURIComponent(owner);
            const repoEnc = encodeURIComponent(repo);
            const dataSegments = [...urls.encodedSegments, 'data.json'];
            const dataLink = `https://raw.githubusercontent.com/${ownerEnc}/${repoEnc}/HEAD/${dataSegments.join('/')}`;
            const htmlAnchor = `<a href="${urls.htmlUrl}" target="_blank" rel="noopener">index.html</a>`;
            const vcfAnchor = `<a href="${urls.vcfUrl}" target="_blank" rel="noopener">${escapeHtml(cardData.vcfFilename)}</a>`;
            const dataAnchor = `<a href="${dataLink}" target="_blank" rel="noopener">data.json</a>`;
            const displayPath = [basePath, cardData.orgKey, cardData.slug].filter(Boolean).join('/') || `${cardData.orgKey}/${cardData.slug}`;
            showStatus('ok', `‚úÖ Publisert! Lagret til <code>${escapeHtml(displayPath)}</code>. ${htmlAnchor} ¬∑ ${vcfAnchor} ¬∑ ${dataAnchor}`);
          } catch (err) {
            showStatus('err', `‚ùå Nettverksfeil: ${escapeHtml(err.message || err)}`);
          }
        }

        function logNFC(msg){
          const el = document.getElementById('nfcLog');
          if (!el) return;
          el.textContent += msg + '\n';
          el.scrollTop = el.scrollHeight;
        }

        function supportsNFC(){
          return ('NDEFReader' in window);
        }

        async function buildNdefMessage(mode, payload){
          if (mode === 'url'){
            const url = payload || state.htmlUrl || getVal('htmlUrl') || getVal('nfcUrl');
            if (!url) throw new Error('Mangler URL √• skrive');
            return { records:[ { recordType:'url', data: url } ] };
          }
          if (mode === 'text'){
            const text = payload || 'Hei fra NFCKING';
            return { records:[ { recordType:'text', data: text } ] };
          }
          if (mode === 'vcard'){
            const vcf = state.vcf || ($vcfPreview?.value || '').trim();
            if (!vcf) throw new Error('Ingen vCard i forh√•ndsvisning. Generer f√∏rst.');
            return { records:[ { recordType:'mime', mediaType:'text/vcard', data: new TextEncoder().encode(vcf) } ] };
          }
          throw new Error('Ukjent skrive-modus');
        }

        window.makeVcard = window.makeVcard || makeVcard;
        window.makeHTML = window.makeHTML || ((d, vcfFile, links, attachments) => makeHTML(d, vcfFile, links, attachments));
        window.generateCardPreview = generateAndPreview;

        $generate?.addEventListener('click', () => generateAndPreview());
        $publish?.addEventListener('click', () => publishCard());

        document.getElementById('openPreviewBtn')?.addEventListener('click', ()=>{
          const html = $htmlPreview?.value || '';
          const blob = new Blob([html], { type:'text/html' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
          setTimeout(()=>URL.revokeObjectURL(url), 60_000);
        });

        document.getElementById('nfcRead')?.addEventListener('click', async ()=>{
          if (!supportsNFC()){ alert('Web NFC st√∏ttes kun i Chrome/Android'); return; }
          try {
            const reader = new NDEFReader();
            await reader.scan();
            logNFC('Hold telefonen n√¶r kortet ‚Äì lytter...');
            reader.onreadingerror = () => logNFC('Lesefeil');
            reader.onreading = (event) => {
              const { message, serialNumber } = event;
              logNFC(`Serial: ${serialNumber || '(ukjent)'}`);
              for (const record of message.records) {
                try {
                  if (record.recordType === 'url') {
                    const text = new TextDecoder().decode(record.data);
                    logNFC('URL: ' + text);
                  } else if (record.recordType === 'text') {
                    const text = new TextDecoder().decode(record.data);
                    logNFC('Tekst: ' + text);
                  } else if (record.mediaType === 'text/vcard' || record.mediaType === 'text/x-vcard') {
                    const vcardText = new TextDecoder().decode(record.data);
                    logNFC('vCard:\n' + vcardText);
                  } else {
                    logNFC(`Record: type=${record.recordType} mediaType=${record.mediaType||''}`);
                  }
                } catch (e) {
                  logNFC('Kunne ikke dekode record: ' + e.message);
                }
              }
            };
          } catch (e) {
            logNFC('Start scanning feilet: ' + e.message);
          }
        });

        document.getElementById('nfcWrite')?.addEventListener('click', async ()=>{
          if (!supportsNFC()){ alert('Web NFC st√∏ttes kun i Chrome/Android'); return; }
          const mode = document.getElementById('nfcWriteMode')?.value || 'url';
          const payload = getVal('nfcPayload');
          try {
            const writer = new NDEFReader();
            await writer.write(await buildNdefMessage(mode, payload));
            logNFC('‚úÖ Skrevet!');
          } catch (e) {
            logNFC('Skrivefeil: ' + e.message);
          }
        });

        const orgSelect = document.getElementById('orgSelect');
        orgSelect?.addEventListener('change', syncOrgKeyFromSelect);

        if (!supportsNFC()){
          logNFC('‚ÑπÔ∏è Web NFC krever Chrome p√• Android. iOS st√∏ttes ikke per i dag.');
        } else {
          logNFC('‚ÑπÔ∏è Web NFC er tilgjengelig. Husk √• holde kortet n√¶r antenna ved les/skriv.');
        }
        logNFC('‚ÑπÔ∏è Tips: Bruk ¬´URL¬ª-modus for √• √•pne HTML-URL; ¬´vCard¬ª-modus for √• skrive selve kontaktkortet.');

        ensureUrlControls('htmlUrl', 'HTML-URL');
        ensureUrlControls('nfcUrl', 'NFC-URL');
      })();
    </script>

    <!-- Recent files banner (GitHub) ‚Äì med modus-bytte (Vedlegg/Kort) -->
    <script>
      const $recentList    = document.getElementById('recentFilesList');
      const $recentSub     = document.getElementById('recentFilesSub');
      const $recentStatus  = document.getElementById('recentFilesStatus');
      const $recentBtn     = document.getElementById('btnRecentRefresh');
      const $recentMoreBtn = document.getElementById('btnRecentMore');
      const $switchToCards = document.getElementById('switchToCards');
      const $recentModeLbl = document.getElementById('recentModeLabel');

      const RECENT_DEFAULT_SHOW = 10;
      const RECENT_MAX_DETAILS  = 6;
      const CACHE_TTL_MS        = 2 * 60 * 1000;

      let _recentAllItems = [];
      let _recentMode = 'cards'; // 'files' | 'cards'

      function getField(id){ const el = document.getElementById(id); return (el?.value || '').trim(); }
      function pathJoin(){ return Array.from(arguments).filter(Boolean).join('/').replace(/\/+/g,'/'); }
      function trimSlashes(s){ return (s||'').replace(/^\/+|\/+$/g,''); }
      function escHtml(s){ return String(s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]||c)); }
      function escAttr(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }
      function splitSegments(str){ return trimSlashes(str).split('/').filter(Boolean); }

      function currentFilesPath(){
        const basePath = trimSlashes(getField('basePath') || 'Vcards');
        const orgKey = getField('orgKey'); const slug = getField('slug');
        return pathJoin(basePath, orgKey, slug, 'files');
      }
      function currentCardsPath(){
        const basePath = trimSlashes(getField('basePath') || 'Vcards');
        const orgKey = getField('orgKey');
        return pathJoin(basePath, orgKey);
      }
      function currentRepoInfo(){
        return { owner:getField('ghUser'), repo:getField('ghRepo') };
      }
      function pagesFileUrl(owner, repo, basePath, orgKey, slug, file){
        const bp = trimSlashes(basePath || 'Vcards');
        return 'https://'+owner+'.github.io/'+repo+(bp?'/'+bp:'')+'/'+orgKey+'/'+slug+'/files/'+file;
      }
      function pagesCardUrl(owner, repo, basePath, orgKey, slug){
        const bp = trimSlashes(basePath || 'Vcards');
        return 'https://'+owner+'.github.io/'+repo+(bp?'/'+bp:'')+'/'+orgKey+'/'+slug+'/index.html';
      }
      function githubDirUrl(owner, repo, basePath, orgKey, slug){
        const bp = trimSlashes(basePath || 'Vcards');
        const dir = bp+'/'+orgKey+'/'+slug+'/files';
        return 'https://github.com/'+owner+'/'+repo+'/tree/HEAD/'+encodeURIComponent(dir);
      }

      function setRecentStatus(cls, msg){
        $recentStatus.className = 'note ' + (cls||'');
        $recentStatus.innerHTML = msg || '';
      }

      function cacheKey(){
        const { owner, repo } = currentRepoInfo();
        const basePath = trimSlashes(getField('basePath') || 'Vcards');
        const orgKey = getField('orgKey');
        const slug = getField('slug');
        return 'rf:'+owner+':'+repo+':'+basePath+':'+orgKey+':'+(slug||'')+':'+_recentMode;
      }
      function cacheStore(items){
        try { localStorage.setItem(cacheKey(), JSON.stringify({ t: Date.now(), items })); } catch {}
      }
      function cacheLoad(){
        try {
          const raw = localStorage.getItem(cacheKey()); if(!raw) return null;
          const o = JSON.parse(raw);
          if (!o || !o.t || !Array.isArray(o.items)) return null;
          if (Date.now() - o.t > CACHE_TTL_MS) return null;
          return o.items;
        } catch { return null; }
      }

      function renderItems(items, limit = RECENT_DEFAULT_SHOW){
        _recentAllItems = items.slice();
        const slice = items.slice(0, limit);
        function fmt(iso){ try { const d = new Date(iso); return d.toLocaleString('no-NO'); } catch { return iso||''; } }
        $recentList.innerHTML = slice.map(it => {
          if (it.kind === 'card') {
            const openLink = it.url ? ' <a class="note" href="'+escAttr(it.url)+'" target="_blank" rel="noopener">√Öpne</a>' : '';
            return '<li><a href="#" data-recent-card="1" data-slug="'+escAttr(it.slug)+'" data-path="'+escAttr(it.path)+'">'+escHtml(it.file)+'</a>'+openLink+' <span class="note" style="margin-left:6px">'+fmt(it.when)+'</span></li>';
          }
          return '<li><a href="'+escAttr(it.url)+'" target="_blank" rel="noopener">'+escHtml(it.file)+'</a> <span class="note" style="margin-left:6px">'+fmt(it.when)+'</span></li>';
        }).join('');

        if (items.length > slice.length) {
          $recentMoreBtn.style.display = '';
          $recentMoreBtn.dataset.shown = String(slice.length);
        } else {
          $recentMoreBtn.style.display = 'none';
        }
      }

      async function fetchJson(url, init){
        const r = await fetch(url, { headers:{'Accept':'application/vnd.github+json'}, ...(init||{}) });
        if (!r.ok) {
          const err = new Error(r.status+' '+r.statusText);
          err.status = r.status;
          err.body = await r.text().catch(()=> '');
          throw err;
        }
        return r.json();
      }

      async function fetchRecentFiles(limit = RECENT_DEFAULT_SHOW, useCache = true){
        $recentList.innerHTML = '';
        setRecentStatus('', 'Laster‚Ä¶');

        const { owner, repo } = currentRepoInfo();
        const basePath = trimSlashes(getField('basePath') || 'Vcards');
        const orgKey = getField('orgKey');
        const slug   = getField('slug');

        if (!owner || !repo || !orgKey) {
          setRecentStatus('err','Fyll ut GitHub owner/repo og OrgKey (og Slug for vedlegg).');
          return;
        }

        if (_recentMode === 'cards') {
          $recentModeLbl.textContent = 'Viser kort';
          $recentSub.innerHTML = 'Viser siste endringer i <code>/' + currentCardsPath() + '/(index.html)</code>';
          if ($switchToCards) $switchToCards.textContent = 'Vedlegg';
        } else {
          $recentModeLbl.textContent = 'Viser vedlegg';
          $recentSub.innerHTML = 'Viser siste endringer i <code>/' + currentFilesPath() + '/</code>';
          if ($switchToCards) $switchToCards.textContent = 'Kort';
        }

        if (useCache){
          const cached = cacheLoad();
          if (cached && cached.length){
            renderItems(cached, limit);
            setRecentStatus('ok','Viser hurtigbuffer (trykk Oppdater for fersk liste).');
            return;
          }
        }

        try{
          const dir = _recentMode === 'cards' ? currentCardsPath() : currentFilesPath();
          const commits = await fetchJson(
            'https://api.github.com/repos/'+owner+'/'+repo+'/commits?path='+encodeURIComponent(dir)+'&per_page=15'
          );

          const detailCommits = await Promise.all(
            (commits || []).slice(0, RECENT_MAX_DETAILS).map(c => fetchJson(c.url).catch(()=>null))
          );

          const seen = new Set();
          const items = [];
          for (const dc of detailCommits){
            if (!dc || !Array.isArray(dc.files)) continue;
            const dt = (dc.commit && (dc.commit.author?.date || dc.commit.committer?.date)) || '';
            for (const f of dc.files){
              const p = f.filename || '';
              if (_recentMode === 'files') {
                if (!slug) continue;
                if (!p.startsWith(dir + '/')) continue;
                const fileName = p.split('/').pop();
                const key = p + '@' + dt;
                if (seen.has(key)) continue;
                seen.add(key);
                items.push({
                  kind: 'file',
                  path: p,
                  file: fileName,
                  when: dt,
                  url: pagesFileUrl(owner, repo, basePath, orgKey, slug, fileName)
                });
              } else {
                if (!p.endsWith('/index.html')) continue;
                if (!p.includes('/'+orgKey+'/')) continue;
                const parts = p.split('/');
                const slugFromPath = parts[parts.length-2] || '';
                const key = p + '@' + dt;
                if (seen.has(key)) continue;
                seen.add(key);
                items.push({
                  kind: 'card',
                  slug: slugFromPath,
                  path: p,
                  file: orgKey + '/' + slugFromPath + '/index.html',
                  when: dt,
                  url: pagesCardUrl(owner, repo, basePath, orgKey, slugFromPath)
                });
              }
            }
          }

          items.sort((a,b)=> new Date(b.when) - new Date(a.when));
          if (items.length === 0){
            const dirUrl = _recentMode === 'files'
              ? githubDirUrl(owner, repo, basePath, orgKey, slug||'')
              : 'https://github.com/'+owner+'/'+repo+'/tree/HEAD/'+encodeURIComponent(currentCardsPath());
            setRecentStatus('', 'Ingen endringer funnet. <a href="'+dirUrl+'" target="_blank" rel="noopener">Se i GitHub</a>.');
            $recentList.innerHTML = '';
            $recentMoreBtn.style.display = 'none';
            return;
          }

          renderItems(items, limit);
          cacheStore(items);
          setRecentStatus('ok','Oppdatert.');
        }catch(e){
          if (e.status === 403){
            setRecentStatus('err','GitHub rate limit (403). Vent litt og pr√∏v igjen.');
          } else if (e.status === 404){
            const dirUrl = _recentMode === 'files'
              ? githubDirUrl(owner, repo, basePath, getField('orgKey'), getField('slug')||'')
              : 'https://github.com/'+getField('ghUser')+'/'+getField('ghRepo')+'/tree/HEAD/'+encodeURIComponent(currentCardsPath());
            setRecentStatus('err','Fant ikke mappen. Sjekk sti/branch. <a href="'+dirUrl+'" target="_blank" rel="noopener">√Öpne i GitHub</a>.');
          } else {
            setRecentStatus('err','Kunne ikke hente: ' + (e.message || e));
          }
          $recentMoreBtn.style.display = 'none';
        }
      }

      async function loadCardIntoForm(slug){
        if (!slug) return;
        const repoInfo = currentRepoInfo();
        const owner = (repoInfo.owner || 'Luckywolf82').trim();
        const repo  = (repoInfo.repo  || 'Vcards').trim();
        const basePath = trimSlashes(getField('basePath') || 'Vcards');
        const orgKey  = getField('orgKey');

        if (!owner || !repo) {
          setRecentStatus('err','Fyll ut GitHub owner og repo f√∏rst.');
          return;
        }
        if (!orgKey) {
          setRecentStatus('err','Angi Org key for √• hente kortdata.');
          return;
        }

        const segments = [...splitSegments(basePath), orgKey, slug, 'data.json'];
        const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/HEAD/${segments.map(s => encodeURIComponent(s)).join('/')}`;

        try {
          setRecentStatus('', `Henter kortdata for ${orgKey}/${slug}‚Ä¶`);
          const resp = await fetch(rawUrl, { cache: 'no-store' });
          if (!resp.ok) {
            throw new Error('Fant ikke data.json for '+orgKey+'/'+slug);
          }
          const data = await resp.json();
          data.slug = slug;
          if (typeof window._fillFromCardData === 'function') {
            window._fillFromCardData(data);
          }
          setRecentStatus('ok', `Fylte feltene fra ${orgKey}/${slug}.`);
        } catch (e) {
          setRecentStatus('err', 'Kunne ikke hente kort: ' + (e.message || e));
        }
      }

      $recentList?.addEventListener('click', (evt)=>{
        const link = evt.target.closest('[data-recent-card]');
        if (!link) return;
        evt.preventDefault();
        const slug = link.getAttribute('data-slug') || '';
        if (!slug) return;
        loadCardIntoForm(slug);
      });

      $recentBtn?.addEventListener('click', ()=> fetchRecentFiles(RECENT_DEFAULT_SHOW, false));
      $recentMoreBtn?.addEventListener('click', ()=>{
        if (!_recentAllItems.length) return;
        renderItems(_recentAllItems, _recentAllItems.length);
        setRecentStatus('ok','Viser alle.');
      });
      $switchToCards?.addEventListener('click', (e)=>{
        e.preventDefault();
        _recentMode = _recentMode === 'cards' ? 'files' : 'cards';
        fetchRecentFiles(RECENT_DEFAULT_SHOW, false);
      });

      ['ghUser','ghRepo','basePath','orgKey','slug'].forEach(id=>{
        const el = document.getElementById(id);
        el?.addEventListener('input', () => {
          clearTimeout(el.__rfTimer);
          el.__rfTimer = setTimeout(()=> fetchRecentFiles(RECENT_DEFAULT_SHOW, true), 400);
        });
      });

      document.addEventListener('DOMContentLoaded', ()=>{
        setTimeout(()=> fetchRecentFiles(RECENT_DEFAULT_SHOW, true), 800);
      });
    </script>

    <!-- =========================
         DEL 4: Firebase Auth + UX
    ========================== -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult,
        GoogleAuthProvider,
        browserLocalPersistence,
        setPersistence
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDypfSLkWWRQh9TFrIjWpYWKmO3dBDnb_s",
        authDomain: "nfcking-bb143.firebaseapp.com",
        projectId: "nfcking-bb143",
        storageBucket: "nfcking-bb143.firebasestorage.app",
        messagingSenderId: "435773344673",
        appId: "1:435773344673:web:0e77e1445209f0adb319e0",
        measurementId: "G-EHN7M5NJJS"
      };

      const app   = initializeApp(firebaseConfig);
      const auth  = getAuth(app);
      const db    = getFirestore(app);

      const $ = (id)=>document.getElementById(id);
      const authSec = $('auth');
      const appSec  = $('app');
      const btnGoogle = $('btnGoogle');
      const loginStatusMessage = $('authStatusMessage');
      const orgAccessStatus = $('orgAccessStatus');

      const SUPERADMIN_EMAILS = new Set(['trygve.waagen@gmail.com']);
      const googleProvider = new GoogleAuthProvider();
      googleProvider.setCustomParameters({ prompt: 'select_account' });

      async function ensurePersistence(){
        if (ensurePersistence._done) return;
        try {
          await setPersistence(auth, browserLocalPersistence);
        } catch (err) {
          console.warn('Kunne ikke sette auth-persistens', err);
        }
        ensurePersistence._done = true;
      }

      function setLoginStatus(message, tone = ''){
        if (!loginStatusMessage) return;
        loginStatusMessage.textContent = message || '';
        loginStatusMessage.classList.remove('ok', 'err');
        if (tone === 'ok') loginStatusMessage.classList.add('ok');
        else if (tone === 'err') loginStatusMessage.classList.add('err');
      }
      const ORG_KEY_PATTERN = /^[A-Za-z0-9_-]+$/;
      const orgAccessState = {
        all: false,
        values: [],
        set(list = [], all = false) {
          const unique = Array.from(new Set((Array.isArray(list) ? list : []).filter(Boolean)));
          this.values = unique;
          this.all = !!all;
        },
        has(key) {
          if (this.all) return true;
          if (!key) return false;
          return this.values.includes(key);
        },
      };

      function setOrgAccessMessage(message){
        if (!orgAccessStatus) return;
        orgAccessStatus.textContent = message || '';
      }

      function parseOrgList(input){
        const raw = Array.isArray(input) ? input : String(input || '').split(/[,\s]+/);
        const set = new Set();
        raw.forEach((entry) => {
          if (entry === null || entry === undefined) return;
          const value = String(entry).trim();
          if (!value) return;
          if (!ORG_KEY_PATTERN.test(value)) return;
          set.add(value);
        });
        return Array.from(set);
      }

      function collectOrgClaims(claims = {}){
        const bag = [];
        if (Array.isArray(claims.orgs)) bag.push(...claims.orgs);
        else if (typeof claims.orgs === 'string') bag.push(claims.orgs);
        if (Array.isArray(claims.orgKeys)) bag.push(...claims.orgKeys);
        if (Array.isArray(claims.orgAccess)) bag.push(...claims.orgAccess);
        if (typeof claims.orgKey === 'string') bag.push(claims.orgKey);
        if (typeof claims.org === 'string') bag.push(claims.org);
        return parseOrgList(bag);
      }

      function hasOrgAccess(key){
        return orgAccessState.has(key);
      }

      function describeAccess(map){
        const keys = Object.keys(map || {});
        if (orgAccessState.all) {
          return keys.length ? `Tilgang til alle (${keys.length}) organisasjoner.` : 'Ingen organisasjoner funnet.';
        }
        if (orgAccessState.values.length) {
          return keys.length ? `Tilgang til: ${keys.join(', ')}` : 'Ingen av dine tildelte organisasjoner ble funnet.';
        }
        return 'Du har ikke tildelte organisasjoner. Kontakt administrator.';
      }

      function enforceOrgSelection(){
        const orgInput = $('orgKey');
        const orgSelect = $('orgSelect');
        if (!orgInput) return;
        const current = (orgInput.value || '').trim();
        if (current && hasOrgAccess(current)) {
          if (orgSelect) {
            const idx = Array.from(orgSelect.options).findIndex((opt) => opt.value === current);
            if (idx >= 0) orgSelect.selectedIndex = idx;
          }
          setOrgAccessMessage(describeAccess(window.ORG_PROFILES || {}));
          return;
        }
        let fallback = '';
        if (orgAccessState.all) {
          fallback = orgSelect?.options?.length ? orgSelect.options[0].value : '';
        } else if (orgAccessState.values.length) {
          fallback = orgAccessState.values[0];
        }
        if (fallback && hasOrgAccess(fallback)) {
          orgInput.value = fallback;
          if (orgSelect) {
            const idx = Array.from(orgSelect.options).findIndex((opt) => opt.value === fallback);
            if (idx >= 0) orgSelect.selectedIndex = idx;
          }
          applyBranding('force');
          loadEmployees();
        } else {
          if (orgSelect) orgSelect.selectedIndex = -1;
          orgInput.value = '';
        }
        setOrgAccessMessage(describeAccess(window.ORG_PROFILES || {}));
      }

      async function loadOrgsFromFirestore(){
        try {
          const snap = await getDocs(collection(db, 'orgs'));
          const fetched = {};
          snap.forEach(d => {
            const key  = d.id;
            const data = d.data() || {};
            fetched[key] = {
              name:   data.name   || key,
              accent: data.accent || '#8fd3ff',
              logo:   data.logo   || '',
              site:   data.site   || '',
              logoBg: data.logoBg || '#ffffff'
            };
          });

          let visible = fetched;
          let fallbackAll = false;
          if (orgAccessState.all) {
            if (Object.keys(visible).length === 0) {
              visible = { "DemoOrg": { name:"DemoOrg", accent:"#3ec6ff", logo:"", site:"https://eksempel.no", logoBg:"#ffffff" } };
            }
          } else if (orgAccessState.values.length) {
            const subset = {};
            orgAccessState.values.forEach((key) => {
              if (fetched[key]) subset[key] = fetched[key];
            });
            visible = subset;
          } else {
            visible = fetched;
            fallbackAll = true;
          }

          window.ORG_PROFILES = visible;
          if (fallbackAll) {
            orgAccessState.set(Object.keys(visible), false);
            setOrgAccessMessage(
              Object.keys(visible).length
                ? 'Ingen tildelte organisasjoner funnet ‚Äì viser alle tilgjengelige for n√•.'
                : 'Ingen organisasjoner funnet.'
            );
          } else {
            setOrgAccessMessage(describeAccess(visible));
          }

          window.ORG_PROFILES = visible;
          if (fallbackAll) {
            orgAccessState.set(Object.keys(visible), false);
            setOrgAccessMessage(
              Object.keys(visible).length
                ? 'Ingen tildelte organisasjoner funnet ‚Äì viser alle tilgjengelige for n√•.'
                : 'Ingen organisasjoner funnet.'
            );
          } else {
            setOrgAccessMessage(describeAccess(visible));
          }

          window.ORG_PROFILES = visible;
          setOrgAccessMessage(describeAccess(visible));
        } catch (e) {
          console.warn('Klarte ikke hente orgs fra Firestore:', e);
          if (!window.ORG_PROFILES || Object.keys(window.ORG_PROFILES).length===0){
            if (orgAccessState.all) {
              window.ORG_PROFILES = { "DemoOrg": { name:"DemoOrg", accent:"#3ec6ff", logo:"", site:"https://eksempel.no", logoBg:"#ffffff" } };
            } else {
              window.ORG_PROFILES = {};
            }
          }
          setOrgAccessMessage(describeAccess(window.ORG_PROFILES || {}));
        }
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          authSec?.classList?.remove('hide');
          appSec?.classList?.add('hide');
          orgAccessState.set([], false);
          setOrgAccessMessage('');
          window.ALLOWED_ORGS = { all: false, values: [] };
          setLoginStatus('Logg inn for √• bruke adminpanelet.');
          return;
        }
        let role = 'viewer';
        let claimedOrgs = [];
        try {
          const result = await user.getIdTokenResult(true);
          role = result.claims?.role || 'viewer';
          claimedOrgs = collectOrgClaims(result.claims);
        } catch (err) {
          console.warn('Kunne ikke lese org-claims', err);
        }
        const emailLower = (user.email || '').toLowerCase();
        if (emailLower && SUPERADMIN_EMAILS.has(emailLower)) {
          role = 'superadmin';
        }
        const allowAll = role === 'superadmin';
        orgAccessState.set(claimedOrgs, allowAll);
        window.ALLOWED_ORGS = { all: orgAccessState.all, values: [...orgAccessState.values] };

        await loadOrgsFromFirestore();
        window.populateOrgSelect?.();
        const currentKey = document.getElementById('orgKey')?.value?.trim() || '';
        if (!currentKey || !hasOrgAccess(currentKey)) {
          enforceOrgSelection();
        } else {
          window.syncOrgSelectFromKey?.();
          window.applyBranding?.('auto');
        }
        authSec?.classList?.add('hide');
        appSec?.classList?.remove('hide');
        setLoginStatus(`Innlogget som ${user.email || 'ukjent bruker'}`, 'ok');
      });

      async function finalizeRedirectLogin(){
        try {
          const result = await getRedirectResult(auth);
          if (result?.user) {
            setLoginStatus(`Innlogging fullf√∏rt for ${result.user.email || 'bruker'}`, 'ok');
          }
        } catch (err) {
          console.warn('Feil fra redirect-innlogging', err);
          setLoginStatus('Innlogging via redirect feilet. Pr√∏v igjen.', 'err');
        }
      }

      ensurePersistence();
      finalizeRedirectLogin();

      btnGoogle?.addEventListener('click', async ()=>{
        try {
          await ensurePersistence();
          setLoginStatus('Logger inn‚Ä¶');
          btnGoogle.disabled = true;
          try {
            await signInWithPopup(auth, googleProvider);
            setLoginStatus('Innlogging fullf√∏rt.', 'ok');
          } catch (err) {
            const code = err?.code || err?.message || '';
            console.warn('Google-p√•logging feilet', err);
            if (code.includes('popup-blocked')) {
              setLoginStatus('Popup ble blokkert ‚Äì fors√∏ker redirect‚Ä¶');
              await signInWithRedirect(auth, googleProvider);
            } else if (code.includes('popup-closed')) {
              setLoginStatus('Innlogging ble avbrutt f√∏r den fullf√∏rte.', 'err');
            } else if (code.includes('cancelled-popup-request')) {
              setLoginStatus('Avventer eksisterende popup‚Ä¶');
            } else {
              setLoginStatus('Innlogging feilet: ' + (err?.message || err), 'err');
            }
          }
        } finally {
          btnGoogle.disabled = false;
        }
      });
      window._firebase = { auth, db };
    </script>

    <!-- =========================
         QA / Test-sjekkliste
    ========================== -->
    <section class="card" style="margin:22px auto 28px">
      <details>
        <summary style="cursor:pointer;font-weight:700">üß™ Test-sjekkliste (fold ut)</summary>
        <div class="note" style="margin-top:10px">
          <ul style="margin-top:6px">
            <li><strong>Innlogging:</strong> Google Sign-In fungerer, og appen vises etter login.</li>
            <li><strong>Branding:</strong> Velg <code>Org</code> i select ‚Üí feltene fylles (accent, logo, bg) og logo-forh√•ndsvisning vises.</li>
            <li><strong>Lenker:</strong> Forvalg-knapper legger til rader. Egendefinerte lenker vises i forh√•ndsvisning.</li>
            <li><strong>Vedlegg:</strong> Filer lastes opp via ¬´Last opp filer¬ª-seksjonen. ¬´Last ned¬ª-seksjon kommer fram p√• kortet.</li>
            <li><strong>Generer & publiser:</strong> Etter generering er <code>HTML-URL</code> og <code>NFC-URL</code> utfylt og kan √•pnes/kopieres.</li>
            <li><strong>Banner ¬´Siste opplastede¬ª:</strong> Modus-bytte mellom <em>Vedlegg</em> og <em>Kort</em> fungerer og viser siste endringer.</li>
            <li><strong>Web NFC (Android/Chrome):</strong> Les og skriv virker for valgt modus (URL, Tekst, vCard).</li>
          </ul>
          <p style="margin-top:10px">Tips: Hvis GitHub Pages ikke viser siste endring, vent litt og oppdater. Bruk ¬´Oppdater¬ª-knappen i banneret for fersk commitliste.</p>
        </div>
      </details>
    </section>

  </main>

<script>
(function(){
  // En liten "state" for sist opplastede sti'er i denne √∏kta:
  const filesState = []; // {path, name}
  const $list = document.getElementById("uploadedList");

  function renderList(){
    if (!$list) return;
    if (filesState.length === 0) { $list.innerHTML = ""; return; }
    $list.innerHTML = `
      <h4 style="margin:8px 0 6px">Opplastede filer (denne √∏kten)</h4>
      <ul style="margin:0;padding-left:18px">
        ${filesState.map(f => `
          <li>
            <a href="${f.viewUrl}" target="_blank" rel="noopener">${f.name}</a>
            <button type="button" class="pill" data-del="${encodeURIComponent(f.path)}" style="margin-left:6px">Slett</button>
          </li>
        `).join("")}
      </ul>`;
  }

  async function deleteFile(owner, repo, path, basePath){
    const res = await fetch('/api/deleteFile', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ owner, repo, path, message: 'Delete attachment from admin' })
    });
    if (!res.ok) throw new Error(await res.text());
    // fjern fra state
    const ix = filesState.findIndex(x => x.path === path);
    if (ix >= 0) filesState.splice(ix,1);
    renderList();
  }

  // Hook inn i eksisterende opplasting (etter vellykket opplasting, legg til i state)
  const fileInput = document.getElementById('fileInput');
  if (fileInput) {
    fileInput.addEventListener('change', ()=>{
      // Vi "patcher" global upload-flyt via fetch-override dersom din opplasting bruker /api/uploadFile
      const owner   = (document.getElementById("ghUser")?.value || "Luckywolf82").trim();
      const repo    = (document.getElementById("ghRepo")?.value || "Vcards").trim();
      const baseDir = (document.getElementById("basePath")?.value || "Vcards").replace(/^\/+|\/+$/g,'');
      const orgKey  = (document.getElementById("orgKey")?.value || "Common").trim();
      const slug    = (document.getElementById("slug")?.value || "").trim();
      // N√•r serverless uploaden returnerer 200, regn ut path og listelenke
      // Vi lytter p√• en "customEvent" hvis du allerede har en; ellers fallback: liten timeout og gjenbruk av felt
      setTimeout(()=>{
        const f = fileInput.files?.[0];
        if (!f || !slug) return;
        const relPath = `${baseDir}/${orgKey}/${slug}/files/${encodeURIComponent(f.name)}`;
        const viewUrl = `https://${owner}.github.io/${repo}/${relPath}`;
        filesState.push({ path: `${baseDir}/${orgKey}/${slug}/files/${f.name}`, name: f.name, viewUrl });
        renderList();
      }, 800);
    });
  }

  // Delegert klikk p√• Slett-knapper
  if ($list) {
    $list.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-del]');
      if (!btn) return;
      e.preventDefault();
      const encoded = btn.getAttribute('data-del');
      const path = decodeURIComponent(encoded);
      const owner   = (document.getElementById("ghUser")?.value || "Luckywolf82").trim();
      const repo    = (document.getElementById("ghRepo")?.value || "Vcards").trim();
      try{
        btn.disabled = true; btn.textContent = 'Sletter...';
        await deleteFile(owner, repo, path);
        btn.textContent = 'Slettet';
      }catch(err){
        alert('Sletting feilet: ' + (err?.message || err));
        btn.disabled = false; btn.textContent = 'Slett';
      }
    });
  }
})();
</script>
<script id="hideGhInputs">
document.addEventListener("DOMContentLoaded", ()=>{
  ["ghUser","ghRepo"].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = "none";
    const lab = el.closest("label");
    if (lab) lab.style.display = "none";
  });
});
</script>
<script id="latestCardScript">
(function(){
  const btn  = document.getElementById("btnFetchLatestCard");
  const stat = document.getElementById("latestCardStatus");
  if (!btn) return;

  const gv=id=>(document.getElementById(id)?.value||"").trim();
  const sv=(id,v)=>{ const el=document.getElementById(id); if(el) el.value=v||""; };
  const ts=s=>(s||"").replace(/^\/+|\/+$/g,"");
  const esc=s=>String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]||c));

  async function j(u){
    const r = await fetch(u,{ headers:{ Accept:"application/vnd.github+json" }});
    if(!r.ok) throw new Error(r.status+" "+r.statusText);
    return r.json();
  }

  // Finn siste slug for DIN bruker i /<basePath>/<orgKey>/*/index.html
  async function latest(owner,repo,basePath,orgKey,author){
    const path = encodeURIComponent(ts(basePath)+"/"+orgKey);
    const commits = await j(`https://api.github.com/repos/${owner}/${repo}/commits?path=${path}&author=${encodeURIComponent(author)}&per_page=25`);
    const details = await Promise.all((commits||[]).slice(0,10).map(c => j(c.url).catch(()=>null)));
    let best=null;
    for(const dc of details){
      if(!dc || !Array.isArray(dc.files)) continue;
      const when = dc.commit?.author?.date || dc.commit?.committer?.date || "";
      for(const f of dc.files){
        const p = f.filename||"";
        if(!/\/index\.html$/.test(p)) continue;
        if(!p.includes("/"+orgKey+"/")) continue;
        const parts = p.split("/");
        const slug  = parts[parts.length-2] || "";
        if(!slug) continue;
        if(!best || new Date(when) > new Date(best.when)) best = { slug, when };
      }
    }
    return best?.slug || "";
  }

  function fill(d){
    sv("slug", d.slug);
    sv("name", d.name);
    sv("title", d.title);
    sv("phone", d.phone);
    sv("email", d.email);
    sv("site", d.site);
    sv("address", d.address);
    sv("vcfFilename", d.vcfFilename);
    sv("orgName", d.orgName || d.orgKey);
    sv("accent", d.accent);
    sv("logoUrl", d.logoUrl);
    sv("logoBg", d.logoBg);
    sv("orgSite", d.orgSite || d.site || "");

    const links = Array.isArray(d.links) ? d.links : [];
    if (typeof window._clearLinkRows === "function") {
      window._clearLinkRows();
      if (typeof window._addLinkRow === "function") {
        links.forEach(l => window._addLinkRow(l?.label || "", l?.url || "", l?.pre || "", l?.post || ""));
      }
    } else {
      const tb=document.querySelector("#linksTable tbody");
        if(tb){
          tb.innerHTML="";
          links.forEach(l=>{
            const tr=document.createElement("tr");
            tr.innerHTML=
              `<td><input value="${esc(l?.label||"")}" class="lbl" /></td>`+
              `<td><input value="${esc(l?.url||"")}"   class="lnk" style="width:100%"/></td>`+
              `<td><textarea class="pre" rows="2">${esc(l?.pre||"")}</textarea></td>`+
              `<td><textarea class="post" rows="2">${esc(l?.post||"")}</textarea></td>`+
              `<td><button type="button" class="remove">Fjern</button></td>`;
            tb.appendChild(tr);
          });
        }
    }

    window._latestAttachments = Array.isArray(d.attachments) ? d.attachments : [];
    if (typeof window._setAttachmentsFromData === "function") {
      window._setAttachmentsFromData(window._latestAttachments);
    }
    const orgForEmployee = d.orgKey || gv("orgKey");
    const slugForEmployee = d.slug || "";
    if (orgForEmployee && slugForEmployee) {
      const store = window.EMPLOYEES || (window.EMPLOYEES = {});
      const list = Array.isArray(store[orgForEmployee]) ? store[orgForEmployee] : (store[orgForEmployee] = []);
      const normalizedEmployee = Object.assign({}, d, { orgKey: orgForEmployee, slug: slugForEmployee });
      const matchIndex = list.findIndex(emp => (emp?.slug || emp?._slug || "") === slugForEmployee);
      if (matchIndex >= 0) {
        list[matchIndex] = normalizedEmployee;
      } else {
        list.push(normalizedEmployee);
      }
      window._markEmployeesLoaded?.(orgForEmployee);
      window._refreshEmployeeSelect?.(orgForEmployee, slugForEmployee);
    }
    if (typeof window.previewLogo === "function") { window.previewLogo(); }
  }

  window._fillFromCardData = fill;

  btn.addEventListener("click", async ()=>{
    const owner  = (document.getElementById("ghUser")?.value || "Luckywolf82");
    const repo   = (document.getElementById("ghRepo")?.value || "Vcards");
    const base   = ts(gv("basePath") || "Vcards");
    const orgKey = gv("orgKey");
    const author = (document.getElementById("ghUser")?.value || "Luckywolf82");

    if(!orgKey){ if(stat) stat.textContent="Angi Org key f√∏rst."; return; }

    try{
      if(stat) stat.textContent="Henter siste kort‚Ä¶";
      const slug = await latest(owner,repo,base,orgKey,author);
      if(!slug){ if(stat) stat.textContent="Fant ingen kort nylig oppdatert av deg."; return; }

      const raw = `https://raw.githubusercontent.com/${owner}/${repo}/HEAD/${base}/${orgKey}/${slug}/data.json`;
      const r = await fetch(raw,{ cache:"no-store" });
      if(!r.ok){ if(stat) stat.textContent="Fant slug, men ikke data.json."; return; }

      const d = await r.json();
      d.slug = slug;
      fill(d);
      if(stat) stat.textContent = `Fylte feltene fra: ${orgKey}/${slug}`;
    }catch(e){
      if(stat) stat.textContent = "Feil: " + (e.message||e);
    }
  });
})();
</script>
<script id="linkDelegation">
document.addEventListener("DOMContentLoaded", ()=>{
  const tbody = document.querySelector("#linksTable tbody");
  if(!tbody) return;
  tbody.addEventListener("click", (e)=>{
    const btn = e.target.closest("button.remove");
    if(!btn) return;
    const tr = btn.closest("tr");
    if(tr) tr.remove();
  });
});
</script>
</body>
</html>
