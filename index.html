<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFCKING – Adminpanel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    body{background:#0b0b10;color:#e9eef5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#21c36a;font-weight:700}
    .err{color:#ff6b6b;font-weight:700}
    .note{font-size:.95rem;color:#8ea0b4}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:1px solid #344458}
    .links-table{width:100%;border-collapse:collapse}
    .links-table th,.links-table td{border-bottom:1px solid #2a3442;padding:.3rem;vertical-align:top}
    .muted{color:#8ea0b4}
    code{background:#0d1117;color:#d1e7ff;padding:.2em .4em;border-radius:6px}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .logo-prev{height:36px;max-width:220px;object-fit:contain;margin-left:8px;background:#fff;border-radius:6px;padding:4px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a}
    .brand{text-align:center;margin:0 0 18px}
    .brand img{max-width:240px;height:auto;filter:drop-shadow(0 0 6px #3fffd2)}
    .brand-sub{margin:6px 0 0;color:#8ea0b4}
    .brand-rule{border:0;height:2px;background:linear-gradient(90deg,#8fd3ff,#52a3ff);opacity:.7;margin:10px 0 16px}
    .card{background:#10141b;border:1px solid #1d2430;border-radius:14px;padding:14px}
    input[type="file"]{padding:6px;border:1px dashed #3a4657;border-radius:8px;background:#0f141c;color:#cfe3ff}
  </style>
</head>
<body>
<main>
  <div class="brand">
    <img src="/assets/NFCKING_dark.png" alt="NFCKING logo"
         onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png'">
    <p class="brand-sub">Kongen av kontaktløs – bygg, merk og publiser NFC-kort</p>
  </div>
  <hr class="brand-rule">

  <script>
  // Enkle org-profiler (kan utvides/endres fritt)
  const ORG_PROFILES = {
    "Wayback": {
      name: "Wayback",
      accent: "#8fd3ff",
      logo: "https://www.wayback.no/wp-content/uploads/2017/12/logo.png",
      site: "https://wayback.no",
      logoBg: "#ffffff"
    },
    "MollerBil": {
      name: "Møller Bil",
      accent: "#002244",
      logo: "",
      site: "https://www.mollerbil.no"
    },
    "JarwsonsKjokken": {
      name: "Jarwsons kjøkken",
      accent: "#ee5500",
      logo: "",
      site: "https://jarwsons.no"
    }
  };
  </script>

  <!-- ========== ORGANISASJON & PERSON ========== -->
  <section class="card">
    <h2>Organisasjon</h2>
    <div class="row">
      <label>Velg organisasjon
        <select id="orgSelect"></select>
      </label>
      <div class="inline">
        <label style="flex:1">Org key (mappe – case sensitive)
          <input id="orgKey" placeholder="Wayback" required oninput="applyBranding('force'); syncOrgSelectFromKey();">
        </label>
        <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
          <img id="logoPreview" class="logo-prev" alt="logo">
        </div>
      </div>
      <label>Org navn (visning)
        <input id="orgName" placeholder="Wayback">
      </label>
      <label>Org nettside
        <input id="orgSite" placeholder="https://wayback.no">
      </label>
      <label>Logo URL (eller last opp)
        <div style="display:flex;gap:6px;align-items:center">
          <input id="logoUrl" placeholder="https://.../logo.png" oninput="previewLogo()" style="flex:1">
          <input type="file" id="logoFile" accept="image/*" onchange="handleLocalLogoUpload(event)">
        </div>
      </label>
      <label>Logo bakgrunn
        <input id="logoBg" placeholder="#ffffff (tom = auto)">
      </label>
    </div>

    <h2>Person</h2>
    <div class="row">
      <label>Navn
        <input id="name" placeholder="Fornavn Etternavn" required>
      </label>
      <label>Tittel
        <input id="title" placeholder="Stilling">
      </label>
      <label>Telefon (E.164)
        <input id="phone" placeholder="+47 40000000">
      </label>
      <label>E-post
        <input id="email" placeholder="navn@firma.no">
      </label>
      <label>Nettside
        <input id="site" placeholder="https://firma.no">
      </label>
      <label>Slug (URL-mappe uten æøå/mellomrom)
        <input id="slug" placeholder="fornavn" required>
      </label>
      <label>VCF-filnavn
        <input id="vcfFilename" placeholder="fornavn_firma.vcf">
      </label>
    </div>
  </section>

  <!-- ========== LENKER ========== -->
  <section class="card" style="margin-top:16px">
    <h2>Lenker og knapper</h2>
    <div class="row">
      <label>Forhåndsvalg (klikk for å legge til)</label>
      <div>
        <button type="button" class="pill" data-label="LinkedIn"  data-url="https://www.linkedin.com/in/">LinkedIn</button>
        <button type="button" class="pill" data-label="Instagram" data-url="https://instagram.com/">Instagram</button>
        <button type="button" class="pill" data-label="Facebook"  data-url="https://facebook.com/">Facebook</button>
        <button type="button" class="pill" data-label="YouTube"   data-url="https://youtube.com/@">YouTube</button>
        <button type="button" class="pill" data-label="TikTok"    data-url="https://www.tiktok.com/@">TikTok</button>
        <button type="button" class="pill" data-label="GitHub"    data-url="https://github.com/">GitHub</button>
        <button type="button" class="pill" data-label="Nettside"  data-url="https://">Nettside</button>
        <button type="button" class="pill" data-label="Kalender"  data-url="https://cal.com/">Kalender</button>
        <button type="button" class="pill" data-label="WhatsApp"  data-url="https://wa.me/">WhatsApp</button>
      </div>
    </div>
    <table class="links-table" id="linksTable">
      <thead>
        <tr>
          <th>Label</th>
          <th>URL</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="row">
      <label>Ny label
        <input id="newLabel" placeholder="LinkedIn">
      </label>
      <label>Ny URL
        <input id="newUrl" placeholder="https://linkedin.com/in/...">
      </label>
      <div><button type="button" id="addLink">Legg til</button></div>
    </div>
  </section>

  <!-- ========== LIVE PREVIEW (GENERERT HTML) ========== -->
  <section id="live" class="card" style="margin-top:16px">
    <h2>Live forhåndsvisning av HTML-kort</h2>
    <p class="note">Viser den genererte index.html for kortet (logo/lenker osv.).</p>
    <iframe id="livePreviewFrame"
            style="width:100%;height:360px;border:0;border-radius:8px;background:#111"
            title="Live Preview"></iframe>
  </section>

  <!-- ========== FYSISKE KORT – MOCKUPS (ADMIN) ========== -->
  <section id="mockups" class="card" style="margin-top:16px">
    <h2>Fysiske kort – mockup</h2>

    <style>
      #mockups .mock-card{background:#0f1216;border:1px solid #1d2430;border-radius:14px;padding:16px}
      #mockups .two-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px}
      @media(max-width:980px){#mockups .two-cards{grid-template-columns:1fr}}
      #mockups canvas.mock-canvas{width:100%;height:auto;max-width:100%;border-radius:14px;display:block;background:#111}
      #mockups .row-ctrl{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:end}
    </style>

    <div class="row-ctrl">
      <label>Stil
        <select id="mkStyle">
          <option value="dark" selected>Dark</option>
          <option value="light">Light</option>
          <option value="red">Red</option>
        </select>
      </label>
      <div>
        <label>Logo-størrelse (%)
          <input id="mkSize" type="range" min="20" max="100" step="1" value="64">
        </label>
      </div>
      <div>
        <button class="pill" id="mkDownloadFront" type="button">Last ned forside</button>
        <button class="pill" id="mkDownloadBack"  type="button">Last ned bakside</button>
      </div>
    </div>

    <div class="mock-card" style="margin-top:8px">
      <div class="two-cards">
        <canvas id="mkFront" class="mock-canvas" width="860" height="540"></canvas>
        <canvas id="mkBack"  class="mock-canvas" width="860" height="540"></canvas>
      </div>
      <p class="note" style="margin:8px 0 0">
        Logo fylles fra midten av kortet. Velg stil (Dark/Light/Red). Eksport er rene PNG-bilder.
      </p>
    </div>
  </section>

  <!-- ========== GENERERING & PUBLISERING ========== -->
  <section id="generate" class="card" style="margin-top:16px">
    <h2>Generer filer & publiser</h2>

    <div class="row">
      <label>GitHub owner
        <input id="ghUser" placeholder="Luckywolf82" />
      </label>
      <label>Repo-navn
        <input id="ghRepo" placeholder="Vcards" />
      </label>
      <label>BASE_PATH (Pages-rotmappe)
        <input id="basePath" placeholder="Vcards" value="Vcards" />
      </label>
      <label>Commit-strategi
        <select id="strategy">
          <option value="pr">Branch + Pull Request</option>
          <option value="direct">Direkte til main</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>Org mappe (case sensitive)
        <input id="orgKeyGen" placeholder="Wayback" />
      </label>
      <label>Slug (URL-mappe uten æøå/mellomrom)
        <input id="slug" placeholder="fornavn" />
      </label>
      <label>VCF-filnavn
        <input id="vcfFilename" placeholder="fornavn_org.vcf" />
      </label>
    </div>

    <div class="row">
      <div>
        <button id="btnGenerate" class="btn" type="button">Generer & forhåndsvis</button>
        <button id="btnPublish" class="pill" type="button">Publiser til GitHub</button>
      </div>
      <div id="genStatus" class="note"></div>
    </div>

    <h3>Resultat</h3>
    <p>NFC-URL (VCF): <input id="nfcUrl" style="width:100%" readonly></p>
    <p>HTML-URL: <input id="htmlUrl" style="width:100%" readonly></p>

    <h4>vCard</h4>
    <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

    <h4>index.html</h4>
    <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>
  </section>

  <!-- ========== NFC (Web NFC – Chrome/Android) ========== -->
  <section id="nfc" class="card" style="margin-top:16px">
    <h2>NFC (Web NFC – Chrome/Android)</h2>
    <p class="note">Web NFC fungerer på Chrome/Android. Hold taggen mot telefonen når du skriver.</p>
    <div class="row">
      <label>
        Skriv type
        <select id="nfcWriteSource">
          <option value="html" selected>HTML-URL (åpner landingssida for kortet)</option>
          <option value="vcf">VCF-URL (nedlasting av kontaktfil)</option>
        </select>
      </label>
      <div>
        <button id="btnNfcWrite" class="btn" type="button">Skriv til NFC</button>
      </div>
    </div>
    <div id="nfcStatus" class="note" style="margin-top:6px"></div>
  </section>

  <!-- ========== SCRIPTS ========== -->
  <script>
    // ---- dropdown for org ----
    function populateOrgSelect(){
      const orgSelect = document.getElementById('orgSelect');
      if(!orgSelect) return;
      orgSelect.innerHTML = '';
      Object.keys(ORG_PROFILES).forEach(key=>{
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = ORG_PROFILES[key].name || key;
        orgSelect.appendChild(opt);
      });
      // standard velg første
      if(orgSelect.options.length) orgSelect.selectedIndex = 0;
      syncOrgKeyFromSelect();
    }
    function syncOrgKeyFromSelect(){
      const key = document.getElementById('orgSelect')?.value;
      if(key) {
        document.getElementById('orgKey').value = key;
        applyBranding('force');
      }
    }
    function syncOrgSelectFromKey(){
      const key = document.getElementById('orgKey')?.value;
      const orgSelect = document.getElementById('orgSelect');
      if(!orgSelect || !key) return;
      const idx = Array.from(orgSelect.options).findIndex(o => o.value === key);
      if(idx>=0) orgSelect.selectedIndex = idx;
    }

    // ---- branding ----
    function applyBranding(mode = 'auto'){
      const key = document.getElementById('orgKey').value.trim();
      const prof = ORG_PROFILES[key];
      if(!prof) return;
      const set = (id, val) => {
        const el = document.getElementById(id);
        if(!el) return;
        if(mode==='force' || !el.value) el.value = val || '';
      };
      set('orgName', prof.name || key);
      set('orgSite', prof.site || '');
      set('logoUrl', prof.logo || '');
      if(mode==='force' && prof.logoBg && !document.getElementById('logoBg').value){
        document.getElementById('logoBg').value = prof.logoBg;
      }
      previewLogo();
    }
    function previewLogo(){
      const url = document.getElementById('logoUrl').value.trim();
      const imgEl = document.getElementById('logoPreview');
      const bgVal = document.getElementById('logoBg').value.trim();
      if(!url){ imgEl.style.display='none'; return; }
      imgEl.src = url;
      imgEl.style.display='block';
      imgEl.style.borderRadius = '8px';
      imgEl.style.padding = '6px';
      if(bgVal) imgEl.style.background = bgVal;
    }
    async function handleLocalLogoUpload(evt){
      const file = evt.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        // bruker DataURL for visning (lagring i repo skjer via Generer/Publiser)
        document.getElementById('logoUrl').value = reader.result;
        previewLogo();
      };
      reader.readAsDataURL(file);
    }

    // ---- lenke-tabell ----
    const tbody = document.querySelector('#linksTable tbody');
    function addRow(label, url){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${label||''}" class="lbl" /></td>
        <td><input value="${url||''}" class="lnk" style="width:100%"/></td>
        <td><button type="button" class="remove">Fjern</button></td>`;
      tr.querySelector('.remove').addEventListener('click', ()=>tr.remove());
      tbody.appendChild(tr);
    }
    document.getElementById('addLink').addEventListener('click', ()=>{
      addRow(
        document.getElementById('newLabel').value,
        document.getElementById('newUrl').value
      );
      ['newLabel','newUrl'].forEach(id=>document.getElementById(id).value='');
    });
    document.querySelectorAll('.pill[data-label]').forEach(btn=>{
      btn.addEventListener('click', ()=> addRow(btn.dataset.label, btn.dataset.url));
    });

    // ---- helpers ----
    const esc = s => (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    function normalizePhone(p){
      p=(p||'').trim(); if(!p) return p;
      if(p.startsWith('0') && !p.startsWith('+')){
        if(p.length <= 8) return '+47' + p.replace(/^0+/, '');
      }
      return p;
    }
    function collectLinks(){
      return Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr=>{
        const label = tr.querySelector('.lbl')?.value.trim();
        const url   = tr.querySelector('.lnk')?.value.trim();
        return (label && url) ? {label, url} : null;
      }).filter(Boolean);
    }

    // ---- vCard & kort-HTML ----
    function makeVcard(d){
      const parts = (d.name||'').trim().split(' ');
      const first = parts[0] || '';
      const last  = parts.length>1 ? parts[parts.length-1] : '';
      const phone = normalizePhone(d.phone||'');
      return [
        'BEGIN:VCARD',
        'VERSION:3.0',
        `FN:${d.name||''}`,
        `N:${last};${first};;;`,
        `ORG:${d.orgName||d.orgKey||''}`,
        `TITLE:${d.title||''}`,
        `TEL;TYPE=CELL:${phone}`,
        `EMAIL;TYPE=INTERNET:${d.email||''}`,
        `URL:${d.site||''}`,
        'END:VCARD'
      ].join('\\n');
    }
    function makeCardHTML(d, vcfFile, links){
      const accent = d.accent || '#8fd3ff';
      const bgStyle = d.logoBg ? `background:${d.logoBg};border-radius:8px;padding:6px;` : '';
      const logoTag = d.logoUrl ? `<img class="brand-logo" src="${esc(d.logoUrl)}" style="${bgStyle}" alt="${esc(d.orgName||d.orgKey||'')} logo">` : '';
      const extras  = (links||[]).map(l => `<a class="btn" href="${esc(l.url)}" target="_blank" rel="noopener">${esc(l.label)}</a>`).join('\\n');
      return `<!doctype html>
<html lang="no">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kontaktkort – ${esc(d.name||'')}</title>
<style>
:root{--accent:${accent};}
body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}
.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}
.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}
.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.card p{color:#bfc8d6}
code{background:#0d1117;padding:.2em .4em;border-radius:6px}
.brand-logo{max-height:56px;max-width:280px;object-fit:contain;margin:0 0 12px 0;display:block}
</style>
</head>
<body>
<main class="container card">
  ${logoTag}
  <h1>Kontaktkort – ${esc(d.name||'')}</h1>
  <p class="muted">${esc(d.title||'')} · ${esc(d.orgName||d.orgKey||'')}</p>
  <p><a class="btn" href="./${esc(vcfFile)}" download>Last ned vCard (.vcf)</a></p>
  <div class="links">
    ${d.phone? `<a href="tel:${esc(d.phone)}" class="btn">Ring</a>`:''}
    ${d.email? `<a href="mailto:${esc(d.email)}" class="btn">E-post</a>`:''}
    ${d.site?  `<a href="${esc(d.site)}" class="btn" target="_blank">Besøk nettside</a>`:''}
    <a href="../index.html" class="btn">← Tilbake</a>
  </div>
  <div class="links" style="margin-top:10px">${extras}</div>
</main>
</body>
</html>`;
    }
    function updateLivePreview(html){
      const frame=document.getElementById('livePreviewFrame');
      if(!frame) return;
      const doc=frame.contentDocument||frame.contentWindow?.document;
      if(!doc) return;
      doc.open(); doc.write(html); doc.close();
    }

    // ---- Mockups (enkelt: logo midt, base-bilde per stil) ----
    (function(){
      const MK_BASES={ dark:'/assets/dark.png', light:'/assets/light.png', red:'/assets/red.png' };
      const get = id => document.getElementById(id);
      const val = id => (get(id)?.value||'').trim();
      function loadImg(url){
        return new Promise((res,rej)=>{
          const i=new Image();
          i.crossOrigin='anonymous';
          i.onload=()=>res(i);
          i.onerror=rej;
          i.src=url;
        });
      }
      async function renderCard(canvas, style, logoUrl){
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const base = await loadImg(MK_BASES[style]||MK_BASES.dark);
        ctx.drawImage(base, 0, 0, canvas.width, canvas.height);
        if(logoUrl){
          const img = await loadImg(logoUrl);
          const pct = parseFloat(val('mkSize')||'64')/100;
          const size = Math.min(canvas.width, canvas.height) * pct;
          const x = (canvas.width - size)/2;
          const y = (canvas.height - size)/2;
          ctx.drawImage(img, x, y, size, size);
        }
      }
      async function updateMockups(){
        const style = val('mkStyle') || 'dark';
        const logo  = val('logoUrl') || '/assets/NFCKING_dark.png';
        await renderCard(get('mkFront'), style, logo);
        await renderCard(get('mkBack'),  style, logo);
      }
      ['mkStyle','mkSize','logoUrl'].forEach(id=>{
        get(id)?.addEventListener('input', updateMockups);
        get(id)?.addEventListener('change', updateMockups);
      });
      get('mkDownloadFront')?.addEventListener('click', ()=>{
        const cnv = document.getElementById('mkFront');
        const a=document.createElement('a'); a.href=cnv.toDataURL('image/png'); a.download='kort-forside.png'; a.click();
      });
      get('mkDownloadBack')?.addEventListener('click', ()=>{
        const cnv = document.getElementById('mkBack');
        const a=document.createElement('a'); a.href=cnv.toDataURL('image/png'); a.download='kort-bakside.png'; a.click();
      });
      window.addEventListener('DOMContentLoaded', updateMockups);
      window._updateMockups = updateMockups; // for trigging frå andre felt
    })();

    // ---- Generer & publiser ----
    function collectForm(){
      const g = id => document.getElementById(id)?.value.trim() || '';
      const orgKey = g('orgKey') || g('orgKeyGen');
      return {
        orgKey,
        orgName: document.getElementById('orgSelect')?.selectedOptions[0]?.textContent.trim() || orgKey,
        name: g('name'),
        title: g('title'),
        phone: g('phone'),
        email: g('email'),
        site: g('site'),
        logoUrl: g('logoUrl'),
        logoBg: g('logoBg') || '',
        accent: '#8fd3ff',
        vcfFilename: g('vcfFilename') || `${(g('slug')||'person')}_${(orgKey||'org')}.vcf`,
        slug: g('slug'),
        ghUser: g('ghUser'),
        ghRepo: g('ghRepo'),
        basePath: g('basePath') || 'Vcards',
        strategy: document.getElementById('strategy')?.value || 'pr'
      };
    }
    document.getElementById('btnGenerate').addEventListener('click', ()=>{
      const d = collectForm();
      if(!d.orgKey || !d.slug || !d.name){
        alert('Mangler: orgKey, slug, name'); return;
      }
      const links = collectLinks();
      const vcf  = makeVcard(d);
      const html = makeCardHTML(d, d.vcfFilename, links);
      document.getElementById('vcfPreview').value  = vcf;
      document.getElementById('htmlPreview').value = html;
      const owner = d.ghUser || '<owner>';
      const repo  = d.ghRepo || '<repo>';
      const base  = (d.basePath||'Vcards').replace(/^\/+|\/+$/g,'');
      const path  = base ? `/${base}` : '';
      const baseUrl = `https://${owner}.github.io/${repo}${path}/${d.orgKey}/${d.slug}`;
      const htmlUrl = `${baseUrl}/index.html`;
      const vcfUrl  = `${baseUrl}/${d.vcfFilename}`;
      document.getElementById('nfcUrl').value  = vcfUrl;
      document.getElementById('htmlUrl').value = htmlUrl;
      updateLivePreview(html);
      document.getElementById('genStatus').textContent = '✅ Generert lokalt. Du kan publisere nå.';
      if(window._updateMockups) setTimeout(window._updateMockups,80);
    });
    async function postJSON(url, data){
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
      const t = await r.text();
      try{ return {ok:r.ok,status:r.status,json:JSON.parse(t)} } catch{ return {ok:r.ok,status:r.status,text:t} }
    }
    document.getElementById('btnPublish').addEventListener('click', async ()=>{
      const d = collectForm();
      const vcf  = document.getElementById('vcfPreview').value;
      const html = document.getElementById('htmlPreview').value;
      if(!vcf || !html){ alert('Klikk "Generer & forhåndsvis" først.'); return; }
      const prefix = d.basePath ? (d.basePath.replace(/^\/+|\/+$/g,'') + '/') : '';
      const payload = {
        repoOwner: d.ghUser || undefined,
        repoName:  d.ghRepo || undefined,
        basePath:  d.basePath,
        orgKey:    d.orgKey,
        slug:      d.slug,
        files: [
          { path: `${prefix}${d.orgKey}/${d.slug}/${d.vcfFilename}`, content: vcf  },
          { path: `${prefix}${d.orgKey}/${d.slug}/index.html`,       content: html },
          { path: `${prefix}${d.orgKey}/${d.slug}/data.json`,        content: JSON.stringify({ ...d, links: collectLinks() }, null, 2) },
          { path: `${prefix}.nojekyll`,                              content: ""   }
        ],
        strategy: d.strategy,
        commitMessage: `Add/Update card: ${d.orgKey}/${d.slug}`
      };
      const s = document.getElementById('genStatus');
      s.textContent = 'Publiserer…';
      try{
        const res = await postJSON('/api/createCard', payload);
        if(res.ok){
          s.textContent = '✅ Publisert! Sjekk GitHub Pages om 30–60 sek.';
        }else{
          const msg = res.json?.error || res.text || 'Ukjent feil';
          s.textContent = '❌ Feil: ' + msg;
        }
      }catch(e){
        s.textContent = '❌ Nettverksfeil: ' + e.message;
      }
    });

    // ---- NFC skriv ----
    (function(){
      const $ = (id) => document.getElementById(id);
      const statusEl = $('nfcStatus');
      function pickUrl(){
        const src = $('nfcWriteSource')?.value || 'html';
        const htmlUrl = $('htmlUrl')?.value?.trim();
        const vcfUrl  = $('nfcUrl')?.value?.trim();
        return (src === 'vcf') ? vcfUrl : htmlUrl;
      }
      async function writeNfcUrl(){
        statusEl.textContent = '';
        const url = pickUrl();
        if(!url){
          statusEl.textContent = '❌ Manglar URL. Klikk "Generer & forhåndsvis" først.';
          return;
        }
        if(!('NDEFReader' in window)){
          statusEl.textContent = '❌ Denne nettlesaren støttar ikkje Web NFC. Bruk Chrome på Android.';
          return;
        }
        try{
          const ndef = new NDEFReader();
          statusEl.textContent = 'Hold taggen nær telefonen …';
          await ndef.write(url);
          statusEl.textContent = '✅ Skreiv URL til taggen!';
        }catch(err){
          console.error(err);
          statusEl.textContent = '❌ Klarte ikkje skrive til taggen: ' + (err?.message || err);
        }
      }
      $('btnNfcWrite')?.addEventListener('click', writeNfcUrl);
    })();

    // ---- init ----
    document.addEventListener('DOMContentLoaded', ()=>{
      populateOrgSelect();
      applyBranding('force');
      const lu = document.getElementById('logoUrl')?.value.trim();
      if (lu) previewLogo();
    });
  </script>
</main>
</body>
</html>
