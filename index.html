<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>vCards Admin – Branding + Tekst pr. knapp</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#0a0;font-weight:700}
    .err{color:#a00;font-weight:700}
    .note{font-size:.9rem;color:#667}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#eef;color:#334;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:none}
    .links-table{width:100%;border-collapse:collapse}
    .links-table th,.links-table td{border-bottom:1px solid #e3e3e3;padding:.3rem;vertical-align:top}
    .muted{color:#76808f}
    code{background:#0d1117;color:#d1e7ff;padding:.2em .4em;border-radius:6px}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .logo-prev{height:36px;max-width:220px;object-fit:contain;margin-left:8px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700}
  </style>
</head>
<body>
<main>
  <h1>vCards Admin – Multi-tenant med branding</h1>
  <p class="note">Auto-fyll logo/farger fra organisasjonsprofil. Legg til ubegrensa lenker og <b>tekst over/under hver knapp</b>.</p>

  <details>
    <summary>Oppsett (engang):</summary>
    <ol>
      <li>Deploy på Netlify. Sett env-vars <code>GITHUB_TOKEN</code> (+ valgfritt <code>GITHUB_OWNER</code>, <code>GITHUB_REPO</code>, <code>BASE_PATH</code>).</li>
      <li>Rediger <code>ORG_PROFILES</code> i denne fila for å legge inn standard logo/farger per organisasjon.</li>
    </ol>
  </details>

  <script>
  // === Branding-profiler per organisasjon (rediger/utvid her) ===
  const ORG_PROFILES = {
    "Wayback": {
      name: "Wayback",
      accent: "#8fd3ff",
      logo: "https://www.wayback.no/wp-content/uploads/2017/12/logo.png",
      site: "https://wayback.no"
    },
    "MollerBil": {
      name: "Møller Bil",
      accent: "#002244",
      logo: "",
      site: "https://www.mollerbil.no"
    },
    "JarwsonsKjokken": {
      name: "Jarwsons kjøkken",
      accent: "#ee5500",
      logo: "",
      site: "https://jarwsons.no"
    }
  };
  </script>

  <h2>Organisasjon</h2>
  <div class="row">
    <div class="inline">
      <label style="flex:1">Org key (mappe – case sensitive)
        <input id="orgKey" placeholder="Wayback" required oninput="applyBranding(true)">
      </label>
      <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
        <img id="logoPreview" class="logo-prev" alt="logo">
      </div>
    </div>
    <label>Org navn (visning)
      <input id="orgName" placeholder="Wayback">
    </label>
    <label>Accent farge (hex)
      <input id="accent" placeholder="#8fd3ff">
    </label>
    <label>Org nettside
      <input id="orgSite" placeholder="https://wayback.no">
    </label>
    <label>Logo URL (valgfri)
      <input id="logoUrl" placeholder="https://.../logo.png" oninput="previewLogo()">
    </label>
    <label>Logo bakgrunn (valgfri)
  <input id="logoBg" placeholder="#ffffff (tom = auto)">
</label>

  </div>

  <h2>Person</h2>
  <div class="row">
    <label>Slug (mappe/URL uten æøå/mellomrom)
      <input id="slug" placeholder="Trygve" required>
    </label>
    <label>Navn
      <input id="name" placeholder="Trygve Eiulf Waagen" required>
    </label>
    <label>Tittel
      <input id="title" placeholder="Daglig leder">
    </label>
    <label>Telefon (E.164)
      <input id="phone" placeholder="+47 47731087">
    </label>
    <label>E-post
      <input id="email" placeholder="trygve@wayback.no">
    </label>
    <label>Nettside
      <input id="site" placeholder="https://wayback.no">
    </label>
    <label>Adresse
      <input id="address" placeholder="Kongens gate 46, 7012 Trondheim, Norge">
    </label>
    <label>VCF-filnavn (valgfri)
      <input id="vcfFilename" placeholder="trygve_wayback.vcf">
    </label>
  </div>

  <h2>Lenker og tekster</h2>
  <div class="row">
    <label>Forhåndsvalg (klikk for å legge til)</label>
    <div>
      <button type="button" class="pill" data-label="LinkedIn" data-url="https://www.linkedin.com/in/">LinkedIn</button>
      <button type="button" class="pill" data-label="Instagram" data-url="https://instagram.com/">Instagram</button>
      <button type="button" class="pill" data-label="Facebook" data-url="https://facebook.com/">Facebook</button>
      <button type="button" class="pill" data-label="YouTube" data-url="https://youtube.com/@">YouTube</button>
      <button type="button" class="pill" data-label="TikTok" data-url="https://www.tiktok.com/@">TikTok</button>
      <button type="button" class="pill" data-label="GitHub" data-url="https://github.com/">GitHub</button>
      <button type="button" class="pill" data-label="Nettside" data-url="https://">Nettside</button>
      <button type="button" class="pill" data-label="Kalender" data-url="https://cal.com/">Kalender</button>
      <button type="button" class="pill" data-label="WhatsApp" data-url="https://wa.me/">WhatsApp</button>
    </div>
  </div>
  <table class="links-table" id="linksTable">
    <thead><tr><th>Label</th><th>URL</th><th>Tekst over</th><th>Tekst under</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="row">
    <label>Ny label<input id="newLabel" placeholder="LinkedIn"></label>
    <label>Ny URL<input id="newUrl" placeholder="https://linkedin.com/in/..."></label>
    <label>Tekst over<input id="newPre" placeholder="Følg meg på LinkedIn"></label>
    <label>Tekst under<input id="newPost" placeholder="@brukernavn (daglig oppdatert)"></label>
    <div><button type="button" id="addLink">Legg til</button></div>
  </div>

  <h2>Publisering</h2>
  <div class="row">
    <label>GitHub owner (kan overskrive Netlify default)
      <input id="ghUser" placeholder="Luckywolf82">
    </label>
    <label>Repo-navn (case sensitive)
      <input id="ghRepo" placeholder="Vcards">
    </label>
    <label>BASE_PATH (Pages-rotmappe)
      <input id="basePath" placeholder="Vcards" value="Vcards">
    </label>
    <label>Commit-strategi
      <select id="strategy">
        <option value="pr">Lage branch + Pull Request (anbefalt)</option>
        <option value="direct">Direkte til main</option>
      </select>
    </label>
  </div>

  <button id="generate">Generer & Publiser</button>
  <span id="status"></span>

  <h3>Resultat</h3>
  <p>NFC-URL: <input id="nfcUrl" style="width:100%" readonly></p>

  <h4>vCard</h4>
  <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

  <h4>index.html</h4>
  <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>
<!-- === LIVE FORHÅNDSVISNING === -->
<div id="livePreviewContainer" style="margin-top:10px;">
  <h4>Live forhåndsvisning</h4>
  <button id="openPreviewBtn" style="margin:6px 0;">Åpne forhåndsvisning i ny fane</button>
  <iframe id="livePreviewFrame"
          style="width:100%;height:480px;border:1px solid #333;border-radius:8px;background:#111;"
          title="Live Preview"></iframe>
</div>
<!-- === /LIVE FORHÅNDSVISNING === -->

  <script>
// === Tabell og lenker ===
const tbody = document.querySelector('#linksTable tbody');

function addRow(label, url, pre = '', post = '') {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${label || ''}" class="lbl" /></td>
    <td><input value="${url || ''}" class="lnk" style="width:100%"/></td>
    <td><textarea class="pre" rows="2" placeholder="Tekst over">${pre || ''}</textarea></td>
    <td><textarea class="post" rows="2" placeholder="Tekst under">${post || ''}</textarea></td>
    <td><button type="button" class="remove">Fjern</button></td>
  `;
  tr.querySelector('.remove').addEventListener('click', () => tr.remove());
  tbody.appendChild(tr);
}

document.getElementById('addLink').addEventListener('click', () => {
  addRow(
    document.getElementById('newLabel').value,
    document.getElementById('newUrl').value,
    document.getElementById('newPre').value,
    document.getElementById('newPost').value
  );
  ['newLabel','newUrl','newPre','newPost'].forEach(id => document.getElementById(id).value = '');
});

document.querySelectorAll('.pill').forEach(btn => {
  btn.addEventListener('click', () => addRow(btn.dataset.label, btn.dataset.url));
});

// === Branding ===
function applyBranding(force = true){
  const key  = document.getElementById('orgKey').value.trim();
  const prof = ORG_PROFILES[key];
  if (!prof) return;

  document.getElementById('orgName').value = prof.name   || key;
  document.getElementById('accent').value  = prof.accent || '#8fd3ff';
  document.getElementById('orgSite').value = prof.site   || '';
  document.getElementById('logoUrl').value = prof.logo   || '';
  previewLogo();
}

function previewLogo(){
  const url = document.getElementById('logoUrl').value.trim();
  const imgEl = document.getElementById('logoPreview');
  const bgInput = document.getElementById('logoBg');
  const manual = bgInput?.value.trim();

  if(!url){
    imgEl.style.display='none';
    return;
  }

  // Vis logo + default bakgrunn umiddelbart (best effort)
  imgEl.src = url;
  imgEl.style.display='block';

  // Hvis manuell farge er satt → bruk den og stopp
  if (manual) {
    imgEl.style.background   = manual;
    imgEl.style.borderRadius = '8px';
    imgEl.style.padding      = '6px';
    return;
  }

  // Default til hvit bakgrunn først (synlig og trygt)
  let chosenBg = '#ffffff';
  imgEl.style.background   = chosenBg;
  imgEl.style.borderRadius = '8px';
  imgEl.style.padding      = '6px';

  // Prøv automatisk analyse (kan feile pga CORS)
  const tmp = new Image();
  tmp.crossOrigin = 'anonymous';   // krever CORS-headere fra server
  tmp.src = url;

  const finish = (bg) => {
    chosenBg = bg || chosenBg;
    imgEl.style.background = chosenBg;
    // Skriv tilbake valgt farge i input, så blir den med i generert HTML
    if (bgInput && !bgInput.value) bgInput.value = chosenBg;
  };

  const analyze = () => {
    try {
      const c = document.createElement('canvas');
      const s = 24;
      c.width = s; c.height = s;
      const ctx = c.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(tmp, 0, 0, s, s);

      // Hent pikslene – kan kaste ved CORS → fanges i catch
      const data = ctx.getImageData(0,0,s,s).data;

      let r=0,g=0,b=0,n=0;
      for(let i=0;i<data.length;i+=4){
        const a = data[i+3];
        if (a < 16) continue; // hopp over nesten transparente
        r += data[i]; g += data[i+1]; b += data[i+2]; n++;
      }
      if (n === 0) { finish('#ffffff'); return; }

      r = Math.round(r/n); g = Math.round(g/n); b = Math.round(b/n);
      const L = 0.2126*r + 0.7152*g + 0.0722*b;

      // Justér terskel litt romsligere
      const autoBg = (L < 150) ? '#ffffff' : '#1e1f28';
      finish(autoBg);
    } catch (e) {
      // CORS eller annen feil → behold hvit
      finish('#ffffff');
    }
  };

  tmp.onload = analyze;
  tmp.onerror = () => finish('#ffffff');

  // Sikkerhetsnett: hvis onload ikke fyrer (rare cache-tilfeller), sett hvit etter 1.5s
  setTimeout(() => {
    if (!bgInput.value) finish('#ffffff');
  }, 1500);
}


  if(!url){ imgEl.style.display='none'; return; }
  imgEl.src = url; 
  imgEl.style.display='block';

  // Manuell bakgrunnsfarge
  if (manual) {
    imgEl.style.background = manual;
    imgEl.style.borderRadius = '8px';
    imgEl.style.padding = '6px';
    return;
  }

  // Automatisk fargeanalyse
  const tmp = new Image();
  tmp.crossOrigin = 'anonymous';
  tmp.src = url;
  tmp.onload = () => {
    try {
      const c = document.createElement('canvas');
      const s = 24;
      c.width = s; c.height = s;
      const ctx = c.getContext('2d');
      ctx.drawImage(tmp, 0, 0, s, s);
      const data = ctx.getImageData(0,0,s,s).data;

      let r=0,g=0,b=0,n=0;
      for(let i=0;i<data.length;i+=4){
        const a = data[i+3];
        if (a < 10) continue; // hopp over transparente pixler
        r += data[i]; g += data[i+1]; b += data[i+2]; n++;
      }
      if (n === 0) { imgEl.style.background='transparent'; return; }
      r = Math.round(r/n); g = Math.round(g/n); b = Math.round(b/n);

      const L = 0.2126*r + 0.7152*g + 0.0722*b;
      const autoBg = (L < 120) ? '#ffffff' : '#1e1f28';
      imgEl.style.background   = autoBg;
      imgEl.style.borderRadius = '8px';
      imgEl.style.padding      = '6px';
    } catch(e){
      imgEl.style.background   = '#ffffff';
      imgEl.style.borderRadius = '8px';
      imgEl.style.padding      = '6px';
    }
  };
}


// === vCard/HTML helpers ===
function normalizePhone(p){
  p = (p||'').trim(); if(!p) return p;
  if(p.startsWith('0') && !p.startsWith('+')){
    if(p.length <= 8) return '+47' + p.replace(/^0+/, '');
  }
  return p;
}

function makeVcard(d){
  const parts = d.name.trim().split(' ');
  const first = parts[0] || ''; 
  const last  = parts.length>1 ? parts[parts.length-1] : '';
  const phone = normalizePhone(d.phone||'');

  return [
    'BEGIN:VCARD','VERSION:3.0',`FN:${d.name}`,`N:${last};${first};;;`,
    `ORG:${d.orgName||d.orgKey}`,`TITLE:${d.title||''}`,`TEL;TYPE=CELL:${phone}`,
    `EMAIL;TYPE=INTERNET:${d.email||''}`,`URL:${d.site||''}`,`ADR;TYPE=WORK:;;${d.address||''}`,
    'END:VCARD'
  ].join('\n');
}

function esc(s){ return (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

function makeLinksHTML(links){
  if(!links.length) return '';
  return links.map(l => {
    const pre  = l.pre  ? `<div class="pre"  style="margin:8px 0 4px;color:#bfc8d6">${esc(l.pre)}</div>` : '';
    const post = l.post ? `<div class="post" style="margin:4px 0 10px;color:#97a3b6;font-size:.95rem">${esc(l.post)}</div>` : '';
    return `<div class="link-block" style="margin-top:10px">
      ${pre}
      <a class="btn" href="${esc(l.url)}" target="_blank" rel="noopener">${esc(l.label)}</a>
      ${post}
    </div>`;
  }).join('');
}

function makeHTML(d, vcfFile, links){
  const accent  = d.accent || '#8fd3ff';
  const bgStyle = d.logoBg ? `background:${d.logoBg};border-radius:8px;padding:6px;` : '';
const logoTag = d.logoUrl ? `<img class="brand-logo" src="${d.logoUrl}" style="${bgStyle}" alt="${d.orgName||d.orgKey} logo">` : '';
  const extras  = makeLinksHTML(links);

  return `<!doctype html>
<html lang="no">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kontaktkort – ${esc(d.name)}</title>
<style>
:root{--accent:${accent};}
body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}
.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}
.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}
.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.card p{color:#bfc8d6}
code{background:#0d1117;padding:.2em .4em;border-radius:6px}
.brand-logo{max-height:56px;max-width:280px;object-fit:contain;margin:0 0 12px 0;display:block}
</style>
</head>
<body>
<main class="container card">
  ${logoTag}
  <h1>Kontaktkort – ${esc(d.name)}</h1>
  <p class="muted">${esc(d.title||'')} · ${esc(d.orgName||d.orgKey)}</p>
  <p><a class="btn" href="./${vcfFile}" download>Last ned vCard (.vcf)</a></p>
  <div class="links">
    <a href="tel:${esc(d.phone||'')}" class="btn">Ring</a>
    <a href="mailto:${esc(d.email||'')}" class="btn">E-post</a>
    <a href="${esc(d.site||'#')}" class="btn" target="_blank">Besøk nettside</a>
    <a href="../index.html" class="btn">← Tilbake</a>
  </div>
  ${extras}
  <p style="margin-top:14px">Adresse: ${esc(d.address||'')}</p>
  <p style="margin-top:8px;font-size:0.9rem;color:#9aa6b2">NFC-URL: <code id="nfcInline"></code></p>
</main>
</body>
</html>`;
}

// === Netlify helper ===
async function postJSON(url, data){
  const r = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  const t = await r.text();
  try { return { ok:r.ok, status:r.status, json:JSON.parse(t) }; }
  catch { return { ok:r.ok, status:r.status, text:t }; }
}

// === Generer & Publiser ===
document.getElementById('generate').addEventListener('click', async ()=>{
  const get = id => document.getElementById(id).value.trim();
  const d = {
    orgKey:get('orgKey'),
    orgName:get('orgName')||get('orgKey'),
    accent:get('accent')||'#8fd3ff',
    logoUrl:get('logoUrl'),
    logoBg:get('logoBg') || '',
    slug:get('slug'),
    name:get('name'),
    title:get('title'),
    phone:get('phone'),
    email:get('email'),
    site:get('site'),
    address:get('address'),
    vcfFilename:get('vcfFilename') || (get('slug') + '_' + get('orgKey') + '.vcf'),
    ghUser:get('ghUser'),
    ghRepo:get('ghRepo'),
    // VIKTIG: behold 'Vcards' så URL blir "dobbel Vcards" (det vi vet fungerer)
    basePath:get('basePath')||'Vcards',
    strategy:document.getElementById('strategy').value
  };

  if(!d.orgKey || !d.slug || !d.name){
    alert('Mangler: orgKey, slug, name'); 
    return;
  }

  const links = Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr=>({
    label: tr.querySelector('.lbl').value.trim(),
    url:   tr.querySelector('.lnk').value.trim(),
    pre:   tr.querySelector('.pre').value.trim(),
    post:  tr.querySelector('.post').value.trim()
  })).filter(x=>x.label && x.url);

  const vcf  = makeVcard(d);
  const html = makeHTML(d, d.vcfFilename, links);
  document.getElementById('vcfPreview').value  = vcf;
  document.getElementById('htmlPreview').value = html;
updateLivePreview(html);

  // === URL-er (bevisst "dobbel Vcards") ===
  const ownerPart = d.ghUser || '<owner>';
  const repoPart  = d.ghRepo || '<repo>';
  const basePath  = (d.basePath || 'Vcards').replace(/^\/+|\/+$/g, ''); // alltid 'Vcards' som default
  const pathPart  = basePath ? `/${basePath}` : '';

  const baseUrl = `https://${ownerPart}.github.io/${repoPart}${pathPart}/${d.orgKey}/${d.slug}`;
  const htmlUrl = `${baseUrl}/index.html`;
  const vcfUrl  = `${baseUrl}/${d.vcfFilename}`;

  // Vis NFC (VCF) – HTML-url kan du åpne manuelt ved behov
  document.getElementById('nfcUrl').value = vcfUrl;
  const inline = document.getElementById('nfcInline');
  if (inline) inline.textContent = vcfUrl;
// === Legg til felt for HTML-URL (vises sammen med NFC-URL) ===
let htmlOut = document.getElementById('htmlUrl');
if (!htmlOut) {
  const label = document.createElement('p');
  label.textContent = 'HTML-URL:';
  const input = document.createElement('input');
  input.id = 'htmlUrl';
  input.readOnly = true;
  input.style.width = '100%';
  input.style.marginBottom = '6px';
  const nfcP = document.getElementById('nfcUrl').parentElement;
  nfcP.parentElement.insertBefore(label, nfcP);
  nfcP.parentElement.insertBefore(input, nfcP);
  htmlOut = input;
}
htmlOut.value = htmlUrl;

                                                     // === Publiser til GitHub via Netlify function ===
  document.getElementById('status').textContent = 'Publiserer…';

  const prefix = d.basePath ? (d.basePath.replace(/^\/+|\/+$/g,'') + '/') : '';
  const payload = {
    repoOwner: d.ghUser || undefined,
    repoName:  d.ghRepo || undefined,
    basePath:  d.basePath,       // beholdt for bakoverkomp.
    orgKey:    d.orgKey,
    slug:      d.slug,
    files: [
      { path: `${prefix}${d.orgKey}/${d.slug}/${d.vcfFilename}`, content: vcf  },
      { path: `${prefix}${d.orgKey}/${d.slug}/index.html`,       content: html },
      { path: `${prefix}.nojekyll`,                              content: ""   }
    ],
    strategy: d.strategy,
    commitMessage: `Add/Update card: ${d.orgKey}/${d.slug}`
  };

  try{
    const res = await postJSON('/api/createCard', payload);
    if(res.ok){
      document.getElementById('status').innerHTML =
        '<span class="ok">✅ Ferdig! Åpne HTML-URL-en i nettleser (gi Pages et lite minutt).</span>';
    } else {
      const msg = res.json && res.json.error ? res.json.error : (res.text || 'Ukjent feil');
      document.getElementById('status').innerHTML = '<span class="err">❌ Feil: '+msg+'</span>';
    }
  }catch(e){
    document.getElementById('status').innerHTML = '<span class="err">❌ Nettverksfeil: '+e.message+'</span>';
  }
});

// Auto-apply branding hvis orgKey allerede er angitt ved load
document.addEventListener('DOMContentLoaded', () => {
  const k = document.getElementById('orgKey').value.trim();
  if (k) applyBranding(true);
}); 
    // === LIVE PREVIEW-FUNKSJONER ===
function updateLivePreview(html) {
  const frame = document.getElementById('livePreviewFrame');
  if (!frame) return;
  const doc = frame.contentDocument || frame.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();
}

function openPreviewInNewTab(html) {
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(() => URL.revokeObjectURL(url), 60_000);
}

document.getElementById('openPreviewBtn')?.addEventListener('click', ()=>{
  const html = document.getElementById('htmlPreview').value;
  openPreviewInNewTab(html);
});
// === /LIVE PREVIEW-FUNKSJONER ===

</script>
</main>
</body>
</html>
