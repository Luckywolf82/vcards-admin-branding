<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFCKING – Adminpanel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
<style>
  /* --- GLOBAL FIX FOR DARK BACKGROUND --- */
  h1, h2, h3, h4, h5, h6 { color:#eaf2ff!important }
  label, p, li, span, td, th { color:#cfe3ff }
  a { color:#8fd3ff }
  input, select, textarea { background:#0f131a;color:#eaf2ff;border:1px solid #2a3442 }

  /* --- NAVBAR --- */
  nav.navbar {
    background:#12121a;display:flex;justify-content:center;gap:1rem;
    padding:10px;border-radius:10px;margin:10px 0 20px;
  }
  nav.navbar a {
    color:#eaf2ff;text-decoration:none;font-weight:600;
    padding:6px 10px;border-radius:8px;background:#1d2735;
    transition:background .2s;
  }
  nav.navbar a:hover { background:#3a4a63 }

    body{background:#0b0b10;color:#e9eef5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#21c36a;font-weight:700}
    .err{color:#ff6b6b;font-weight:700}
    .note{font-size:.95rem;color:#8ea0b4}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:1px solid #344458}
    .links-table{width:100%;border-collapse:collapse}
    .links-table th,.links-table td{border-bottom:1px solid #2a3442;padding:.3rem;vertical-align:top}
    .muted{color:#8ea0b4}
    code{background:#0d1117;color:#d1e7ff;padding:.2em .4em;border-radius:6px}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .logo-prev{height:36px;max-width:220px;object-fit:contain;margin-left:8px;background:#fff;border-radius:6px;padding:4px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a}
    .url-actions{margin-left:6px}
    .brand{text-align:center;margin:0 0 18px}
    .brand img{max-width:240px;height:auto;filter:drop-shadow(0 0 6px #3fffd2)}
    .brand-sub{margin:6px 0 0;color:#8ea0b4}
    .brand-rule{border:0;height:2px;background:linear-gradient(90deg,#8fd3ff,#52a3ff);opacity:.7;margin:10px 0 16px}
    #nfcLog{background:#0d1117;color:#cfe3ff;padding:10px;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto;margin-top:10px}
    .hide{display:none}
    .card{max-width:980px;margin:0 auto}
  </style>
</head>

<body>
  <!-- AUTH: vises før innlogging -->
    <nav class="navbar">
    <a href="/demo.html">Demo</a>
    <a href="/bestill-kort.html">Bestill kort</a>
  </nav>

  <section id="auth" class="card">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Logg inn for å bruke adminpanelet</p>
    </div>
    <hr class="brand-rule">
    <button id="btnGoogle" class="btn">Logg inn med Google</button>
    <p class="note" style="margin-top:8px">Krever at brukeren finnes i Firestore policy (kan åpnes for alle – nå tillater vi alle innloggede).</p>
  </section>

  <!-- APP: skjules til bruker er innlogget -->
  <main id="app" class="hide">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Kongen av kontaktløs – bygg, merk og publiser NFC-kort</p>
    </div>
    <hr class="brand-rule">

    <!-- (1) Organisasjonsprofiler + ansatte-lister (hentes fra Firestore hvis mulig) -->
    <script>
      // Disse fylles fra Firestore ved innlogging. Vi har også fallback.
      window.ORG_PROFILES = {};   // { key: {name, accent, logo, site, logoBg} }
      window.EMPLOYEES    = {};   // { key: [ {slug, name, ...} ] } – valgfritt, tom som default
    </script>

    <h2>Organisasjon</h2>
    <div class="row">
      <label>Velg organisasjon
        <select id="orgSelect"></select>
      </label>

      <div class="inline">
        <label style="flex:1">Org key (mappe – case sensitive)
          <input id="orgKey" placeholder="OrgKey" required oninput="applyBranding('force'); syncOrgSelectFromKey(); loadEmployees();">
        </label>
        <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
          <img id="logoPreview" class="logo-prev" alt="logo" />
        </div>
      </div>

      <label>Org navn (visning)
        <input id="orgName" placeholder="Din organisasjon">
      </label>
      <label>Accent farge (hex)
        <input id="accent" placeholder="#3aa0ff">
      </label>
      <label>Org nettside
        <input id="orgSite" placeholder="https://domene.no">
      </label>

      <label>Logo URL (eller last opp)
        <div style="display:flex;gap:6px;align-items:center">
          <input id="logoUrl" placeholder="https://.../logo.png" oninput="previewLogo()" style="flex:1">
          <input type="file" id="logoFile" accept="image/*" onchange="handleLogoUpload(event)">
        </div>
      </label>

      <label>Logo bakgrunn
        <input id="logoBg" placeholder="#ffffff (tom = auto)">
      </label>
    </div>

    <h2>Person</h2>
    <div class="row">
      <label>Velg ansatt
        <select id="employeeSelect"><option value="">(Velg ansatt…)</option></select>
      </label>
      <div></div>

      <label>Slug (mappe/URL uten æøå/mellomrom)
        <input id="slug" placeholder="ola-nordmann" required>
      </label>
      <label>Navn
        <input id="name" placeholder="Ola Nordmann" required>
      </label>
      <label>Tittel
        <input id="title" placeholder="Salgsleder">
      </label>
      <label>Telefon (E.164)
        <input id="phone" placeholder="+47 40000000">
      </label>
      <label>E-post
        <input id="email" placeholder="ola@firma.no">
      </label>
      <label>Nettside
        <input id="site" placeholder="https://firma.no">
      </label>
      <label>Adresse
        <input id="address" placeholder="Storgata 1, 0001 Oslo">
      </label>
      <label>VCF-filnavn
        <input id="vcfFilename" placeholder="ola_nordmann.vcf">
      </label>
    </div>

    <h2>Lenker og tekster</h2>
    <div class="row">
      <label>Forhåndsvalg (klikk for å legge til)</label>
      <div>
        <button type="button" class="pill" data-label="LinkedIn"  data-url="https://www.linkedin.com/in/">LinkedIn</button>
        <button type="button" class="pill" data-label="Instagram" data-url="https://instagram.com/">Instagram</button>
        <button type="button" class="pill" data-label="Facebook"  data-url="https://facebook.com/">Facebook</button>
        <button type="button" class="pill" data-label="YouTube"   data-url="https://youtube.com/@">YouTube</button>
        <button type="button" class="pill" data-label="TikTok"    data-url="https://www.tiktok.com/@">TikTok</button>
        <button type="button" class="pill" data-label="GitHub"    data-url="https://github.com/">GitHub</button>
        <button type="button" class="pill" data-label="Nettside"  data-url="https://">Nettside</button>
        <button type="button" class="pill" data-label="Kalender"  data-url="https://cal.com/">Kalender</button>
        <button type="button" class="pill" data-label="WhatsApp"  data-url="https://wa.me/">WhatsApp</button>
      </div>
    </div>

    <table class="links-table" id="linksTable">
      <thead><tr><th>Label</th><th>URL</th><th>Tekst over</th><th>Tekst under</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row">
      <label>Ny label<input id="newLabel" placeholder="LinkedIn"></label>
      <label>Ny URL<input id="newUrl" placeholder="https://linkedin.com/in/..."></label>
      <label>Tekst over<input id="newPre" placeholder="Følg meg på LinkedIn"></label>
      <label>Tekst under<input id="newPost" placeholder="@brukernavn (daglig oppdatert)"></label>
      <div><button type="button" id="addLink">Legg til</button></div>
    </div>

    <h2>Publisering</h2>
    <div class="row">
      <label>GitHub owner
        <input id="ghUser" placeholder="brukernavn">
      </label>
      <label>Repo-navn
        <input id="ghRepo" placeholder="Vcards">
      </label>
      <label>BASE_PATH
        <input id="basePath" placeholder="Vcards" value="Vcards">
      </label>
      <label>Commit-strategi
        <select id="strategy">
          <option value="pr">Branch + Pull Request</option>
          <option value="direct">Direkte til main</option>
        </select>
      </label>
    </div>

    <button id="generate">Generer & Publiser</button>
    <span id="status"></span>

    <h3>Resultat</h3>
    <p>NFC-URL: <input id="nfcUrl" style="width:100%" readonly></p>
    <p>HTML-URL: <input id="htmlUrl" style="width:100%" readonly></p>

    <h4>vCard</h4>
    <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

    <h4>index.html</h4>
    <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>

    <!-- Live forhåndsvisning -->
    <div id="livePreviewContainer" style="margin-top:10px;">
      <h4>Live forhåndsvisning</h4>
      <button id="openPreviewBtn" style="margin:6px 0;">Åpne forhåndsvisning i ny fane</button>
      <iframe id="livePreviewFrame" style="width:100%;height:480px;border:1px solid #333;border-radius:8px;background:#111;" title="Live Preview"></iframe>
    </div>

    <h2>NFC (Web NFC – Chrome/Android)</h2>
    <div class="row">
      <label>Velg skrive-type
        <select id="nfcWriteMode">
          <option value="url">URL (åpnes i nettleser)</option>
          <option value="text">Tekst</option>
          <option value="vcard">vCard (.vcf fra forhåndsvisning)</option>
        </select>
      </label>
      <label>Payload (for URL/tekst)
        <input id="nfcPayload" placeholder="https://ditt-domene.no/sti">
      </label>
      <div>
        <button id="nfcRead" class="pill" type="button">Les NFC</button>
        <button id="nfcWrite" class="pill" type="button">Skriv NFC</button>
      </div>
    </div>
    <pre id="nfcLog"></pre>

  </main>

  <!-- Firebase (CDN) + Auth/Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase-prosjektet ditt
    const firebaseConfig = {
      apiKey: "AIzaSyDypfSLkWWRQh9TFrIjWpYWKmO3dBDnb_s",
      authDomain: "nfcking-bb143.firebaseapp.com",
      projectId: "nfcking-bb143",
      storageBucket: "nfcking-bb143.firebasestorage.app",
      messagingSenderId: "435773344673",
      appId: "1:435773344673:web:0e77e1445209f0adb319e0",
      measurementId: "G-EHN7M5NJJS"
    };

    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const authSec = $('auth');
    const appSec  = $('app');
    const btnGoogle = $('btnGoogle');

    // Hent orgs fra Firestore → bygg ORG_PROFILES
    async function loadOrgsFromFirestore(){
      try {
        const snap = await getDocs(collection(db, 'orgs'));
        const orgs = {};
        snap.forEach(d => {
          const key  = d.id;
          const data = d.data() || {};
          orgs[key] = {
            name:   data.name   || key,
            accent: data.accent || '#8fd3ff',
            logo:   data.logo   || '',
            site:   data.site   || '',
            logoBg: data.logoBg || '#ffffff'
          };
        });
        if (Object.keys(orgs).length === 0) {
          window.ORG_PROFILES = { "DemoOrg": { name:"DemoOrg", accent:"#3ec6ff", logo:"", site:"https://eksempel.no", logoBg:"#ffffff" } };
        } else {
          window.ORG_PROFILES = orgs;
        }
      } catch (e) {
        console.warn('Klarte ikke hente orgs fra Firestore:', e);
        if (!window.ORG_PROFILES || Object.keys(window.ORG_PROFILES).length===0){
          window.ORG_PROFILES = { "DemoOrg": { name:"DemoOrg", accent:"#3ec6ff", logo:"", site:"https://eksempel.no", logoBg:"#ffffff" } };
        }
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authSec.classList.remove('hide');
        appSec.classList.add('hide');
        return;
      }
      await loadOrgsFromFirestore();
      populateOrgSelect();
      if (!$('orgKey').value && $('orgSelect').options.length){
        $('orgSelect').selectedIndex = 0; syncOrgKeyFromSelect();
      } else { syncOrgSelectFromKey(); applyBranding('auto'); loadEmployees(); }
      authSec.classList.add('hide');
      appSec.classList.remove('hide');
    });

    btnGoogle?.addEventListener('click', async ()=>{
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch (e) { alert('Innlogging feilet: '+e.message); }
    });

    window._firebase = { auth, db };
  </script>

  <!-- UI: organisasjoner/ansatte -->
  <script>
    function populateOrgSelect(){
      const orgSelect = document.getElementById('orgSelect');
      orgSelect.innerHTML = '';
      const orgs = window.ORG_PROFILES || {};
      Object.keys(orgs).forEach(key=>{
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = orgs[key].name || key;
        orgSelect.appendChild(opt);
      });
    }

    function syncOrgKeyFromSelect(){
      const key = document.getElementById('orgSelect').value;
      document.getElementById('orgKey').value = key;
      applyBranding('force');
      loadEmployees();
    }

    function syncOrgSelectFromKey(){
      const key = document.getElementById('orgKey').value.trim();
      const orgSelect = document.getElementById('orgSelect');
      const idx = Array.from(orgSelect.options).findIndex(o => o.value === key);
      if (idx >= 0) orgSelect.selectedIndex = idx;
    }

    function loadEmployees(){
      const key = document.getElementById('orgKey').value.trim();
      const list = (window.EMPLOYEES || {})[key] || [];
      const sel = document.getElementById('employeeSelect');
      sel.innerHTML = '<option value="">(Velg ansatt…)</option>';
      list.forEach((emp, i)=>{
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = emp.name + (emp.title ? ' – ' + emp.title : '');
        sel.appendChild(opt);
      });
    }

    function fillEmployee(iStr){
      const key = document.getElementById('orgKey').value.trim();
      const list = (window.EMPLOYEES || {})[key] || [];
      const emp  = list[parseInt(iStr,10)];
      if (!emp) return;
      const set = (id, val) => { const el=document.getElementById(id); if (el) el.value = val || ''; };
      set('slug', emp.slug); set('name', emp.name); set('title', emp.title);
      set('phone', emp.phone); set('email', emp.email);
      set('site', emp.site); set('address', emp.address); set('vcfFilename', emp.vcfFilename);
    }

    document.getElementById('employeeSelect').addEventListener('change', (e)=> fillEmployee(e.target.value));
  </script>

  <!-- Lenketabell -->
  <script>
    const tbody = document.querySelector('#linksTable tbody');

    function addRow(label, url, pre = '', post = '') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${label||''}" class="lbl" /></td>
        <td><input value="${url||''}" class="lnk" style="width:100%"/></td>
        <td><textarea class="pre" rows="2" placeholder="Tekst over">${pre||''}</textarea></td>
        <td><textarea class="post" rows="2" placeholder="Tekst under">${post||''}</textarea></td>
        <td><button type="button" class="remove">Fjern</button></td>`;
      tr.querySelector('.remove').addEventListener('click', () => tr.remove());
      tbody.appendChild(tr);
    }

    document.getElementById('addLink').addEventListener('click', () => {
      addRow(
        document.getElementById('newLabel').value,
        document.getElementById('newUrl').value,
        document.getElementById('newPre').value,
        document.getElementById('newPost').value
      );
      ['newLabel','newUrl','newPre','newPost'].forEach(id => document.getElementById(id).value = '');
    });

    document.querySelectorAll('.pill').forEach(btn => {
      btn.addEventListener('click', () => addRow(btn.dataset.label, btn.dataset.url));
    });
  </script>

  <!-- Branding & logo -->
  <script>
    function applyBranding(mode = 'auto'){
      const key  = document.getElementById('orgKey').value.trim();
      const prof = (window.ORG_PROFILES || {})[key];
      if (!prof) return;
      const set = (id, val) => { const el=document.getElementById(id); if (!el) return; if (mode==='force' || !el.value) el.value = val || ''; };
      set('orgName', prof.name || key);
      set('accent' , prof.accent || '#8fd3ff');
      set('orgSite', prof.site || '');
      set('logoUrl', prof.logo || '');
      set('logoBg' , prof.logoBg || '#ffffff');
      previewLogo();
    }
    window.applyBranding = applyBranding;

    function previewLogo(){
      const url = document.getElementById('logoUrl').value.trim();
      const img = document.getElementById('logoPreview');
      const bg  = document.getElementById('logoBg').value.trim();
      if(!url){ img.style.display='none'; return; }
      img.src = url; img.style.display='block'; img.style.borderRadius='8px'; img.style.padding='6px';
      img.style.background = bg || '#ffffff';
    }
    window.previewLogo = previewLogo;

    async function handleLogoUpload(evt){
      const file = evt.target.files?.[0];
      if(!file) return;
      const orgKey = (document.getElementById('orgKey').value || '').trim() || 'Common';
      const ghUser = (document.getElementById('ghUser').value || '').trim();
      const ghRepo = (document.getElementById('ghRepo').value || '').trim();
      const basePath = (document.getElementById('basePath').value || 'Vcards').trim();
      const arrBuf = await file.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
      const cleanOrg = orgKey.replace(/[^A-Za-z0-9_-]/g, '');
      const ext = (file.name.split('.').pop() || 'png').toLowerCase().replace(/[^a-z0-9]/g,'') || 'png';
      const safeName = `${cleanOrg}_logo_${Date.now()}.${ext}`;
      const res = await fetch('/api/uploadLogo', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ repoOwner:ghUser||undefined, repoName:ghRepo||undefined, basePath, orgKey:cleanOrg, filename:safeName, contentBase64:base64 })
      });
      const out = await res.json().catch(()=> ({}));
      if(!res.ok || !out.url){ alert('Kunne ikke laste opp logo'); return; }
      document.getElementById('logoUrl').value = out.url; previewLogo();
    }
    window.handleLogoUpload = handleLogoUpload;
  </script>

  <!-- vCard/HTML + helpers -->
  <script>
    function normalizePhone(p){ p=(p||'').trim(); if(!p) return p; if(p.startsWith('0')&&!p.startsWith('+')){ if(p.length<=8) return '+47'+p.replace(/^0+/, ''); } return p; }
    function makeVcard(d){
      const parts = d.name.trim().split(' ');
      const first = parts[0]||''; const last = parts.length>1?parts[parts.length-1]:'';
      const phone = normalizePhone(d.phone||'');
      return ['BEGIN:VCARD','VERSION:3.0',`FN:${d.name}`,`N:${last};${first};;;`,`ORG:${d.orgName||d.orgKey}`,`TITLE:${d.title||''}`,`TEL;TYPE=CELL:${phone}`,`EMAIL;TYPE=INTERNET:${d.email||''}`,`URL:${d.site||''}`,`ADR;TYPE=WORK:;;${d.address||''}`,'END:VCARD'].join('\n');
    }
    const esc = s => (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    function makeLinksHTML(links){
      if(!links.length) return '';
      return links.map(l=>{
        const pre  = l.pre  ? `<div class="pre"  style="margin:8px 0 4px;color:#bfc8d6">${esc(l.pre)}</div>` : '';
        const post = l.post ? `<div class="post" style="margin:4px 0 10px;color:#97a3b6;font-size:.95rem">${esc(l.post)}</div>` : '';
        return `<div class="link-block" style="margin-top:10px">${pre}<a class="btn" href="${esc(l.url)}" target="_blank" rel="noopener">${esc(l.label)}</a>${post}</div>`;
      }).join('');
    }
    function makeHTML(d, vcfFile, links){
      const accent  = d.accent || '#8fd3ff';
      const bgStyle = `background:${d.logoBg || '#ffffff'};border-radius:8px;padding:6px;`;
      const logoTag = d.logoUrl ? `<img class="brand-logo" src="${d.logoUrl}" style="${bgStyle}" alt="${esc(d.orgName||d.orgKey)} logo">` : '';
      const extras  = makeLinksHTML(links);
      return `<!doctype html>
<html lang="no">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kontaktkort – ${esc(d.name)}</title>
<style>
:root{--accent:${accent};}
body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}
.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}
.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}
.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.card p{color:#bfc8d6}
.brand-logo{max-height:56px;max-width:280px;object-fit:contain;margin:0 0 12px 0;display:block}
</style>
</head>
<body>
<main class="container card">
  ${logoTag}
  <h1>Kontaktkort – ${esc(d.name)}</h1>
  <p class="muted">${esc(d.title||'')} · ${esc(d.orgName||d.orgKey)}</p>
  <p><a class="btn" href="./${vcfFile}" download>Last ned vCard (.vcf)</a></p>
  <div class="links">
    <a href="tel:${esc(d.phone||'')}" class="btn">Ring</a>
    <a href="mailto:${esc(d.email||'')}" class="btn">E-post</a>
    <a href="${esc(d.site||'#')}" class="btn" target="_blank">Besøk nettside</a>
    <a href="../index.html" class="btn">← Tilbake</a>
  </div>
  ${extras}
  <p style="margin-top:14px">Adresse: ${esc(d.address||'')}</p>
  <p style="margin-top:8px;font-size:0.9rem;color:#9aa6b2">NFC-URL: <code id="nfcInline"></code></p>
</main>
</body>
</html>`;
    }

    async function postJSON(url, data){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      const t = await r.text(); try{return{ok:r.ok,status:r.status,json:JSON.parse(t)}}catch{return{ok:r.ok,status:r.status,text:t}};
    }

    function ensureUrlControls(id,label){
      const input = document.getElementById(id); if(!input) return;
      if (input.nextSibling?.classList?.contains('url-actions')) return;
      const wrap = document.createElement('span'); wrap.className = 'url-actions';
      wrap.innerHTML = `<button type="button" class="pill" data-act="copy">Kopier ${label}</button><button type="button" class="pill" data-act="open">Åpne</button>`;
      input.after(wrap);
      wrap.addEventListener('click',(e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const val=input.value.trim(); if(!val) return;
        if(btn.dataset.act==='copy') navigator.clipboard.writeText(val);
        if(btn.dataset.act==='open') window.open(val,'_blank','noopener');
      });
    }
  </script>

  <!-- Generer & Publiser + Live preview + NFC -->
  <script>
    document.getElementById('generate').addEventListener('click', async ()=>{
      const get = id => document.getElementById(id).value.trim();
      const d = {
        orgKey:get('orgKey'),
        orgName:get('orgName')||get('orgKey'),
        accent:get('accent')||'#8fd3ff',
        logoUrl:get('logoUrl'),
        logoBg:get('logoBg')||'',
        slug:get('slug'),
        name:get('name'),
        title:get('title'),
        phone:get('phone'),
        email:get('email'),
        site:get('site'),
        address:get('address'),
        vcfFilename:get('vcfFilename')||(get('slug')+'_'+get('orgKey')+'.vcf'),
        ghUser:get('ghUser'),
        ghRepo:get('ghRepo'),
        basePath:get('basePath')||'Vcards',
        strategy:document.getElementById('strategy').value
      };
      if(!d.orgKey||!d.slug||!d.name){ alert('Mangler: orgKey, slug, name'); return; }

      const links = Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr=>({
        label: tr.querySelector('.lbl').value.trim(),
        url:   tr.querySelector('.lnk').value.trim(),
        pre:   tr.querySelector('.pre').value.trim(),
        post:  tr.querySelector('.post').value.trim()
      })).filter(x=>x.label && x.url);

      const vcf  = makeVcard(d);
      const html = makeHTML(d, d.vcfFilename, links);
      document.getElementById('vcfPreview').value  = vcf;
      document.getElementById('htmlPreview').value = html;
      updateLivePreview(html);

      const ownerPart = d.ghUser || '<owner>';
      const repoPart  = d.ghRepo || '<repo>';
      const basePath  = (d.basePath||'Vcards').replace(/^\/+|\/+$/g,'');
      const baseUrl   = `https://${ownerPart}.github.io/${repoPart}${basePath?`/${basePath}`:''}/${d.orgKey}/${d.slug}`;
      const htmlUrl   = `${baseUrl}/index.html`;
      const vcfUrl    = `${baseUrl}/${d.vcfFilename}`;

      document.getElementById('nfcUrl').value  = vcfUrl;
      document.getElementById('htmlUrl').value = htmlUrl;
      ensureUrlControls('nfcUrl','NFC-URL');
      ensureUrlControls('htmlUrl','HTML-URL');
      const inline = document.getElementById('nfcInline'); if(inline) inline.textContent = vcfUrl;

      document.getElementById('status').textContent = 'Publiserer…';
      const prefix = d.basePath ? (d.basePath.replace(/^\/+|\/+$/g,'') + '/') : '';
      const payload = {
        repoOwner:d.ghUser||undefined, repoName:d.ghRepo||undefined,
        basePath:d.basePath, orgKey:d.orgKey, slug:d.slug,
        files:[
          { path:`${prefix}${d.orgKey}/${d.slug}/${d.vcfFilename}`, content: vcf },
          { path:`${prefix}${d.orgKey}/${d.slug}/index.html`,       content: html },
          { path:`${prefix}${d.orgKey}/${d.slug}/data.json`,        content: JSON.stringify({ ...d, links }, null, 2) },
          { path:`${prefix}.nojekyll`,                              content: "" }
        ],
        strategy:d.strategy,
        commitMessage:`Add/Update card: ${d.orgKey}/${d.slug}`
      };

      try{
        const res = await postJSON('/api/createCard', payload);
        if(res.ok){ document.getElementById('status').innerHTML = '<span class="ok">✅ Ferdig! Åpne HTML-URL-en (gi Pages litt tid).</span>'; }
        else {
          const msg = res.json && res.json.error ? res.json.error : (res.text || 'Ukjent feil');
          document.getElementById('status').innerHTML = '<span class="err">❌ Feil: '+msg+'</span>';
        }
      }catch(e){ document.getElementById('status').innerHTML = '<span class="err">❌ Nettverksfeil: '+e.message+'</span>'; }
    });

    // Live preview
    function updateLivePreview(html){
      const frame = document.getElementById('livePreviewFrame'); if(!frame) return;
      const doc = frame.contentDocument || frame.contentWindow.document;
      doc.open(); doc.write(html); doc.close();
    }
    document.getElementById('openPreviewBtn')?.addEventListener('click', ()=>{
      const blob = new Blob([document.getElementById('htmlPreview').value], {type:'text/html'});
      const url  = URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url), 60_000);
    });

    // NFC helpers
    function logNFC(msg){
      const el = document.getElementById('nfcLog');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
    }
    function supportsNFC(){
      return ('NDEFReader' in window);
    }

    // LES NFC
    document.getElementById('nfcRead').addEventListener('click', async ()=>{
      if(!supportsNFC()){ alert('Web NFC støttes kun i Chrome/Android'); return; }
      try{
        const reader = new NDEFReader();
        await reader.scan();
        logNFC('Hold telefonen nær kortet – lytter...');
        reader.onreadingerror = () => logNFC('Lesefeil');
        reader.onreading = (event) => {
          const { message, serialNumber } = event;
          logNFC(`Serial: ${serialNumber || '(ukjent)'}`);
          for (const record of message.records) {
            try{
              if (record.recordType === 'url') {
                const text = new TextDecoder().decode(record.data);
                logNFC('URL: ' + text);
              } else if (record.recordType === 'text') {
                const text = new TextDecoder().decode(record.data);
                logNFC('Tekst: ' + text);
              } else if (record.mediaType === 'text/vcard' || record.mediaType === 'text/x-vcard') {
                const vcf = new TextDecoder().decode(record.data);
                logNFC('vCard:\n' + vcf);
              } else {
                logNFC(`Record: type=${record.recordType} mediaType=${record.mediaType||''}`);
              }
            }catch(e){ logNFC('Kunne ikke dekode record: '+e.message); }
          }
        };
      }catch(e){
        logNFC('Start scanning feilet: '+e.message);
      }
    });

    // SKRIV NFC
    document.getElementById('nfcWrite').addEventListener('click', async ()=>{
      if(!supportsNFC()){ alert('Web NFC støttes kun i Chrome/Android'); return; }
      const mode = document.getElementById('nfcWriteMode').value;
      const payload = document.getElementById('nfcPayload').value.trim();
      try{
        const writer = new NDEFReader();
        await writer.write(await buildNdefMessage(mode, payload));
        logNFC('✅ Skrevet!');
      }catch(e){
        logNFC('Skrivefeil: '+e.message);
      }
    });

    async function buildNdefMessage(mode, payload){
      if (mode === 'url') {
        const url = payload || document.getElementById('htmlUrl').value.trim() || document.getElementById('nfcUrl').value.trim();
        if (!url) throw new Error('Mangler URL å skrive');
        return { records:[ { recordType:'url', data: url } ] };
      }
      if (mode === 'text') {
        const text = payload || 'Hei fra NFCKING';
        return { records:[ { recordType:'text', data: text } ] };
      }
      if (mode === 'vcard') {
        const vcf = document.getElementById('vcfPreview').value.trim();
        if (!vcf) throw new Error('Ingen vCard i forhåndsvisning. Generer først.');
        return { records:[ { recordType:'mime', mediaType:'text/vcard', data: new TextEncoder().encode(vcf) } ] };
      }
      throw new Error('Ukjent skrive-modus');
    }

    // Init etter DOM ready (merk: auth viser/skjuler app)
    document.addEventListener('DOMContentLoaded', ()=>{
      const sel = document.getElementById('orgSelect');
      if (sel) sel.addEventListener('change', syncOrgKeyFromSelect);
    });
  </script>
</body>
</html>
