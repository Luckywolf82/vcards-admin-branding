.cardCanvas{
  position: relative;
  width: 100%;
  aspect-ratio: 85.6 / 54; /* ekte bankkortformat */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.25);
  overflow: hidden;
}

.cardCanvas .logoLayer{
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%; /* justeres med slideren */
  height: auto;
  object-fit: contain;
  pointer-events: none;
  opacity: .9;
  mix-blend-mode: multiply;
  filter: grayscale(1) sepia(1) saturate(600%) hue-rotate(-10deg) brightness(.55) contrast(1.25);
}
<header>
  <h1>NFCKING – Mockup-generator</h1>
  <p>Legg inn logoen din, så får du en realistisk forhåndsvisning på ekte trekort (liggende). Logoen legges i midten og får en «lasergravert» effekt.</p>
</header>

<section class="controls">
  <div>
    <h3>1) Last opp logo</h3>
    <div class="row">
      <input type="file" id="logoFile" accept="image/*">
    </div>
    <p class="help">Tips: Svart/hvit PNG (transparent) er best. Du kan også fjerne lys bakgrunn automatisk.</p>

    <div class="row" style="margin-top:8px">
      <label class="row"><input type="checkbox" id="autoBg" checked> Fjern lys bakgrunn automatisk</label>
      <div class="rangeBox">
        <span>Terskel:</span>
        <input type="range" id="bgThreshold" min="10" max="90" value="56">
        <span id="bgVal">56</span>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <label class="row"><input type="checkbox" id="invertLogo"> Inverter (bruk kun hvis logoen blir «negativ»)</label>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="rangeBox">
        <span>Logo-størrelse:</span>
        <input type="range" id="logoScale" min="40" max="100" value="80">
        <span id="scaleVal">80%</span>
      </div>
    </div>
  </div>

  <div>
    <h3>2) Last ned</h3>
    <div class="downloadBar">
      <label>Treverk:</label>
      <select id="woodSelect">
        <option value="light">Lys</option>
        <option value="red">Valnøtt (midt)</option>
        <option value="dark">Mørk</option>
      </select>
      <button id="downloadBtn">Last ned valgt mockup (PNG)</button>
    </div>
    <p class="note">Alt skjer i nettleseren – ingenting lastes opp.</p>
  </div>
</section>

<hr>

<h3>Mockup av fysisk kort (liggende)</h3>
<div class="mockup-grid" id="grid">
  <!-- Lys -->
  <div class="cardFrame">
    <div class="cardCanvas" style="background-image:url('assets/light.png')">
      <img class="logoLayer" alt="logo">
    </div>
    <div class="woodLabel">Lys</div>
  </div>

  <!-- Valnøtt (midt) -->
  <div class="cardFrame">
    <div class="cardCanvas" style="background-image:url('assets/red.png')">
      <img class="logoLayer" alt="logo">
    </div>
    <div class="woodLabel">Valnøtt</div>
  </div>

  <!-- Mørk -->
  <div class="cardFrame">
    <div class="cardCanvas" style="background-image:url('assets/dark.png')">
      <img class="logoLayer" alt="logo">
    </div>
    <div class="woodLabel">Mørk</div>
  </div>
</div>
<script>
let rawLogoURL = null;       // original dataURL
let processedLogoURL = null; // etter evt. bakgrunnsfjerning
let currentScale = 80;

const autoBg   = document.getElementById('autoBg');
const thInput  = document.getElementById('bgThreshold');
const thVal    = document.getElementById('bgVal');
const invertEl = document.getElementById('invertLogo');

const scaleIn  = document.getElementById('logoScale');
const scaleVal = document.getElementById('scaleVal');
const woodSel  = document.getElementById('woodSelect');
const grid     = document.getElementById('grid');

function setLogoOnTiles(url){
  grid.querySelectorAll('.logoLayer').forEach(img => {
    img.src = url || '';
    img.style.display = url ? 'block' : 'none';
  });
}

function updateScale(v){
  currentScale = v;
  scaleVal.textContent = v + '%';
  grid.querySelectorAll('.logoLayer').forEach(img => {
    img.style.width = v + '%';
  });
}

scaleIn.addEventListener('input', (e)=> updateScale(e.target.value));
updateScale(currentScale);

thInput.addEventListener('input', ()=>{
  thVal.textContent = thInput.value;
  if(rawLogoURL && autoBg.checked){ processLogo(); }
});
autoBg.addEventListener('change', ()=>{ if(rawLogoURL) processLogo(); });
invertEl.addEventListener('change', ()=>{ if(rawLogoURL) processLogo(); });

document.getElementById('logoFile').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  rawLogoURL = await fileToDataURL(file);
  await processLogo();
});

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror= reject;
    r.readAsDataURL(file);
  });
}

/* Fjerner lys bakgrunn (lyseste piksler blir transparent) */
async function removeLightBackground(dataURL, threshold){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      const w = img.naturalWidth, h = img.naturalHeight;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(img,0,0);
      const image = ctx.getImageData(0,0,w,h);
      const d = image.data;
      const th = Math.round(threshold/100 * 255);
      for(let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        const max = Math.max(r,g,b); // «lyseste» kanal
        if(max >= th){ d[i+3] = 0; } // alpha=0 (transparent)
      }
      ctx.putImageData(image,0,0);
      resolve(c.toDataURL('image/png'));
    };
    img.src = dataURL;
  });
}

async function processLogo(){
  if(!rawLogoURL){ setLogoOnTiles(null); return; }
  if(!autoBg.checked){
    processedLogoURL = rawLogoURL;
    setLogoOnTiles(processedLogoURL);
    return;
  }
  const t = parseInt(thInput.value,10) || 56;
  processedLogoURL = await removeLightBackground(rawLogoURL, t);
  setLogoOnTiles(processedLogoURL);
}

/* Ny “brenn inn”-funksjon: mørke piksler = blekk (kan invertes) */
function paintLogoOnWood(woodCtx, logoCtx, x, y, options = {}){
  const { threshold = 0.6, burnStrength = 0.9, invert = false } = options;
  const w = logoCtx.canvas.width, h = logoCtx.canvas.height;

  const src = logoCtx.getImageData(0,0,w,h);
  const dst = woodCtx.getImageData(x,y,w,h);
  const s = src.data, d = dst.data;

  const thr = Math.round(threshold*255);

  for(let i=0;i<s.length;i+=4){
    const r=s[i], g=s[i+1], b=s[i+2], a=s[i+3];
    if(a < 10) continue; // transparent i logo

    const luma = (0.2126*r + 0.7152*g + 0.0722*b) | 0; // 0..255
    let isInk = luma < thr;          // mørk = blekk (riktig vei)
    if(invert) isInk = !isInk;       // evt. inverter

    if(!isInk) continue;

    // brenn inn (mørk ned d under)
    const j=i;
    d[j]   = (d[j]  * (1 - burnStrength)) | 0;
    d[j+1] = (d[j+1]* (1 - burnStrength)) | 0;
    d[j+2] = (d[j+2]* (1 - burnStrength)) | 0;
    d[j+3] = 255;
  }
  woodCtx.putImageData(dst, x, y);
}

function loadImage(src){
  return new Promise((resolve,reject)=>{
    const i = new Image();
    i.onload = ()=> resolve(i);
    i.onerror= reject;
    i.src = src;
  });
}
</script>
<script>
document.getElementById('downloadBtn').addEventListener('click', async ()=>{
  const woodKey = document.getElementById('woodSelect').value;
  const woodSrc =
    woodKey === 'dark'  ? 'assets/dark.png' :
    woodKey === 'light' ? 'assets/light.png' :
                          'assets/red.png';

  if(!processedLogoURL){
    alert('Last opp en logo først.');
    return;
  }

  const bg   = await loadImage(woodSrc);
  const logo = await loadImage(processedLogoURL);

  // Canvas-størrelse (bankkort proporsjon, god oppløsning)
  const W = 1712; // 85.6mm * ~20
  const H = Math.round(W * 54 / 85.6);
  const mock = document.createElement('canvas');
  mock.width = W; mock.height = H;
  const ctx = mock.getContext('2d');

  // bakgrunn
  ctx.drawImage(bg, 0, 0, W, H);

  // plasser logo midt – fyll frå midten
  const minSide = Math.min(W, H);
  const cover = (parseInt(document.getElementById('logoScale').value,10) || 80) / 100; // 0.4–1.0
  const targetSize = minSide * cover;

  const ratio = logo.naturalHeight / logo.naturalWidth;
  const targetW = targetSize;
  const targetH = targetW * ratio;

  const drawW = Math.round(targetW);
  const drawH = Math.round(targetH);
  const drawX = Math.round(W/2 - drawW/2);
  const drawY = Math.round(H/2 - drawH/2);

  // legg logo i tmp-canvas for pikseltilgang
  const tmp = document.createElement('canvas');
  tmp.width = drawW; tmp.height = drawH;
  const tctx = tmp.getContext('2d', { willReadFrequently:true });
  tctx.drawImage(logo, 0, 0, drawW, drawH);

  // brenn inn (mørke piksler = blekk)
  const thr = (parseInt(document.getElementById('bgThreshold').value,10) || 56) / 100;
  const invert = document.getElementById('invertLogo').checked === true;
  paintLogoOnWood(ctx, tctx, drawX, drawY, { threshold: thr, burnStrength: 0.85, invert });

  // last ned
  const a = document.createElement('a');
  a.href = mock.toDataURL('image/png');
  a.download = `nfcking_mockup_${woodKey}.png`;
  a.click();
});

// init tom logo
setLogoOnTiles(null);
</script>
</body>
</html>
