<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFCKING – Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    :root{--brand:#3fffd2;--ink:#0b0b10;--card:#12121a;--muted:#8ea0b4}
    body{background:var(--ink);color:#eaf2ff}
    header.card{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .tag{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#17333a;color:#9ef7ea;font-weight:700}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;border:1px solid #344458}
    .muted{color:var(--muted)}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.row{grid-template-columns:1fr}}
    .card{background:#12121a;border-radius:14px;padding:16px}
    .brandmark{filter:drop-shadow(0 0 6px var(--brand))}
    .help{font-size:.9rem;color:#9fb0c6}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a;border:0;cursor:pointer}

    /* Mockups */
    .mock-card{background:#0f1216;border:1px solid #1d2430;border-radius:14px;padding:16px}
    .two-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.two-cards{grid-template-columns:1fr}}
    canvas.mock-canvas{width:100%;height:auto;max-width:100%;border-radius:14px;display:block;background:#111}
    .axis{display:grid;gap:6px;min-width:260px}
    .axis h4{margin:4px 0}
    .axis-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center}
    .axis-cap{font:700 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#cfe3ff;background:#223141;border:1px solid #33465e;padding:4px 6px;border-radius:6px;white-space:nowrap}
    .val{font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#9fb0c6}
    .val code{color:#cfe3ff}

    /* Digital forhåndsvisning */
    .phone{background:#0f1216;border:1px solid #1d2430;border-radius:14px;padding:16px}
    .phone iframe{width:100%;height:520px;border:0;border-radius:10px;background:#0b0b10}
    .logo-prev{height:42px;max-width:240px;object-fit:contain;background:#fff;border-radius:8px;padding:6px}
  </style>
</head>
<body>
<header class="card">
  <div class="inline">
    <img src="/assets/NFCKING_dark.png" alt="NFCKING" class="brandmark" style="height:40px">
    <span class="tag">Admin</span>
  </div>
  <div class="inline">
    <a href="/Landing.html" class="pill">Til demo/landingsside</a>
  </div>
</header>

<!-- ADMIN-INNHOLD -->
<section class="card">
  <h1>Administrer kort</h1>
  <p class="muted">Fyll inn info for digitalt kort. Logo kan settes via URL eller opplasting. Alt under bevares — og i tillegg har du nå <b>mockups</b> for fysiske kort lenger ned.</p>

  <div class="row">
    <label>Organisasjon <input id="orgName" placeholder="Wayback Trondheim"></label>
    <label>Org key <input id="orgKey" placeholder="Wayback" value="Wayback"></label>
    <label>Accent-farge <input id="accent" placeholder="#8fd3ff" value="#8fd3ff"></label>

    <label>Logo-URL <input id="logoUrl" placeholder="https://…/logo.png"></label>
    <label>eller last opp logo <input id="logoFile" type="file" accept="image/*"><small id="logoFileNote" class="help"></small></label>
    <label>Logo-bakgrunn <input id="logoBg" placeholder="#ffffff (tom = auto)"></label>

    <label>Navn <input id="name" placeholder="Trygve Eiulf Waagen"></label>
    <label>Tittel <input id="title" placeholder="Avdelingsleder"></label>
    <label>Telefon <input id="phone" placeholder="+47 47731087"></label>
    <label>E-post <input id="email" placeholder="trygve@wayback.no"></label>
    <label>Nettside <input id="site" placeholder="https://wayback.no"></label>
    <label>Adresse <input id="address" placeholder="Kongens gate 46, 7012 Trondheim"></label>
    <label>Slug <input id="slug" placeholder="Trygve"></label>
    <label>VCF-filnavn <input id="vcfFilename" placeholder="trygve_wayback.vcf"></label>
  </div>

  <div class="inline" style="margin-top:8px">
    <img id="logoPreview" class="logo-prev" alt="logo" style="display:none">
    <span class="help">Tips: Mørk logo → sett hvit bakgrunn for digitalt kort. Lasergravering for fysiske kort ignorerer bakgrunnen.</span>
  </div>
</section>

<!-- DIGITALT KORT (forhåndsvisning) -->
<section class="card">
  <h2>Digitalt kort – forhåndsvisning</h2>
  <div class="phone">
    <iframe id="liveFrame"></iframe>
  </div>
  <div class="inline" style="margin-top:10px">
    <button class="btn" id="updatePreview">Oppdater forhåndsvisning</button>
  </div>
</section>

<!-- === FYSISKE KORT – MOCKUPS (ADMIN) === -->
<section id="mockups" class="card" style="margin-top:14px">
  <h2>Fysiske kort – mockup</h2>

  <div class="inline" style="gap:18px;flex-wrap:wrap">
    <label>Modus
      <select id="mkMode">
        <option value="logo-both" selected>1) Logo på begge sider</option>
        <option value="logo-front-only">2) Kun logo forside, bakside blank</option>
        <option value="logo-front-text-back">3) Logo forside + tekst bakside</option>
        <option value="logo-front-text+smalllogo-back">4) Logo forside + tekst + liten logo bakside</option>
      </select>
    </label>
    <label>Stil
      <select id="mkStyle">
        <option value="dark" selected>Dark</option>
        <option value="light">Light</option>
        <option value="red">Red</option>
      </select>
    </label>
    <button class="pill" id="mkDownloadFront">Last ned forside</button>
    <button class="pill" id="mkDownloadBack">Last ned bakside</button>
  </div>

  <!-- Forhåndsvisning rett under modusvalget -->
  <div class="mock-card" style="margin-top:8px">
    <div class="two-cards">
      <canvas id="mkFront" class="mock-canvas" width="860" height="540"></canvas>
      <canvas id="mkBack"  class="mock-canvas" width="860" height="540"></canvas>
    </div>
    <p class="help" style="margin:8px 0 0">Denne forhåndsvisningen oppdateres av sliderne under. Eksport er rene bilder uten UI.</p>
  </div>

  <!-- Slidere / kontroller -->
  <div class="row" style="margin-top:12px">
    <!-- Laser -->
    <div class="axis">
      <h4>Lasergravering</h4>
      <label class="pill" style="width:max-content"><input type="checkbox" id="mkEngrave" checked> Lasergravér logo</label>
      <label style="width:max-content">Fjern lys bakgrunn <input type="checkbox" id="mkAutoRemoveBg" checked></label>
      <label>Dybde
        <input type="range" id="mkDepth" min="0.25" max="1" step="0.05" value="0.75">
      </label>
      <label>Terskel
        <input type="range" id="mkThreshold" min="8" max="80" step="1" value="28">
        <code id="mkThresholdVal">28</code>
      </label>
    </div>

    <!-- Forside-logo -->
    <div class="axis">
      <h4>Forside-logo</h4>
      <div><span class="val">Størrelse: </span><code id="mkFrontSizeVal">64%</code></div>
      <input type="range" id="mkFrontSize" min="20" max="100" step="1" value="64">
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="mkFrontX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="mkFrontXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="mkFrontY" min="0" max="100" step="1" value="50">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="mkFrontYVal">50%</code></span>
      </div>
    </div>

    <!-- Bakside – liten logo -->
    <div class="axis">
      <h4>Liten logo – bakside</h4>
      <div><span class="val">Størrelse: </span><code id="mkBackSmallVal">24%</code></div>
      <input type="range" id="mkBackSmall" min="10" max="60" step="1" value="24">
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="mkBackX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="mkBackXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="mkBackY" min="0" max="100" step="1" value="18">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="mkBackYVal">18%</code></span>
      </div>
    </div>

    <!-- Tekst bakside -->
    <div class="axis">
      <h4>Tekst – bakside</h4>
      <div class="inline" style="gap:12px;margin:4px 0">
        <label>Justering
          <select id="mkTextAlign">
            <option value="center" selected>Midtstilt</option>
            <option value="left">Venstrejustert</option>
          </select>
        </label>
        <label>Størrelse (base)
          <input type="range" id="mkTextBase" min="18" max="72" step="1" value="40">
          <code id="mkTextBaseVal">40 px</code>
        </label>
      </div>
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="mkTextX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="mkTextXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="mkTextY" min="10" max="90" step="1" value="38">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="mkTextYVal">38%</code></span>
      </div>
      <p class="help" style="margin:4px 0 0">Ved “Logo forside + liten logo bak” starter teksten under logo automatisk.</p>
    </div>
  </div>
</section>

<footer class="card" style="margin-top:18px">
  <small class="muted">© NFCKING. Admin m/digital forhåndsvisning og fysiske kort-mockups. Bestilling er ikke aktivert.</small>
</footer>

<!-- DINE EKSISTERENDE SCRIPTS (berøres ikke) -->
<script src="/uploadLogo.js"></script>
<script src="/createCard.js"></script>

<script>
/* ====== FELT & DIGITAL PREVIEW (uendret logikk) ====== */
window._uploadedLogoDataUrl='';

function esc(s){return (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}
function makeLinksHTML(){ return ''; } // beholdes som tom for admin, kan kobles til ev. lenkesystem hvis du har

function makeHTML(d){
  const acc=d.accent||'#8fd3ff';
  const logoTag = d.logoUrl
    ? '<img class="brand-logo" src="'+d.logoUrl+'" style="max-height:56px;max-width:280px;object-fit:contain;'
      +(d.logoBg?('background:'+d.logoBg+';border-radius:8px;padding:6px;'):'')+'" alt="'+esc(d.orgName)+' logo">'
    : '';
  return '<!doctype html><html lang="no"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'
    +'<title>Kontaktkort – '+esc(d.name||'')+'</title>'
    +'<style>:root{--accent:'+acc+';}body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}.card p{color:#bfc8d6}.brand-logo{display:block;margin:0 0 12px 0}</style>'
    +'</head><body><main class="container card">'
    +logoTag
    +'<h1>Kontaktkort – '+esc(d.name||'')+'</h1>'
    +'<p class="muted">'+esc(d.title||'')+' · '+esc(d.orgName||'')+'</p>'
    +(d.phone?'<a class="btn" href="tel:'+esc(d.phone)+'">Ring</a> ':'')
    +(d.email?'<a class="btn" href="mailto:'+esc(d.email)+'">E-post</a> ':'')
    +(d.site?'<a class="btn" href="'+esc(d.site)+'" target="_blank" rel="noopener">Nettside</a>':'')
    +(d.address?'<p style="margin-top:14px">Adresse: '+esc(d.address)+'</p>':'')
    +'</main></body></html>';
}

function previewLogo(){
  const img=document.getElementById('logoPreview');
  const bg=(document.getElementById('logoBg')?.value||'').trim();
  const src=window._uploadedLogoDataUrl || (document.getElementById('logoUrl')?.value||'').trim();
  if(!img) return;
  img.style.display = src ? 'block' : 'none';
  if(!src) return;
  img.src=src; img.style.background=bg||'#ffffff'; img.style.borderRadius='8px'; img.style.padding='6px';
}
function handleLogoFileInput(file){
  if(!file) return;
  const note=document.getElementById('logoFileNote');
  const r=new FileReader();
  r.onload=()=>{ window._uploadedLogoDataUrl=String(r.result||''); const u=document.getElementById('logoUrl'); if(u) u.value=''; if(note) note.textContent='Bruker opplastet logo: '+file.name; previewLogo(); updatePreview(); };
  r.readAsDataURL(file);
}
document.getElementById('logoFile')?.addEventListener('change', e=>{
  const f=e.target.files && e.target.files[0]; handleLogoFileInput(f);
});

function currentData(){
  return {
    orgName:(document.getElementById('orgName')?.value||'').trim() || (document.getElementById('orgKey')?.value||'').trim(),
    orgKey:(document.getElementById('orgKey')?.value||'').trim(),
    accent:(document.getElementById('accent')?.value||'').trim() || '#8fd3ff',
    logoUrl:window._uploadedLogoDataUrl || (document.getElementById('logoUrl')?.value||'').trim(),
    logoBg:(document.getElementById('logoBg')?.value||'').trim(),
    name:(document.getElementById('name')?.value||'').trim(),
    title:(document.getElementById('title')?.value||'').trim(),
    phone:(document.getElementById('phone')?.value||'').trim(),
    email:(document.getElementById('email')?.value||'').trim(),
    site:(document.getElementById('site')?.value||'').trim(),
    address:(document.getElementById('address')?.value||'').trim(),
    slug:(document.getElementById('slug')?.value||'').trim(),
    vcfFilename:(document.getElementById('vcfFilename')?.value||'').trim()
  };
}

function updatePreview(){
  const frame=document.getElementById('liveFrame');
  if(!frame) return;
  const d=currentData();
  const doc=frame.contentDocument||frame.contentWindow.document;
  doc.open(); doc.write(makeHTML(d)); doc.close();
}

['orgName','orgKey','accent','logoUrl','logoBg','name','title','phone','email','site','address','slug','vcfFilename']
  .forEach(id=>document.getElementById(id)?.addEventListener('input',()=>{ if(id==='logoUrl'||id==='logoBg') previewLogo(); updatePreview(); }));
document.getElementById('updatePreview')?.addEventListener('click', updatePreview);

/* ====== MOCKUP-RENDER ====== */
const MK_BASES = { dark:'/assets/dark.png', light:'/assets/light.png', red:'/assets/red.png' };

function mkLoadImg(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>res(i);i.onerror=rej;i.src=url;});}
function mkToCanvas(img){const c=document.createElement('canvas');c.width=img.width;c.height=img.height;c.getContext('2d',{willReadFrequently:true}).drawImage(img,0,0);return c;}
function mkRoundRect(ctx,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.lineTo(x+w-rr,y);ctx.quadraticCurveTo(x+w,y,x+w,y+rr);ctx.lineTo(x+w,y+h-rr);ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);ctx.lineTo(x+rr,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-rr);ctx.lineTo(x,y+rr);ctx.quadraticCurveTo(x,y,x+rr,y);ctx.closePath();}

function mkRemoveBgByThreshold(c,t=28){
  const x=c.getContext('2d',{willReadFrequently:true});
  const id=x.getImageData(0,0,c.width,c.height);const d=id.data;
  for(let i=0;i<d.length;i+=4){
    const r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];
    if(a<20){ d[i+3]=0; continue; }
    const dist=Math.sqrt((255-r)**2+(255-g)**2+(255-b)**2);
    if(dist<t) d[i+3]=0;
  }
  x.putImageData(id,0,0); return c;
}
function mkToGrayBoost(c){
  const x=c.getContext('2d',{willReadFrequently:true});const id=x.getImageData(0,0,c.width,c.height);const d=id.data;
  for(let i=0;i<d.length;i+=4){
    let y=.2126*d[i]+.7152*d[i+1]+.0722*d[i+2];
    y=(y/255-.5)*1.2+.5; y=Math.max(0,Math.min(1,y));
    const v=Math.round(y*255); d[i]=d[i+1]=d[i+2]=v;
  }
  x.putImageData(id,0,0); return c;
}
async function mkPrepareEngraveCanvas(src){
  if(!src) return null;
  let c=mkToCanvas(await mkLoadImg(src));
  if(document.getElementById('mkAutoRemoveBg')?.checked){
    const thr=parseInt(document.getElementById('mkThreshold')?.value||'28',10);
    c=mkRemoveBgByThreshold(c,thr);
  }
  return mkToGrayBoost(c);
}
function mkDrawEngraved(ctx,img,x,y,w,h,d=0.75){
  ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='brightness(0.18) contrast(1.25)'; ctx.globalAlpha=d;
  ctx.drawImage(img,x,y,w,h); ctx.restore();
  ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='blur(1.2px)'; ctx.globalAlpha=Math.min(0.35,d*0.5);
  ctx.drawImage(img,x+1,y+1,w,h); ctx.restore();
}

async function mkDrawLogoBlock(ctx, box){
  const engraveOn=!!document.getElementById('mkEngrave')?.checked;
  const depth=parseFloat(document.getElementById('mkDepth')?.value||'0.75');
  const d=currentData();
  if(!d.logoUrl) return;

  if(engraveOn){
    const engrC=await mkPrepareEngraveCanvas(d.logoUrl);
    if(!engrC) return;
    const sc=Math.min(box.w/engrC.width, box.h/engrC.height);
    const lw=engrC.width*sc, lh=engrC.height*sc;
    const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
    mkDrawEngraved(ctx, engrC, lx, ly, lw, lh, depth);
  } else {
    if((d.logoBg||'').trim()){ ctx.fillStyle=d.logoBg.trim(); mkRoundRect(ctx, box.x, box.y, box.w, box.h, 12); ctx.fill(); }
    const logo=await mkLoadImg(d.logoUrl);
    const sc=Math.min(box.w/logo.width, box.h/logo.height);
    const lw=logo.width*sc, lh=logo.height*sc;
    const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
    ctx.drawImage(logo, lx, ly, lw, lh);
  }
}

function mkDrawEngravedText(ctx, lines, startY, spacing=30, depth=0.85, align='center', xAnchor=null){
  const isCenter=(align==='center');
  const x = xAnchor!=null ? xAnchor : (isCenter ? Math.round(ctx.canvas.width/2) : Math.round(ctx.canvas.width*0.10));
  ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='brightness(0.25) contrast(1.25)'; ctx.globalAlpha=depth;
  ctx.textAlign = isCenter ? 'center' : 'left';
  let y=startY;
  for(const [txt,size,weight] of lines){
    ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillStyle='#ffffff';
    ctx.fillText(txt, x, y);
    y+=spacing;
  }
  ctx.restore();

  if(!isCenter){
    ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='blur(1.2px)'; ctx.globalAlpha=Math.min(0.4, depth*0.5);
    y=startY;
    for(const [txt,size,weight] of lines){
      ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.fillText(txt, x+1, y+1);
      y+=spacing;
    }
    ctx.restore();
  }
}

async function mkRender(canvas, style, side, mode){
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const base=await mkLoadImg(MK_BASES[style]||MK_BASES.dark);
  const s=Math.max(canvas.width/base.width,canvas.height/base.height);
  const w=base.width*s, h=base.height*s;
  const ox=(canvas.width-w)/2, oy=(canvas.height-h)/2;
  ctx.drawImage(base,ox,oy,w,h);

  const frontPct = parseFloat(document.getElementById('mkFrontSize').value||'64')/100;
  const backPct  = parseFloat(document.getElementById('mkBackSmall').value||'24')/100;
  const fxpc     = parseFloat(document.getElementById('mkFrontX').value||'50')/100;
  const fypc     = parseFloat(document.getElementById('mkFrontY').value||'50')/100;
  const bxpc     = parseFloat(document.getElementById('mkBackX').value ||'50')/100;
  const bypc     = parseFloat(document.getElementById('mkBackY').value ||'18')/100;

  const baseSize = parseFloat(document.getElementById('mkTextBase').value||'40');
  const alignSel = document.getElementById('mkTextAlign').value || 'center';
  const txpc     = parseFloat(document.getElementById('mkTextX').value|| (alignSel==='center'?'50':'10'))/100;
  const typc     = parseFloat(document.getElementById('mkTextY').value||'38')/100;

  const frontSize = canvas.height * frontPct;
  const fullLogoBox = { x: canvas.width*fxpc - frontSize/2, y: canvas.height*fypc - frontSize/2, w: frontSize, h: frontSize };

  const smallSize = canvas.height * backPct;
  const smallLogoBox = { x: canvas.width*bxpc - smallSize/2, y: canvas.height*bypc - smallSize/2, w: smallSize, h: smallSize };

  const textTop = (mode === 'logo-front-text+smalllogo-back')
    ? (smallLogoBox.y + smallLogoBox.h + canvas.height*0.05)
    : canvas.height*typc;

  if(side==='front'){ await mkDrawLogoBlock(ctx, fullLogoBox); return; }

  if(mode==='logo-both'){ await mkDrawLogoBlock(ctx, fullLogoBox); return; }
  if(mode==='logo-front-only'){ return; }
  if(mode==='logo-front-text+smalllogo-back'){ await mkDrawLogoBlock(ctx, smallLogoBox); }

  const d=currentData();
  const nameSize  = Math.round(baseSize * 1.3);
  const titleSize = Math.round(baseSize * 1.0);
  const infoSize  = Math.round(baseSize * 0.85);
  const hintSize  = Math.round(baseSize * 0.65);
  const spacing   = Math.round(baseSize * 0.95);

  const lines=[];
  if(d.name)  lines.push([d.name, nameSize, '800']);
  if(d.title || d.orgName){
    const t = d.title ? d.title + (d.orgName ? ' · '+d.orgName : '') : d.orgName;
    lines.push([t, titleSize, '700']);
  }
  if(d.phone) lines.push(['Tel: '+d.phone,  infoSize, '600']);
  if(d.email) lines.push(['E-post: '+d.email,infoSize, '600']);
  if(d.site)  lines.push(['Nettside: '+d.site,infoSize, '600']);
  lines.push(['Scan NFC / QR for digitalt kort', hintSize, '600']);

  mkDrawEngravedText(ctx, lines, textTop, spacing, 0.88, alignSel, canvas.width*txpc);
}

async function mkUpdate(){
  const style = document.getElementById('mkStyle').value || 'dark';
  const mode  = document.getElementById('mkMode').value || 'logo-both';
  await mkRender(document.getElementById('mkFront'), style, 'front', mode);
  await mkRender(document.getElementById('mkBack'),  style, 'back',  mode);
}

// Events for mockups
['mkMode','mkStyle','mkEngrave','mkAutoRemoveBg','mkDepth','mkThreshold',
 'mkFrontSize','mkFrontX','mkFrontY','mkBackSmall','mkBackX','mkBackY',
 'mkTextAlign','mkTextBase','mkTextX','mkTextY',
 // endringer i admin-feltene påvirker mockups
 'name','title','orgName','orgKey','phone','email','site','logoUrl','logoBg'
].forEach(id=>document.getElementById(id)?.addEventListener('input', ()=>{
  const setVal = (id,suf)=>{const el=document.getElementById(id), out=document.getElementById(id+'Val'); if(el&&out) out.textContent = el.value+(suf||'');};
  setVal('mkThreshold',''); setVal('mkFrontSize','%'); setVal('mkBackSmall','%');
  setVal('mkFrontX','%'); setVal('mkFrontY','%'); setVal('mkBackX','%'); setVal('mkBackY','%');
  setVal('mkTextBase',' px'); setVal('mkTextX','%'); setVal('mkTextY','%');
  mkUpdate();
}));

// Nedlasting
function mkDownload(cnv, name){ const a=document.createElement('a'); a.href=cnv.toDataURL('image/png'); a.download=name; a.click(); }
document.getElementById('mkDownloadFront')?.addEventListener('click', ()=> mkDownload(document.getElementById('mkFront'), 'kort-forside.png'));
document.getElementById('mkDownloadBack') ?.addEventListener('click', ()=> mkDownload(document.getElementById('mkBack'),  'kort-bakside.png'));

/* INIT */
function initCounters(){
  ['mkThreshold','mkFrontSize','mkBackSmall','mkFrontX','mkFrontY','mkBackX','mkBackY','mkTextBase','mkTextX','mkTextY']
    .forEach(id=>{ const el=document.getElementById(id), out=document.getElementById(id+'Val'); if(el&&out) out.textContent = el.value + (id==='mkTextBase'?' px':'%'); });
}
function init(){
  previewLogo();
  updatePreview();
  initCounters();
  mkUpdate();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
