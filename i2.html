<!-- === FYSISKE KORT – MOCKUPS (ADMIN) === -->
<section id="mockups" class="card" style="margin-top:14px">
  <h2>Fysiske kort – mockup</h2>

  <style>
    /* Lokal stil for mockups */
    .mock-card{background:#0f1216;border:1px solid #1d2430;border-radius:14px;padding:16px}
    .two-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.two-cards{grid-template-columns:1fr}}
    canvas.mock-canvas{width:100%;height:auto;max-width:100%;border-radius:14px;display:block;background:#111}
    .axis{display:grid;gap:6px;min-width:260px}
    .axis h4{margin:4px 0}
    .axis-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center}
    .axis-cap{font:700 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#cfe3ff;background:#223141;border:1px solid #33465e;padding:4px 6px;border-radius:6px;white-space:nowrap}
    .val{font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#9fb0c6}
    .val code{color:#cfe3ff}
  </style>

  <div class="row" style="align-items:flex-end">
    <label>Modus
      <select id="mkMode">
        <option value="logo-both" selected>1) Logo på begge sider</option>
        <option value="logo-front-only">2) Kun logo forside, bakside blank</option>
        <option value="logo-front-text-back">3) Logo forside + tekst bakside</option>
        <option value="logo-front-text+smalllogo-back">4) Logo forside + tekst + liten logo bakside</option>
      </select>
    </label>
    <label>Stil
      <select id="mkStyle">
        <option value="dark" selected>Dark</option>
        <option value="light">Light</option>
        <option value="red">Red</option>
      </select>
    </label>
    <div>
      <button class="pill" id="mkDownloadFront">Last ned forside</button>
      <button class="pill" id="mkDownloadBack">Last ned bakside</button>
    </div>
  </div>

  <!-- Forhåndsvisning rett under modusvalget -->
  <div class="mock-card" style="margin-top:8px">
    <div class="two-cards">
      <canvas id="mkFront" class="mock-canvas" width="860" height="540"></canvas>
      <canvas id="mkBack"  class="mock-canvas" width="860" height="540"></canvas>
    </div>
    <p class="note" style="margin:8px 0 0">Justér med sliderne under. Eksport er rene bilder uten UI.</p>
  </div>

  <!-- Slidere / kontroller -->
  <div class="grid" style="margin-top:12px">
    <!-- Laser -->
    <div class="axis">
      <h4>Lasergravering</h4>
      <label class="pill" style="width:max-content"><input type="checkbox" id="mkEngrave" checked> Lasergravér logo</label>
      <label style="width:max-content">Fjern lys bakgrunn <input type="checkbox" id="mkAutoRemoveBg" checked></label>
      <label>Dybde
        <input type="range" id="mkDepth" min="0.25" max="1" step="0.05" value="0.75">
      </label>
      <label>Terskel
        <input type="range" id="mkThreshold" min="8" max="80" step="1" value="28">
        <code id="mkThresholdVal">28</code>
      </label>
    </div>

    <!-- Forside-logo -->
    <div class="axis">
      <h4>Forside-logo</h4>
      <div><span class="val">Størrelse: </span><code id="mkFrontSizeVal">64%</code></div>
      <input type="range" id="mkFrontSize" min="20" max="100" step="1" value="64">
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="mkFrontX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="mkFrontXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="mkFrontY" min="0" max="100" step="1" value="50">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="mkFrontYVal">50%</code></span>
      </div>
    </div>

    <!-- Bakside – liten logo -->
    <div class="axis">
      <h4>Liten logo – bakside</h4>
      <div><span class="val">Størrelse: </span><code id="mkBackSmallVal">24%</code></div>
      <input type="range" id="mkBackSmall" min="10" max="60" step="1" value="24">
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="mkBackX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="mkBackXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="mkBackY" min="0" max="100" step="1" value="18">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="mkBackYVal">18%</code></span>
      </div>
    </div>

    <!-- Tekst bakside -->
    <div class="axis">
      <h4>Tekst – bakside</h4>
      <div class="inline" style="gap:12px;margin:4px 0">
        <label>Justering
          <select id="mkTextAlign">
            <option value="center" selected>Midtstilt</option>
            <option value="left">Venstrejustert</option>
          </select>
        </label>
        <label>Størrelse (base)
          <input type="range" id="mkTextBase" min="18" max="72" step="1" value="40">
          <code id="mkTextBaseVal">40 px</code>
        </label>
      </div>
      <div class="axis-row">
        <span class="axis-cap">← VENSTRE</span>
        <input type="range" id="mkTextX" min="0" max="100" step="1" value="50">
        <span class="axis-cap">HØYRE →</span>
        <span class="val"><code id="mkTextXVal">50%</code></span>
      </div>
      <div class="axis-row">
        <span class="axis-cap">↑ OPP</span>
        <input type="range" id="mkTextY" min="10" max="90" step="1" value="38">
        <span class="axis-cap">NED ↓</span>
        <span class="val"><code id="mkTextYVal">38%</code></span>
      </div>
      <p class="note" style="margin:4px 0 0">Ved “Logo forside + liten logo bak” starter teksten under logo automatisk.</p>
    </div>
  </div>

  <!-- JS for mockups -->
  <script>
    // === Konstanter / assets ===
    const MK_BASES = { dark:'/assets/dark.png', light:'/assets/light.png', red:'/assets/red.png' };

    // === Hjelpere ===
    function mkLoadImg(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>res(i);i.onerror=rej;i.src=url;});}
    function mkToCanvas(img){const c=document.createElement('canvas');c.width=img.width;c.height=img.height;c.getContext('2d',{willReadFrequently:true}).drawImage(img,0,0);return c;}
    function mkRoundRect(ctx,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.lineTo(x+w-rr,y);ctx.quadraticCurveTo(x+w,y,x+w,y+rr);ctx.lineTo(x+w,y+h-rr);ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);ctx.lineTo(x+rr,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-rr);ctx.lineTo(x,y+rr);ctx.quadraticCurveTo(x,y,x+rr,y);ctx.closePath();}

    // === Bildebehandling (laser) ===
    function mkRemoveBgByThreshold(c,t=28){
      const x=c.getContext('2d',{willReadFrequently:true}), id=x.getImageData(0,0,c.width,c.height), d=id.data;
      for(let i=0;i<d.length;i+=4){
        const r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];
        if(a<20){ d[i+3]=0; continue; }
        const dist=Math.sqrt((255-r)**2+(255-g)**2+(255-b)**2);
        if(dist<t) d[i+3]=0;
      }
      x.putImageData(id,0,0); return c;
    }
    function mkToGrayBoost(c){
      const x=c.getContext('2d',{willReadFrequently:true}), id=x.getImageData(0,0,c.width,c.height), d=id.data;
      for(let i=0;i<d.length;i+=4){
        let y=.2126*d[i]+.7152*d[i+1]+.0722*d[i+2];
        y=(y/255-.5)*1.2+.5; y=Math.max(0,Math.min(1,y));
        const v=Math.round(y*255); d[i]=d[i+1]=d[i+2]=v;
      }
      x.putImageData(id,0,0); return c;
    }
    async function mkPrepareEngraveCanvas(src){
      if(!src) return null;
      let c=mkToCanvas(await mkLoadImg(src));
      if(document.getElementById('mkAutoRemoveBg')?.checked){
        const thr=parseInt(document.getElementById('mkThreshold').value||'28',10);
        c=mkRemoveBgByThreshold(c,thr);
      }
      return mkToGrayBoost(c);
    }
    function mkDrawEngraved(ctx,img,x,y,w,h,d=0.75){
      ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='brightness(0.18) contrast(1.25)'; ctx.globalAlpha=d;
      ctx.drawImage(img,x,y,w,h); ctx.restore();
      ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='blur(1.2px)'; ctx.globalAlpha=Math.min(0.35,d*0.5);
      ctx.drawImage(img,x+1,y+1,w,h); ctx.restore();
    }

    // === Logo-blokk ===
    async function mkDrawLogoBlock(ctx, data, box){
      const engraveOn = !!document.getElementById('mkEngrave')?.checked;
      const depth = parseFloat(document.getElementById('mkDepth')?.value||'0.75');
      const logoUrl = (document.getElementById('logoUrl')?.value||'').trim();
      const logoBg  = (document.getElementById('logoBg')?.value||'').trim();
      if(!logoUrl) return;

      if(engraveOn){
        const engrC=await mkPrepareEngraveCanvas(logoUrl);
        if(!engrC) return;
        const sc=Math.min(box.w/engrC.width, box.h/engrC.height);
        const lw=engrC.width*sc, lh=engrC.height*sc;
        const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
        mkDrawEngraved(ctx, engrC, lx, ly, lw, lh, depth);
      } else {
        if(logoBg){ ctx.fillStyle=logoBg; mkRoundRect(ctx, box.x, box.y, box.w, box.h, 12); ctx.fill(); }
        const logo=await mkLoadImg(logoUrl);
        const sc=Math.min(box.w/logo.width, box.h/logo.height);
        const lw=logo.width*sc, lh=logo.height*sc;
        const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
        ctx.drawImage(logo, lx, ly, lw, lh);
      }
    }

    // === Lasergravert tekst ===
    function mkDrawEngravedText(ctx, lines, startY, spacing=30, depth=0.85, align='center', xAnchor=null){
      const isCenter = (align==='center');
      const x = xAnchor != null ? xAnchor : (isCenter ? Math.round(ctx.canvas.width/2) : Math.round(ctx.canvas.width*0.10));
      ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='brightness(0.25) contrast(1.25)'; ctx.globalAlpha=depth;
      ctx.textAlign = isCenter ? 'center' : 'left';
      let y = startY;
      for(const [txt,size,weight] of lines){
        ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
        ctx.fillStyle = '#ffffff';
        ctx.fillText(txt, x, y);
        y += spacing;
      }
      ctx.restore();

      if(!isCenter){
        ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='blur(1.2px)'; ctx.globalAlpha=Math.min(0.4, depth*0.5);
        y = startY;
        for(const [txt,size,weight] of lines){
          ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
          ctx.fillText(txt, x+1, y+1);
          y += spacing;
        }
        ctx.restore();
      }
    }

    // === Render én side ===
    async function mkRender(canvas, style, side, mode){
      const ctx=canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // base
      const base=await mkLoadImg(MK_BASES[style]||MK_BASES.dark);
      const s=Math.max(canvas.width/base.width,canvas.height/base.height);
      const w=base.width*s, h=base.height*s;
      const ox=(canvas.width-w)/2, oy=(canvas.height-h)/2;
      ctx.drawImage(base,ox,oy,w,h);

      // Slidere
      const frontPct = parseFloat(document.getElementById('mkFrontSize').value||'64')/100;
      const backPct  = parseFloat(document.getElementById('mkBackSmall').value||'24')/100;
      const fxpc     = parseFloat(document.getElementById('mkFrontX').value||'50')/100;
      const fypc     = parseFloat(document.getElementById('mkFrontY').value||'50')/100;
      const bxpc     = parseFloat(document.getElementById('mkBackX').value ||'50')/100;
      const bypc     = parseFloat(document.getElementById('mkBackY').value ||'18')/100;

      const baseSize = parseFloat(document.getElementById('mkTextBase').value||'40');
      const alignSel = document.getElementById('mkTextAlign').value || 'center';
      const txpc     = parseFloat(document.getElementById('mkTextX').value|| (alignSel==='center'?'50':'10'))/100;
      const typc     = parseFloat(document.getElementById('mkTextY').value||'38')/100;

      // Bokser
      const frontSize = canvas.height * frontPct;
      const fullLogoBox = { x: canvas.width*fxpc - frontSize/2, y: canvas.height*fypc - frontSize/2, w: frontSize, h: frontSize };

      const smallSize = canvas.height * backPct;
      const smallLogoBox = { x: canvas.width*bxpc - smallSize/2, y: canvas.height*bypc - smallSize/2, w: smallSize, h: smallSize };

      // Tekststart (under liten logo ved modus 4)
      const textTop = (mode === 'logo-front-text+smalllogo-back')
        ? (smallLogoBox.y + smallLogoBox.h + canvas.height*0.05)
        : canvas.height*typc;

      // FRONT
      if(side==='front'){ await mkDrawLogoBlock(ctx, {}, fullLogoBox); return; }

      // BACK
      if(mode==='logo-both'){ await mkDrawLogoBlock(ctx, {}, fullLogoBox); return; }
      if(mode==='logo-front-only'){ return; }
      if(mode==='logo-front-text+smalllogo-back'){ await mkDrawLogoBlock(ctx, {}, smallLogoBox); }

      // Tekstinnhold (fra adminfeltene)
      const get = id => (document.getElementById(id)?.value||'').trim();
      const name  = get('name');
      const title = get('title');
      const org   = get('orgName') || get('orgKey');
      const phone = get('phone');
      const email = get('email');
      const site  = get('site');

      const nameSize  = Math.round(baseSize * 1.3);
      const titleSize = Math.round(baseSize * 1.0);
      const infoSize  = Math.round(baseSize * 0.85);
      const hintSize  = Math.round(baseSize * 0.65);
      const spacing   = Math.round(baseSize * 0.95);

      const lines=[];
      if(name)  lines.push([name, nameSize, '800']);
      if(title || org){ lines.push([ title ? (org ? (title+' · '+org) : title) : org, titleSize, '700' ]); }
      if(phone) lines.push(['Tel: '+phone,  infoSize, '600']);
      if(email) lines.push(['E-post: '+email,infoSize, '600']);
      if(site)  lines.push(['Nettside: '+site,infoSize, '600']);
      lines.push(['Scan NFC / QR for digitalt kort', hintSize, '600']);

      const anchorX = canvas.width*txpc;
      mkDrawEngravedText(ctx, lines, textTop, spacing, 0.88, alignSel, anchorX);
    }

    // === Oppdater begge sider ===
    async function mkUpdate(){
      const style = document.getElementById('mkStyle').value || 'dark';
      const mode  = document.getElementById('mkMode').value || 'logo-both';
      await mkRender(document.getElementById('mkFront'), style, 'front', mode);
      await mkRender(document.getElementById('mkBack'),  style, 'back',  mode);
    }

    // === Events ===
    ['mkMode','mkStyle','mkEngrave','mkAutoRemoveBg','mkDepth','mkThreshold',
     'mkFrontSize','mkFrontX','mkFrontY','mkBackSmall','mkBackX','mkBackY',
     'mkTextAlign','mkTextBase','mkTextX','mkTextY',
     // når man endrer felter i admin-skjemaet
     'name','title','orgName','orgKey','phone','email','site','logoUrl','logoBg'
    ].forEach(id=>document.getElementById(id)?.addEventListener('input', ()=>{
      const setVal = (id,suf)=>{const el=document.getElementById(id), out=document.getElementById(id+'Val'); if(el&&out) out.textContent = el.value+(suf||'');};
      setVal('mkThreshold',''); setVal('mkFrontSize','%'); setVal('mkBackSmall','%');
      setVal('mkFrontX','%'); setVal('mkFrontY','%'); setVal('mkBackX','%'); setVal('mkBackY','%');
      setVal('mkTextBase',' px'); setVal('mkTextX','%'); setVal('mkTextY','%');
      mkUpdate();
    }));

    // Nedlasting
    function mkDownload(cnv, name){ const a=document.createElement('a'); a.href=cnv.toDataURL('image/png'); a.download=name; a.click(); }
    document.getElementById('mkDownloadFront')?.addEventListener('click', ()=> mkDownload(document.getElementById('mkFront'), 'kort-forside.png'));
    document.getElementById('mkDownloadBack') ?.addEventListener('click', ()=> mkDownload(document.getElementById('mkBack'),  'kort-bakside.png'));

    // Init
    (function initMockups(){
      // init visningstall
      ['mkThreshold','mkFrontSize','mkBackSmall','mkFrontX','mkFrontY','mkBackX','mkBackY','mkTextBase','mkTextX','mkTextY']
        .forEach(id=>{ const el=document.getElementById(id), out=document.getElementById(id+'Val'); if(el&&out) out.textContent = el.value + (id==='mkTextBase'?' px':'%'); });
      mkUpdate();
    })();
  </script>
</section>
