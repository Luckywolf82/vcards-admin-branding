<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFCKING – Adminpanel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    body{background:#0b0b10;color:#e9eef5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#21c36a;font-weight:700}
    .err{color:#ff6b6b;font-weight:700}
    .note{font-size:.95rem;color:#8ea0b4}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:1px solid #344458}
    .links-table{width:100%;border-collapse:collapse}
    .links-table th,.links-table td{border-bottom:1px solid #2a3442;padding:.3rem;vertical-align:top}
    .muted{color:#8ea0b4}
    code{background:#0d1117;color:#d1e7ff;padding:.2em .4em;border-radius:6px}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .logo-prev{height:36px;max-width:220px;object-fit:contain;margin-left:8px;background:#fff;border-radius:6px;padding:4px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a}
    .url-actions{margin-left:6px}
    .brand{text-align:center;margin:0 0 18px}
    .brand img{max-width:240px;height:auto;filter:drop-shadow(0 0 6px #3fffd2)}
    .brand-sub{margin:6px 0 0;color:#8ea0b4}
    .brand-rule{border:0;height:2px;background:linear-gradient(90deg,#8fd3ff,#52a3ff);opacity:.7;margin:10px 0 16px}
    #nfcLog{background:#0d1117;color:#cfe3ff;padding:10px;border-radius:8px;white-space:pre-wrap;max-height:220px;overflow:auto;margin-top:10px}
    .hide{display:none}
    .card{max-width:980px;margin:0 auto}
  </style>

<style>
  /* Tillegg for mockup/order-kort – lav risiko for konflikt */
  .card {
    background: var(--card-bg, #111);
    border: 1px solid #2a2a2a;
    border-radius: 14px;
    padding: 14px 16px;
  }
  .row {
    display: grid;
    grid-template-columns: repeat(4, minmax(180px, 1fr));
    gap: 12px;
  }
  .row label { display: grid; gap: 6px; font-size: 0.95rem; }
  .inline { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .pill, .btn {
    border-radius: 999px;
    border: 1px solid #333;
    background: #1b1b1b;
    padding: 10px 14px;
    cursor: pointer;
  }
  .pill:hover, .btn:hover { background:#222; }
  .help { opacity: .75; font-size: .9rem; }
  canvas#mockupCanvas { box-shadow: 0 8px 32px rgba(0,0,0,.45) inset; }
  @media (max-width: 960px) {
    .row { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 620px) {
    .row { grid-template-columns: 1fr; }
  }
</style>

<style>
  details#advancedRepo summary { cursor:pointer; user-select:none; }
  details#advancedRepo[open] summary { opacity:.85 }
  :where(input,select,textarea){ background:#121212; color:#eee; border:1px solid #2a2a2a; border-radius:10px; padding:10px }
  :where(input,select,textarea):focus { outline:2px solid #3a3a3a }
  .muted { opacity:.7; font-size:.9rem }
  .hide { display:none !important; }
</style>

</head>

<body>
  <!-- AUTH: vises før innlogging -->
  <section id="auth" class="card">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Logg inn for å bruke adminpanelet</p>
    </div>
    <hr class="brand-rule">
    <button id="btnGoogle" class="btn">Logg inn med Google</button>
    <p class="note" style="margin-top:8px">Krever at brukeren finnes i Firestore policy (kan åpnes for alle – nå tillater vi alle innloggede).</p>
  </section>

  <!-- APP: skjules til bruker er innlogget -->
  <main id="app" class="hide">

<!-- === FYSISK KORT – MOCKUP === -->
<section id="mockupSection" class="card" style="margin-top:16px">
  <h2>Fysisk kort – mockup (lasergravert look)</h2>

  <div class="row" style="align-items:end">
    <label>Tretype
      <select id="woodType">
        <option value="walnut">Valnøtt (mørk)</option>
        <option value="cherry">Kirsebær (lys)</option>
        <option value="mahogany">Mahogni (varm)</option>
      </select>
    </label>

    <label>Logo (PNG)
      <input type="file" id="logoPng" accept="image/png" />
    </label>

    <label style="grid-column:1 / -1;display:flex;align-items:center;gap:10px">
      <input type="checkbox" id="autoRemoveBg" checked />
      Fjern lys bakgrunn automatisk
      <span style="margin-left:8px">Terskel:
        <input type="range" id="bgThreshold" min="8" max="80" value="28" />
        <code id="bgThresholdVal">28</code>
      </span>
    </label>

    <div style="grid-column:1 / -1;display:flex;gap:10px;flex-wrap:wrap">
      <button type="button" id="downloadMockup" class="pill">Last ned mockup (PNG)</button>
      <span class="help">Tips: last opp logo i svart/hvitt for renest “lasergravert” uttrykk.</span>
    </div>
  </div>

  <div style="margin-top:12px;display:flex;justify-content:center">
    <canvas id="mockupCanvas" width="1000" height="630"
            style="max-width:100%;background:#2a2a2a;border-radius:14px"></canvas>
  </div>
</section>
<!-- === /FYSISK KORT – MOCKUP === -->

<!-- === BESTILL KORT === -->
<section id="orderSection" class="card" style="margin-top:16px">
  <h2>Bestill kort</h2>
  <div class="row">
    <label>Antall
      <input id="orderQty" type="number" min="1" value="10" />
    </label>
    <label>Format
      <select id="orderFormat">
        <option value="86x54">Standard 85.6×54 mm</option>
      </select>
    </label>
    <label>Sider
      <select id="orderSides">
        <option value="single">Enkeltsidig</option>
        <option value="double">Dobbelsidig</option>
      </select>
    </label>
    <label>Tresort
      <select id="orderWood">
        <option value="walnut">Valnøtt</option>
        <option value="cherry">Kirsebær</option>
        <option value="mahogany">Mahogni</option>
      </select>
    </label>
    <label>Kontaktperson / Referanse
      <input id="orderRef" placeholder="Navn / PO / referanse" />
    </label>
    <label>Leveringsadresse
      <input id="orderAddr" placeholder="Firma, adresse, postnr/sted" />
    </label>
    <label style="grid-column:1 / -1">Kommentarer / spesifikasjon (gravering, plassering, ekstra)
      <textarea id="orderNotes" rows="3" placeholder="Evt. ønsker for graveringstekst, plassering, QR/NFC, logo på bakside osv."></textarea>
    </label>

    <!-- Avanserte repo-innstillinger (for publisering via Netlify Functions) -->
    <details id="advancedRepo" style="grid-column:1 / -1; margin-top:6px">
      <summary>Avanserte innstillinger (repo & organisasjonsnøkkel)</summary>
      <div class="row" style="margin-top:8px">
        <label>GitHub Owner
          <input id="repoOwner" placeholder="f.eks. luckywolf82" />
        </label>
        <label>GitHub Repo
          <input id="repoName" placeholder="f.eks. nfcking-pages" />
        </label>
        <label>Base path (valgfritt)
          <input id="basePath" placeholder="Vcards (default hvis tom)" />
        </label>
        <label>Org-nøkkel (orgKey)
          <input id="orgKey" placeholder="unik nøkkel for kunde/org" />
        </label>
      </div>
      <p class="help">Dersom disse feltene er tomme, brukes standard fra Netlify-funksjonen (env). Fyll inn hvis du vil publisere til et bestemt repo/sti/org.</p>
    </details>
  </div>

  <div class="inline" style="margin-top:8px">
    <button class="btn" id="btnCopyOrder">Kopier bestillingstekst</button>
    <button class="pill" id="btnEmailOrder">Åpne e-post med bestilling</button>
    <button class="pill" id="btnDownloadOrder">Last ned ordre.json</button>
    <button class="btn" id="btnUploadLogoRepo">Publiser logo til repo (assets)</button>
    <button class="btn" id="btnSendToProd">Send til produksjon (mockup + ordre)</button>
  </div>
  <p class="help">Bestilling legger ved alle felter + linker til generert digitalt kort. Legg ved mockup-PNG manuelt i e-posten (lastet ned over).</p>
</section>
<!-- === /BESTILL KORT === -->


    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/Luckywolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Kongen av kontaktløs – bygg, merk og publiser NFC-kort</p>
    </div>
    <hr class="brand-rule">

    <!-- (1) Organisasjonsprofiler + ansatte-lister (hentes fra Firestore hvis mulig) -->
    <script>
      // Disse fylles fra Firestore ved innlogging. Vi har også fallback.
      window.ORG_PROFILES = {};   // { key: {name, accent, logo, site, logoBg} }
      window.EMPLOYEES    = {};   // { key: [ {slug, name, ...} ] } – valgfritt, tom som default
    </script>

    <h2>Organisasjon</h2>
    <div class="row">
      <label>Velg organisasjon
        <select id="orgSelect"></select>
      </label>

      <div class="inline">
        <label style="flex:1">Org key (mappe – case sensitive)
          <input id="orgKey" placeholder="OrgKey" required oninput="applyBranding('force'); syncOrgSelectFromKey(); loadEmployees();">
        </label>
        <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
          <img id="logoPreview" class="logo-prev" alt="logo" />
        </div>
      </div>

      <label>Org navn (visning)
        <input id="orgName" placeholder="Din organisasjon">
      </label>
      <label>Accent farge (hex)
        <input id="accent" placeholder="#3aa0ff">
      </label>
      <label>Org nettside
        <input id="orgSite" placeholder="https://domene.no">
      </label>

      <label>Logo URL (eller last opp)
        <div style="display:flex;gap:6px;align-items:center">
          <input id="logoUrl" placeholder="https://.../logo.png" oninput="previewLogo()" style="flex:1">
          <input type="file" id="logoFile" accept="image/*" onchange="handleLogoUpload(event)">
        </div>
      </label>

      <label>Logo bakgrunn
        <input id="logoBg" placeholder="#ffffff (tom = auto)">
      </label>
    </div>

    <h2>Person</h2>
    <div class="row">
      <label>Velg ansatt
        <select id="employeeSelect"><option value="">(Velg ansatt…)</option></select>
      </label>
      <div></div>

      <label>Slug (mappe/URL uten æøå/mellomrom)
        <input id="slug" placeholder="ola-nordmann" required>
      </label>
      <label>Navn
        <input id="name" placeholder="Ola Nordmann" required>
      </label>
      <label>Tittel
        <input id="title" placeholder="Salgsleder">
      </label>
      <label>Telefon (E.164)
        <input id="phone" placeholder="+47 40000000">
      </label>
      <label>E-post
        <input id="email" placeholder="ola@firma.no">
      </label>
      <label>Nettside
        <input id="site" placeholder="https://firma.no">
      </label>
      <label>Adresse
        <input id="address" placeholder="Storgata 1, 0001 Oslo">
      </label>
      <label>VCF-filnavn
        <input id="vcfFilename" placeholder="ola_nordmann.vcf">
      </label>
    </div>

    <h2>Lenker og tekster</h2>
    <div class="row">
      <label>Forhåndsvalg (klikk for å legge til)</label>
      <div>
        <button type="button" class="pill" data-label="LinkedIn"  data-url="https://www.linkedin.com/in/">LinkedIn</button>
        <button type="button" class="pill" data-label="Instagram" data-url="https://instagram.com/">Instagram</button>
        <button type="button" class="pill" data-label="Facebook"  data-url="https://facebook.com/">Facebook</button>
        <button type="button" class="pill" data-label="YouTube"   data-url="https://youtube.com/@">YouTube</button>
        <button type="button" class="pill" data-label="TikTok"    data-url="https://www.tiktok.com/@">TikTok</button>
        <button type="button" class="pill" data-label="GitHub"    data-url="https://github.com/">GitHub</button>
        <button type="button" class="pill" data-label="Nettside"  data-url="https://">Nettside</button>
        <button type="button" class="pill" data-label="Kalender"  data-url="https://cal.com/">Kalender</button>
        <button type="button" class="pill" data-label="WhatsApp"  data-url="https://wa.me/">WhatsApp</button>
      </div>
    </div>

    <table class="links-table" id="linksTable">
      <thead><tr><th>Label</th><th>URL</th><th>Tekst over</th><th>Tekst under</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row">
      <label>Ny label<input id="newLabel" placeholder="LinkedIn"></label>
      <label>Ny URL<input id="newUrl" placeholder="https://linkedin.com/in/..."></label>
      <label>Tekst over<input id="newPre" placeholder="Følg meg på LinkedIn"></label>
      <label>Tekst under<input id="newPost" placeholder="@brukernavn (daglig oppdatert)"></label>
      <div><button type="button" id="addLink">Legg til</button></div>
    </div>

    <h2>Publisering</h2>
    <div class="row">
      <label>GitHub owner
        <input id="ghUser" placeholder="brukernavn">
      </label>
      <label>Repo-navn
        <input id="ghRepo" placeholder="Vcards">
      </label>
      <label>BASE_PATH
        <input id="basePath" placeholder="Vcards" value="Vcards">
      </label>
      <label>Commit-strategi
        <select id="strategy">
          <option value="pr">Branch + Pull Request</option>
          <option value="direct">Direkte til main</option>
        </select>
      </label>
    </div>

    <button id="generate">Generer & Publiser</button>
    <span id="status"></span>

    <h3>Resultat</h3>
    <p>NFC-URL: <input id="nfcUrl" style="width:100%" readonly></p>
    <p>HTML-URL: <input id="htmlUrl" style="width:100%" readonly></p>

    <h4>vCard</h4>
    <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

    <h4>index.html</h4>
    <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>

    <!-- Live forhåndsvisning -->
    <div id="livePreviewContainer" style="margin-top:10px;">
      <h4>Live forhåndsvisning</h4>
      <button id="openPreviewBtn" style="margin:6px 0;">Åpne forhåndsvisning i ny fane</button>
      <iframe id="livePreviewFrame" style="width:100%;height:480px;border:1px solid #333;border-radius:8px;background:#111;" title="Live Preview"></iframe>
    </div>

    <h2>NFC (Web NFC – Chrome/Android)</h2>
    <div class="row">
      <label>Velg skrive-type
        <select id="nfcWriteMode">
          <option value="url">URL (åpnes i nettleser)</option>
          <option value="text">Tekst</option>
          <option value="vcard">vCard (.vcf fra forhåndsvisning)</option>
        </select>
      </label>
      <label>Payload (for URL/tekst)
        <input id="nfcPayload" placeholder="https://ditt-domene.no/sti">
      </label>
      <div>
        <button id="nfcRead" class="pill" type="button">Les NFC</button>
        <button id="nfcWrite" class="pill" type="button">Skriv NFC</button>
      </div>
    </div>
    <pre id="nfcLog"></pre>

  </main>

  <!-- Firebase (CDN) + Auth/Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase-prosjektet ditt
    const firebaseConfig = {
      apiKey: "AIzaSyDypfSLkWWRQh9TFrIjWpYWKmO3dBDnb_s",
      authDomain: "nfcking-bb143.firebaseapp.com",
      projectId: "nfcking-bb143",
      storageBucket: "nfcking-bb143.firebasestorage.app",
      messagingSenderId: "435773344673",
      appId: "1:435773344673:web:0e77e1445209f0adb319e0",
      measurementId: "G-EHN7M5NJJS"
    };

    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const authSec = $('auth');
    const appSec  = $('app');
    const btnGoogle = $('btnGoogle');

    // Hent orgs fra Firestore → bygg ORG_PROFILES
    async function loadOrgsFromFirestore(){
      try {
        const snap = await getDocs(collection(db, 'orgs'));
        const orgs = {};
        snap.forEach(d => {
          const key  = d.id;
          const data = d.data() || {};
          orgs[key] = {
            name:   data.name   || key,
            accent: data.accent || '#8fd3ff',
            logo:   data.logo   || '',
            site:   data.site   || '',
            logoBg: data.logoBg || '#ffffff'
          };
        });
        if (Object.keys(orgs).length === 0) {
          window.ORG_PROFILES = { "DemoOrg": { name:"DemoOrg", accent:"#3ec6ff", logo:"", site:"https://eksempel.no", logoBg:"#ffffff" } };
        } else {
          window.ORG_PROFILES = orgs;
        }
      } catch (e) {
        console.warn('Klarte ikke hente orgs fra Firestore:', e);
        if (!window.ORG_PROFILES || Object.keys(window.ORG_PROFILES).length===0){
          window.ORG_PROFILES = { "DemoOrg": { name:"DemoOrg", accent:"#3ec6ff", logo:"", site:"https://eksempel.no", logoBg:"#ffffff" } };
        }
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authSec.classList.remove('hide');
        appSec.classList.add('hide');
        return;
      }
      await loadOrgsFromFirestore();
      populateOrgSelect();
      if (!$('orgKey').value && $('orgSelect').options.length){
        $('orgSelect').selectedIndex = 0; syncOrgKeyFromSelect();
      } else { syncOrgSelectFromKey(); applyBranding('auto'); loadEmployees(); }
      authSec.classList.add('hide');
      appSec.classList.remove('hide');
    });

    btnGoogle?.addEventListener('click', async ()=>{
      try { await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch (e) { alert('Innlogging feilet: '+e.message); }
    });

    window._firebase = { auth, db };
  </script>

  <!-- UI: organisasjoner/ansatte -->
  <script>
    function populateOrgSelect(){
      const orgSelect = document.getElementById('orgSelect');
      orgSelect.innerHTML = '';
      const orgs = window.ORG_PROFILES || {};
      Object.keys(orgs).forEach(key=>{
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = orgs[key].name || key;
        orgSelect.appendChild(opt);
      });
    }

    function syncOrgKeyFromSelect(){
      const key = document.getElementById('orgSelect').value;
      document.getElementById('orgKey').value = key;
      applyBranding('force');
      loadEmployees();
    }

    function syncOrgSelectFromKey(){
      const key = document.getElementById('orgKey').value.trim();
      const orgSelect = document.getElementById('orgSelect');
      const idx = Array.from(orgSelect.options).findIndex(o => o.value === key);
      if (idx >= 0) orgSelect.selectedIndex = idx;
    }

    function loadEmployees(){
      const key = document.getElementById('orgKey').value.trim();
      const list = (window.EMPLOYEES || {})[key] || [];
      const sel = document.getElementById('employeeSelect');
      sel.innerHTML = '<option value="">(Velg ansatt…)</option>';
      list.forEach((emp, i)=>{
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = emp.name + (emp.title ? ' – ' + emp.title : '');
        sel.appendChild(opt);
      });
    }

    function fillEmployee(iStr){
      const key = document.getElementById('orgKey').value.trim();
      const list = (window.EMPLOYEES || {})[key] || [];
      const emp  = list[parseInt(iStr,10)];
      if (!emp) return;
      const set = (id, val) => { const el=document.getElementById(id); if (el) el.value = val || ''; };
      set('slug', emp.slug); set('name', emp.name); set('title', emp.title);
      set('phone', emp.phone); set('email', emp.email);
      set('site', emp.site); set('address', emp.address); set('vcfFilename', emp.vcfFilename);
    }

    document.getElementById('employeeSelect').addEventListener('change', (e)=> fillEmployee(e.target.value));
  </script>

  <!-- Lenketabell -->
  <script>
    const tbody = document.querySelector('#linksTable tbody');

    function addRow(label, url, pre = '', post = '') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${label||''}" class="lbl" /></td>
        <td><input value="${url||''}" class="lnk" style="width:100%"/></td>
        <td><textarea class="pre" rows="2" placeholder="Tekst over">${pre||''}</textarea></td>
        <td><textarea class="post" rows="2" placeholder="Tekst under">${post||''}</textarea></td>
        <td><button type="button" class="remove">Fjern</button></td>`;
      tr.querySelector('.remove').addEventListener('click', () => tr.remove());
      tbody.appendChild(tr);
    }

    document.getElementById('addLink').addEventListener('click', () => {
      addRow(
        document.getElementById('newLabel').value,
        document.getElementById('newUrl').value,
        document.getElementById('newPre').value,
        document.getElementById('newPost').value
      );
      ['newLabel','newUrl','newPre','newPost'].forEach(id => document.getElementById(id).value = '');
    });

    document.querySelectorAll('.pill').forEach(btn => {
      btn.addEventListener('click', () => addRow(btn.dataset.label, btn.dataset.url));
    });
  </script>

  <!-- Branding & logo -->
  <script>
    function applyBranding(mode = 'auto'){
      const key  = document.getElementById('orgKey').value.trim();
      const prof = (window.ORG_PROFILES || {})[key];
      if (!prof) return;
      const set = (id, val) => { const el=document.getElementById(id); if (!el) return; if (mode==='force' || !el.value) el.value = val || ''; };
      set('orgName', prof.name || key);
      set('accent' , prof.accent || '#8fd3ff');
      set('orgSite', prof.site || '');
      set('logoUrl', prof.logo || '');
      set('logoBg' , prof.logoBg || '#ffffff');
      previewLogo();
    }
    window.applyBranding = applyBranding;

    function previewLogo(){
      const url = document.getElementById('logoUrl').value.trim();
      const img = document.getElementById('logoPreview');
      const bg  = document.getElementById('logoBg').value.trim();
      if(!url){ img.style.display='none'; return; }
      img.src = url; img.style.display='block'; img.style.borderRadius='8px'; img.style.padding='6px';
      img.style.background = bg || '#ffffff';
    }
    window.previewLogo = previewLogo;

    async function handleLogoUpload(evt){
      const file = evt.target.files?.[0];
      if(!file) return;
      const orgKey = (document.getElementById('orgKey').value || '').trim() || 'Common';
      const ghUser = (document.getElementById('ghUser').value || '').trim();
      const ghRepo = (document.getElementById('ghRepo').value || '').trim();
      const basePath = (document.getElementById('basePath').value || 'Vcards').trim();
      const arrBuf = await file.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(arrBuf)));
      const cleanOrg = orgKey.replace(/[^A-Za-z0-9_-]/g, '');
      const ext = (file.name.split('.').pop() || 'png').toLowerCase().replace(/[^a-z0-9]/g,'') || 'png';
      const safeName = `${cleanOrg}_logo_${Date.now()}.${ext}`;
      const res = await fetch('/api/uploadLogo', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ repoOwner:ghUser||undefined, repoName:ghRepo||undefined, basePath, orgKey:cleanOrg, filename:safeName, contentBase64:base64 })
      });
      const out = await res.json().catch(()=> ({}));
      if(!res.ok || !out.url){ alert('Kunne ikke laste opp logo'); return; }
      document.getElementById('logoUrl').value = out.url; previewLogo();
    }
    window.handleLogoUpload = handleLogoUpload;
  </script>

  <!-- vCard/HTML + helpers -->
  <script>
    function normalizePhone(p){ p=(p||'').trim(); if(!p) return p; if(p.startsWith('0')&&!p.startsWith('+')){ if(p.length<=8) return '+47'+p.replace(/^0+/, ''); } return p; }
    function makeVcard(d){
      const parts = d.name.trim().split(' ');
      const first = parts[0]||''; const last = parts.length>1?parts[parts.length-1]:'';
      const phone = normalizePhone(d.phone||'');
      return ['BEGIN:VCARD','VERSION:3.0',`FN:${d.name}`,`N:${last};${first};;;`,`ORG:${d.orgName||d.orgKey}`,`TITLE:${d.title||''}`,`TEL;TYPE=CELL:${phone}`,`EMAIL;TYPE=INTERNET:${d.email||''}`,`URL:${d.site||''}`,`ADR;TYPE=WORK:;;${d.address||''}`,'END:VCARD'].join('\n');
    }
    const esc = s => (s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    function makeLinksHTML(links){
      if(!links.length) return '';
      return links.map(l=>{
        const pre  = l.pre  ? `<div class="pre"  style="margin:8px 0 4px;color:#bfc8d6">${esc(l.pre)}</div>` : '';
        const post = l.post ? `<div class="post" style="margin:4px 0 10px;color:#97a3b6;font-size:.95rem">${esc(l.post)}</div>` : '';
        return `<div class="link-block" style="margin-top:10px">${pre}<a class="btn" href="${esc(l.url)}" target="_blank" rel="noopener">${esc(l.label)}</a>${post}</div>`;
      }).join('');
    }
    function makeHTML(d, vcfFile, links){
      const accent  = d.accent || '#8fd3ff';
      const bgStyle = `background:${d.logoBg || '#ffffff'};border-radius:8px;padding:6px;`;
      const logoTag = d.logoUrl ? `<img class="brand-logo" src="${d.logoUrl}" style="${bgStyle}" alt="${esc(d.orgName||d.orgKey)} logo">` : '';
      const extras  = makeLinksHTML(links);
      return `<!doctype html>
<html lang="no">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kontaktkort – ${esc(d.name)}</title>
<style>
:root{--accent:${accent};}
body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}
.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}
.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}
.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.card p{color:#bfc8d6}
.brand-logo{max-height:56px;max-width:280px;object-fit:contain;margin:0 0 12px 0;display:block}
</style>
</head>
<body>
<main class="container card">
  ${logoTag}
  <h1>Kontaktkort – ${esc(d.name)}</h1>
  <p class="muted">${esc(d.title||'')} · ${esc(d.orgName||d.orgKey)}</p>
  <p><a class="btn" href="./${vcfFile}" download>Last ned vCard (.vcf)</a></p>
  <div class="links">
    <a href="tel:${esc(d.phone||'')}" class="btn">Ring</a>
    <a href="mailto:${esc(d.email||'')}" class="btn">E-post</a>
    <a href="${esc(d.site||'#')}" class="btn" target="_blank">Besøk nettside</a>
    <a href="../index.html" class="btn">← Tilbake</a>
  </div>
  ${extras}
  <p style="margin-top:14px">Adresse: ${esc(d.address||'')}</p>
  <p style="margin-top:8px;font-size:0.9rem;color:#9aa6b2">NFC-URL: <code id="nfcInline"></code></p>
</main>

<script>
/* === MOCKUP-FUNKSJON === */
const mockupCanvas = document.getElementById('mockupCanvas');
const ctx = mockupCanvas.getContext('2d');
const logoInput = document.getElementById('logoPng');
const woodSel = document.getElementById('woodType');
const bgChk = document.getElementById('autoRemoveBg');
const thr = document.getElementById('bgThreshold');
const thrVal = document.getElementById('bgThresholdVal');
const dlMock = document.getElementById('downloadMockup');

let logoImg = null;

// oppdater terskelvisning
thr && thr.addEventListener('input', ()=> thrVal.textContent = thr.value);

// last opp logo
logoInput && logoInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = ()=> { logoImg = img; drawMockup(); };
  img.src = URL.createObjectURL(file);
});

// tegn kort
function drawMockup(){
  const wood = woodSel?.value;
  const bg = {
    walnut: '#4b2e1b',
    cherry: '#a96b43',
    mahogany: '#7a3b23'
  }[wood] || '#5a3b2b';

  ctx.fillStyle = bg;
  ctx.fillRect(0,0,mockupCanvas.width,mockupCanvas.height);

  // "lasergravert" overlaytekst
  ctx.font = 'bold 42px "Segoe UI", sans-serif';
  ctx.fillStyle = 'rgba(0,0,0,.2)';
  ctx.fillText('NFCKING', 30, 70);

  if(logoImg){
    const w = logoImg.width;
    const h = logoImg.height;
    const maxW = 500, maxH = 400;
    let scale = Math.min(maxW/w, maxH/h);
    const dw = w*scale, dh = h*scale;
    const dx = (mockupCanvas.width-dw)/2;
    const dy = (mockupCanvas.height-dh)/2;

    if(bgChk?.checked){
      // enkel bakgrunnsfjerning (threshold)
      const off = document.createElement('canvas');
      off.width=w; off.height=h;
      const octx = off.getContext('2d');
      octx.drawImage(logoImg,0,0);
      const imgData = octx.getImageData(0,0,w,h);
      const data = imgData.data;
      const limit = parseInt(thr.value);
      for(let i=0;i<data.length;i+=4){
        const avg = (data[i]+data[i+1]+data[i+2])/3;
        if(avg>limit*3){ data[i+3]=0; } // gjør gjennomsiktig
      }
      octx.putImageData(imgData,0,0);
      ctx.drawImage(off,dx,dy,dw,dh);
    } else {
      ctx.drawImage(logoImg,dx,dy,dw,dh);
    }
  }
}
woodSel && woodSel.addEventListener('change', drawMockup);
bgChk && bgChk.addEventListener('change', drawMockup);
dlMock && dlMock.addEventListener('click',()=>{
  drawMockup();
  const link=document.createElement('a');
  link.download=`mockup_${woodSel?.value || 'wood'}.png`;
  link.href=mockupCanvas.toDataURL('image/png');
  link.click();
});

/* === BESTILLINGS-FUNKSJON === */
function collectOrder(){
  return {
    qty: document.getElementById('orderQty')?.value,
    format: document.getElementById('orderFormat')?.value,
    sides: document.getElementById('orderSides')?.value,
    wood: document.getElementById('orderWood')?.value,
    ref: document.getElementById('orderRef')?.value,
    addr: document.getElementById('orderAddr')?.value,
    notes: document.getElementById('orderNotes')?.value,
    timestamp: new Date().toISOString()
  };
}

function buildOrderText(o){
  return `Bestilling av NFC-visittkort

Antall: ${o.qty}
Format: ${o.format}
Sider: ${o.sides}
Tresort: ${o.wood}

Referanse: ${o.ref}
Adresse: ${o.addr}

Kommentarer:
${o.notes}

Generert: ${new Date().toLocaleString()}`;
}

document.getElementById('btnCopyOrder')?.addEventListener('click',()=>{
  const o=collectOrder(); navigator.clipboard.writeText(buildOrderText(o));
  alert('Bestilling kopiert til utklippstavle');
});
document.getElementById('btnEmailOrder')?.addEventListener('click',()=>{
  const o=collectOrder();
  const mail=`mailto:bestilling@nfcking.no?subject=Bestilling%20NFC%20kort&body=${encodeURIComponent(buildOrderText(o))}`;
  window.location.href=mail;
});
document.getElementById('btnDownloadOrder')?.addEventListener('click',()=>{
  const o=collectOrder();
  const blob=new Blob([JSON.stringify(o,null,2)],{type:'application/json'});
  const link=document.createElement('a');
  link.download='ordre.json';
  link.href=URL.createObjectURL(blob);
  link.click();
});

/* === INTEGRASJON: last logo fra adminfelter inn i mockup === */
(function(){
  const logoUrlInput = document.getElementById('logoUrl');
  const orderWood = document.getElementById('orderWood');
  const woodSel   = document.getElementById('woodType');

  function setMockupLogoFromUrl(url){
    if(!url) return;
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=> { logoImg = img; drawMockup(); };
    img.onerror = ()=> { /* ignorer feil */ };
    img.src = url;
  }
  window.setMockupLogoFromUrl = setMockupLogoFromUrl;

  if (logoUrlInput) {
    logoUrlInput.addEventListener('input', ()=> {
      const url = logoUrlInput.value.trim();
      if(url) setMockupLogoFromUrl(url);
    });
  }

  if (window.previewLogo) {
    const _orig = window.previewLogo;
    window.previewLogo = function(){
      _orig && _orig();
      const url = document.getElementById('logoUrl')?.value?.trim() || '';
      if (url) setMockupLogoFromUrl(url);
    };
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    try {
      drawMockup();
      const url = document.getElementById('logoUrl')?.value?.trim();
      if (url) setMockupLogoFromUrl(url);
    } catch(e){ /* no-op */ }
  });

  function syncWood(from, to){
    if (!from || !to) return;
    to.value = from.value;
    if (from === woodSel) drawMockup();
  }
  woodSel?.addEventListener('change', ()=> syncWood(woodSel, orderWood));
  orderWood?.addEventListener('change', ()=> syncWood(orderWood, woodSel));

  if (woodSel && orderWood) { orderWood.value = woodSel.value; }
})();

/* === Netlify-funksjoner: uploadLogo & createCard === */
function val(id){ return document.getElementById(id)?.value?.trim() || ""; }
function nonEmpty(v, name){ if(!v){ throw new Error(`Mangler verdi: ${name}`); } return v; }

async function postJSON(url, payload, headers={}){
  const res = await fetch(url, {
    method:'POST',
    headers: { 'Content-Type':'application/json', ...headers },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = { raw:text }; }
  if(!res.ok){ const m = data?.error || data?.message || text; throw new Error(m); }
  return data;
}

// 1) Publiser logo til repo
document.getElementById('btnUploadLogoRepo')?.addEventListener('click', async ()=>{
  try{
    let filename = 'logo.png';
    let dataUrl = null;

    if (logoImg) {
      const tmp = document.createElement('canvas');
      tmp.width = logoImg.width; tmp.height = logoImg.height;
      const tctx = tmp.getContext('2d');
      tctx.drawImage(logoImg, 0, 0);
      dataUrl = tmp.toDataURL('image/png');
    } else {
      const url = val('logoUrl');
      if (!url) throw new Error('Last opp logo (PNG) eller angi logo-URL først.');
      const r = await fetch(url, { mode:'cors' });
      if (!r.ok) throw new Error('Kunne ikke hente logo fra URL.');
      const blob = await r.blob();
      dataUrl = await new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.readAsDataURL(blob);
      });
      try{
        const u = new URL(url); 
        const parts=u.pathname.split('/'); 
        filename = parts[parts.length-1] || 'logo.png'
      except Exception:
        filename = 'logo.png'
    }

    const base64 = dataUrl.split(',')[1];
    const payload = {
      repoOwner: val('repoOwner') || undefined,
      repoName : val('repoName')  || undefined,
      basePath : val('basePath')  || undefined,
      orgKey   : nonEmpty(val('orgKey'), 'Org-nøkkel (orgKey)'),
      filename,
      contentBase64: base64
    };

    const res = await postJSON('/.netlify/functions/uploadLogo', payload);
    if (!res?.ok) throw new Error(res?.error || 'Ukjent feil fra uploadLogo');

    const urlField = document.getElementById('logoUrl');
    if (urlField && res.url) {
      urlField.value = res.url;
      window.setMockupLogoFromUrl?.(res.url);
    }

    alert(`Logo publisert.
Sti: ${res.path}
URL: ${res.url}`);
  } catch(e){
    alert('Feil ved opplasting: ' + e.message);
  }
});

// 2) Send til produksjon (mockup + ordre)
document.getElementById('btnSendToProd')?.addEventListener('click', async ()=>{
  try{
    const qty = parseInt(nonEmpty(val('orderQty'),'Antall'), 10);
    if (!(qty>0)) throw new Error('Antall må være > 0');

    const orgKey = nonEmpty(val('orgKey'), 'Org-nøkkel (orgKey)');
    const wood   = nonEmpty(val('orderWood'),'Tresort');
    const sides  = nonEmpty(val('orderSides'),'Sider');
    const format = nonEmpty(val('orderFormat'),'Format');

    drawMockup();
    const pngDataUrl = mockupCanvas.toDataURL('image/png');
    const mockupBase64 = pngDataUrl.split(',')[1];

    const order = {
      qty, wood, sides, format,
      ref: val('orderRef'), addr: val('orderAddr'),
      notes: val('orderNotes'),
      logoUrl: val('logoUrl') || null,
      name: val('fullName') || val('name') || null,
      title: val('title') || null,
      company: val('company') || null,
      phone: val('phone') || null,
      email: val('email') || null,
      website: val('website') || null,
      timestamp: new Date().toISOString()
    };

    const ts = Date.now();
    const safeOrg = orgKey.replace(/[^a-z0-9-_]/gi,'');
    const files = [
      {
        path: `assets/${safeOrg}/mockup_${ts}.png`,
        contentBase64: mockupBase64,
        message: `Add mockup ${ts} for ${safeOrg}`
      },
      {
        path: `orders/${safeOrg}/ordre_${ts}.json`,
        contentBase64: btoa(unescape(encodeURIComponent(JSON.stringify(order,null,2)))),
        message: `Add order ${ts} for ${safeOrg}`
      }
    ];

    const payload = {
      repoOwner: val('repoOwner') || undefined,
      repoName : val('repoName')  || undefined,
      basePath : val('basePath')  || undefined,
      orgKey   : orgKey,
      slug     : `ordre_${ts}`,
      files
    };

    const res = await postJSON('/.netlify/functions/createCard', payload);
    if (!res?.ok) throw new Error(res?.error || 'Ukjent feil fra createCard');

    alert(`Sendt til produksjon.
Branch: ${res.branch || 'main'}`);
  } catch(e){
    alert('Feil ved produksjon: ' + e.message);
  }
});

/* === Del 6 polish: persist + responsive + shadow-off === */
(function(){
  const LS = {
    wood: 'nfcking.woodType',
    thr: 'nfcking.bgThreshold',
    auto: 'nfcking.autoRemoveBg',
    order: 'nfcking.orderDraft'
  };

  try {
    const woodSel = document.getElementById('woodType');
    const thr = document.getElementById('bgThreshold');
    const thrVal = document.getElementById('bgThresholdVal');
    const auto = document.getElementById('autoRemoveBg');

    if(localStorage.getItem(LS.wood)) woodSel.value = localStorage.getItem(LS.wood);
    if(localStorage.getItem(LS.thr))  thr.value = localStorage.getItem(LS.thr);
    if(localStorage.getItem(LS.auto)) auto.checked = localStorage.getItem(LS.auto) === '1';

    thrVal.textContent = thr.value;
    drawMockup();

    woodSel.addEventListener('change', ()=> localStorage.setItem(LS.wood, woodSel.value));
    thr.addEventListener('input', ()=>{
      thrVal.textContent = thr.value;
      localStorage.setItem(LS.thr, thr.value);
      drawMockup();
    });
    auto.addEventListener('change', ()=>{
      localStorage.setItem(LS.auto, auto.checked ? '1':'0');
      document.getElementById('thrWrap')?.classList.toggle('hide', !auto.checked);
      drawMockup();
    });
  } catch(e){}

  try {
    const orderIds = ['orderQty','orderFormat','orderSides','orderWood','orderRef','orderAddr','orderNotes','repoOwner','repoName','basePath','orgKey'];
    const saved = localStorage.getItem(LS.order);
    if(saved){
      const o = JSON.parse(saved);
      orderIds.forEach(id => { if (o[id] != null && document.getElementById(id)) document.getElementById(id).value = o[id]; });
    }
    const persist = ()=>{
      const o={};
      orderIds.forEach(id => { const el=document.getElementById(id); if(el) o[id]=el.value; });
      localStorage.setItem(LS.order, JSON.stringify(o));
    };
    orderIds.forEach(id => document.getElementById(id)?.addEventListener('input', persist));
  } catch(e){}

  (function(){
    const auto = document.getElementById('autoRemoveBg');
    if(!auto) return;
    const thrWrap = document.createElement('span');
    thrWrap.id = 'thrWrap';
    thrWrap.style.marginLeft = '8px';
    const thrEl = document.getElementById('bgThreshold');
    const thrValEl = document.getElementById('bgThresholdVal');
    thrWrap.innerHTML = `Terskel: <input type="range" id="bgThreshold" min="8" max="80" value="${thrEl?.value || 28}" />
                         <code id="bgThresholdVal">${thrValEl?.textContent || 28}</code>`;
    const chkLabel = auto.closest('label');
    chkLabel && chkLabel.appendChild(thrWrap);
    thrWrap.classList.toggle('hide', !auto.checked);
    auto.addEventListener('change', ()=> thrWrap.classList.toggle('hide', !auto.checked));
  })();

  (function(){
    const canvas = document.getElementById('mockupCanvas');
    if(!canvas) return;
    const parent = canvas.parentElement;
    function fit(){
      const ratio = canvas.width / canvas.height;
      const cssW = Math.min(parent.clientWidth, 1000);
      const cssH = Math.round(cssW / ratio);
      canvas.style.width = cssW + 'px';
      canvas.style.height = cssH + 'px';
    }
    window.addEventListener('resize', fit);
    fit();
  })();

  const _draw = drawMockup;
  window.drawMockup = function(){
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    _draw();
  };
})();
</script>

</body>
</html>`;
    }

    async function postJSON(url, data){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      const t = await r.text(); try{return{ok:r.ok,status:r.status,json:JSON.parse(t)}}catch{return{ok:r.ok,status:r.status,text:t}};
    }

    function ensureUrlControls(id,label){
      const input = document.getElementById(id); if(!input) return;
      if (input.nextSibling?.classList?.contains('url-actions')) return;
      const wrap = document.createElement('span'); wrap.className = 'url-actions';
      wrap.innerHTML = `<button type="button" class="pill" data-act="copy">Kopier ${label}</button><button type="button" class="pill" data-act="open">Åpne</button>`;
      input.after(wrap);
      wrap.addEventListener('click',(e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const val=input.value.trim(); if(!val) return;
        if(btn.dataset.act==='copy') navigator.clipboard.writeText(val);
        if(btn.dataset.act==='open') window.open(val,'_blank','noopener');
      });
    }
  </script>

  <!-- Generer & Publiser + Live preview + NFC -->
  <script>
    document.getElementById('generate').addEventListener('click', async ()=>{
      const get = id => document.getElementById(id).value.trim();
      const d = {
        orgKey:get('orgKey'),
        orgName:get('orgName')||get('orgKey'),
        accent:get('accent')||'#8fd3ff',
        logoUrl:get('logoUrl'),
        logoBg:get('logoBg')||'',
        slug:get('slug'),
        name:get('name'),
        title:get('title'),
        phone:get('phone'),
        email:get('email'),
        site:get('site'),
        address:get('address'),
        vcfFilename:get('vcfFilename')||(get('slug')+'_'+get('orgKey')+'.vcf'),
        ghUser:get('ghUser'),
        ghRepo:get('ghRepo'),
        basePath:get('basePath')||'Vcards',
        strategy:document.getElementById('strategy').value
      };
      if(!d.orgKey||!d.slug||!d.name){ alert('Mangler: orgKey, slug, name'); return; }

      const links = Array.from(document.querySelectorAll('#linksTable tbody tr')).map(tr=>({
        label: tr.querySelector('.lbl').value.trim(),
        url:   tr.querySelector('.lnk').value.trim(),
        pre:   tr.querySelector('.pre').value.trim(),
        post:  tr.querySelector('.post').value.trim()
      })).filter(x=>x.label && x.url);

      const vcf  = makeVcard(d);
      const html = makeHTML(d, d.vcfFilename, links);
      document.getElementById('vcfPreview').value  = vcf;
      document.getElementById('htmlPreview').value = html;
      updateLivePreview(html);

      const ownerPart = d.ghUser || '<owner>';
      const repoPart  = d.ghRepo || '<repo>';
      const basePath  = (d.basePath||'Vcards').replace(/^\/+|\/+$/g,'');
      const baseUrl   = `https://${ownerPart}.github.io/${repoPart}${basePath?`/${basePath}`:''}/${d.orgKey}/${d.slug}`;
      const htmlUrl   = `${baseUrl}/index.html`;
      const vcfUrl    = `${baseUrl}/${d.vcfFilename}`;

      document.getElementById('nfcUrl').value  = vcfUrl;
      document.getElementById('htmlUrl').value = htmlUrl;
      ensureUrlControls('nfcUrl','NFC-URL');
      ensureUrlControls('htmlUrl','HTML-URL');
      const inline = document.getElementById('nfcInline'); if(inline) inline.textContent = vcfUrl;

      document.getElementById('status').textContent = 'Publiserer…';
      const prefix = d.basePath ? (d.basePath.replace(/^\/+|\/+$/g,'') + '/') : '';
      const payload = {
        repoOwner:d.ghUser||undefined, repoName:d.ghRepo||undefined,
        basePath:d.basePath, orgKey:d.orgKey, slug:d.slug,
        files:[
          { path:`${prefix}${d.orgKey}/${d.slug}/${d.vcfFilename}`, content: vcf },
          { path:`${prefix}${d.orgKey}/${d.slug}/index.html`,       content: html },
          { path:`${prefix}${d.orgKey}/${d.slug}/data.json`,        content: JSON.stringify({ ...d, links }, null, 2) },
          { path:`${prefix}.nojekyll`,                              content: "" }
        ],
        strategy:d.strategy,
        commitMessage:`Add/Update card: ${d.orgKey}/${d.slug}`
      };

      try{
        const res = await postJSON('/api/createCard', payload);
        if(res.ok){ document.getElementById('status').innerHTML = '<span class="ok">✅ Ferdig! Åpne HTML-URL-en (gi Pages litt tid).</span>'; }
        else {
          const msg = res.json && res.json.error ? res.json.error : (res.text || 'Ukjent feil');
          document.getElementById('status').innerHTML = '<span class="err">❌ Feil: '+msg+'</span>';
        }
      }catch(e){ document.getElementById('status').innerHTML = '<span class="err">❌ Nettverksfeil: '+e.message+'</span>'; }
    });

    // Live preview
    function updateLivePreview(html){
      const frame = document.getElementById('livePreviewFrame'); if(!frame) return;
      const doc = frame.contentDocument || frame.contentWindow.document;
      doc.open(); doc.write(html); doc.close();
    }
    document.getElementById('openPreviewBtn')?.addEventListener('click', ()=>{
      const blob = new Blob([document.getElementById('htmlPreview').value], {type:'text/html'});
      const url  = URL.createObjectURL(blob); window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url), 60_000);
    });

    // NFC helpers
    function logNFC(msg){
      const el = document.getElementById('nfcLog');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
    }
    function supportsNFC(){
      return ('NDEFReader' in window);
    }

    // LES NFC
    document.getElementById('nfcRead').addEventListener('click', async ()=>{
      if(!supportsNFC()){ alert('Web NFC støttes kun i Chrome/Android'); return; }
      try{
        const reader = new NDEFReader();
        await reader.scan();
        logNFC('Hold telefonen nær kortet – lytter...');
        reader.onreadingerror = () => logNFC('Lesefeil');
        reader.onreading = (event) => {
          const { message, serialNumber } = event;
          logNFC(`Serial: ${serialNumber || '(ukjent)'}`);
          for (const record of message.records) {
            try{
              if (record.recordType === 'url') {
                const text = new TextDecoder().decode(record.data);
                logNFC('URL: ' + text);
              } else if (record.recordType === 'text') {
                const text = new TextDecoder().decode(record.data);
                logNFC('Tekst: ' + text);
              } else if (record.mediaType === 'text/vcard' || record.mediaType === 'text/x-vcard') {
                const vcf = new TextDecoder().decode(record.data);
                logNFC('vCard:\n' + vcf);
              } else {
                logNFC(`Record: type=${record.recordType} mediaType=${record.mediaType||''}`);
              }
            }catch(e){ logNFC('Kunne ikke dekode record: '+e.message); }
          }
        };
      }catch(e){
        logNFC('Start scanning feilet: '+e.message);
      }
    });

    // SKRIV NFC
    document.getElementById('nfcWrite').addEventListener('click', async ()=>{
      if(!supportsNFC()){ alert('Web NFC støttes kun i Chrome/Android'); return; }
      const mode = document.getElementById('nfcWriteMode').value;
      const payload = document.getElementById('nfcPayload').value.trim();
      try{
        const writer = new NDEFReader();
        await writer.write(await buildNdefMessage(mode, payload));
        logNFC('✅ Skrevet!');
      }catch(e){
        logNFC('Skrivefeil: '+e.message);
      }
    });

    async function buildNdefMessage(mode, payload){
      if (mode === 'url') {
        const url = payload || document.getElementById('htmlUrl').value.trim() || document.getElementById('nfcUrl').value.trim();
        if (!url) throw new Error('Mangler URL å skrive');
        return { records:[ { recordType:'url', data: url } ] };
      }
      if (mode === 'text') {
        const text = payload || 'Hei fra NFCKING';
        return { records:[ { recordType:'text', data: text } ] };
      }
      if (mode === 'vcard') {
        const vcf = document.getElementById('vcfPreview').value.trim();
        if (!vcf) throw new Error('Ingen vCard i forhåndsvisning. Generer først.');
        return { records:[ { recordType:'mime', mediaType:'text/vcard', data: new TextEncoder().encode(vcf) } ] };
      }
      throw new Error('Ukjent skrive-modus');
    }

    // Init etter DOM ready (merk: auth viser/skjuler app)
    document.addEventListener('DOMContentLoaded', ()=>{
      const sel = document.getElementById('orgSelect');
      if (sel) sel.addEventListener('change', syncOrgKeyFromSelect);
    });
  </script>
</body>
</html>
