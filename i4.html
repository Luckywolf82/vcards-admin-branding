<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFCKING – Adminpanel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <style>
    body{background:#0b0b10;color:#e9eef5}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.row{grid-template-columns:1fr}}
    textarea{font-family:monospace}
    .ok{color:#21c36a;font-weight:700}
    .err{color:#ff6b6b;font-weight:700}
    .note{font-size:.95rem;color:#8ea0b4}
    .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#243244;color:#cfe3ff;margin-right:.3rem;font-size:.8rem;cursor:pointer;border:1px solid #344458}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .logo-prev{height:42px;max-width:240px;object-fit:contain;background:#fff;border-radius:8px;padding:6px}
    @media (max-width:640px){.logo-prev{height:28px}}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;text-decoration:none;font-weight:700;background:#8fd3ff;color:#03101a}
    .url-actions{margin-left:6px}
    .brand{text-align:center;margin:0 0 18px}
    .brand img{max-width:240px;height:auto;filter:drop-shadow(0 0 6px #3fffd2)}
    .brand-sub{margin:6px 0 0;color:#8ea0b4}
    .brand-rule{border:0;height:2px;background:linear-gradient(90deg,#8fd3ff,#52a3ff);opacity:.7;margin:10px 0 16px}
    #nfcLog{background:#0d1117;color:#cfe3ff;padding:10px;border-radius:8px;border:1px solid #1c2736;white-space:pre-wrap;max-height:220px;overflow:auto;margin-top:10px}
    .hide{display:none}
    .card{max-width:980px;margin:0 auto}
  </style>
</head>

<body>
  <!-- AUTH: vises før innlogging -->
  <section id="auth" class="card">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/paalrodolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Logg inn for å bruke adminpanelet</p>
    </div>
    <hr class="brand-rule">
    <button id="btnGoogle" class="btn">Logg inn med Google</button>
    <p class="note" style="margin-top:8px">Krever at brukeren finnes i Firestore/allowlist – eller at vi åpner policy (kan åpnes for alle – nå tillater vi alle innloggede).</p>
  </section>

  <!-- APP: skjules til bruker er innlogget -->
  <main id="app" class="hide">
    <div class="brand">
      <img
        src="/assets/NFCKING_dark.png?v=4"
        alt="NFCKING logo"
        onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/paalrodolf82/vcards-admin-branding/main/assets/NFCKING_dark.png?v=4';">
      <p class="brand-sub">Kongen av kontaktløs – bygg, merk og publiser NFC-kort</p>
    </div>
    <hr class="brand-rule">

    <!-- (1) Organisasjonsprofiler + ansatte-lister (hentes fra Firestore hvis mulig) -->
    <script>
      // Disse fylles fra Firestore ved innlogging. Vi har også fallback.
      window.ORG_PROFILES = {};   // { key: {name, accent, logo, site, logoBg} }
      window.EMPLOYEES    = {};   // { key: [ {slug, name, ...} ] } – valgfritt, tom som default
    </script>

    <h2>Organisasjon</h2>
    <div class="row">
      <label>Velg organisasjon
        <select id="orgSelect"></select>
      </label>

      <div class="inline">
        <label style="flex:1">Org key (mappe – case sensitive)
          <input id="orgKey" placeholder="OrgKey" required oninput="applyBranding('force'); syncOrgSelectFromKey(); loadEmployees();">
        </label>
        <div style="display:flex;align-items:center;justify-content:flex-start;min-width:200px">
          <img id="logoPreview" class="logo-prev" alt="logo" style="display:none">
          <span class="note" style="margin-left:8px">Logo kan settes via URL eller opplasting under.</span>
        </div>
      </div>

      <label>Accent-farge (hex)
        <input id="accent" placeholder="#8fd3ff" oninput="applyBranding()">
      </label>

      <label>Logo-URL
        <input id="logoUrl" placeholder="https://…/logo.png" oninput="previewLogo();applyBranding()">
        <span class="url-actions">
          <button class="pill" type="button" onclick="testLogoUrl()">Test</button>
          <button class="pill" type="button" onclick="clearLogoUrl()">Tøm</button>
        </span>
      </label>

      <label>Logo-bakgrunn (bare digital visning)
        <input id="logoBg" placeholder="#ffffff (tom = auto)" oninput="previewLogo()">
      </label>

      <label>Last opp logo (PNG/SVG)
        <input id="logoFile" type="file" accept="image/*">
        <small id="logoFileNote" class="note"></small>
      </label>

      <label>Nettside
        <input id="site" placeholder="https://ditt-domene.no">
      </label>
    </div>

    <h2>Person</h2>
    <div class="row">
      <label>Navn <input id="name" placeholder="Fornavn Etternavn"></label>
      <label>Tittel <input id="title" placeholder="Stilling"></label>
      <label>Telefon <input id="phone" placeholder="+47 …"></label>
      <label>E-post <input id="email" placeholder="navn@domene.no"></label>
      <label>Adresse <input id="address" placeholder="Gate 1, 0001 Oslo"></label>
      <label>Slug (URL-endelse) <input id="slug" placeholder="fornavn-etternavn"></label>
      <label>VCF-filnavn <input id="vcfFilename" placeholder="fornavn_etternavn.vcf"></label>
    </div>

    <h2>Publisering</h2>
    <div class="row">
      <label>Base-URL (hosting)
        <input id="baseUrl" placeholder="https://kort.ditt-domene.no">
      </label>
      <label>Bucket/sti
        <input id="bucketPath" placeholder="/kort">
      </label>
    </div>

    <h3>Generer</h3>
    <button id="generate">Generer & Publiser</button>
    <span id="status"></span>

    <h3>Resultat</h3>
    <p>NFC-URL: <input id="nfcUrl" style="width:100%" readonly></p>
    <p>HTML-URL: <input id="htmlUrl" style="width:100%" readonly></p>

    <h4>vCard</h4>
    <textarea id="vcfPreview" rows="8" style="width:100%"></textarea>

    <h4>index.html</h4>
    <textarea id="htmlPreview" rows="14" style="width:100%"></textarea>

    <!-- Live forhåndsvisning -->
    <div id="livePreviewContainer" style="margin-top:10px;">
      <h4>Live forhåndsvisning</h4>
      <button id="openPreviewBtn" style="margin:6px 0;">Åpne forhåndsvisning i ny fane</button>
      <iframe id="livePreviewFrame" style="width:100%;height:480px;border:0;border-radius:8px;background:#111;" title="Live Preview"></iframe>
    </div>

    <!-- === FYSISKE KORT – MOCKUPS (ADMIN) === -->
    <section id="mockups" class="card" style="margin-top:14px">
      <h2>Fysiske kort – mockup</h2>

      <style>
        .mock-card{background:#0f1216;border:1px solid #1d2430;border-radius:14px;padding:16px}
        .two-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px}
        @media(max-width:980px){.two-cards{grid-template-columns:1fr}}
        canvas.mock-canvas{width:100%;height:auto;max-width:100%;border-radius:14px;display:block;background:#111}
        .axis{display:grid;gap:6px;min-width:260px}
        .axis h4{margin:4px 0}
        .axis-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center}
        .axis-cap{font:700 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#cfe3ff;background:#223141;border:1px solid #33465e;padding:4px 6px;border-radius:6px;white-space:nowrap}
        .val{font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#9fb0c6}
        .val code{color:#cfe3ff}
      </style>

      <div class="row" style="align-items:flex-end">
        <label>Modus
          <select id="mkMode">
            <option value="logo-both" selected>1) Logo på begge sider</option>
            <option value="logo-front-only">2) Kun logo forside, bakside blank</option>
            <option value="logo-front-text-back">3) Logo forside + tekst bakside</option>
            <option value="logo-front-text+smalllogo-back">4) Logo forside + tekst + liten logo bakside</option>
          </select>
        </label>
        <label>Stil
          <select id="mkStyle">
            <option value="dark" selected>Dark</option>
            <option value="light">Light</option>
            <option value="red">Red</option>
          </select>
        </label>
        <div>
          <button class="pill" id="mkDownloadFront">Last ned forside</button>
          <button class="pill" id="mkDownloadBack">Last ned bakside</button>
        </div>
      </div>

      <!-- Forhåndsvisning rett under modusvalget -->
      <div class="mock-card" style="margin-top:8px">
        <div class="two-cards">
          <canvas id="mkFront" class="mock-canvas" width="860" height="540"></canvas>
          <canvas id="mkBack"  class="mock-canvas" width="860" height="540"></canvas>
        </div>
        <p class="note" style="margin:8px 0 0">Justér med sliderne under. Eksport er rene bilder uten UI.</p>
      </div>

      <!-- Slidere / kontroller -->
      <div class="row" style="margin-top:12px">
        <!-- Laser -->
        <div class="axis">
          <h4>Lasergravering</h4>
          <label class="pill" style="width:max-content"><input type="checkbox" id="mkEngrave" checked> Lasergravér logo</label>
          <label style="width:max-content">Fjern lys bakgrunn <input type="checkbox" id="mkAutoRemoveBg" checked></label>
          <label>Dybde
            <input type="range" id="mkDepth" min="0.25" max="1" step="0.05" value="0.75">
          </label>
          <label>Terskel
            <input type="range" id="mkThreshold" min="8" max="80" step="1" value="28">
            <code id="mkThresholdVal">28</code>
          </label>
        </div>

        <!-- Forside-logo -->
        <div class="axis">
          <h4>Forside-logo</h4>
          <div><span class="val">Størrelse: </span><code id="mkFrontSizeVal">64%</code></div>
          <input type="range" id="mkFrontSize" min="20" max="100" step="1" value="64">
          <div class="axis-row">
            <span class="axis-cap">← VENSTRE</span>
            <input type="range" id="mkFrontX" min="0" max="100" step="1" value="50">
            <span class="axis-cap">HØYRE →</span>
            <span class="val"><code id="mkFrontXVal">50%</code></span>
          </div>
          <div class="axis-row">
            <span class="axis-cap">↑ OPP</span>
            <input type="range" id="mkFrontY" min="0" max="100" step="1" value="50">
            <span class="axis-cap">NED ↓</span>
            <span class="val"><code id="mkFrontYVal">50%</code></span>
          </div>
        </div>

        <!-- Bakside – liten logo -->
        <div class="axis">
          <h4>Liten logo – bakside</h4>
          <div><span class="val">Størrelse: </span><code id="mkBackSmallVal">24%</code></div>
          <input type="range" id="mkBackSmall" min="10" max="60" step="1" value="24">
          <div class="axis-row">
            <span class="axis-cap">← VENSTRE</span>
            <input type="range" id="mkBackX" min="0" max="100" step="1" value="50">
            <span class="axis-cap">HØYRE →</span>
            <span class="val"><code id="mkBackXVal">50%</code></span>
          </div>
          <div class="axis-row">
            <span class="axis-cap">↑ OPP</span>
            <input type="range" id="mkBackY" min="0" max="100" step="1" value="18">
            <span class="axis-cap">NED ↓</span>
            <span class="val"><code id="mkBackYVal">18%</code></span>
          </div>
        </div>

        <!-- Tekst bakside -->
        <div class="axis">
          <h4>Tekst – bakside</h4>
          <div class="inline" style="gap:12px;margin:4px 0">
            <label>Justering
              <select id="mkTextAlign">
                <option value="center" selected>Midtstilt</option>
                <option value="left">Venstrejustert</option>
              </select>
            </label>
            <label>Størrelse (base)
              <input type="range" id="mkTextBase" min="18" max="72" step="1" value="40">
              <code id="mkTextBaseVal">40 px</code>
            </label>
          </div>
          <div class="axis-row">
            <span class="axis-cap">← VENSTRE</span>
            <input type="range" id="mkTextX" min="0" max="100" step="1" value="50">
            <span class="axis-cap">HØYRE →</span>
            <span class="val"><code id="mkTextXVal">50%</code></span>
          </div>
          <div class="axis-row">
            <span class="axis-cap">↑ OPP</span>
            <input type="range" id="mkTextY" min="10" max="90" step="1" value="38">
            <span class="axis-cap">NED ↓</span>
            <span class="val"><code id="mkTextYVal">38%</code></span>
          </div>
          <p class="note" style="margin:4px 0 0">Ved “Logo forside + liten logo bak” starter teksten under logo automatisk.</p>
        </div>
      </div>

      <!-- JS for mockups -->
      <script>
        const MK_BASES = { dark:'/assets/dark.png', light:'/assets/light.png', red:'/assets/red.png' };
        function mkLoadImg(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin='anonymous';i.onload=()=>res(i);i.onerror=rej;i.src=url;});}
        function mkToCanvas(img){const c=document.createElement('canvas');c.width=img.width;c.height=img.height;c.getContext('2d',{willReadFrequently:true}).drawImage(img,0,0);return c;}
        function mkRoundRect(ctx,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.lineTo(x+w-rr,y);ctx.quadraticCurveTo(x+w,y,x+w,y+rr);ctx.lineTo(x+w,y+h-rr);ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);ctx.lineTo(x+rr,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-rr);ctx.lineTo(x,y+rr);ctx.quadraticCurveTo(x,y,x+rr,y);ctx.closePath();}
        function mkRemoveBgByThreshold(c,t=28){const x=c.getContext('2d',{willReadFrequently:true}),id=x.getImageData(0,0,c.width,c.height),d=id.data;for(let i=0;i<d.length;i+=4){const r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];if(a<20){d[i+3]=0;continue;}const dist=Math.sqrt((255-r)**2+(255-g)**2+(255-b)**2);if(dist<t)d[i+3]=0;}x.putImageData(id,0,0);return c;}
        function mkToGrayBoost(c){const x=c.getContext('2d',{willReadFrequently:true}),id=x.getImageData(0,0,c.width,c.height),d=id.data;for(let i=0;i<d.length;i+=4){let y=.2126*d[i]+.7152*d[i+1]+.0722*d[i+2];y=(y/255-.5)*1.2+.5;y=Math.max(0,Math.min(1,y));const v=Math.round(y*255);d[i]=d[i+1]=d[i+2]=v;}x.putImageData(id,0,0);return c;}
        async function mkPrepareEngraveCanvas(src){if(!src)return null;let c=mkToCanvas(await mkLoadImg(src));if(document.getElementById('mkAutoRemoveBg')?.checked){const thr=parseInt(document.getElementById('mkThreshold').value||'28',10);c=mkRemoveBgByThreshold(c,thr);}return mkToGrayBoost(c);}
        function mkDrawEngraved(ctx,img,x,y,w,h,d=0.75){ctx.save();ctx.globalCompositeOperation='multiply';ctx.filter='brightness(0.18) contrast(1.25)';ctx.globalAlpha=d;ctx.drawImage(img,x,y,w,h);ctx.restore();ctx.save();ctx.globalCompositeOperation='multiply';ctx.filter='blur(1.2px)';ctx.globalAlpha=Math.min(0.35,d*0.5);ctx.drawImage(img,x+1,y+1,w,h);ctx.restore();}
        async function mkDrawLogoBlock(ctx, box){
          const engraveOn=!!document.getElementById('mkEngrave')?.checked;
          const depth=parseFloat(document.getElementById('mkDepth')?.value||'0.75');
          const logoUrl=(window._uploadedLogoDataUrl||document.getElementById('logoUrl')?.value||'').trim();
          const logoBg=(document.getElementById('logoBg')?.value||'').trim();
          if(!logoUrl) return;
          if(engraveOn){
            const engrC=await mkPrepareEngraveCanvas(logoUrl);
            if(!engrC) return;
            const sc=Math.min(box.w/engrC.width, box.h/engrC.height);
            const lw=engrC.width*sc, lh=engrC.height*sc;
            const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
            mkDrawEngraved(ctx, engrC, lx, ly, lw, lh, depth);
          } else {
            if(logoBg){ ctx.fillStyle=logoBg; mkRoundRect(ctx, box.x, box.y, box.w, box.h, 12); ctx.fill(); }
            const logo=await mkLoadImg(logoUrl);
            const sc=Math.min(box.w/logo.width, box.h/logo.height);
            const lw=logo.width*sc, lh=logo.height*sc;
            const lx=box.x+(box.w-lw)/2, ly=box.y+(box.h-lh)/2;
            ctx.drawImage(logo, lx, ly, lw, lh);
          }
        }
        function mkDrawEngravedText(ctx,lines,startY,spacing=30,depth=0.85,align='center',xAnchor=null){
          const isCenter=(align==='center');
          const x=xAnchor!=null?xAnchor:(isCenter?Math.round(ctx.canvas.width/2):Math.round(ctx.canvas.width*0.10));
          ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='brightness(0.25) contrast(1.25)'; ctx.globalAlpha=depth; ctx.textAlign=isCenter?'center':'left';
          let y=startY;
          for(const [txt,size,weight] of lines){
            ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
            ctx.fillStyle='#ffffff';
            ctx.fillText(txt, x, y);
            y+=spacing;
          }
          ctx.restore();
          if(!isCenter){
            ctx.save(); ctx.globalCompositeOperation='multiply'; ctx.filter='blur(1.2px)'; ctx.globalAlpha=Math.min(0.4, depth*0.5);
            y=startY;
            for(const [txt,size,weight] of lines){
              ctx.font = `${weight} ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
              ctx.fillText(txt, x+1, y+1);
              y+=spacing;
            }
            ctx.restore();
          }
        }
        async function mkRender(canvas, style, side, mode){
          const ctx=canvas.getContext('2d');
          ctx.clearRect(0,0,canvas.width,canvas.height);
          const base=await mkLoadImg(MK_BASES[style]||MK_BASES.dark);
          const s=Math.max(canvas.width/base.width,canvas.height/base.height);
          const w=base.width*s,h=base.height*s;
          const ox=(canvas.width-w)/2,oy=(canvas.height-h)/2;
          ctx.drawImage(base,ox,oy,w,h);
          const frontPct=parseFloat(document.getElementById('mkFrontSize').value||'64')/100;
          const backPct=parseFloat(document.getElementById('mkBackSmall').value||'24')/100;
          const fxpc=parseFloat(document.getElementById('mkFrontX').value||'50')/100;
          const fypc=parseFloat(document.getElementById('mkFrontY').value||'50')/100;
          const bxpc=parseFloat(document.getElementById('mkBackX').value||'50')/100;
          const bypc=parseFloat(document.getElementById('mkBackY').value||'18')/100;
          const baseSize=parseFloat(document.getElementById('mkTextBase').value||'40');
          const alignSel=document.getElementById('mkTextAlign').value||'center';
          const txpc=parseFloat(document.getElementById('mkTextX').value||(alignSel==='center'?'50':'10'))/100;
          const typc=parseFloat(document.getElementById('mkTextY').value||'38')/100;
          const frontSize=canvas.height*frontPct;
          const fullLogoBox={x:canvas.width*fxpc-frontSize/2,y:canvas.height*fypc-frontSize/2,w:frontSize,h:frontSize};
          const smallSize=canvas.height*backPct;
          const smallLogoBox={x:canvas.width*bxpc-smallSize/2,y:canvas.height*bypc-smallSize/2,w:smallSize,h:smallSize};
          const textTop=(mode==='logo-front-text+smalllogo-back')?(smallLogoBox.y+smallLogoBox.h+canvas.height*0.05):canvas.height*typc;
          if(side==='front'){ await mkDrawLogoBlock(ctx, fullLogoBox); return; }
          if(mode==='logo-both'){ await mkDrawLogoBlock(ctx, fullLogoBox); return; }
          if(mode==='logo-front-only'){ return; }
          if(mode==='logo-front-text+smalllogo-back'){ await mkDrawLogoBlock(ctx, smallLogoBox); }
          const d={
            name: (document.getElementById('name')?.value||'').trim(),
            title:(document.getElementById('title')?.value||'').trim(),
            orgName:(document.getElementById('orgName')?.value||'').trim() || (document.getElementById('orgKey')?.value||'').trim(),
            phone:(document.getElementById('phone')?.value||'').trim(),
            email:(document.getElementById('email')?.value||'').trim(),
            site:(document.getElementById('site')?.value||'').trim()
          };
          const nameSize=Math.round(baseSize*1.3);
          const titleSize=Math.round(baseSize*1.0);
          const infoSize=Math.round(baseSize*0.85);
          const hintSize=Math.round(baseSize*0.65);
          const spacing=Math.round(baseSize*0.95);
          const lines=[];
          if(d.name) lines.push([d.name,nameSize,'800']);
          if(d.title||d.orgName){ lines.push([ d.title ? (d.orgName ? (d.title+' · '+d.orgName) : d.title) : d.orgName, titleSize, '700' ]); }
          if(d.phone) lines.push(['Tel: '+d.phone,infoSize,'600']);
          if(d.email) lines.push(['E-post: '+d.email,infoSize,'600']);
          if(d.site)  lines.push(['Nettside: '+d.site,infoSize,'600']);
          lines.push(['Scan NFC / QR for digitalt kort', hintSize, '600']);
          mkDrawEngravedText(ctx, lines, textTop, spacing, 0.88, alignSel, canvas.width*txpc);
        }
        async function mkUpdate(){
          const style=document.getElementById('mkStyle').value||'dark';
          const mode =document.getElementById('mkMode').value ||'logo-both';
          await mkRender(document.getElementById('mkFront'), style, 'front', mode);
          await mkRender(document.getElementById('mkBack'),  style, 'back',  mode);
        }
        ['mkMode','mkStyle','mkEngrave','mkAutoRemoveBg','mkDepth','mkThreshold',
         'mkFrontSize','mkFrontX','mkFrontY','mkBackSmall','mkBackX','mkBackY',
         'mkTextAlign','mkTextBase','mkTextX','mkTextY',
         'name','title','orgName','orgKey','phone','email','site','logoUrl','logoBg'
        ].forEach(id=>document.getElementById(id)?.addEventListener('input', ()=>{
          const setVal=(id,suf)=>{const el=document.getElementById(id),out=document.getElementById(id+'Val');if(el&&out) out.textContent=el.value+(suf||'');};
          setVal('mkThreshold',''); setVal('mkFrontSize','%'); setVal('mkBackSmall','%');
          setVal('mkFrontX','%'); setVal('mkFrontY','%'); setVal('mkBackX','%'); setVal('mkBackY','%');
          setVal('mkTextBase',' px'); setVal('mkTextX','%'); setVal('mkTextY','%');
          mkUpdate();
        }));
        function mkDownload(cnv,name){ const a=document.createElement('a'); a.href=cnv.toDataURL('image/png'); a.download=name; a.click(); }
        document.getElementById('mkDownloadFront')?.addEventListener('click', ()=> mkDownload(document.getElementById('mkFront'),'kort-forside.png'));
        document.getElementById('mkDownloadBack') ?.addEventListener('click', ()=> mkDownload(document.getElementById('mkBack'),'kort-bakside.png'));
        (function initMockups(){
          ['mkThreshold','mkFrontSize','mkBackSmall','mkFrontX','mkFrontY','mkBackX','mkBackY','mkTextBase','mkTextX','mkTextY']
            .forEach(id=>{ const el=document.getElementById(id), out=document.getElementById(id+'Val'); if(el&&out) out.textContent=el.value+(id==='mkTextBase'?' px':'%'); });
          mkUpdate();
        })();
      </script>
    </section>

    <h2>NFC (Web NFC – Chrome/Android)</h2>
    <div class="row">
      <label>Velg skrive-type
        <select id="nfcWriteMode">
          <option value="url">URL (åpnes i nettleser)</option>
          <option value="text">Tekst</option>
          <option value="vcard">vCard (.vcf fra forhåndsvisning)</option>
        </select>
      </label>
      <label>Payload (for URL/tekst)
        <input id="nfcPayload" placeholder="https://ditt-domene.no/sti">
      </label>
      <div>
        <button id="nfcRead" class="pill" type="button">Les NFC</button>
        <button id="nfcWrite" class="pill" type="button">Skriv NFC</button>
      </div>
    </div>
    <pre id="nfcLog"></pre>

  </main>

  <!-- Firebase (CDN) + Auth/Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "…",
      authDomain: "…",
      projectId: "…",
      storageBucket: "…",
      messagingSenderId: "…",
      appId: "…"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const btnGoogle = document.getElementById('btnGoogle');
    const authSection = document.getElementById('auth');
    const appMain = document.getElementById('app');

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        authSection.classList.add('hide');
        appMain.classList.remove('hide');
        await loadOrgProfiles();
      } else {
        authSection.classList.remove('hide');
        appMain.classList.add('hide');
      }
    });

    if(btnGoogle){
      btnGoogle.addEventListener('click', async ()=>{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      });
    }

    async function loadOrgProfiles(){
      try{
        const snap = await getDocs(collection(db,'orgProfiles'));
        const map = {};
        snap.forEach(doc=>{ map[doc.id]=doc.data(); });
        window.ORG_PROFILES = map;
        hydrateOrgSelect();
      }catch(e){
        console.warn('Kunne ikke hente orgProfiles fra Firestore:', e);
        hydrateOrgSelect(); // fallback uten data
      }
    }

    function hydrateOrgSelect(){
      const sel = document.getElementById('orgSelect');
      if(!sel) return;
      sel.innerHTML='';
      const keys = Object.keys(window.ORG_PROFILES||{}).sort();
      for(const k of keys){
        const opt = document.createElement('option');
        opt.value=k; opt.textContent = (window.ORG_PROFILES[k]?.name || k);
        sel.appendChild(opt);
      }
    }

    function syncOrgKeyFromSelect(){
      const sel = document.getElementById('orgSelect');
      const key = sel?.value || '';
      const inp = document.getElementById('orgKey');
      if(inp && key) { inp.value=key; applyBranding('force'); loadEmployees(); }
    }

    async function loadEmployees(){
      // valgfritt – hvis du har en collection
      try{
        const key = (document.getElementById('orgKey')?.value||'').trim();
        if(!key) return;
        const snap = await getDocs(collection(db, 'orgProfiles', key, 'employees'));
        const arr = [];
        snap.forEach(d => arr.push({slug:d.id, ...d.data()}));
        window.EMPLOYEES[key] = arr;
      }catch(e){ /* ignorér */ }
    }

    // ENKEL BRANDING
    function applyBranding(force){
      const key = (document.getElementById('orgKey')?.value||'').trim();
      const prof = (window.ORG_PROFILES||{})[key] || {};
      const accent = (document.getElementById('accent')?.value||'').trim() || prof.accent || '#8fd3ff';
      if(force==='force'){
        if(!document.getElementById('accent').value) document.getElementById('accent').value = accent;
        if(!document.getElementById('logoUrl').value && prof.logo) document.getElementById('logoUrl').value = prof.logo;
        if(!document.getElementById('site').value && prof.site) document.getElementById('site').value = prof.site;
        previewLogo();
      }
    }

    function esc(s){return (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}
    function makeHTML(d){
      const acc=d.accent||'#8fd3ff';
      const logoTag = d.logoUrl
        ? '<img class="brand-logo" src="'+d.logoUrl+'" style="max-height:56px;max-width:280px;object-fit:contain;'
          +(d.logoBg?('background:'+d.logoBg+';border-radius:8px;padding:6px;'):'')+'" alt="'+esc(d.orgName)+' logo">'
        : '';
      return '<!doctype html><html lang="no"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'
        +'<title>Kontaktkort – '+esc(d.name||'')+'</title>'
        +'<style>:root{--accent:'+acc+';}body{font-family:system-ui,-apple-system,Roboto,Arial;background:#0b0b10;color:#eee;padding:20px}.container{max-width:760px;margin:0 auto;background:#12121a;padding:24px;border-radius:12px}.btn{display:inline-block;padding:12px 14px;background:var(--accent);color:#03101a;border-radius:10px;text-decoration:none;font-weight:700}.links{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}.card p{color:#bfc8d6}.brand-logo{display:block;margin:0 0 12px 0}</style>'
        +'</head><body><main class="container card">'
        +logoTag
        +'<h1>Kontaktkort – '+esc(d.name||'')+'</h1>'
        +'<p class="muted">'+esc(d.title||'')+' · '+esc(d.orgName||'')+'</p>'
        +(d.phone?'<a class="btn" href="tel:'+esc(d.phone)+'">Ring</a> ':'')
        +(d.email?'<a class="btn" href="mailto:'+esc(d.email)+'">E-post</a> ':'')
        +(d.site?'<a class="btn" href="'+esc(d.site)+'" target="_blank" rel="noopener">Nettside</a>':'')
        +(d.address?'<p style="margin-top:14px">Adresse: '+esc(d.address)+'</p>':'')
        +'</main></body></html>';
    }

    function currentData(){
      return {
        orgName:(document.getElementById('orgName')?.value||'').trim() || (document.getElementById('orgKey')?.value||'').trim(),
        orgKey:(document.getElementById('orgKey')?.value||'').trim(),
        accent:(document.getElementById('accent')?.value||'').trim() || '#8fd3ff',
        logoUrl:(window._uploadedLogoDataUrl || document.getElementById('logoUrl')?.value||'').trim(),
        logoBg:(document.getElementById('logoBg')?.value||'').trim(),
        name:(document.getElementById('name')?.value||'').trim(),
        title:(document.getElementById('title')?.value||'').trim(),
        phone:(document.getElementById('phone')?.value||'').trim(),
        email:(document.getElementById('email')?.value||'').trim(),
        site:(document.getElementById('site')?.value||'').trim(),
        address:(document.getElementById('address')?.value||'').trim(),
        slug:(document.getElementById('slug')?.value||'').trim(),
        vcfFilename:(document.getElementById('vcfFilename')?.value||'').trim()
      };
    }

    function updateLivePreview(){
      const frame=document.getElementById('livePreviewFrame');
      if(!frame) return;
      const d=currentData();
      const doc=frame.contentDocument||frame.contentWindow.document;
      doc.open(); doc.write(makeHTML(d)); doc.close();
    }

    // Åpne forhåndsvisning i ny fane
    document.getElementById('openPreviewBtn')?.addEventListener('click', ()=>{
      const w=window.open('about:blank','_blank');
      if(!w) return;
      const d=currentData();
      w.document.open(); w.document.write(makeHTML(d)); w.document.close();
    });

    // Logo-preview + opplasting
    function previewLogo(){
      const img=document.getElementById('logoPreview');
      const bg=(document.getElementById('logoBg')?.value||'').trim();
      const src= (window._uploadedLogoDataUrl || (document.getElementById('logoUrl')?.value||'').trim());
      if(!img) return;
      img.style.display = src ? 'block' : 'none';
      if(!src) return;
      img.src=src; img.style.background=bg||'#ffffff'; img.style.borderRadius='8px'; img.style.padding='6px';
    }
    async function testLogoUrl(){
      const url=(document.getElementById('logoUrl')?.value||'').trim();
      if(!url) return alert('Angi en URL først.');
      try{ const i=new Image(); i.src=url; await i.decode(); alert('OK: Bildet lastet.'); previewLogo(); }
      catch(e){ alert('Kunne ikke laste bildet: '+e.message); }
    }
    function clearLogoUrl(){ const el=document.getElementById('logoUrl'); if(el) el.value=''; window._uploadedLogoDataUrl=''; previewLogo(); updateLivePreview(); }

    document.getElementById('logoFile')?.addEventListener('change', (e)=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      const note=document.getElementById('logoFileNote');
      const r=new FileReader();
      r.onload=()=>{ window._uploadedLogoDataUrl=String(r.result||''); const u=document.getElementById('logoUrl'); if(u) u.value=''; if(note) note.textContent='Bruker opplastet logo: '+f.name; previewLogo(); updateLivePreview(); };
      r.readAsDataURL(f);
    });

    // Form-endringer trigger live preview
    ['orgName','orgKey','accent','logoUrl','logoBg','name','title','phone','email','site','address','slug','vcfFilename']
      .forEach(id=>document.getElementById(id)?.addEventListener('input',()=>{ if(id==='logoUrl'||id==='logoBg') previewLogo(); updateLivePreview(); }));

    document.getElementById('generate')?.addEventListener('click', async ()=>{
      // her kalles eksisterende publiseringslogikk din (beholdt)
      // ...
      alert('Generer & Publiser: implementer kobling til backend som før (beholdt).');
    });

    // NFC: les/skriv (uendret fra din fil)
    function supportsNFC(){ return 'NDEFReader' in window; }
    function logNFC(s){ const el=document.getElementById('nfcLog'); if(el) el.textContent += (s+'\n'); }

    document.getElementById('nfcRead').addEventListener('click', async ()=>{
      if(!supportsNFC()){ alert('Web NFC støttes kun i Chrome/Android'); return; }
      try{
        const reader=new NDEFReader(); await reader.scan();
        logNFC('Lytter etter NFC …');
        reader.onreading = (event)=>{
          logNFC('--- Tag lest ---');
          for (const record of event.message.records) {
            try{
              if (record.recordType === "url") {
                logNFC('URL: '+record.data);
              } else if (record.recordType === "mime" && record.mediaType === "text/vcard") {
                const textDecoder = new TextDecoder();
                const vcf = textDecoder.decode(record.data);
                logNFC('vCard:\\n'+vcf);
              } else {
                logNFC(`Record: type=${record.recordType} mediaType=${record.mediaType||''}`);
              }
            }catch(e){ logNFC('Kunne ikke dekode record: '+e.message); }
          }
        };
      }catch(e){
        logNFC('Start scanning feilet: '+e.message);
      }
    });

    // SKRIV NFC
    document.getElementById('nfcWrite').addEventListener('click', async ()=>{
      if(!supportsNFC()){ alert('Web NFC støttes kun i Chrome/Android'); return; }
      try{
        const writer = new NDEFReader();
        await writer.write(await buildNdefToWrite());
        alert('Skrevet til tag!');
      }catch(e){ alert('Skriving feilet: '+e.message); }
    });

    async function buildNdefToWrite(){
      const mode = document.getElementById('nfcWriteMode').value;
      if(mode==='url'){
        const url = (document.getElementById('nfcPayload')?.value||'').trim();
        if(!url) throw new Error('Ingen URL angitt.');
        return { records:[ { recordType:'url', data:url } ] };
      }
      if(mode==='text'){
        const txt = (document.getElementById('nfcPayload')?.value||'').trim();
        if(!txt) throw new Error('Ingen tekst angitt.');
        return { records:[ { recordType:'text', data:txt } ] };
      }
      if(mode==='vcard'){
        const vcf = (document.getElementById('vcfPreview')?.value||'').trim();
        if (!vcf) throw new Error('Ingen vCard i forhåndsvisning. Generer først.');
        return { records:[ { recordType:'mime', mediaType:'text/vcard', data: new TextEncoder().encode(vcf) } ] };
      }
      throw new Error('Ukjent skrive-modus');
    }

    // Init etter DOM ready (merk: auth viser/skjuler app)
    document.addEventListener('DOMContentLoaded', ()=>{
      const sel = document.getElementById('orgSelect');
      if (sel) sel.addEventListener('change', syncOrgKeyFromSelect);
    });
  </script>
</body>
</html>
