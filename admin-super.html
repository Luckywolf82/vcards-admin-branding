<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFCKING ‚Äì Superadmin</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0b0b10; --card:#12131a; --muted:#1a1c25;
      --text:#e9eef5; --sub:#9fb0c9; --brand:#ff1a1a; --ok:#21c36a; --err:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    a{color:#cfe3ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header.nav{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, rgba(11,11,16,.95), rgba(11,11,16,.85));
      border-bottom:1px solid #1d2230; backdrop-filter: blur(8px);
    }
    .nav-inner{display:flex;align-items:center;gap:14px;max-width:1200px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--brand);box-shadow:0 0 14px rgba(255,26,26,.6)}
    .spacer{flex:1}
    .nav a{padding:8px 10px;border-radius:10px}
    .nav a[aria-current="page"]{background:var(--muted);color:#fff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:20px 0}
    .tab-btn{
      background:var(--muted); color:var(--text); border:1px solid #222736;
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .tab-btn[aria-selected="true"]{outline:2px solid var(--brand)}
    .card{background:var(--card);border:1px solid #1b2030;border-radius:var(--radius);padding:16px}
    .grid{display:grid; gap:16px}
    @media (min-width:1000px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:2fr 1fr 1fr} }
    .muted{color:var(--sub)}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span> NFCKING Superadmin</div>
      <nav>
        <a href="/index.html">Admin</a>
        <a href="/demo.html">Demo</a>
        <a href="/bestill-kort.html">Bestill kort</a>
        <a href="/admin-super.html" aria-current="page">Superadmin</a>
      </nav>
      <div class="spacer"></div>
      <div id="userBadge" class="muted">Ikke innlogget</div>
    </div>
  </header>

  <main class="container">
    <h1>Superadmin</h1>
    <p class="muted">Full kontroll over farger, spr√•k, brukere, sider, Stripe, ordrer, NFC-batcher, SEO m.m.</p>

    <!-- Tab knapper -->
    <div class="tabs" role="tablist" aria-label="Superadmin seksjoner">
      <button class="tab-btn" role="tab" aria-selected="true" data-tab="branding">üé® Branding</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="lang">üåê Spr√•k</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="users">üë§ Brukere</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="pages">üßæ Sider</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="stripe">üí≥ Stripe</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="orders">üì¶ Ordrer</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="nfc">üß± NFC-Batch</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="seo">üîç SEO</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="settings">‚öôÔ∏è System</button>
    </div>

    <!-- Branding -->
    <section id="tab-branding" role="tabpanel">
      <div class="grid cols-2">
        <form id="brandForm" class="card">
          <h2>Branding</h2>
          <p class="muted">Velg farger, radius og lys/m√∏rk modus. Last opp logo. Lagre lokalt n√• ‚Äì senere kan vi koble til Firestore.</p>

          <div class="grid" style="gap:10px">
            <label>Prim√¶rfarge
              <input type="color" id="themePrimary" value="#ff1a1a" />
            </label>
            <label>Sekund√¶rfarge
              <input type="color" id="themeSecondary" value="#111827" />
            </label>
            <label>Bakgrunn
              <input type="color" id="themeBg" value="#0b0b10" />
            </label>
            <label>Kortbakgrunn
              <input type="color" id="themeCard" value="#12131a" />
            </label>
            <label>Tekst
              <input type="color" id="themeText" value="#e9eef5" />
            </label>
            <label>Muted
              <input type="color" id="themeMuted" value="#1a1c25" />
            </label>
            <label>Radius (px)
              <input type="number" id="themeRadius" value="16" min="0" max="40" />
            </label>
            <label>Modus
              <select id="themeMode">
                <option value="auto">Auto (system)</option>
                <option value="dark" selected>M√∏rk</option>
                <option value="light">Lys</option>
              </select>
            </label>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <label>Logo (PNG/SVG)
              <input type="file" id="logoFile" accept=".png,.svg,.jpg,.webp" />
            </label>
            <button type="button" id="btnUploadLogo" class="tab-btn">Last opp logo</button>
            <button type="button" id="btnSaveTheme" class="tab-btn">Lagre</button>
            <button type="button" id="btnResetTheme" class="tab-btn">Nullstill</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button type="button" id="btnExportTheme" class="tab-btn">Eksporter JSON</button>
            <label class="tab-btn" style="cursor:pointer">
              Importer JSON
              <input type="file" id="importThemeFile" accept="application/json" style="display:none" />
            </label>
          </div>

          <p id="brandMsg" class="muted" style="margin-top:10px"></p>
        </form>

        <div class="card" id="brandPreview" style="border-radius:var(--radius)">
          <h2 style="margin-top:0">Live-preview</h2>
          <p class="muted">Forh√•ndsvis farger/typografi under. Logo vises dersom opplastet.</p>
          <div id="logoWrap" style="display:flex;align-items:center;gap:10px;margin:6px 0 14px">
            <img id="logoImg" alt="Logo" style="max-height:46px;display:none;border-radius:8px" />
            <span id="siteName" style="font-weight:800">NFCKING</span>
          </div>

          <div style="display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))">
            <div style="background:var(--muted);padding:12px;border-radius:12px;border:1px solid #222736">
              <strong>Kort</strong>
              <p class="muted">Sekund√¶rtekst ‚Äì slik ser ‚Äúmuted‚Äù ut.</p>
              <button class="tab-btn">Knapp</button>
            </div>
            <div style="background:var(--card);padding:12px;border-radius:12px;border:1px solid #1b2030">
              <strong>Panel</strong>
              <p style="margin:0">Prim√¶r: <span id="pvPrimary"></span></p>
              <p style="margin:0">Bakgrunn: <span id="pvBg"></span></p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Spr√•k -->
    <section id="tab-lang" class="hidden" role="tabpanel">
      <div class="card" style="margin-bottom:12px">
        <h2>Spr√•k & oversettelser</h2>
        <p class="muted">Rediger n√∏kkel/verdier for flere spr√•k. ‚ÄúManglende‚Äù markeres r√∏dt. Data lagres lokalt n√• (kan kobles mot Firestore senere).</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <label>Standard spr√•k
            <select id="i18nDefaultLang">
              <option value="nb">nb</option>
              <option value="en">en</option>
            </select>
          </label>
          <label>Aktive spr√•k
            <input id="i18nLangs" type="text" value="nb,en" style="min-width:160px" />
          </label>
          <input id="i18nSearch" type="search" placeholder="S√∏k n√∏kkel/tekst‚Ä¶" style="flex:1;min-width:220px" />
          <button id="i18nAddKey" class="tab-btn">+ Ny n√∏kkel</button>
          <button id="i18nSave" class="tab-btn">Lagre</button>
          <button id="i18nReset" class="tab-btn">Nullstill</button>
          <button id="i18nExportJson" class="tab-btn">Eksporter JSON</button>
          <button id="i18nExportCsv" class="tab-btn">Eksporter CSV</button>
          <label class="tab-btn" style="cursor:pointer">Importer JSON
            <input id="i18nImportJson" type="file" accept="application/json" style="display:none" />
          </label>
          <label class="tab-btn" style="cursor:pointer">Importer CSV
            <input id="i18nImportCsv" type="file" accept=".csv,text/csv" style="display:none" />
          </label>
        </div>
        <p id="i18nMsg" class="muted" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <div style="overflow:auto">
          <table id="i18nTable" style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736;width:280px">N√∏kkel</th>
                <!-- spr√•k-kolonner genereres i JS -->
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736;width:120px">Handling</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Brukere -->
    <section id="tab-users" role="tabpanel" class="hidden">
      <div class="card" style="margin-bottom:12px">
        <h2>Brukere & roller</h2>
        <p class="muted">Opprett, deaktiver/aktiver, endre roller. (Kaller backend-endepunkt n√•r de kobles.)</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="usrSearch" type="search" placeholder="S√∏k navn/e-post‚Ä¶" style="flex:1;min-width:220px" />
          <label>Rolle
            <select id="usrRoleFilter">
              <option value="">Alle</option>
              <option value="superadmin">superadmin</option>
              <option value="admin">admin</option>
              <option value="editor">editor</option>
              <option value="viewer">viewer</option>
            </select>
          </label>
          <label>Status
            <select id="usrStatusFilter">
              <option value="">Alle</option>
              <option value="active">Aktiv</option>
              <option value="disabled">Deaktivert</option>
            </select>
          </label>
          <button id="usrRefresh" class="tab-btn">Oppdater</button>
          <button id="usrInviteOpen" class="tab-btn">+ Ny bruker</button>
        </div>
        <p id="usrMsg" class="muted" style="margin-top:6px"></p>
      </div>

      <div class="card">
        <div style="overflow:auto">
          <table id="usrTable" style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Navn</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">E-post</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Rolle</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Org</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Status</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736;width:260px">Handling</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="usrPagination" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="usrPrev" class="tab-btn">Forrige</button>
          <button id="usrNext" class="tab-btn">Neste</button>
        </div>
      </div>

      <div id="usrInvite" class="card hidden" style="margin-top:12px">
        <h3>Inviter ny bruker</h3>
        <div class="grid cols-2" style="gap:10px">
          <label>Navn
            <input id="invName" type="text" placeholder="Ola Nordmann" />
          </label>
          <label>E-post
            <input id="invEmail" type="email" placeholder="ola@firma.no" />
          </label>
          <label>Rolle
            <select id="invRole">
              <option value="admin">admin</option>
              <option value="editor">editor</option>
              <option value="viewer">viewer</option>
              <option value="superadmin">superadmin</option>
            </select>
          </label>
          <label>Org-n√∏kkel
            <input id="invOrg" type="text" placeholder="Wayback" />
          </label>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="invSend" class="tab-btn">Send invitasjon</button>
          <button id="invCancel" class="tab-btn">Avbryt</button>
        </div>
      </div>
    </section>

    <!-- Sider -->
    <section id="tab-pages" role="tabpanel" class="hidden">
      <div class="card" style="margin-bottom:12px">
        <h2>Sider</h2>
        <p class="muted">Opprett, rediger, planlegg og publiser sider. Menybygger nederst.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="pgSearch" type="search" placeholder="S√∏k tittel/slug‚Ä¶" style="flex:1;min-width:240px" />
          <label>Status
            <select id="pgStatus">
              <option value="">Alle</option>
              <option value="draft">draft</option>
              <option value="published">published</option>
              <option value="scheduled">scheduled</option>
            </select>
          </label>
          <button id="pgRefresh" class="tab-btn">Oppdater</button>
          <button id="pgNew" class="tab-btn">+ Ny side</button>
        </div>
        <p id="pgMsg" class="muted" style="margin-top:6px"></p>
      </div>

      <div class="card" style="margin-bottom:12px">
        <div style="overflow:auto">
          <table id="pgTable" style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Tittel</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Slug</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Status</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Oppdatert</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #222736;width:280px">Handling</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="pgEditor" class="card hidden" style="margin-bottom:12px">
        <h3 id="pgEditorTitle">Ny side</h3>
        <div class="grid cols-2" style="gap:12px">
          <label>Slug
            <input id="pgSlug" type="text" placeholder="bestill-kort" />
          </label>
          <label>Status
            <select id="pgStatusEdit">
              <option value="draft">draft</option>
              <option value="published">published</option>
              <option value="scheduled">scheduled</option>
            </select>
          </label>
          <label>Publiseringsdato (valgfritt ved scheduled)
            <input id="pgScheduleAt" type="datetime-local" />
          </label>
          <label>Org (valgfritt)
            <input id="pgOrg" type="text" placeholder="Wayback" />
          </label>

          <label style="grid-column:1/-1">Tittel (nb)
            <input id="pgTitleNb" type="text" placeholder="Tittel (norsk)" />
          </label>
          <label style="grid-column:1/-1">Tittel (en)
            <input id="pgTitleEn" type="text" placeholder="Title (English)" />
          </label>

          <label style="grid-column:1/-1">Innhold (HTML ‚Äì nb)
            <textarea id="pgBodyNb" rows="10" placeholder="&lt;section&gt;‚Ä¶&lt;/section&gt;"></textarea>
          </label>
          <label style="grid-column:1/-1">Innhold (HTML ‚Äì en)
            <textarea id="pgBodyEn" rows="10" placeholder="&lt;section&gt;‚Ä¶&lt;/section&gt;"></textarea>
          </label>

          <details style="grid-column:1/-1">
            <summary>SEO</summary>
            <div class="grid" style="gap:10px;margin-top:8px">
              <label>SEO Title
                <input id="pgSeoTitle" type="text" />
              </label>
              <label>SEO Description
                <input id="pgSeoDesc" type="text" />
              </label>
              <label>OG-bilde URL
                <input id="pgSeoOg" type="text" placeholder="/media/og.png" />
              </label>
              <label>Canonical
                <input id="pgSeoCanonical" type="text" placeholder="/bestill-kort" />
              </label>
              <label>Synlig i meny
                <select id="pgMenuShow">
                  <option value="true">Ja</option>
                  <option value="false">Nei</option>
                </select>
              </label>
              <label>Menysortering (heltall)
                <input id="pgMenuOrder" type="number" value="10" />
              </label>
            </div>
          </details>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="pgSaveDraft" class="tab-btn">Lagre kladd</button>
          <button id="pgPublish" class="tab-btn">Publiser</button>
          <button id="pgPreview" class="tab-btn">Forh√•ndsvis</button>
          <button id="pgClose" class="tab-btn">Lukk</button>
          <span id="pgEditMsg" class="muted"></span>
        </div>
      </div>

      <div class="card">
        <h3>Menybygger</h3>
        <p class="muted">Bygg toppmeny. Dra/endre rekkef√∏lge med pilknapper.</p>
        <div id="menuList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="menuAdd" class="tab-btn">+ Legg til</button>
          <button id="menuSave" class="tab-btn">Lagre meny</button>
          <span id="menuMsg" class="muted"></span>
        </div>
      </div>
    </section>

    <!-- Stripe -->
    <section id="tab-stripe" class="" role="tabpanel">
  <div class="grid cols-2">
    <!-- Konfig -->
    <div class="card">
      <h2>Stripe ‚Äì Konfig</h2>
      <p class="muted">Les/oppdater konfig. Hemmeligheter holdes i milj√∏variabler (server).</p>
      <div class="grid" style="gap:10px">
        <label>Mode
          <select id="stMode">
            <option value="test">test</option>
            <option value="live">live</option>
          </select>
        </label>
        <label>Publishable key
          <input id="stPubKey" type="text" placeholder="pk_test_..." />
        </label>
        <label>Connect aktivert
          <select id="stConnect">
            <option value="false">Nei</option>
            <option value="true">Ja</option>
          </select>
        </label>
        <div class="muted" id="stWebhookInfo">Webhook secret: ukjent</div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="stLoad" class="tab-btn">Last konfig</button>
        <button id="stSave" class="tab-btn">Lagre</button>
        <span id="stMsg" class="muted"></span>
      </div>
    </div>

    <!-- Produkter/Priser -->
    <div class="card">
      <h2>Produkter & priser</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px">
        <input id="stProdSearch" type="search" placeholder="S√∏k produktnavn‚Ä¶" style="flex:1;min-width:200px" />
        <button id="stProdReload" class="tab-btn">Oppdater</button>
        <button id="stProdNew" class="tab-btn">+ Nytt produkt</button>
      </div>
      <div id="stProdForm" class="hidden" style="border:1px solid #1b2030;padding:10px;border-radius:12px;margin-bottom:8px">
        <div class="grid" style="gap:8px">
          <label>Navn
            <input id="stNewProdName" type="text" placeholder="Kort / Abonnement" />
          </label>
          <label>Beskrivelse
            <input id="stNewProdDesc" type="text" />
          </label>
        </div>
        <div style="margin-top:6px;display:flex;gap:8px">
          <button id="stProdCreate" class="tab-btn">Opprett produkt</button>
          <button id="stProdCancel" class="tab-btn">Avbryt</button>
          <span id="stProdMsg" class="muted"></span>
        </div>
      </div>
      <div style="overflow:auto;max-height:420px">
        <table id="stProdTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Produkt</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Priser</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736;width:240px">Handling</th>
            </tr>
          </thead>
          <tbody><!-- fylles i JS --></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:16px">
    <!-- Betalinger -->
    <div class="card">
      <h2>Betalinger</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px">
        <label>Status
          <select id="stChStatus">
            <option value="">Alle</option>
            <option value="succeeded">succeeded</option>
            <option value="pending">pending</option>
            <option value="failed">failed</option>
          </select>
        </label>
        <label>Fra
          <input id="stChFrom" type="date" />
        </label>
        <label>Til
          <input id="stChTo" type="date" />
        </label>
        <button id="stChReload" class="tab-btn">Oppdater</button>
        <span id="stChMsg" class="muted"></span>
      </div>
      <div style="overflow:auto;max-height:420px">
        <table id="stChTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Tid</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Bel√∏p</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Kunde</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736;width:200px">Handling</th>
            </tr>
          </thead>
          <tbody><!-- fylles i JS --></tbody>
        </table>
      </div>
    </div>

    <!-- Kunder / Testbetaling -->
    <div class="card">
      <h2>Kunder & testbetaling</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px">
        <input id="stCustEmail" type="email" placeholder="Filter e-post‚Ä¶" />
        <button id="stCustReload" class="tab-btn">Hent kunder</button>
        <button id="stCustCreate" class="tab-btn">+ Ny kunde</button>
        <span id="stCustMsg" class="muted"></span>
      </div>
      <div style="overflow:auto;max-height:300px;margin-bottom:10px">
        <table id="stCustTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">Navn</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #222736">E-post</th>
            </tr>
          </thead>
          <tbody><!-- fylles i JS --></tbody>
        </table>
      </div>

      <details>
        <summary>Test-checkout</summary>
        <div class="grid" style="gap:10px;margin-top:8px">
          <label>Price ID
            <input id="stTestPrice" type="text" placeholder="price_..." />
          </label>
          <label>Antall
            <input id="stTestQty" type="number" value="1" min="1" />
          </label>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="stStartCheckout" class="tab-btn">Start Checkout</button>
          <span id="stTestMsg" class="muted"></span>
        </div>
      </details>
    </div>
  </div>
</section>


    <!-- Ordrer -->
    <section id="tab-orders" class="hidden" role="tabpanel">
      <div class="card"><h2>Ordrer</h2><p class="muted">Filter, liste, detaljpanel ‚Ä¶</p></div>
    </section>

    <!-- NFC -->
    <section id="tab-nfc" class="hidden" role="tabpanel">
      <div class="card"><h2>NFC-Batch</h2><p class="muted">Batch-opprettelse, jobb-k√∏, verifisering ‚Ä¶</p></div>
    </section>

    <!-- SEO -->
    <section id="tab-seo" class="hidden" role="tabpanel">
      <div class="card"><h2>SEO</h2><p class="muted">Globalt, sider, sitemap/robots, schema ‚Ä¶</p></div>
    </section>

    <!-- System -->
    <section id="tab-settings" class="hidden" role="tabpanel">
      <div class="card"><h2>System</h2><p class="muted">Milj√∏, API-n√∏kler (maskert), audit, backup ‚Ä¶</p></div>
    </section>
  </main>

  <!-- Del 6 ‚Äì del 2/6: Tab logic -->
  <script>
    (function(){
      const TAB_MAP = [
        { btn:'[data-tab="branding"]',  panel:'#tab-branding' },
        { btn:'[data-tab="lang"]',      panel:'#tab-lang' },
        { btn:'[data-tab="users"]',     panel:'#tab-users' },
        { btn:'[data-tab="pages"]',     panel:'#tab-pages' },
        { btn:'[data-tab="stripe"]',    panel:'#tab-stripe' },
        { btn:'[data-tab="orders"]',    panel:'#tab-orders' },
        { btn:'[data-tab="nfc"]',       panel:'#tab-nfc' },
        { btn:'[data-tab="seo"]',       panel:'#tab-seo' },
        { btn:'[data-tab="settings"]',  panel:'#tab-settings' }
      ];

      const qs = (sel, root=document) => root.querySelector(sel);
      const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
      const panels = TAB_MAP.map(t => qs(t.panel)).filter(Boolean);
      const buttons = TAB_MAP.map(t => qs(t.btn)).filter(Boolean);

      function activateTab(key, pushHash=true){
        const entry = TAB_MAP.find(t => qs(t.btn)?.dataset.tab === key);
        if(!entry){ return; }
        buttons.forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab === key)));
        panels.forEach(p => p.classList.add('hidden'));
        qs(entry.panel)?.classList.remove('hidden');
        if(pushHash){
          const url = new URL(location.href);
          url.hash = key;
          history.replaceState(null, '', url);
        }
      }

      qsa('.tab-btn').forEach(btn => {
        if(btn.getAttribute('role') === 'tab'){
          btn.addEventListener('click', () => activateTab(btn.dataset.tab));
        }
      });

      const userBadge = qs('#userBadge');
      try {
        const name = localStorage.getItem('nfcking.userName');
        const role = localStorage.getItem('nfcking.role');
        if(name || role){
          userBadge.textContent = [name, role ? `(${role})` : ''].filter(Boolean).join(' ');
        }
      } catch(_) {}

      function focusPanelHeader(panelSel){
        const h = qs(panelSel + ' h2');
        if(h){ h.setAttribute('tabindex','-1'); h.focus({preventScroll:false}); }
      }
      const _activate = activateTab;
      activateTab = function(key, pushHash=true){
        _activate(key, pushHash);
        const entry = TAB_MAP.find(t => qs(t.btn)?.dataset.tab === key);
        if(entry){ focusPanelHeader(entry.panel); }
      };

      const initial = (location.hash || '').replace(/^#/, '') || 'branding';
      activateTab(initial, false);
      window.addEventListener('hashchange', () => {
        const key = (location.hash || '').replace(/^#/, '') || 'branding';
        activateTab(key, false);
      });
    })();
  </script>

  <!-- Del 6 ‚Äì del 3/6: Branding script -->
  <script>
  (function(){
    const qs = (s, r=document)=>r.querySelector(s);
    const el = {
      primary: qs('#themePrimary'),
      secondary: qs('#themeSecondary'),
      bg: qs('#themeBg'),
      card: qs('#themeCard'),
      text: qs('#themeText'),
      muted: qs('#themeMuted'),
      radius: qs('#themeRadius'),
      mode: qs('#themeMode'),
      msg: qs('#brandMsg'),
      logoFile: qs('#logoFile'),
      logoImg: qs('#logoImg'),
      pvPrimary: qs('#pvPrimary'),
      pvBg: qs('#pvBg'),
    };

    const STORAGE_KEY = 'nfcking.theme.v1';
    const LOGO_KEY = 'nfcking.logoUrl';

    function applyTheme(t){
      const r = document.documentElement;
      if(!t) return;
      r.style.setProperty('--brand', t.primary || '#ff1a1a');
      r.style.setProperty('--bg',    t.bg      || '#0b0b10');
      r.style.setProperty('--card',  t.card    || '#12131a');
      r.style.setProperty('--text',  t.text    || '#e9eef5');
      r.style.setProperty('--muted', t.muted   || '#1a1c25');
      r.style.setProperty('--radius', (t.radius??16)+'px');
      document.body.dataset.theme = t.mode || 'dark';
      el.pvPrimary.textContent = t.primary;
      el.pvBg.textContent = t.bg;
    }

    function readForm(){
      return {
        primary:  el.primary.value,
        secondary:el.secondary.value,
        bg:       el.bg.value,
        card:     el.card.value,
        text:     el.text.value,
        muted:    el.muted.value,
        radius:   Number(el.radius.value || 16),
        mode:     el.mode.value
      };
    }

    function writeForm(t){
      if(!t) return;
      el.primary.value   = t.primary   || '#ff1a1a';
      el.secondary.value = t.secondary || '#111827';
      el.bg.value        = t.bg        || '#0b0b10';
      el.card.value      = t.card      || '#12131a';
      el.text.value      = t.text      || '#e9eef5';
      el.muted.value     = t.muted     || '#1a1c25';
      el.radius.value    = t.radius    ?? 16;
      el.mode.value      = t.mode      || 'dark';
    }

    function saveLocal(t){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(t));
      el.msg.textContent = 'Tema lagret lokalt.';
    }

    function loadLocal(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); }
      catch{ return null; }
    }

    const initTheme = loadLocal();
    if(initTheme){ writeForm(initTheme); applyTheme(initTheme); }
    else { applyTheme(readForm()); }

    ['input','change'].forEach(evt=>{
      ['#themePrimary','#themeSecondary','#themeBg','#themeCard','#themeText','#themeMuted','#themeRadius','#themeMode']
        .forEach(sel => qs(sel).addEventListener(evt, ()=>applyTheme(readForm())));
    });

    qs('#btnSaveTheme').addEventListener('click', ()=> saveLocal(readForm()));
    qs('#btnResetTheme').addEventListener('click', ()=>{
      localStorage.removeItem(STORAGE_KEY);
      const def = {primary:'#ff1a1a',secondary:'#111827',bg:'#0b0b10',card:'#12131a',text:'#e9eef5',muted:'#1a1c25',radius:16,mode:'dark'};
      writeForm(def); applyTheme(def); el.msg.textContent = 'Tilbakestilt til standard.';
    });

    qs('#btnExportTheme').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(readForm(), null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='nfcking-theme.json'; a.click();
      URL.revokeObjectURL(url);
    });
    qs('#importThemeFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const txt = await f.text();
        const t = JSON.parse(txt);
        writeForm(t); applyTheme(t); saveLocal(t);
      }catch{ el.msg.textContent = 'Kunne ikke lese JSON.'; }
      e.target.value = '';
    });

    const uploadEndpoint = '/.netlify/functions/uploadLogo';
    async function uploadLogo(file){
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch(uploadEndpoint, { method:'POST', body: fd });
      if(!res.ok) throw new Error('Upload feilet');
      const data = await res.json();
      return data.url || data.location || null;
    }

    const storedLogo = localStorage.getItem(LOGO_KEY);
    if(storedLogo){ el.logoImg.src = storedLogo; el.logoImg.style.display='block'; }

    qs('#btnUploadLogo').addEventListener('click', async ()=>{
      const f = el.logoFile.files?.[0];
      if(!f){ el.msg.textContent = 'Velg en logo-fil f√∏rst.'; return; }
      el.msg.textContent = 'Laster opp logo ‚Ä¶';
      try{
        const url = await uploadLogo(f);
        if(url){
          localStorage.setItem(LOGO_KEY, url);
          el.logoImg.src = url; el.logoImg.style.display='block';
          el.msg.textContent = 'Logo lastet opp.';
        } else {
          el.msg.textContent = 'Manglende URL i svar.';
        }
      }catch(err){
        el.msg.textContent = 'Opplasting feilet.';
      }
    });
  })();
  </script>

  <!-- Del 6 ‚Äì del 4/6: Spr√•k script -->
  <script>
  (function(){
    const qs=(s,r=document)=>r.querySelector(s);
    const qsa=(s,r=document)=>[...r.querySelectorAll(s)];
    const STORAGE_KEY='nfcking.i18n.v1';

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||''); }catch{ return null; }
    }
    function saveState(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }

    function defaultState(){
      return {
        defaultLang:'nb',
        langs:['nb','en'],
        data:{
          'app.title': { nb:'NFCKING', en:'NFCKING' },
          'nav.home':  { nb:'Hjem', en:'Home' },
          'nav.order': { nb:'Bestill', en:'Order' }
        }
      };
    }

    const el = {
      msg: qs('#i18nMsg'),
      def: qs('#i18nDefaultLang'),
      langs: qs('#i18nLangs'),
      table: qs('#i18nTable'),
      tbody: qs('#i18nTable tbody'),
      search: qs('#i18nSearch'),
      addKey: qs('#i18nAddKey'),
      save: qs('#i18nSave'),
      reset: qs('#i18nReset'),
      expJson: qs('#i18nExportJson'),
      expCsv: qs('#i18nExportCsv'),
      impJson: qs('#i18nImportJson'),
      impCsv: qs('#i18nImportCsv'),
    };

    let state = loadState() || defaultState();
    hydrateControls();
    renderTable();

    function hydrateControls(){
      el.def.value = state.defaultLang;
      el.langs.value = state.langs.join(',');
    }

    function setMsg(txt){ el.msg.textContent = txt; }

    function normalizeLangs(){
      state.langs = el.langs.value.split(',').map(s=>s.trim()).filter(Boolean);
      if(!state.langs.length){ state.langs=['nb']; }
      for(const [k, obj] of Object.entries(state.data)){
        state.langs.forEach(L=>{ if(!(L in obj)) obj[L]=''; });
      }
    }

    function renderHeader(){
      qsa('th[data-lang]', el.table).forEach(th=>th.remove());
      const headRow = qs('thead tr', el.table);
      const actionTh = headRow.lastElementChild;
      state.langs.forEach(L=>{
        const th = document.createElement('th');
        th.setAttribute('data-lang', L);
        th.style.cssText = 'text-align:left;padding:8px;border-bottom:1px solid #222736;min-width:200px';
        th.textContent = L;
        headRow.insertBefore(th, actionTh);
      });
    }

    function renderTable(){
      normalizeLangs();
      renderHeader();

      const q = (el.search.value||'').toLowerCase();
      const rows = [];
      const keys = Object.keys(state.data).sort();

      keys.forEach(key=>{
        const obj = state.data[key] || {};
        const textBlob = [key].concat(state.langs.map(L=>obj[L]||'')).join(' ').toLowerCase();
        if(q && !textBlob.includes(q)) return;

        const tr = document.createElement('tr');
        tr.setAttribute('data-key', key);

        const tdKey = document.createElement('td');
        tdKey.style.cssText='padding:8px;border-bottom:1px solid #1b2030;vertical-align:top';
        const keyInput = document.createElement('input');
        keyInput.type='text'; keyInput.value=key; keyInput.style='width:100%';
        keyInput.addEventListener('change', ()=>{
          const newKey = keyInput.value.trim();
          if(!newKey || newKey===key) return;
          if(state.data[newKey]){ setMsg('N√∏kkel finnes allerede.'); keyInput.value=key; return; }
          state.data[newKey] = {...state.data[key]};
          delete state.data[key];
          tr.setAttribute('data-key', newKey);
          setMsg(`Endret n√∏kkel: ${key} ‚Üí ${newKey}`);
        });
        tdKey.appendChild(keyInput);
        tr.appendChild(tdKey);

        state.langs.forEach(L=>{
          const td = document.createElement('td');
          td.style.cssText='padding:8px;border-bottom:1px solid #1b2030';
          const ta = document.createElement('textarea');
          ta.value = obj[L] || '';
          ta.rows = 2; ta.style = 'width:100%;font-family:system-ui,monospace';
          if(!ta.value){
            ta.style.border='1px solid #ff6b6b';
            ta.title='Mangler oversettelse';
          } else {
            ta.style.border='1px solid #222736';
          }
          ta.addEventListener('input', ()=>{
            const rowKey = tr.getAttribute('data-key');
            state.data[rowKey][L] = ta.value;
            ta.style.border = ta.value ? '1px solid #222736' : '1px solid #ff6b6b';
          });
          td.appendChild(ta);
          tr.appendChild(td);
        });

        const tdAct = document.createElement('td');
        tdAct.style.cssText='padding:8px;border-bottom:1px solid #1b2030;vertical-align:top';
        const delBtn = document.createElement('button');
        delBtn.className='tab-btn'; delBtn.textContent='Slett';
        delBtn.addEventListener('click', ()=>{
          const k = tr.getAttribute('data-key');
          delete state.data[k];
          tr.remove();
          setMsg(`Slettet n√∏kkel: ${k}`);
        });
        tdAct.appendChild(delBtn);
        tr.appendChild(tdAct);

        rows.push(tr);
      });

      el.tbody.replaceChildren(...rows);
    }

    el.search.addEventListener('input', renderTable);
    el.def.addEventListener('change', ()=>{
      state.defaultLang = el.def.value;
      setMsg(`Standard spr√•k: ${state.defaultLang}`);
    });
    el.langs.addEventListener('change', ()=>{ renderTable(); setMsg('Oppdatert spr√•k-liste.'); });

    el.addKey.addEventListener('click', ()=>{
      let base='section.title', i=1, key=base;
      while(state.data[key]){ i++; key=`${base}.${i}`; }
      state.data[key] = Object.fromEntries(state.langs.map(L=>[L,'']));
      renderTable();
      setMsg(`La til n√∏kkel: ${key}`);
    });

    el.save.addEventListener('click', ()=>{
      saveState(state);
      setMsg('Oversettelser lagret lokalt.');
    });

    el.reset.addEventListener('click', ()=>{
      state = defaultState();
      hydrateControls();
      renderTable();
      saveState(state);
      setMsg('Tilbakestilt til standard.');
    });

    el.expJson.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='i18n.json'; a.click();
      URL.revokeObjectURL(url);
    });

    el.expCsv.addEventListener('click', ()=>{
      const lines = [['key','lang','value']];
      for(const [k,obj] of Object.entries(state.data)){
        state.langs.forEach(L=>{
          lines.push([k, L, (obj[L]||'').replaceAll('"','""')]);
        });
      }
      const csv = lines.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='i18n.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    el.impJson.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const txt = await f.text();
        const incoming = JSON.parse(txt);
        if(!incoming || !incoming.data){ throw new Error('invalid'); }
        if(Array.isArray(incoming.langs)) state.langs = Array.from(new Set([...(state.langs||[]), ...incoming.langs]));
        if(incoming.defaultLang) state.defaultLang = incoming.defaultLang;
        for(const [k,obj] of Object.entries(incoming.data)){
          state.data[k] = {...(state.data[k]||{})};
          for(const [L,val] of Object.entries(obj)){
            state.data[k][L] = val;
          }
        }
        hydrateControls(); renderTable(); saveState(state);
        setMsg('Importert JSON og sl√•tt sammen.');
      }catch{
        setMsg('Kunne ikke importere JSON.');
      }
      e.target.value='';
    });

    el.impCsv.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const txt = await f.text();
        const rows = txt.split(/\r?\n/).filter(Boolean).map(line=>{
          const m=[...line.matchAll(/"((?:[^"]|"")*)"(,|$)/g)].map(x=>x[1].replaceAll('""','"'));
          return m;
        });
        const header = (rows.shift()||[]).map(h=>h.toLowerCase());
        const idxKey = header.indexOf('key');
        const idxLang= header.indexOf('lang');
        const idxVal = header.indexOf('value');
        if(idxKey<0||idxLang<0||idxVal<0) throw new Error('bad header');
        rows.forEach(cols=>{
          const k=cols[idxKey]; const L=cols[idxLang]; const v=cols[idxVal]||'';
          if(!k||!L) return;
          if(!state.data[k]) state.data[k]={};
          state.data[k][L]=v;
          if(!state.langs.includes(L)) state.langs.push(L);
        });
        hydrateControls(); renderTable(); saveState(state);
        setMsg('Importert CSV.');
      }catch{
        setMsg('Kunne ikke importere CSV.');
      }
      e.target.value='';
    });

  })();
  </script>

  <!-- Del 6 ‚Äì del 5/6: Brukere script -->
  <script>
  (function(){
    const qs=(s,r=document)=>r.querySelector(s);
    const qsa=(s,r=document)=>[...r.querySelectorAll(s)];
    const el = {
      msg: qs('#usrMsg'),
      table: qs('#usrTable tbody'),
      search: qs('#usrSearch'),
      roleF: qs('#usrRoleFilter'),
      statF: qs('#usrStatusFilter'),
      refresh: qs('#usrRefresh'),
      inviteOpen: qs('#usrInviteOpen'),
      inviteBox: qs('#usrInvite'),
      invName: qs('#invName'),
      invEmail: qs('#invEmail'),
      invRole: qs('#invRole'),
      invOrg: qs('#invOrg'),
      invSend: qs('#invSend'),
      invCancel: qs('#invCancel'),
      prev: qs('#usrPrev'),
      next: qs('#usrNext'),
    };

    const API = {
      list:   '/.netlify/functions/users.list',
      create: '/.netlify/functions/users.create',
      role:   '/.netlify/functions/users.role',
      status: '/.netlify/functions/users.status',
      imp:    '/.netlify/functions/users.impersonate'
    };

    let pageToken = null;
    let lastQuery = {};

    function setMsg(t){ el.msg.textContent = t || ''; }

    async function idToken(){
      return localStorage.getItem('nfcking.idToken') || '';
    }

    async function apiGet(url, params={}){
      const token = await idToken();
      const qs = new URLSearchParams(params).toString();
      const res = await fetch(url + (qs ? `?${qs}` : ''), { headers:{ Authorization: token ? `Bearer ${token}` : '' }});
      if(!res.ok) throw new Error(`GET ${url} ${res.status}`);
      return res.json();
    }
    async function apiPost(url, body){
      const token = await idToken();
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', Authorization: token ? `Bearer ${token}` : '' },
        body: JSON.stringify(body||{})
      });
      if(!res.ok) throw new Error(`POST ${url} ${res.status}`);
      return res.json();
    }

    function renderRows(users){
      const rows = users.map(u=>{
        const tr = document.createElement('tr');
        const td = (...nodes)=>{ const t=document.createElement('td'); t.style.cssText='padding:8px;border-bottom:1px solid #1b2030;vertical-align:top'; nodes.forEach(n=>t.append(n)); return t; };

        tr.appendChild(td(document.createTextNode(u.name || '‚Äî')));

        const aMail = document.createElement('a'); aMail.href = `mailto:${u.email}`; aMail.textContent = u.email||'‚Äî';
        tr.appendChild(td(aMail));

        const roleSel = document.createElement('select');
        ['superadmin','admin','editor','viewer'].forEach(r=>{
          const opt=document.createElement('option'); opt.value=r; opt.textContent=r;
          if((u.roles||[]).includes(r)) opt.selected = true;
          roleSel.appendChild(opt);
        });
        roleSel.addEventListener('change', async ()=>{
          try{
            await apiPost(API.role, { uid:u.uid, roles:[roleSel.value], orgKey:u.orgKey||null });
            setMsg(`Oppdatert rolle for ${u.email} ‚Üí ${roleSel.value}`);
          }catch{ setMsg('Kunne ikke oppdatere rolle.'); }
        });
        tr.appendChild(td(roleSel));

        tr.appendChild(td(document.createTextNode(u.orgKey || '‚Äî')));

        const statusBadge = document.createElement('span');
        statusBadge.textContent = u.status || 'active';
        statusBadge.className = 'muted';
        tr.appendChild(td(statusBadge));

        const actions = document.createElement('div');
        actions.style.display='flex'; actions.style.gap='6px'; actions.style.flexWrap='wrap';

        const btnToggle = document.createElement('button');
        btnToggle.className='tab-btn';
        btnToggle.textContent = (u.status==='disabled') ? 'Aktiver' : 'Deaktiver';
        btnToggle.addEventListener('click', async ()=>{
          try{
            const to = (u.status==='disabled') ? 'active' : 'disabled';
            await apiPost(API.status, { uid:u.uid, status:to });
            u.status = to; statusBadge.textContent = to;
            btnToggle.textContent = (to==='disabled') ? 'Aktiver' : 'Deaktiver';
            setMsg(`Status oppdatert for ${u.email} ‚Üí ${to}`);
          }catch{ setMsg('Kunne ikke endre status.'); }
        });
        actions.appendChild(btnToggle);

        const btnImpersonate = document.createElement('button');
        btnImpersonate.className='tab-btn'; btnImpersonate.textContent='Impersonate (lese)';
        btnImpersonate.addEventListener('click', async ()=>{
          try{
            await apiPost(API.imp, { uid:u.uid });
            setMsg(`Impersonate-token generert for ${u.email} (lese-modus).`);
          }catch{ setMsg('Kunne ikke impersonate.'); }
        });
        actions.appendChild(btnImpersonate);

        tr.appendChild(td(actions));
        return tr;
      });

      el.table.replaceChildren(...rows);
    }

    async function loadUsers(opts={}){
      const params = {
        q: el.search.value || '',
        role: el.roleF.value || '',
        status: el.statF.value || '',
        pageToken: opts.pageToken || null,
        limit: 20
      };
      lastQuery = params;
      setMsg('Laster brukere ‚Ä¶');
      try{
        const data = await apiGet(API.list, params);
        renderRows(data.users || []);
        pageToken = { next: data.nextPageToken || null, prev: data.prevPageToken || null };
        el.prev.disabled = !pageToken.prev;
        el.next.disabled = !pageToken.next;
        setMsg(`Fant ${data.count ?? (data.users||[]).length} brukere.`);
      }catch{
        setMsg('Kunne ikke hente brukere.');
      }
    }

    function toggleInvite(show){
      el.inviteBox.classList.toggle('hidden', !show);
      if(show){ el.invName.focus(); }
    }

    el.inviteOpen.addEventListener('click', ()=> toggleInvite(true));
    el.invCancel.addEventListener('click', ()=> toggleInvite(false));
    el.invSend.addEventListener('click', async ()=>{
      const name = el.invName.value.trim();
      const email = el.invEmail.value.trim();
      const role = el.invRole.value;
      const org  = el.invOrg.value.trim() || null;
      if(!email){ setMsg('E-post er p√•krevd.'); return; }
      setMsg('Sender invitasjon ‚Ä¶');
      try{
        const res = await apiPost(API.create, { name, email, role, orgKey: org });
        setMsg(`Invitasjon sendt til ${email}. UID: ${res.uid || '‚Äî'}`);
        toggleInvite(false); el.invName.value=''; el.invEmail.value='';
        await loadUsers();
      }catch{
        setMsg('Kunne ikke sende invitasjon.');
      }
    });

    el.refresh.addEventListener('click', ()=> loadUsers());
    el.search.addEventListener('input', ()=> loadUsers());
    el.roleF.addEventListener('change', ()=> loadUsers());
    el.statF.addEventListener('change', ()=> loadUsers());

    el.prev.addEventListener('click', ()=> pageToken?.prev && loadUsers({ pageToken: pageToken.prev }));
    el.next.addEventListener('click', ()=> pageToken?.next && loadUsers({ pageToken: pageToken.next }));

    function onTabChange(){
      const active = (location.hash||'#branding').replace('#','');
      if(active==='users'){ loadUsers(); }
    }
    window.addEventListener('hashchange', onTabChange);
    onTabChange();
  })();
  </script>

  <!-- Del 6 ‚Äì del 6/6: Sider script -->
  <script>
  (function(){
    const qs=(s,r=document)=>r.querySelector(s);
    const ce=(t)=>document.createElement(t);
    const el = {
      msg: qs('#pgMsg'),
      table: qs('#pgTable tbody'),
      search: qs('#pgSearch'),
      status: qs('#pgStatus'),
      refresh: qs('#pgRefresh'),
      create: qs('#pgNew'),
      editor: qs('#pgEditor'),
      editorTitle: qs('#pgEditorTitle'),
      slug: qs('#pgSlug'),
      statusEdit: qs('#pgStatusEdit'),
      scheduleAt: qs('#pgScheduleAt'),
      org: qs('#pgOrg'),
      titleNb: qs('#pgTitleNb'),
      titleEn: qs('#pgTitleEn'),
      bodyNb: qs('#pgBodyNb'),
      bodyEn: qs('#pgBodyEn'),
      seoTitle: qs('#pgSeoTitle'),
      seoDesc: qs('#pgSeoDesc'),
      seoOg: qs('#pgSeoOg'),
      seoCanonical: qs('#pgSeoCanonical'),
      menuShow: qs('#pgMenuShow'),
      menuOrder: qs('#pgMenuOrder'),
      saveDraft: qs('#pgSaveDraft'),
      publish: qs('#pgPublish'),
      preview: qs('#pgPreview'),
      close: qs('#pgClose'),
      editMsg: qs('#pgEditMsg'),
      menuList: qs('#menuList'),
      menuAdd: qs('#menuAdd'),
      menuSave: qs('#menuSave'),
      menuMsg: qs('#menuMsg'),
    };

    const API = {
      list:   '/.netlify/functions/pages.list',
      get:    '/.netlify/functions/pages.get',
      save:   '/.netlify/functions/pages.save',
      publish:'/.netlify/functions/pages.publish',
      del:    '/.netlify/functions/pages.delete',
      menuGet:'/.netlify/functions/menu.get',
      menuSave:'/.netlify/functions/menu.save',
      preview:'/preview/'
    };

    let editingId = null;
    let lastPages = [];

    function setMsg(t){ el.msg.textContent = t || ''; }
    function setEditMsg(t){ el.editMsg.textContent = t || ''; }
    function setMenuMsg(t){ el.menuMsg.textContent = t || ''; }

    async function token(){
      return localStorage.getItem('nfcking.idToken') || '';
    }
    async function apiGet(url, params={}){
      const tk = await token();
      const qs = new URLSearchParams(params).toString();
      const res = await fetch(url + (qs?`?${qs}`:''), { headers: { Authorization: tk?`Bearer ${tk}`:'' } });
      if(!res.ok) throw new Error(`GET ${url} ${res.status}`);
      return res.json();
    }
    async function apiPost(url, body){
      const tk = await token();
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json', Authorization: tk?`Bearer ${tk}`:''}, body: JSON.stringify(body||{}) });
      if(!res.ok) throw new Error(`POST ${url} ${res.status}`);
      return res.json();
    }

    function fmtDate(ts){
      try{ const d = new Date(ts); return d.toLocaleString(); }catch{ return '‚Äî'; }
    }

    function renderPages(pages){
      lastPages = pages || [];
      const rows = lastPages.map(p=>{
        const tr = ce('tr');
        const td = (n)=>{ const t=ce('td'); t.style.cssText='padding:8px;border-bottom:1px solid #1b2030;vertical-align:top'; t.append(n); return t; };

        tr.appendChild(td(document.createTextNode((p.title?.nb || p.title?.en || '‚Äî'))));
        tr.appendChild(td(document.createTextNode(p.slug || '‚Äî')));
        tr.appendChild(td(document.createTextNode(p.status || 'draft')));
        tr.appendChild(td(document.createTextNode(p.updatedAt ? fmtDate(p.updatedAt) : '‚Äî')));

        const actions = ce('div'); actions.style.display='flex'; actions.style.gap='6px'; actions.style.flexWrap='wrap';
        const bEdit = ce('button'); bEdit.className='tab-btn'; bEdit.textContent='Rediger';
        const bPub  = ce('button'); bPub.className='tab-btn'; bPub.textContent='Publiser';
        const bPrev = ce('button'); bPrev.className='tab-btn'; bPrev.textContent='Vis';
        const bDel  = ce('button'); bDel.className='tab-btn'; bDel.textContent='Slett';

        bEdit.onclick = ()=> openEditor(p.slug);
        bPub.onclick  = async ()=>{
          setMsg('Publiserer ‚Ä¶');
          try{
            await apiPost(API.publish, { slug:p.slug });
            setMsg(`Publisert: /${p.slug}`);
            await loadPages();
          }catch{ setMsg('Publisering feilet.'); }
        };
        bPrev.onclick = ()=> window.open(`/${p.slug}`, '_blank');
        bDel.onclick = async ()=>{
          if(!confirm(`Slette side /${p.slug}?`)) return;
          setMsg('Sletter ‚Ä¶');
          try{
            await apiPost(API.del, { slug:p.slug });
            setMsg(`Slettet /${p.slug}`);
            await loadPages();
          }catch{ setMsg('Sletting feilet.'); }
        };

        actions.append(bEdit,bPub,bPrev,bDel);
        tr.appendChild(td(actions));
        return tr;
      });

      el.table.replaceChildren(...rows);
    }

    async function loadPages(){
      setMsg('Laster sider ‚Ä¶');
      try{
        const data = await apiGet(API.list, { q: el.search.value || '', status: el.status.value || '', limit: 100 });
        renderPages(data.pages || []);
        setMsg(`Fant ${data.count ?? (data.pages||[]).length} sider.`);
      }catch{
        setMsg('Kunne ikke hente sider.');
      }
    }

    function openEditor(slug){
      if(!slug){
        editingId = null;
        el.editorTitle.textContent = 'Ny side';
        el.slug.value=''; el.statusEdit.value='draft'; el.scheduleAt.value=''; el.org.value='';
        el.titleNb.value=''; el.titleEn.value='';
        el.bodyNb.value=''; el.bodyEn.value='';
        el.seoTitle.value=''; el.seoDesc.value=''; el.seoOg.value=''; el.seoCanonical.value='';
        el.menuShow.value='true'; el.menuOrder.value='10';
        setEditMsg('');
        el.editor.classList.remove('hidden');
        return;
      }
      setMsg('√Öpner side ‚Ä¶');
      apiGet(API.get, { slug }).then(p=>{
        editingId = slug;
        el.editorTitle.textContent = `Rediger: /${slug}`;
        el.slug.value = p.slug || slug;
        el.statusEdit.value = p.status || 'draft';
        el.scheduleAt.value = p.scheduleAt ? new Date(p.scheduleAt).toISOString().slice(0,16) : '';
        el.org.value = p.orgKey || '';
        el.titleNb.value = p.title?.nb || '';
        el.titleEn.value = p.title?.en || '';
        el.bodyNb.value  = p.body?.nb  || '';
        el.bodyEn.value  = p.body?.en  || '';
        el.seoTitle.value = p.seo?.title || '';
        el.seoDesc.value  = p.seo?.description || '';
        el.seoOg.value    = p.seo?.ogImage || '';
        el.seoCanonical.value = p.seo?.canonical || '';
        el.menuShow.value = String(p.menu?.show ?? true);
        el.menuOrder.value = Number(p.menu?.order ?? 10);
        setEditMsg('');
        el.editor.classList.remove('hidden');
        setMsg('');
      }).catch(()=> setMsg('Kunne ikke √•pne side.'));
    }

    function collectPage(statusOverride){
      const scheduleValue = el.scheduleAt.value ? new Date(el.scheduleAt.value).toISOString() : null;
      return {
        slug: (el.slug.value || '').trim(),
        status: statusOverride || el.statusEdit.value || 'draft',
        scheduleAt: scheduleValue,
        orgKey: (el.org.value || '').trim() || null,
        title: { nb: el.titleNb.value || '', en: el.titleEn.value || '' },
        body:  { nb: el.bodyNb.value  || '', en: el.bodyEn.value  || '' },
        seo:   { title: el.seoTitle.value || '', description: el.seoDesc.value || '', ogImage: el.seoOg.value || '', canonical: el.seoCanonical.value || '' },
        menu:  { show: el.menuShow.value === 'true', order: Number(el.menuOrder.value || 10) }
      };
    }

    async function saveDraft(){
      const doc = collectPage('draft');
      if(!doc.slug){ setEditMsg('Slug er p√•krevd.'); return; }
      setEditMsg('Lagrer kladd ‚Ä¶');
      try{
        await apiPost(API.save, doc);
        setEditMsg('Kladd lagret.');
        await loadPages();
      }catch{ setEditMsg('Lagring feilet.'); }
    }

    async function publishNow(){
      const doc = collectPage('published');
      if(!doc.slug){ setEditMsg('Slug er p√•krevd.'); return; }
      setEditMsg('Publiserer ‚Ä¶');
      try{
        await apiPost(API.save, doc);
        await apiPost(API.publish, { slug: doc.slug });
        setEditMsg(`Publisert: /${doc.slug}`);
        await loadPages();
      }catch{ setEditMsg('Publisering feilet.'); }
    }

    el.refresh.addEventListener('click', loadPages);
    el.search.addEventListener('input', loadPages);
    el.status.addEventListener('change', loadPages);
    el.create.addEventListener('click', ()=> openEditor(null));
    el.saveDraft.addEventListener('click', saveDraft);
    el.publish.addEventListener('click', publishNow);
    el.preview.addEventListener('click', ()=>{
      const slug = (el.slug.value||'').trim();
      if(!slug) { setEditMsg('Sett slug f√∏rst.'); return; }
      window.open(`/${slug}`, '_blank');
    });
    el.close.addEventListener('click', ()=> el.editor.classList.add('hidden'));

    function onTabChange(){
      const active = (location.hash||'#branding').replace('#','');
      if(active==='pages'){ loadPages(); loadMenu(); }
    }
    window.addEventListener('hashchange', onTabChange);
    onTabChange();

    function menuRow(item, idx){
      const wrap = ce('div'); wrap.className='card'; wrap.style.display='grid'; wrap.style.gap='8px'; wrap.style.gridTemplateColumns='1fr 1fr auto';
      const lbl = ce('input'); lbl.type='text'; lbl.value=item.label||''; lbl.placeholder='Label';
      const href= ce('input'); href.type='text'; href.value=item.href||''; href.placeholder='/bestill-kort';
      const controls = ce('div'); controls.style.display='flex'; controls.style.gap='6px';
      const up = ce('button'); up.className='tab-btn'; up.textContent='‚Üë';
      const down = ce('button'); down.className='tab-btn'; down.textContent='‚Üì';
      const del = ce('button'); del.className='tab-btn'; del.textContent='Slett';

      up.onclick = ()=> move(idx, -1);
      down.onclick = ()=> move(idx, +1);
      del.onclick = ()=> { state.menu.splice(idx,1); renderMenu(); };

      lbl.oninput = ()=> state.menu[idx].label = lbl.value;
      href.oninput = ()=> state.menu[idx].href  = href.value;

      controls.append(up,down,del);
      wrap.append(lbl, href, controls);
      return wrap;
    }

    const state = { menu: [] };

    function renderMenu(){
      el.menuList.replaceChildren(...state.menu.map(menuRow));
    }
    function move(i, d){
      const j = i + d; if(j<0 || j>=state.menu.length) return;
      const tmp = state.menu[i]; state.menu[i]=state.menu[j]; state.menu[j]=tmp;
      renderMenu();
    }

    async function loadMenu(){
      setMenuMsg('Laster meny ‚Ä¶');
      try{
        const data = await apiGet(API.menuGet, {});
        state.menu = Array.isArray(data.nav) ? data.nav : [];
        renderMenu();
        setMenuMsg(`Meny lastet (${state.menu.length} element).`);
      }catch{
        setMenuMsg('Kunne ikke laste meny.');
      }
    }
    async function saveMenu(){
      setMenuMsg('Lagrer meny ‚Ä¶');
      try{
        await apiPost(API.menuSave, { nav: state.menu });
        setMenuMsg('Meny lagret.');
      }catch{
        setMenuMsg('Kunne ikke lagre meny.');
      }
    }

    el.menuAdd.addEventListener('click', ()=>{
      state.menu.push({ label:'Ny side', href:'/' });
      renderMenu();
    });
    el.menuSave.addEventListener('click', saveMenu);

  })();
  </script>

</body>
</html>
